<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Office Groups' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Office Groups</h1>
      <% if (isSuperAdmin) { %>
      <section>
        <h2>Add Group</h2>
        <form action="/office-groups" method="post">
          <%- include('partials/csrf-field') %>
          <input type="text" name="name" placeholder="Group Name" required>
          <button type="submit">Add</button>
        </form>
      </section>
      <% } %>
      <section>
        <h2>Groups</h2>
        <% if (officeGroups.length > 0) { %>
        <table>
          <thead>
            <tr><th>Name</th><th>Actions</th></tr>
          </thead>
          <tbody>
            <% officeGroups.forEach(function(g){ %>
              <tr>
                <td><%= g.name %></td>
                <td>
                  <button type="button" data-open-group-modal="<%= g.id %>">Edit</button>
                  <% if (isSuperAdmin) { %>
                    <form action="/office-groups/<%= g.id %>/delete" method="post" style="display:inline;">
                      <%- include('partials/csrf-field') %>
                      <button type="submit">Delete</button>
                    </form>
                  <% } %>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
        <% } else { %>
          <p>No groups.</p>
        <% } %>
        <div id="groupModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0.5);">
          <div style="background:#fff; margin:10% auto; padding:20px; width:400px;">
            <h3>Edit Group Members</h3>
            <form id="groupMembersForm" method="post">
              <%- include('partials/csrf-field') %>
              <table>
                <thead>
                  <tr><th>Name</th><th>Email</th><th>Add</th></tr>
                </thead>
                <tbody>
                  <% staff.forEach(function(s){ %>
                    <tr>
                      <td><%= s.first_name %> <%= s.last_name %></td>
                      <td><%= s.email %></td>
                      <td><input type="checkbox" name="staffIds" value="<%= s.id %>"></td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
              <button type="submit">Save</button>
              <button type="button" data-close-group-modal>Close</button>
            </form>
          </div>
        </div>
      </section>
    </div>
  </div>
  <script>
    const officeGroupsData = <%- JSON.stringify(officeGroups) %>;

    function openGroupModal(id) {
      const group = officeGroupsData.find(g => g.id === id);
      const form = document.getElementById('groupMembersForm');
      form.action = '/office-groups/' + id + '/members';
      form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
        cb.checked = group.members.some((m) => m.id === parseInt(cb.value, 10));
      });
      document.getElementById('groupModal').style.display = 'block';
    }

    function closeGroupModal() {
      document.getElementById('groupModal').style.display = 'none';
    }

    document.querySelectorAll('.open-group-modal').forEach((btn) => {
      btn.addEventListener('click', () => {
        const id = parseInt(btn.dataset.groupId, 10);
        openGroupModal(id);
      });
    });

    document.getElementById('groupModalClose')?.addEventListener('click', closeGroupModal);
  </script>
</body>
</html>

