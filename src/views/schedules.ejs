<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Schedules' }) %>
  <body>
    <div class="app-container">
      <%- include('partials/sidebar') %>
      <div class="content">
        <h1>Schedules</h1>
        <table>
          <thead>
            <tr>
              <th>ID</th><th>Company</th><th>Name</th><th>Command</th><th>Cron</th><th>Last Run</th><th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% tasks.forEach(function(t){ %>
              <tr>
                <td><%= t.id %></td>
                <td><%= t.company_name || '' %></td>
                <td><%= t.name %></td>
                <td><%= t.command %></td>
                <td><%= t.cron %></td>
                <td><%= t.last_run_at ? new Date(t.last_run_at).toLocaleString() : '' %></td>
                <td>
                  <form action="/admin/schedules/<%= t.id %>/run" method="post" style="display:inline">
                    <button type="submit">Run Now</button>
                  </form>
                  <form action="/admin/schedules/<%= t.id %>" method="post" style="display:inline">
                    <input type="text" name="name" value="<%= t.name %>" required>
                    <input type="text" name="cron" value="<%= t.cron %>" required>
                    <button type="submit">Save</button>
                  </form>
                  <form action="/admin/schedules/<%= t.id %>/delete" method="post" style="display:inline" onsubmit="return confirm('Delete?');">
                    <button type="submit">Delete</button>
                  </form>
                </td>
              </tr>
            <% }); %>
          </tbody>
        </table>
        <h2>Add Schedule</h2>
        <form action="/admin/schedules" method="post">
          <input type="text" name="name" placeholder="Name" required>
          <select name="command">
            <option value="sync_staff">Sync Staff From Syncro</option>
            <option value="sync_o365">Sync Office 365 License Counts</option>
            <option value="sync_xero">Sync Xero Invoices</option>
            <option value="sync_assets">Sync Assets From Syncro</option>
            <option value="system_update">MyPortal System Update</option>
          </select>
          <input type="text" name="cron" placeholder="Cron Expression" required>
          <select name="companyId">
            <option value="">System</option>
            <% allCompanies.forEach(function(c){ %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% }); %>
          </select>
          <button type="submit">Add</button>
        </form>
      </div>
    </div>
  </body>
</html>
