<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'System Update' }) %>
  <body class="login-page">
    <div class="login-container">
      <h1>Installing Update</h1>
      <p>An update is being installed. This page will refresh once the process completes.</p>
      <p id="loading">Checking status...</p>
    </div>
    <script>
      var loadingEl = document.getElementById('loading');
      var dots = 0;
      var loadingInterval = setInterval(function () {
        dots = (dots + 1) % 4;
        loadingEl.textContent = 'Checking status' + '.'.repeat(dots);
      }, 500);

      var pollInterval = setInterval(function () {
        fetch('/admin/system-update-status', { credentials: 'same-origin' })
          .then(function (res) {
            if (res.redirected) {
              window.location.href = res.url;
              return '';
            }
            return res.text();
          })
          .then(function (text) {
            try {
              var data = JSON.parse(text);
              if (data.complete) {
                clearInterval(pollInterval);
                clearInterval(loadingInterval);
                window.location.href = '/logon';
              }
            } catch (err) {
              if (text && text.includes('logon')) {
                window.location.href = '/logon';
              }
            }
          })
          .catch(function () {
            // Network error; ignore and retry
          });
      }, 3000);
    </script>
  </body>
</html>
