<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Audit Logs' }) %>
  <body>
    <div class="app-container">
      <%- include('partials/sidebar') %>
      <div class="content">
        <h1>Audit Logs</h1>
        <% if (isSuperAdmin) { %>
          <form method="get">
            <label>Company:
              <select name="companyId">
                <option value="">All</option>
                <% filterCompanies.forEach(function(c){ %>
                  <option value="<%= c.id %>" <%= selectedCompanyId == c.id ? 'selected' : '' %>><%= c.name %></option>
                <% }); %>
              </select>
            </label>
            <button type="submit">Filter</button>
          </form>
        <% } %>
        <table>
          <thead>
            <tr>
              <% if (isSuperAdmin) { %><th>Company</th><% } %>
              <th>User</th>
              <th>Action</th>
              <th>Value</th>
              <th>API Key</th>
              <th>IP Address</th>
              <th>Date</th>
            </tr>
          </thead>
          <tbody>
            <% logs.forEach(function(l){ %>
              <tr>
                <% if (isSuperAdmin) { %><td><%= l.company_name || '' %></td><% } %>
                <td><%= l.email || '' %></td>
                <td><%= l.action %></td>
                <td class="audit-value">
                  <% if (l.value && l.value.length > 100) { %>
                    <span class="truncate" data-full="<%= encodeURIComponent(l.value) %>"><%= l.value.slice(0, 100) %>...</span>
                  <% } else { %>
                    <span><%- l.value || '' %></span>
                  <% } %>
                </td>
                <td><%= l.api_key || '' %></td>
                <td><%= l.ip_address || '' %></td>
                <td class="created-at" data-created-at="<%= l.created_at %>"></td>
              </tr>
            <% }); %>
          </tbody>
        </table>
      </div>
    </div>
    <script>
      document.querySelectorAll('.created-at').forEach(function(td){
        var date = new Date(td.dataset.createdAt);
        if (!isNaN(date.getTime())) {
          td.textContent = date.toLocaleString();
        }
      });
      document.querySelectorAll('.audit-value .truncate').forEach(function(span){
        span.addEventListener('click', function(){
          var modal = document.createElement('div');
          modal.className = 'modal';
          var full = decodeURIComponent(span.dataset.full);
          modal.innerHTML = '<div class="modal-content"><span class="close">&times;</span><pre>' +
            full.replace(/</g, '&lt;') + '</pre></div>';
          document.body.appendChild(modal);
          modal.style.display = 'flex';
          modal.querySelector('.close').addEventListener('click', function(){
            modal.remove();
          });
        });
      });
    </script>
  </body>
</html>
