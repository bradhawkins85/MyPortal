<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Shop' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Shop</h1>
      <% if (cartError) { %>
        <p><%= cartError %></p>
      <% } %>
      <form method="get">
        <label>Category:
          <select name="category" data-submit-on-change>
            <option value="" <%= typeof currentCategory === 'undefined' ? 'selected' : '' %>>All</option>
            <% categories.forEach(function(c){ %>
              <option value="<%= c.id %>" <%= currentCategory === c.id ? 'selected' : '' %>><%= c.name %></option>
            <% }) %>
          </select>
        </label>
      </form>
      <table>
        <thead>
          <tr><th>Image</th><th>Name</th><th>SKU</th><th>Price</th><th>Details</th><th>Order</th></tr>
        </thead>
        <tbody>
          <% products.forEach(function(p){ %>
            <tr>
              <td><% if (p.image_url) { %><img src="<%= p.image_url %>" width="50" alt="" class="product-img"><% } %></td>
              <td><%= p.name %></td>
              <td><%= p.sku %></td>
              <td>$<%= p.price.toFixed(2) %></td>
              <td><button type="button" class="details-btn" data-image="<%= p.image_url || '' %>" data-price="<%= p.price.toFixed(2) %>" data-stock="<%= p.stock %>" data-details="<%- p.description.replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '&#10;') %>">Details</button></td>
              <td class="order-column">
                <form action="/cart/add" method="post">
                  <input type="hidden" name="productId" value="<%= p.id %>">
                  <input type="number" name="quantity" min="1" max="<%= p.stock %>" value="1">
                  <button type="submit">Add to Cart</button>
                </form>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
      <div id="image-modal" class="modal" style="display:none;">
        <div class="modal-content">
          <span id="image-close" class="close">&times;</span>
          <img id="modal-image" src="" alt="">
        </div>
      </div>
      <div id="details-modal" class="modal" style="display:none;">
        <div class="modal-content">
          <span id="details-close" class="close">&times;</span>
          <div id="details-content"></div>
        </div>
      </div>
    </div>
  </div>
  <script>
    document.querySelectorAll('.product-img').forEach(function(img) {
      img.addEventListener('click', function () {
        document.getElementById('modal-image').src = this.src;
        document.getElementById('image-modal').style.display = 'flex';
      });
    });

    document.getElementById('image-close').addEventListener('click', function () {
      document.getElementById('image-modal').style.display = 'none';
    });

    document.getElementById('image-modal').addEventListener('click', function (e) {
      if (e.target === this) {
        this.style.display = 'none';
      }
    });

      document.querySelectorAll('.details-btn').forEach(function(btn) {
        btn.addEventListener('click', function () {
          const img = this.dataset.image;
          const price = parseFloat(this.dataset.price).toFixed(2);
          const stock = parseInt(this.dataset.stock, 10);
          let stockText;
          if (stock <= 0) {
            stockText = 'Out of Stock';
          } else if (stock <= 5) {
            stockText = 'Low Stock';
          } else {
            stockText = 'In Stock';
          }
          let html = '';
          if (img) {
            html += `<img src="${img}" alt="" style="max-width:100%;"><br>`;
          }
          html += `<p>Price: $${price}</p>`;
          html += `<p>${stockText}</p>`;
          html += `<p>${this.dataset.details.replace(/\n/g, '<br>')}</p>`;
          document.getElementById('details-content').innerHTML = html;
          document.getElementById('details-modal').style.display = 'flex';
        });
      });

    document.getElementById('details-close').addEventListener('click', function () {
      document.getElementById('details-modal').style.display = 'none';
    });

    document.getElementById('details-modal').addEventListener('click', function (e) {
      if (e.target === this) {
        this.style.display = 'none';
      }
    });
  </script>
</body>
</html>
