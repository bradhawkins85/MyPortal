<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Licenses' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Licenses</h1>
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>SKU</th>
            <th>Count</th>
            <th>Allocated</th>
            <th>Expiry</th>
            <th>Contract Term</th>
            <% if (canOrderLicenses || isSuperAdmin) { %><th>Actions</th><% } %>
          </tr>
        </thead>
        <tbody>
        <% licenses.forEach(function(lic) { %>
          <tr>
            <td><%= lic.name %></td>
            <td><%= lic.platform %></td>
            <td><%= lic.count %></td>
            <td><a href="#" class="allocated-link" data-license-id="<%= lic.id %>"><%= lic.allocated %></a></td>
            <td><%= lic.expiry_date %></td>
            <td><%= lic.contract_term %></td>
            <% if (canOrderLicenses || isSuperAdmin) { %>
              <td>
                <% if (isSuperAdmin) { %>
                  <button
                    class="edit-btn"
                    data-license-id="<%= lic.id %>"
                    data-name="<%= lic.name %>"
                    data-sku="<%= lic.platform %>"
                    data-count="<%= lic.count %>"
                    data-expiry-date="<%= lic.expiry_date %>"
                    data-contract-term="<%= lic.contract_term %>"
                  >Edit</button>
                <% } %>
                <% if (canOrderLicenses) { %>
                  <button class="order-btn" data-license-id="<%= lic.id %>">Order More</button>
                  <button class="remove-btn" data-license-id="<%= lic.id %>">Request Removal</button>
                <% } %>
              </td>
            <% } %>
          </tr>
        <% }); %>
        </tbody>
      </table>
    </div>
  </div>

  <div id="allocated-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span id="allocated-close" class="close">&times;</span>
      <h2>Allocated Users</h2>
      <ul id="allocated-users"></ul>
    </div>
  </div>

  <div id="edit-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span id="edit-close" class="close">&times;</span>
      <h2>Edit License</h2>
      <form id="edit-form">
        <label>
          Name
          <input type="text" id="edit-name">
        </label>
        <label>
          SKU
          <input type="text" id="edit-sku">
        </label>
        <label>
          Count
          <input type="number" id="edit-count">
        </label>
        <label>
          Expiry
          <input type="date" id="edit-expiry">
        </label>
        <label>
          Contract Term
          <input type="text" id="edit-contract">
        </label>
        <button type="submit">Save</button>
      </form>
    </div>
  </div>

  <script>
    const currentCompanyId = <%= currentCompanyId %>;
    document.querySelectorAll('.allocated-link').forEach(function (link) {
      link.addEventListener('click', async function (e) {
        e.preventDefault();
        const id = this.dataset.licenseId;
        const res = await fetch(`/licenses/${id}/allocated`);
        if (!res.ok) return;
        const users = await res.json();
        const list = document.getElementById('allocated-users');
        list.innerHTML = '';
        if (users.length === 0) {
          const li = document.createElement('li');
          li.textContent = 'No users allocated';
          list.appendChild(li);
        } else {
          users.forEach(function (u) {
            const li = document.createElement('li');
            li.textContent = `${u.first_name} ${u.last_name} (${u.email})`;
            list.appendChild(li);
          });
        }
        document.getElementById('allocated-modal').style.display = 'flex';
      });
    });

    document.getElementById('allocated-close').addEventListener('click', function () {
      document.getElementById('allocated-modal').style.display = 'none';
    });

    document.querySelectorAll('.order-btn').forEach(function (btn) {
      btn.addEventListener('click', async function () {
        const qty = prompt('How many licenses to order?');
        if (!qty) return;
        await fetch(`/licenses/${this.dataset.licenseId}/order`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity: parseInt(qty, 10) }),
        });
        alert('Order submitted');
      });
    });

    document.querySelectorAll('.remove-btn').forEach(function (btn) {
      btn.addEventListener('click', async function () {
        const qty = prompt('How many licenses to remove?');
        if (!qty) return;
        await fetch(`/licenses/${this.dataset.licenseId}/remove`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ quantity: parseInt(qty, 10) }),
        });
        alert('Removal requested');
      });
    });

    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    let editingId = null;

    document.querySelectorAll('.edit-btn').forEach(function (btn) {
      btn.addEventListener('click', function () {
        editingId = this.dataset.licenseId;
        document.getElementById('edit-name').value = this.dataset.name;
        document.getElementById('edit-sku').value = this.dataset.sku;
        document.getElementById('edit-count').value = this.dataset.count;
        document.getElementById('edit-expiry').value = this.dataset.expiryDate;
        document.getElementById('edit-contract').value = this.dataset.contractTerm;
        editModal.style.display = 'flex';
      });
    });

    document.getElementById('edit-close').addEventListener('click', function () {
      editModal.style.display = 'none';
    });

    editForm.addEventListener('submit', async function (e) {
      e.preventDefault();
      const payload = {
        name: document.getElementById('edit-name').value,
        platform: document.getElementById('edit-sku').value,
        count: parseInt(document.getElementById('edit-count').value, 10),
        expiryDate: document.getElementById('edit-expiry').value || null,
        contractTerm: document.getElementById('edit-contract').value,
      };
      const res = await fetch(`/licenses/${editingId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        location.reload();
      } else {
        alert('Failed to update license');
      }
    });
  </script>
</body>
</html>
