<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: isAdmin ? 'Admin' : 'Account' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1><%= isAdmin ? 'Admin' : 'Account' %></h1>
      <div class="admin-tabs">
        <div class="tabs">
          <% if (isSuperAdmin) { %>
            <button data-tab="site-settings" class="active">Site Settings</button>
            <button data-tab="account">Account</button>
            <button data-tab="api-keys">API Keys</button>
            <button data-tab="companies">Companies</button>
            <button data-tab="assignments">Current Assignments</button>
            <button data-tab="schedules">Schedules</button>
            <button data-tab="apps">Apps</button>
            <button data-tab="shop-settings">Shop Settings</button>
            <button data-tab="products">Products</button>
            <button data-tab="forms-admin">Forms</button>
            <button data-tab="form-permissions">Form Permissions</button>
            <button type="button" onclick="window.location.href='/admin/email-templates'">Email Templates</button>
          <% } else if (isAdmin) { %>
            <button data-tab="account" class="active">Account</button>
            <button data-tab="companies">Companies</button>
            <button data-tab="assignments">Current Assignments</button>
          <% } else { %>
            <button data-tab="account" class="active">Account</button>
          <% } %>
        </div>
        <% if (isAdmin) { %>
        <div id="companies" class="tab-content">
          <% if (isSuperAdmin) { %>
          <section>
            <h2>Syncro Import</h2>
            <a href="/admin/syncro/customers">Import from Syncro</a>
          </section>
          <section>
            <h2>Add Company</h2>
            <form action="/admin/company" method="post">
              <input type="text" name="name" placeholder="Company Name" required>
              <input type="text" name="syncroCompanyId" placeholder="Syncro Company ID">
              <input type="text" name="xeroId" placeholder="Xero ID">
              <label><input type="checkbox" name="isVip" value="1"> VIP</label>
              <button type="submit">Add</button>
            </form>
          </section>
          <section>
            <h2>Companies</h2>
            <table>
              <thead>
                <tr><th>Name</th><th>Syncro Company ID</th><th>Xero ID</th><th>VIP</th><th></th></tr>
              </thead>
              <tbody>
                <% allCompanies.forEach(function(c) { %>
                  <tr>
                    <td><%= c.name %></td>
                    <td><input type="text" name="syncroCompanyId" value="<%= c.syncro_company_id || '' %>" form="c<%= c.id %>"></td>
                    <td><input type="text" name="xeroId" value="<%= c.xero_id || '' %>" form="c<%= c.id %>"></td>
                    <td><input type="checkbox" name="isVip" value="1" <%= c.is_vip ? 'checked' : '' %> form="c<%= c.id %>"></td>
                    <td>
                      <form id="c<%= c.id %>" action="/admin/company/<%= c.id %>" method="post">
                        <button type="submit">Save</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </section>
          <% } %>
          <section>
            <h2>Add User</h2>
            <form action="/admin/user" method="post">
              <input type="email" name="email" placeholder="Email" required>
              <input type="password" name="password" placeholder="Password" required>
              <% if (isSuperAdmin) { %>
                <select name="companyId">
                  <% allCompanies.forEach(function(c) { %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                  <% }); %>
                </select>
              <% } else { %>
                <input type="hidden" name="companyId" value="<%= currentCompanyId %>">
              <% } %>
              <button type="submit">Add User</button>
            </form>
          </section>
          <section>
            <h2>Invite User</h2>
            <form action="/admin/invite" method="post">
              <input type="text" name="firstName" placeholder="First Name">
              <input type="text" name="lastName" placeholder="Last Name">
              <input type="email" name="email" placeholder="Email" required>
              <% if (isSuperAdmin) { %>
                <select name="companyId">
                  <% allCompanies.forEach(function(c) { %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                  <% }); %>
                </select>
              <% } else { %>
                <input type="hidden" name="companyId" value="<%= currentCompanyId %>">
              <% } %>
              <button type="submit">Send Invitation</button>
            </form>
          </section>
          <% if (isSuperAdmin) { %>
          <section>
            <h2>Assign Existing User to Company</h2>
            <form action="/admin/assign" method="post">
              <select name="userId">
                <% users.forEach(function(u) { %>
                  <option value="<%= u.id %>"><%= u.email %></option>
                <% }); %>
              </select>
              <select name="companyId">
                <% allCompanies.forEach(function(c) { %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }); %>
              </select>
              <button type="submit">Assign</button>
            </form>
            <table>
              <thead>
                <tr><th>User</th><th>Delete</th></tr>
              </thead>
              <tbody>
                <% users.forEach(function(u){ %>
                  <tr>
                    <td><%= u.email %></td>
                    <td><button class="delete-user-btn" data-user-id="<%= u.id %>">Delete</button></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </section>
          <% } %>
          </div>
          <div id="assignments" class="tab-content">
          <section>
            <h2>Current Assignments</h2>
            <table>
              <thead>
                <tr><th>User</th><th>Company</th><th>Admin</th><th>Licenses</th><th>Order</th><th>Staff</th><th>Assets</th><th>Invoices</th><th>Shop</th><% if (isSuperAdmin) { %><th>Remove</th><% } %></tr>
              </thead>
              <tbody>
              <% assignments.forEach(function(a) { %>
                <tr>
                  <td><%= a.email %></td>
                  <td><%= a.company_name %></td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="isAdmin" value="0">
                      <input type="checkbox" name="isAdmin" value="1" <%= a.is_admin ? 'checked' : '' %> <%= (!isSuperAdmin && a.user_id === currentUserId) ? 'disabled' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageLicenses" value="0">
                      <input type="checkbox" name="canManageLicenses" value="1" <%= a.can_manage_licenses ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canOrderLicenses" value="0">
                      <input type="checkbox" name="canOrderLicenses" value="1" <%= a.can_order_licenses ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageStaff" value="0">
                      <input type="checkbox" name="canManageStaff" value="1" <%= a.can_manage_staff ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageAssets" value="0">
                      <input type="checkbox" name="canManageAssets" value="1" <%= a.can_manage_assets ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageInvoices" value="0">
                      <input type="checkbox" name="canManageInvoices" value="1" <%= a.can_manage_invoices ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canAccessShop" value="0">
                      <input type="checkbox" name="canAccessShop" value="1" <%= a.can_access_shop ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <% if (isSuperAdmin) { %>
                  <td><button class="unassign-btn" data-user-id="<%= a.user_id %>" data-company-id="<%= a.company_id %>">Remove</button></td>
                  <% } %>
                </tr>
              <% }); %>
              </tbody>
            </table>
            <p>The permissions in this table mean:</p>
            <ul>
              <li><strong>Admin</strong>: Manage users and permissions on MyPortal.</li>
              <li><strong>Licenses</strong>: View current license usage and assignments and request licensing changes.</li>
              <li><strong>Order</strong>: Allow ordering of new licenses.</li>
              <li><strong>Staff</strong>: Access staff information and request offboarding.</li>
              <li><strong>Assets</strong>: View company asset information.</li>
              <li><strong>Invoices</strong>: View company invoices.</li>
              <li><strong>Shop</strong>: Order hardware and software from our shop.</li>
            </ul>
            <p><em>Note: Not all functionality is currently available and will be added in future MyPortal releases.</em></p>
          </section>
          </div>
          <% if (isSuperAdmin) { %>
          <div id="schedules" class="tab-content">
            <section>
              <h2>Add Schedule</h2>
              <form action="/admin/schedules" method="post">
                <select name="command">
                  <option value="sync_staff">Sync Staff From Syncro</option>
                  <option value="sync_o365">Sync Office 365 License Counts</option>
                  <option value="sync_xero">Sync Xero Invoices</option>
                  <option value="sync_assets">Sync Assets From Syncro</option>
                  <option value="system_update">MyPortal System Update</option>
                </select>
                <select name="companyId">
                  <option value="">System</option>
                  <% allCompanies.forEach(function(c){ %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                  <% }); %>
                </select>
                <input type="text" name="cron" id="cron-input" placeholder="Cron Expression" required>
                <details id="cron-generator">
                  <summary>Cron Generator</summary>
                  <div id="cron-generator-container">
                  <table class="generator">
                    <tr>
                      <td>
                        <table class="generatorBlock">
                          <tr>
                            <th colspan="2">Minutes</th>
                          </tr>
                          <tr>
                            <td>
                              <label class="radio" for="everyMinute"><input id="everyMinute" type="radio" checked value="*" name="minutes"> Every Minute</label><br>
                              <label class="radio" for="everyEvenMinute"><input id="everyEvenMinute" type="radio" value="*/2" name="minutes"> Even Minutes</label><br>
                              <label class="radio" for="everyOddMinute"><input id="everyOddMinute" type="radio" value="1-59/2" name="minutes"> Odd Minutes</label><br>
                              <label class="radio" for="every5Minute"><input id="every5Minute" type="radio" value="*/5" name="minutes"> Every 5 Minutes</label><br>
                              <label class="radio" for="every15Minute"><input id="every15Minute" type="radio" value="*/15" name="minutes"> Every 15 Minutes</label><br>
                              <label class="radio" for="every30Minute"><input id="every30Minute" type="radio" value="*/30" name="minutes"> Every 30 Minutes</label><br>
                            </td>
                            <td>
                              <table class="multipleEntries">
                                <tr>
                                  <td><input type="radio" value="select" name="minutes"></td>
                                  <td>
                                    <select id="minutes-select" multiple size="10">
                                      <% for (let i = 0; i < 60; i++) { %>
                                        <option value="<%= i %>"><%= i %></option>
                                      <% } %>
                                    </select>
                                  </td>
                                </tr>
                              </table>
                            </td>
                          </tr>
                        </table>
                      </td>
                      <td>
                        <table class="generatorBlock">
                          <tr>
                            <th colspan="2">Hours</th>
                          </tr>
                          <tr>
                            <td>
                              <label class="radio" for="everyHour"><input id="everyHour" type="radio" checked value="*" name="hours"> Every Hour</label>
                              <label class="radio" for="everyEvenHour"><input id="everyEvenHour" type="radio" value="*/2" name="hours"> Even Hours</label>
                              <label class="radio" for="everyOddHour"><input id="everyOddHour" type="radio" value="1-23/2" name="hours"> Odd Hours</label>
                              <label class="radio" for="every6Hours"><input id="every6Hours" type="radio" value="*/6" name="hours"> Every 6 Hours</label>
                              <label class="radio" for="every12Hours"><input id="every12Hours" type="radio" value="*/12" name="hours"> Every 12 Hours</label>
                            </td>
                            <td>
                              <table class="multipleEntries">
                                <tr>
                                  <td><input type="radio" value="select" name="hours"></td>
                                  <td>
                                    <select id="hours-select" multiple size="10">
                                      <% for (let i = 0; i < 24; i++) { %>
                                        <option value="<%= i %>">
                                          <% if (i === 0) { %>Midnight<% } %>
                                          <% if (i > 0 && i < 12) { %><%= i %>am<% } %>
                                          <% if (i === 12) { %>Noon<% } %>
                                          <% if (i > 12) { %><%= i - 12 %>pm<% } %>
                                        </option>
                                      <% } %>
                                    </select>
                                  </td>
                                </tr>
                              </table>
                            </td>
                          </tr>
                        </table>
                      </td>
                      <td>
                        <table class="generatorBlock">
                          <tr>
                            <th colspan="2">Days of Month</th>
                          </tr>
                          <tr>
                            <td>
                              <label class="radio" for="everyday"><input id="everyday" type="radio" checked value="*" name="days"> Every Day</label>
                              <label class="radio" for="everyEvenDay"><input id="everyEvenDay" type="radio" value="2-30/2" name="days"> Even Days</label>
                              <label class="radio" for="everyOddDay"><input id="everyOddDay" type="radio" value="1-31/2" name="days"> Odd Days</label>
                              <label class="radio" for="every5Days"><input id="every5Days" type="radio" value="*/5" name="days"> Every 5 Days</label>
                              <label class="radio" for="every10Days"><input id="every10Days" type="radio" value="*/10" name="days"> Every 10 Days</label>
                              <label class="radio" for="every15Days"><input id="every15Days" type="radio" value="*/15" name="days"> Every Half Month</label>
                            </td>
                            <td>
                              <table class="multipleEntries">
                                <tr>
                                  <td><input type="radio" value="select" name="days"></td>
                                  <td>
                                    <select id="days-select" multiple size="10">
                                      <% for (let i = 1; i <= 31; i++) { %>
                                        <option value="<%= i %>"><%= i %></option>
                                      <% } %>
                                    </select>
                                  </td>
                                </tr>
                              </table>
                            </td>
                          </tr>
                        </table>
                      </td>
                      <td>
                        <table class="generatorBlock">
                          <tr>
                            <th colspan="2">Months</th>
                          </tr>
                          <tr>
                            <td>
                              <label class="radio" for="everyMonth"><input id="everyMonth" type="radio" checked value="*" name="months"> Every Month</label>
                              <label class="radio" for="everyEvenMonths"><input id="everyEvenMonths" type="radio" value="*/2" name="months"> Even Months</label>
                              <label class="radio" for="everyOddMonths"><input id="everyOddMonths" type="radio" value="1-11/2" name="months"> Odd Months</label>
                              <label class="radio" for="every4Months"><input id="every4Months" type="radio" value="*/4" name="months"> Every 4 Months</label>
                              <label class="radio" for="every6Months"><input id="every6Months" type="radio" value="*/6" name="months"> Every Half Year</label>
                            </td>
                            <td>
                              <table class="multipleEntries">
                                <tr>
                                  <td><input type="radio" value="select" name="months"></td>
                                  <td>
                                    <select id="months-select" multiple size="10" class="cron">
                                      <% const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; %>
                                      <% for (let i = 1; i <= 12; i++) { %>
                                        <option value="<%= i %>"><%= monthNames[i-1] %></option>
                                      <% } %>
                                    </select>
                                  </td>
                                </tr>
                              </table>
                            </td>
                          </tr>
                        </table>
                      </td>
                      <td>
                        <table class="generatorBlock">
                          <tr>
                            <th colspan="2">Days of Week</th>
                          </tr>
                          <tr>
                            <td>
                              <label class="radio" for="everyWeekday"><input id="everyWeekday" type="radio" checked value="*" name="weekdays"> Every Day</label>
                              <label class="radio" for="everyNonWeekenDays"><input id="everyNonWeekenDays" type="radio" value="1-5" name="weekdays"> Monday - Friday</label>
                              <label class="radio" for="everyWeekenDays"><input id="everyWeekenDays" type="radio" value="0,6" name="weekdays"> Saturday - Sunday</label>
                            </td>
                            <td>
                              <table class="multipleEntries">
                                <tr>
                                  <td><input type="radio" value="select" name="weekdays"></td>
                                  <td>
                                    <select id="weekdays-select" multiple size="10">
                                      <% const weekdayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; %>
                                      <% for (let i = 0; i <= 6; i++) { %>
                                        <option value="<%= i %>"><%= weekdayNames[i] %></option>
                                      <% } %>
                                    </select>
                                  </td>
                                </tr>
                              </table>
                            </td>
                          </tr>
                        </table>
                      </td>
                    </tr>
                  </table>
                  </div>
                </details>
                <button type="submit">Add</button>
              </form>
            </section>
            <section>
              <h2>Schedules</h2>
              <table>
                <thead>
                  <tr><th>ID</th><th>Company</th><th>Command</th><th>Cron</th><th>Last Run</th><th>Actions</th></tr>
                </thead>
                <tbody>
                  <% tasks.forEach(function(t){ %>
                    <tr>
                      <td><%= t.id %></td>
                      <td><%= t.company_name || '' %></td>
                      <td><%= t.command %></td>
                      <td><%= t.cron %></td>
                      <td><%= t.last_run_at ? new Date(t.last_run_at).toLocaleString() : '' %></td>
                      <td>
                        <form action="/admin/schedules/<%= t.id %>/run" method="post" style="display:inline">
                          <button type="submit">Run Now</button>
                        </form>
                        <form action="/admin/schedules/<%= t.id %>" method="post" style="display:inline">
                          <input type="text" name="cron" value="<%= t.cron %>" required>
                          <button type="submit">Save</button>
                        </form>
                        <form action="/admin/schedules/<%= t.id %>/delete" method="post" style="display:inline" onsubmit="return confirm('Delete?');">
                          <button type="submit">Delete</button>
                        </form>
                      </td>
                    </tr>
                  <% }); %>
                </tbody>
              </table>
            </section>
            <script>
              (function(){
                function getField(name, selectId){
                  const chosen = document.querySelector(`input[name="${name}"]:checked`);
                  if (chosen && chosen.value === 'select') {
                    const sel = document.getElementById(selectId);
                    const vals = Array.from(sel.selectedOptions).map(o => o.value);
                    return vals.length ? vals.join(',') : '*';
                  }
                  return chosen ? chosen.value : '*';
                }
                function updateCron(){
                  const m = getField('minutes','minutes-select');
                  const h = getField('hours','hours-select');
                  const d = getField('days','days-select');
                  const mo = getField('months','months-select');
                  const w = getField('weekdays','weekdays-select');
                  document.getElementById('cron-input').value = `${m} ${h} ${d} ${mo} ${w}`;
                }
                document.querySelectorAll('#cron-generator-container input, #cron-generator-container select').forEach(function(el){
                  el.addEventListener('change', updateCron);
                });
                updateCron();
              })();
            </script>
          </div>
          <% } %>
        <% } %>
        <div id="account" class="tab-content<% if (!isSuperAdmin) { %> active<% } %>">
          <section>
            <h2>Profile</h2>
            <% if (nameError) { %><p class="error"><%= nameError %></p><% } %>
            <% if (nameSuccess) { %><p class="success"><%= nameSuccess %></p><% } %>
            <form method="post" action="/change-name">
              <label>First Name:
                <input type="text" name="firstName" value="<%= currentUserFirstName %>" required>
              </label>
              <label>Last Name:
                <input type="text" name="lastName" value="<%= currentUserLastName %>" required>
              </label>
              <button type="submit">Update Name</button>
            </form>
          </section>
          <section>
            <h2>SMS Alerts</h2>
            <% if (mobileError) { %><p class="error"><%= mobileError %></p><% } %>
            <% if (mobileSuccess) { %><p class="success"><%= mobileSuccess %></p><% } %>
            <form method="post" action="/change-mobile">
              <label>Mobile Phone:
                <input type="tel" name="mobilePhone" value="<%= currentUserMobilePhone %>">
              </label>
              <button type="submit">Update Mobile</button>
            </form>
          </section>
          <section>
            <h2>Change Password</h2>
            <% if (passwordError) { %><p class="error"><%= passwordError %></p><% } %>
            <% if (passwordSuccess) { %><p class="success"><%= passwordSuccess %></p><% } %>
            <form method="post" action="/change-password">
              <label>Current Password:
                <input type="password" name="currentPassword" required>
              </label>
              <label>New Password:
                <input type="password" name="newPassword" required>
              </label>
              <button type="submit">Update Password</button>
            </form>
          </section>
          <section>
            <h2>TOTP Authenticators</h2>
            <ul>
              <% totpAuthenticators.forEach(function(t){ %>
                <li>
                  <%= t.name %>
                  <form method="post" action="/admin/totp/<%= t.id %>/delete" style="display:inline">
                    <button type="submit">Remove</button>
                  </form>
                </li>
              <% }); %>
            </ul>
            <% if (newTotpQr) { %>
              <p>Scan this QR code or enter the code manually.</p>
              <img src="<%= newTotpQr %>" alt="QR Code">
              <p>Manual code: <code><%= newTotpSecret %></code></p>
              <% if (totpError) { %><p class="error"><%= totpError %></p><% } %>
              <form method="post" action="/admin/totp/verify">
                <label>Authentication Code:
                  <input type="text" name="token" required>
                </label>
                <button type="submit">Verify</button>
              </form>
              <form method="post" action="/admin/totp/cancel"><button type="submit">Cancel</button></form>
            <% } else { %>
              <form method="post" action="/admin/totp/start">
                <input type="text" name="name" placeholder="Authenticator Name" required>
                <button type="submit">Add Authenticator</button>
              </form>
            <% } %>
          </section>
        </div>
        <% if (isSuperAdmin) { %>
        <div id="site-settings" class="tab-content active">
          <section>
            <h2>Site Settings</h2>
            <form action="/admin/site-settings" method="post" enctype="multipart/form-data">
              <label>Company Name:
                <input type="text" name="companyName" value="<%= siteSettings?.company_name || '' %>">
              </label>
              <div>
                <label>Login/Verify Logo:
                  <input type="file" name="loginLogo" accept="image/*">
                </label>
                <% if (siteSettings && siteSettings.login_logo) { %>
                  <img src="<%= siteSettings.login_logo %>" alt="Login Logo" style="max-width:200px;display:block;margin-top:10px;"/>
                <% } %>
              </div>
              <div>
                <label>Sidebar Logo:
                  <input type="file" name="sidebarLogo" accept="image/*">
                </label>
                <% if (siteSettings && siteSettings.sidebar_logo) { %>
                  <img src="<%= siteSettings.sidebar_logo %>" alt="Sidebar Logo" style="max-width:200px;display:block;margin-top:10px;"/>
                <% } %>
              </div>
              <button type="submit">Save</button>
            </form>
          </section>
        </div>
        <div id="apps" class="tab-content">
          <section>
            <h2>Add App</h2>
            <form action="/apps" method="post">
              <input type="text" name="sku" placeholder="SKU" required>
              <input type="text" name="name" placeholder="Name" required>
              <input type="number" step="0.01" name="price" placeholder="Default Price" required>
              <input type="text" name="contractTerm" placeholder="Contract Term" required>
              <button type="submit">Add App</button>
            </form>
          </section>
          <section>
            <h2>Apps</h2>
            <table>
              <thead>
                <tr><th>SKU</th><th>Name</th><th>Default Price</th><th>Contract Term</th><th>Actions</th></tr>
              </thead>
              <tbody>
              <% apps.forEach(function(a){ %>
                <tr>
                  <td><%= a.sku %></td>
                  <td><%= a.name %></td>
                  <td><%= a.default_price %></td>
                  <td><%= a.contract_term %></td>
                  <td><button class="add-sku-default" data-app-id="<%= a.id %>" data-app-name="<%= a.name %>">Add to Company</button></td>
                </tr>
              <% }); %>
              </tbody>
            </table>
          </section>
          <section>
            <h2>Company Pricing</h2>
            <form action="/apps/price" method="post">
              <select name="appId">
                <% apps.forEach(function(a){ %>
                  <option value="<%= a.id %>"><%= a.name %></option>
                <% }); %>
              </select>
              <select name="companyId">
                <% allCompanies.forEach(function(c){ %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }); %>
              </select>
              <input type="number" step="0.01" name="price" placeholder="Price" required>
              <button type="submit">Set Price</button>
            </form>
            <h3>Existing Company Prices</h3>
            <table>
              <thead>
                <tr><th>Company</th><th>SKU</th><th>App</th><th>Price</th><th>Actions</th></tr>
              </thead>
              <tbody>
              <% companyPrices.forEach(function(p){ %>
                <tr>
                  <td><%= p.company_name %></td>
                  <td><%= p.sku %></td>
                  <td><%= p.app_name %></td>
                  <td><%= p.price %></td>
                  <td><button class="add-sku-company" data-app-id="<%= p.app_id %>" data-company-id="<%= p.company_id %>" data-company-name="<%= p.company_name %>">Add to Company</button></td>
                </tr>
              <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <div id="api-keys" class="tab-content">
          <section>
            <h2>API Keys</h2>
            <form action="/admin/api-key" method="post">
              <input type="text" name="description" placeholder="Description">
              <input type="date" name="expiryDate">
              <button type="submit">Add API Key</button>
            </form>
            <table>
              <thead>
                <tr>
                  <th>Key</th><th>Description</th><th>Expiry</th><th>Usage</th><th>Last Used</th><th>IPs</th><th></th>
                </tr>
              </thead>
              <tbody>
              <% apiKeys.forEach(function(k) { %>
                <tr>
                  <td><a href="#" class="show-key" data-full="<%= k.api_key %>"><%= k.api_key.slice(0,3) %>...<%= k.api_key.slice(-3) %></a></td>
                  <td><%= k.description %></td>
                  <td><%= k.expiry_date || '' %></td>
                  <td><%= k.usage_count %></td>
                  <td class="last-used" data-last="<%= k.last_used_at ? (k.last_used_at.toISOString ? k.last_used_at.toISOString() : k.last_used_at) : '' %>"></td>
                  <td><a href="#" class="show-ips" data-ips='<%- JSON.stringify(k.ips) %>'>View</a></td>
                  <td>
                    <form action="/admin/api-key/delete" method="post">
                      <input type="hidden" name="id" value="<%= k.id %>">
                      <button type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }); %>
              </tbody>
            </table>
            <div id="ip-modal" class="modal" style="display:none;">
              <div class="modal-content">
                <button id="ip-modal-close">Close</button>
                <ul id="ip-list"></ul>
              </div>
            </div>
            <div id="key-modal" class="modal" style="display:none;">
              <div class="modal-content">
                <button id="key-modal-close">Close</button>
                <pre id="full-key"></pre>
              </div>
            </div>
          </section>
        </div>
        <div id="forms-admin" class="tab-content">
          <section>
            <h2>Add Form</h2>
            <form action="/forms/admin" method="post">
              <input type="text" name="name" placeholder="Name" required>
              <input type="url" name="url" placeholder="URL" required>
              <input type="text" name="description" placeholder="Description">
              <button type="submit">Add</button>
            </form>
          </section>
          <section>
            <h2>Edit Forms</h2>
            <table>
              <thead>
                <tr><th>Name</th><th>URL</th><th>Description</th><th>Actions</th></tr>
              </thead>
              <tbody>
                <% forms.forEach(function(f){ %>
                  <tr>
                    <td><input form="form-<%= f.id %>" type="text" name="name" value="<%= f.name %>" required></td>
                    <td><input form="form-<%= f.id %>" type="url" name="url" value="<%= f.url %>" required></td>
                    <td><input form="form-<%= f.id %>" type="text" name="description" value="<%= f.description %>"></td>
                    <td>
                      <form id="form-<%= f.id %>" action="/forms/admin/edit" method="post">
                        <input type="hidden" name="id" value="<%= f.id %>">
                        <button type="submit">Save</button>
                      </form>
                      <form action="/forms/admin/delete" method="post">
                        <input type="hidden" name="id" value="<%= f.id %>">
                        <button type="submit">Delete</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <div id="form-permissions" class="tab-content">
          <section>
            <h2>Manage Permissions</h2>
            <form action="/forms/admin" method="get">
              <select name="formId" onchange="this.form.submit()">
                <option value="">Select Form</option>
                <% forms.forEach(function(f){ %>
                  <option value="<%= f.id %>" <%= selectedFormId === f.id ? 'selected' : '' %>><%= f.name %></option>
                <% }); %>
              </select>
              <select name="companyId" onchange="this.form.submit()">
                <option value="">Select Company</option>
                <% allCompanies.forEach(function(c){ %>
                  <option value="<%= c.id %>" <%= selectedCompanyId === c.id ? 'selected' : '' %>><%= c.name %></option>
                <% }); %>
              </select>
            </form>
            <% if (selectedFormId && selectedCompanyId) { %>
              <form action="/forms/admin/permissions" method="post">
                <input type="hidden" name="formId" value="<%= selectedFormId %>">
                <input type="hidden" name="companyId" value="<%= selectedCompanyId %>">
                <% formUsers.forEach(function(u){ %>
                  <label><input type="checkbox" name="userIds" value="<%= u.user_id %>" <%= permissions.includes(u.user_id) ? 'checked' : '' %>> <%= u.email %></label><br>
                <% }); %>
                <button type="submit">Save</button>
              </form>
            <% } %>
          </section>
          <section>
            <h2>User Form Access</h2>
            <table>
              <thead>
                <tr><th>User</th><th>Company</th><th>Form</th><th>Actions</th></tr>
              </thead>
              <tbody>
                <% formAccess.forEach(function(p){ %>
                  <tr>
                    <td><%= p.email %></td>
                    <td><%= p.company_name %></td>
                    <td><%= p.form_name %></td>
                    <td>
                      <form action="/forms/admin/permissions/delete" method="post">
                        <input type="hidden" name="formId" value="<%= p.form_id %>">
                        <input type="hidden" name="userId" value="<%= p.user_id %>">
                        <input type="hidden" name="companyId" value="<%= p.company_id %>">
                        <button type="submit">Remove</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <div id="shop-settings" class="tab-content">
          <section>
            <h2>Categories</h2>
            <form action="/shop/admin/category" method="post">
              <input type="text" name="name" placeholder="Name" required>
              <button type="submit">Add</button>
            </form>
            <ul>
              <% categories.forEach(function(c){ %>
                <li>
                  <%= c.name %>
                  <form action="/shop/admin/category/<%= c.id %>/delete" method="post" style="display:inline" onsubmit="return confirm('Delete category?');">
                    <button type="submit">Delete</button>
                  </form>
                </li>
              <% }) %>
            </ul>
          </section>
        </div>
        <div id="products" class="tab-content">
          <section>
            <h2>Add Product</h2>
            <form action="/shop/admin/product" method="post" enctype="multipart/form-data">
              <input type="text" name="name" placeholder="Name" required>
              <input type="text" name="sku" placeholder="SKU" required>
              <input type="text" name="vendor_sku" placeholder="Vendor SKU" required>
              <textarea name="description" placeholder="Description"></textarea>
              <input type="number" step="0.01" name="price" placeholder="Price" required>
              <input type="number" step="0.01" name="vip_price" placeholder="VIP Price">
              <input type="number" name="stock" placeholder="Stock" required>
              <select name="category_id">
                <option value="">No Category</option>
                <% categories.forEach(function(c){ %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
              </select>
              <input type="file" name="image">
              <button type="submit">Add</button>
            </form>
          </section>
          <section>
            <h2>Products</h2>
            <input type="text" id="search" placeholder="Search products">
            <select id="stockFilter">
              <option value="">All</option>
              <option value="in">In Stock</option>
              <option value="out">Out of Stock</option>
            </select>
            <label><input type="checkbox" id="showArchived" <%= showArchived ? 'checked' : '' %>> Show Archived</label>
            <table id="productsTable">
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Name</th>
                  <th>SKU</th>
                  <th>Vendor SKU</th>
                  <th>Price</th>
                  <th>VIP Price</th>
                  <th>Category</th>
                  <th>Stock</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% products.forEach(function(p){ %>
                  <tr
                    data-name="<%= p.name.toLowerCase() %>"
                    data-sku="<%= p.sku.toLowerCase() %>"
                    data-vendor="<%= p.vendor_sku.toLowerCase() %>"
                    data-stock="<%= p.stock %>"
                  >
                    <td><% if (p.image_url) { %><img src="<%= p.image_url %>" width="50" alt=""><% } %></td>
                    <td><%= p.name %></td>
                    <td><%= p.sku %></td>
                    <td><%= p.vendor_sku %></td>
                    <td><%= p.price %></td>
                    <td><%= p.vip_price !== null ? p.vip_price : '' %></td>
                    <td><%= p.category_name || '' %></td>
                    <td><%= p.stock %></td>
                    <td>
                      <button type="button" onclick="openEditModal(<%= p.id %>)">Edit</button>
                      <form action="/shop/admin/product/<%= p.id %>/<%= p.archived ? 'unarchive' : 'archive' %>" method="post" style="display:inline-block">
                        <button type="submit"><%= p.archived ? 'Unarchive' : 'Archive' %></button>
                      </form>
                      <form action="/shop/admin/product/<%= p.id %>/delete" method="post" style="display:inline-block" onsubmit="return confirm('Are you sure you want to delete this product?');">
                        <button type="submit">Delete</button>
                      </form>
                      <button type="button" onclick="openVisibilityModal(<%= p.id %>)">Visibility</button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
            <script>
              const searchInput = document.getElementById('search');
              const stockFilter = document.getElementById('stockFilter');
              const showArchivedCheckbox = document.getElementById('showArchived');
              const rows = document.querySelectorAll('#productsTable tbody tr');
              function filterRows() {
                const query = searchInput.value.toLowerCase();
                const stock = stockFilter.value;
                rows.forEach(row => {
                  const name = row.dataset.name;
                  const sku = row.dataset.sku;
                  const vendor = row.dataset.vendor;
                  const rowStock = parseInt(row.dataset.stock, 10);
                  const matchesSearch = !query || name.includes(query) || sku.includes(query) || vendor.includes(query);
                  const matchesStock = !stock || (stock === 'in' && rowStock > 0) || (stock === 'out' && rowStock === 0);
                  row.style.display = matchesSearch && matchesStock ? '' : 'none';
                });
              }
              searchInput.addEventListener('input', filterRows);
              stockFilter.addEventListener('change', filterRows);
              showArchivedCheckbox.addEventListener('change', () => {
                const url = new URL(window.location.href);
                if (showArchivedCheckbox.checked) {
                  url.searchParams.set('showArchived', '1');
                } else {
                  url.searchParams.delete('showArchived');
                }
                window.location.href = url.toString();
              });
              const productRestrictions = <%- JSON.stringify(productRestrictions) %>;
              const productsData = <%- JSON.stringify(products) %>;
              function openEditModal(id) {
                const product = productsData.find(p => p.id === id);
                const modal = document.getElementById('editModal');
                const form = document.getElementById('editForm');
                form.action = `/shop/admin/product/${id}`;
                form.name.value = product.name;
                form.sku.value = product.sku;
                form.vendor_sku.value = product.vendor_sku;
                form.description.value = product.description || '';
                form.price.value = product.price;
                form.vip_price.value = product.vip_price !== null ? product.vip_price : '';
                form.stock.value = product.stock;
                form.category_id.value = product.category_id || '';
                const img = document.getElementById('editImagePreview');
                if (product.image_url) {
                  img.src = product.image_url;
                  img.style.display = 'block';
                } else {
                  img.style.display = 'none';
                }
                modal.style.display = 'flex';
              }
              function closeEditModal() {
                document.getElementById('editModal').style.display = 'none';
              }
              function openVisibilityModal(id) {
                const modal = document.getElementById('visibilityModal');
                const form = document.getElementById('visibilityForm');
                form.action = `/shop/admin/product/${id}/visibility`;
                const selected = (productRestrictions[id] || []).map(r => r.company_id);
                form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                  cb.checked = selected.includes(parseInt(cb.value, 10));
                });
                modal.style.display = 'flex';
              }
              function closeVisibilityModal() {
                document.getElementById('visibilityModal').style.display = 'none';
              }
            </script>
            <div id="editModal" class="modal" style="display:none;">
              <div class="modal-content" style="width:300px;">
                <h3>Edit Product</h3>
                <form id="editForm" method="post" enctype="multipart/form-data">
                  <label for="edit-name">Name
                    <input type="text" id="edit-name" name="name" required>
                  </label>
                  <label for="edit-sku">SKU
                    <input type="text" id="edit-sku" name="sku" required>
                  </label>
                  <label for="edit-vendor-sku">Vendor SKU
                    <input type="text" id="edit-vendor-sku" name="vendor_sku" required>
                  </label>
                  <label for="edit-description">Description
                    <textarea id="edit-description" name="description"></textarea>
                  </label>
                  <label for="edit-price">Price
                    <input type="number" step="0.01" id="edit-price" name="price" required>
                  </label>
                  <label for="edit-vip-price">VIP Price
                    <input type="number" step="0.01" id="edit-vip-price" name="vip_price">
                  </label>
                  <label for="edit-stock">Stock
                    <input type="number" id="edit-stock" name="stock" required>
                  </label>
                  <label for="edit-category">Category
                    <select id="edit-category" name="category_id">
                      <option value="">No Category</option>
                      <% categories.forEach(function(c){ %>
                        <option value="<%= c.id %>"><%= c.name %></option>
                      <% }) %>
                    </select>
                  </label>
                  <label for="edit-image">Image
                    <input type="file" id="edit-image" name="image">
                  </label>
                  <img id="editImagePreview" src="" width="100" alt="" style="display:none;">
                  <button type="submit">Save</button>
                  <button type="button" onclick="closeEditModal()">Close</button>
                </form>
              </div>
            </div>
            <div id="visibilityModal" class="modal" style="display:none;">
              <div class="modal-content" style="width:300px;">
                <h3>Product Visibility</h3>
                <form id="visibilityForm" method="post">
                  <% allCompanies.forEach(function(c){ %>
                    <label><input type="checkbox" name="excluded" value="<%= c.id %>"> <%= c.name %></label><br>
                  <% }) %>
                  <button type="submit">Save</button>
                  <button type="button" onclick="closeVisibilityModal()">Close</button>
                </form>
              </div>
            </div>
          </section>
        </div>
        <% } %>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tabs = document.querySelectorAll('.tabs button');
      const contents = document.querySelectorAll('.tab-content');
      const ACTIVE_TAB_KEY = 'admin-active-tab';

      function activate(tabName) {
        tabs.forEach((t) => t.classList.toggle('active', t.dataset.tab === tabName));
        contents.forEach((c) => c.classList.toggle('active', c.id === tabName));
        localStorage.setItem(ACTIVE_TAB_KEY, tabName);
      }

      tabs.forEach(function (tab) {
        tab.addEventListener('click', function () {
          activate(tab.dataset.tab);
        });
      });

      let initialTab = window.location.hash
        ? window.location.hash.substring(1)
        : localStorage.getItem(ACTIVE_TAB_KEY) || '<%= isSuperAdmin ? "site-settings" : "account" %>';
      <% if (isSuperAdmin && selectedFormId && selectedCompanyId) { %>
      initialTab = 'form-permissions';
      <% } %>
      if (!document.querySelector(`.tabs button[data-tab="${initialTab}"]`)) {
        initialTab = tabs[0].dataset.tab;
      }
      activate(initialTab);
      const allCompanies = <%- JSON.stringify(allCompanies) %>;
      document.querySelectorAll('.add-sku-default').forEach(function(btn){
        btn.addEventListener('click', async function(){
          const appId = this.dataset.appId;
          const appName = this.dataset.appName;
          const list = allCompanies.map(c => `${c.id}: ${c.name}`).join('\n');
          const companyId = prompt(`Select company for ${appName}:\n${list}`);
          if(!companyId) return;
          const qty = prompt('Number of licenses purchased?');
          if(!qty) return;
          await fetch(`/apps/${appId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ companyId: parseInt(companyId,10), quantity: parseInt(qty,10) })
          });
          alert('App added to company');
        });
      });
      document.querySelectorAll('.add-sku-company').forEach(function(btn){
        btn.addEventListener('click', async function(){
          const appId = this.dataset.appId;
          const companyId = this.dataset.companyId;
          const companyName = this.dataset.companyName;
          const qty = prompt(`Number of licenses for ${companyName}?`);
          if(!qty) return;
          await fetch(`/apps/${appId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ companyId: parseInt(companyId,10), quantity: parseInt(qty,10) })
          });
          alert('App added to company');
        });
      });

      document.querySelectorAll('.unassign-btn').forEach(function(btn){
        btn.addEventListener('click', async function(){
          if(!confirm('Remove assignment?')) return;
          await fetch(`/admin/assign/${this.dataset.companyId}/${this.dataset.userId}`, { method: 'DELETE' });
          location.reload();
        });
      });
      document.querySelectorAll('.delete-user-btn').forEach(function(btn){
        btn.addEventListener('click', async function(){
          if(!confirm('Delete user?')) return;
          await fetch(`/admin/user/${this.dataset.userId}`, { method: 'DELETE' });
          location.reload();
        });
      });
      document.querySelectorAll('.show-ips').forEach(function(link){
        link.addEventListener('click', function(e){
          e.preventDefault();
          const ips = JSON.parse(this.dataset.ips || '[]');
          const list = document.getElementById('ip-list');
          list.innerHTML = '';
          ips.forEach(function(ip){
            const li = document.createElement('li');
            li.textContent = ip.ip_address + ' (' + ip.usage_count + ')';
            list.appendChild(li);
          });
          document.getElementById('ip-modal').style.display = 'flex';
        });
      });
      document.getElementById('ip-modal-close')?.addEventListener('click', function(){
        document.getElementById('ip-modal').style.display = 'none';
      });
      document.querySelectorAll('.show-key').forEach(function(link){
        link.addEventListener('click', function(e){
          e.preventDefault();
          document.getElementById('full-key').textContent = this.dataset.full || '';
          document.getElementById('key-modal').style.display = 'flex';
        });
      });
      document.getElementById('key-modal-close')?.addEventListener('click', function(){
        document.getElementById('key-modal').style.display = 'none';
      });
      document.querySelectorAll('td.last-used').forEach(function(td){
        const val = td.dataset.last;
        if(val){
          const d = new Date(val);
          td.textContent = d.toLocaleString();
        }
      });
    });
  </script>
</body>
</html>
