<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Admin' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Admin</h1>
      <div class="admin-tabs">
        <div class="tabs">
          <button data-tab="companies" class="active">Companies</button>
          <button data-tab="assignments">Current Assignments</button>
          <button data-tab="account">Account</button>
          <% if (isSuperAdmin) { %>
            <button data-tab="apps">Apps</button>
            <button data-tab="api-keys">API Keys</button>
            <button data-tab="forms-admin">Forms</button>
            <button data-tab="form-permissions">Form Permissions</button>
            <button data-tab="shop-settings">Shop Settings</button>
            <button data-tab="products">Products</button>
          <% } %>
        </div>
        <div id="companies" class="tab-content active">
          <% if (isSuperAdmin) { %>
          <section>
            <h2>Add Company</h2>
            <form action="/admin/company" method="post">
              <input type="text" name="name" placeholder="Company Name" required>
              <input type="text" name="syncroCompanyId" placeholder="Syncro Company ID">
              <input type="text" name="xeroId" placeholder="Xero ID">
              <label><input type="checkbox" name="isVip" value="1"> VIP</label>
              <button type="submit">Add</button>
            </form>
          </section>
          <section>
            <h2>Companies</h2>
            <table>
              <thead>
                <tr><th>Name</th><th>Syncro Company ID</th><th>Xero ID</th><th>VIP</th><th></th></tr>
              </thead>
              <tbody>
                <% allCompanies.forEach(function(c) { %>
                  <tr>
                    <td><%= c.name %></td>
                    <td><input type="text" name="syncroCompanyId" value="<%= c.syncro_company_id || '' %>" form="c<%= c.id %>"></td>
                    <td><input type="text" name="xeroId" value="<%= c.xero_id || '' %>" form="c<%= c.id %>"></td>
                    <td><input type="checkbox" name="isVip" value="1" <%= c.is_vip ? 'checked' : '' %> form="c<%= c.id %>"></td>
                    <td>
                      <form id="c<%= c.id %>" action="/admin/company/<%= c.id %>" method="post">
                        <button type="submit">Save</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </section>
          <% } %>
          <section>
            <h2>Add User</h2>
            <form action="/admin/user" method="post">
              <input type="email" name="email" placeholder="Email" required>
              <input type="password" name="password" placeholder="Password" required>
              <% if (isSuperAdmin) { %>
                <select name="companyId">
                  <% allCompanies.forEach(function(c) { %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                  <% }); %>
                </select>
              <% } else { %>
                <input type="hidden" name="companyId" value="<%= currentCompanyId %>">
              <% } %>
              <button type="submit">Add User</button>
            </form>
          </section>
          <% if (isSuperAdmin) { %>
          <section>
            <h2>Assign Existing User to Company</h2>
            <form action="/admin/assign" method="post">
              <select name="userId">
                <% users.forEach(function(u) { %>
                  <option value="<%= u.id %>"><%= u.email %></option>
                <% }); %>
              </select>
              <select name="companyId">
                <% allCompanies.forEach(function(c) { %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }); %>
              </select>
              <button type="submit">Assign</button>
            </form>
          </section>
          <% } %>
        </div>
        <div id="assignments" class="tab-content">
          <section>
            <h2>Current Assignments</h2>
            <table>
              <thead>
                <tr><th>User</th><th>Company</th><th>Admin</th><th>Licenses</th><th>Order</th><th>Staff</th><th>Assets</th><th>Invoices</th><th>Shop</th><% if (isSuperAdmin) { %><th>Remove</th><% } %></tr>
              </thead>
              <tbody>
              <% assignments.forEach(function(a) { %>
                <tr>
                  <td><%= a.email %></td>
                  <td><%= a.company_name %></td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="isAdmin" value="0">
                      <input type="checkbox" name="isAdmin" value="1" <%= a.is_admin ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageLicenses" value="0">
                      <input type="checkbox" name="canManageLicenses" value="1" <%= a.can_manage_licenses ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canOrderLicenses" value="0">
                      <input type="checkbox" name="canOrderLicenses" value="1" <%= a.can_order_licenses ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageStaff" value="0">
                      <input type="checkbox" name="canManageStaff" value="1" <%= a.can_manage_staff ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageAssets" value="0">
                      <input type="checkbox" name="canManageAssets" value="1" <%= a.can_manage_assets ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageInvoices" value="0">
                      <input type="checkbox" name="canManageInvoices" value="1" <%= a.can_manage_invoices ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canAccessShop" value="0">
                      <input type="checkbox" name="canAccessShop" value="1" <%= a.can_access_shop ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <% if (isSuperAdmin) { %>
                  <td><button class="unassign-btn" data-user-id="<%= a.user_id %>" data-company-id="<%= a.company_id %>">Remove</button></td>
                  <% } %>
                </tr>
              <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <div id="account" class="tab-content">
          <section>
            <h2>Change Password</h2>
            <% if (passwordError) { %><p class="error"><%= passwordError %></p><% } %>
            <% if (passwordSuccess) { %><p class="success"><%= passwordSuccess %></p><% } %>
            <form method="post" action="/change-password">
              <label>Current Password:
                <input type="password" name="currentPassword" required>
              </label>
              <label>New Password:
                <input type="password" name="newPassword" required>
              </label>
              <button type="submit">Update Password</button>
            </form>
          </section>
          <section>
            <h2>TOTP Authenticators</h2>
            <ul>
              <% totpAuthenticators.forEach(function(t){ %>
                <li>
                  <%= t.name %>
                  <form method="post" action="/admin/totp/<%= t.id %>/delete" style="display:inline">
                    <button type="submit">Remove</button>
                  </form>
                </li>
              <% }); %>
            </ul>
            <% if (newTotpQr) { %>
              <p>Scan this QR code or enter the code manually.</p>
              <img src="<%= newTotpQr %>" alt="QR Code">
              <p>Manual code: <code><%= newTotpSecret %></code></p>
              <% if (totpError) { %><p class="error"><%= totpError %></p><% } %>
              <form method="post" action="/admin/totp/verify">
                <label>Authentication Code:
                  <input type="text" name="token" required>
                </label>
                <button type="submit">Verify</button>
              </form>
              <form method="post" action="/admin/totp/cancel"><button type="submit">Cancel</button></form>
            <% } else { %>
              <form method="post" action="/admin/totp/start">
                <input type="text" name="name" placeholder="Authenticator Name" required>
                <button type="submit">Add Authenticator</button>
              </form>
            <% } %>
          </section>
        </div>
        <% if (isSuperAdmin) { %>
        <div id="apps" class="tab-content">
          <section>
            <h2>Add App</h2>
            <form action="/apps" method="post">
              <input type="text" name="sku" placeholder="SKU" required>
              <input type="text" name="name" placeholder="Name" required>
              <input type="number" step="0.01" name="price" placeholder="Default Price" required>
              <input type="text" name="contractTerm" placeholder="Contract Term" required>
              <button type="submit">Add App</button>
            </form>
          </section>
          <section>
            <h2>Apps</h2>
            <table>
              <thead>
                <tr><th>SKU</th><th>Name</th><th>Default Price</th><th>Contract Term</th><th>Actions</th></tr>
              </thead>
              <tbody>
              <% apps.forEach(function(a){ %>
                <tr>
                  <td><%= a.sku %></td>
                  <td><%= a.name %></td>
                  <td><%= a.default_price %></td>
                  <td><%= a.contract_term %></td>
                  <td><button class="add-sku-default" data-app-id="<%= a.id %>" data-app-name="<%= a.name %>">Add to Company</button></td>
                </tr>
              <% }); %>
              </tbody>
            </table>
          </section>
          <section>
            <h2>Company Pricing</h2>
            <form action="/apps/price" method="post">
              <select name="appId">
                <% apps.forEach(function(a){ %>
                  <option value="<%= a.id %>"><%= a.name %></option>
                <% }); %>
              </select>
              <select name="companyId">
                <% allCompanies.forEach(function(c){ %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }); %>
              </select>
              <input type="number" step="0.01" name="price" placeholder="Price" required>
              <button type="submit">Set Price</button>
            </form>
            <h3>Existing Company Prices</h3>
            <table>
              <thead>
                <tr><th>Company</th><th>SKU</th><th>App</th><th>Price</th><th>Actions</th></tr>
              </thead>
              <tbody>
              <% companyPrices.forEach(function(p){ %>
                <tr>
                  <td><%= p.company_name %></td>
                  <td><%= p.sku %></td>
                  <td><%= p.app_name %></td>
                  <td><%= p.price %></td>
                  <td><button class="add-sku-company" data-app-id="<%= p.app_id %>" data-company-id="<%= p.company_id %>" data-company-name="<%= p.company_name %>">Add to Company</button></td>
                </tr>
              <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <div id="api-keys" class="tab-content">
          <section>
            <h2>API Keys</h2>
            <form action="/admin/api-key" method="post">
              <input type="text" name="description" placeholder="Description">
              <input type="date" name="expiryDate">
              <button type="submit">Add API Key</button>
            </form>
            <table>
              <thead>
                <tr>
                  <th>Key</th><th>Description</th><th>Expiry</th><th>Usage</th><th>Last Used</th><th>IPs</th><th></th>
                </tr>
              </thead>
              <tbody>
              <% apiKeys.forEach(function(k) { %>
                <tr>
                  <td><%= k.api_key %></td>
                  <td><%= k.description %></td>
                  <td><%= k.expiry_date || '' %></td>
                  <td><%= k.usage_count %></td>
                  <td><%= k.last_used_at || '' %></td>
                  <td><a href="#" class="show-ips" data-ips='<%- JSON.stringify(k.ips) %>'>View</a></td>
                  <td>
                    <form action="/admin/api-key/delete" method="post">
                      <input type="hidden" name="id" value="<%= k.id %>">
                      <button type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }); %>
              </tbody>
            </table>
            <div id="ip-modal" class="modal" style="display:none;">
              <div class="modal-content">
                <button id="ip-modal-close">Close</button>
                <ul id="ip-list"></ul>
              </div>
            </div>
          </section>
        </div>
        <div id="forms-admin" class="tab-content">
          <section>
            <h2>Add Form</h2>
            <form action="/forms/admin" method="post">
              <input type="text" name="name" placeholder="Name" required>
              <input type="url" name="url" placeholder="URL" required>
              <input type="text" name="description" placeholder="Description">
              <button type="submit">Add</button>
            </form>
          </section>
          <section>
            <h2>Edit Forms</h2>
            <table>
              <thead>
                <tr><th>Name</th><th>URL</th><th>Description</th><th>Actions</th></tr>
              </thead>
              <tbody>
                <% forms.forEach(function(f){ %>
                  <tr>
                    <td><input form="form-<%= f.id %>" type="text" name="name" value="<%= f.name %>" required></td>
                    <td><input form="form-<%= f.id %>" type="url" name="url" value="<%= f.url %>" required></td>
                    <td><input form="form-<%= f.id %>" type="text" name="description" value="<%= f.description %>"></td>
                    <td>
                      <form id="form-<%= f.id %>" action="/forms/admin/edit" method="post">
                        <input type="hidden" name="id" value="<%= f.id %>">
                        <button type="submit">Save</button>
                      </form>
                      <form action="/forms/admin/delete" method="post">
                        <input type="hidden" name="id" value="<%= f.id %>">
                        <button type="submit">Delete</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <div id="form-permissions" class="tab-content">
          <section>
            <h2>Manage Permissions</h2>
            <form action="/forms/admin" method="get">
              <select name="formId" onchange="this.form.submit()">
                <option value="">Select Form</option>
                <% forms.forEach(function(f){ %>
                  <option value="<%= f.id %>" <%= selectedFormId === f.id ? 'selected' : '' %>><%= f.name %></option>
                <% }); %>
              </select>
              <select name="companyId" onchange="this.form.submit()">
                <option value="">Select Company</option>
                <% allCompanies.forEach(function(c){ %>
                  <option value="<%= c.id %>" <%= selectedCompanyId === c.id ? 'selected' : '' %>><%= c.name %></option>
                <% }); %>
              </select>
            </form>
            <% if (selectedFormId && selectedCompanyId) { %>
              <form action="/forms/admin/permissions" method="post">
                <input type="hidden" name="formId" value="<%= selectedFormId %>">
                <input type="hidden" name="companyId" value="<%= selectedCompanyId %>">
                <% formUsers.forEach(function(u){ %>
                  <label><input type="checkbox" name="userIds" value="<%= u.user_id %>" <%= permissions.includes(u.user_id) ? 'checked' : '' %>> <%= u.email %></label><br>
                <% }); %>
                <button type="submit">Save</button>
              </form>
            <% } %>
          </section>
          <section>
            <h2>User Form Access</h2>
            <table>
              <thead>
                <tr><th>User</th><th>Company</th><th>Form</th><th>Actions</th></tr>
              </thead>
              <tbody>
                <% formAccess.forEach(function(p){ %>
                  <tr>
                    <td><%= p.email %></td>
                    <td><%= p.company_name %></td>
                    <td><%= p.form_name %></td>
                    <td>
                      <form action="/forms/admin/permissions/delete" method="post">
                        <input type="hidden" name="formId" value="<%= p.form_id %>">
                        <input type="hidden" name="userId" value="<%= p.user_id %>">
                        <input type="hidden" name="companyId" value="<%= p.company_id %>">
                        <button type="submit">Remove</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <div id="shop-settings" class="tab-content">
          <section>
            <h2>Categories</h2>
            <form action="/shop/admin/category" method="post">
              <input type="text" name="name" placeholder="Name" required>
              <button type="submit">Add</button>
            </form>
            <ul>
              <% categories.forEach(function(c){ %>
                <li>
                  <%= c.name %>
                  <form action="/shop/admin/category/<%= c.id %>/delete" method="post" style="display:inline" onsubmit="return confirm('Delete category?');">
                    <button type="submit">Delete</button>
                  </form>
                </li>
              <% }) %>
            </ul>
          </section>
        </div>
        <div id="products" class="tab-content">
          <section>
            <h2>Add Product</h2>
            <form action="/shop/admin/product" method="post" enctype="multipart/form-data">
              <input type="text" name="name" placeholder="Name" required>
              <input type="text" name="sku" placeholder="SKU" required>
              <input type="text" name="vendor_sku" placeholder="Vendor SKU" required>
              <textarea name="description" placeholder="Description"></textarea>
              <input type="number" step="0.01" name="price" placeholder="Price" required>
              <input type="number" step="0.01" name="vip_price" placeholder="VIP Price">
              <input type="number" name="stock" placeholder="Stock" required>
              <select name="category_id">
                <option value="">No Category</option>
                <% categories.forEach(function(c){ %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
              </select>
              <input type="file" name="image">
              <button type="submit">Add</button>
            </form>
          </section>
          <section>
            <h2>Products</h2>
            <input type="text" id="search" placeholder="Search products">
            <select id="stockFilter">
              <option value="">All</option>
              <option value="in">In Stock</option>
              <option value="out">Out of Stock</option>
            </select>
            <label><input type="checkbox" id="showArchived" <%= showArchived ? 'checked' : '' %>> Show Archived</label>
            <table id="productsTable">
              <thead>
                <tr>
                  <th>Image</th>
                  <th>Name</th>
                  <th>SKU</th>
                  <th>Vendor SKU</th>
                  <th>Price</th>
                  <th>VIP Price</th>
                  <th>Category</th>
                  <th>Stock</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <% products.forEach(function(p){ %>
                  <tr
                    data-name="<%= p.name.toLowerCase() %>"
                    data-sku="<%= p.sku.toLowerCase() %>"
                    data-vendor="<%= p.vendor_sku.toLowerCase() %>"
                    data-stock="<%= p.stock %>"
                  >
                    <td><% if (p.image_url) { %><img src="<%= p.image_url %>" width="50" alt=""><% } %></td>
                    <td><%= p.name %></td>
                    <td><%= p.sku %></td>
                    <td><%= p.vendor_sku %></td>
                    <td><%= p.price %></td>
                    <td><%= p.vip_price !== null ? p.vip_price : '' %></td>
                    <td><%= p.category_name || '' %></td>
                    <td><%= p.stock %></td>
                    <td>
                      <button type="button" onclick="openEditModal(<%= p.id %>)">Edit</button>
                      <form action="/shop/admin/product/<%= p.id %>/<%= p.archived ? 'unarchive' : 'archive' %>" method="post" style="display:inline-block">
                        <button type="submit"><%= p.archived ? 'Unarchive' : 'Archive' %></button>
                      </form>
                      <form action="/shop/admin/product/<%= p.id %>/delete" method="post" style="display:inline-block" onsubmit="return confirm('Are you sure you want to delete this product?');">
                        <button type="submit">Delete</button>
                      </form>
                      <button type="button" onclick="openVisibilityModal(<%= p.id %>)">Visibility</button>
                    </td>
                  </tr>
                <% }) %>
              </tbody>
            </table>
            <script>
              const searchInput = document.getElementById('search');
              const stockFilter = document.getElementById('stockFilter');
              const showArchivedCheckbox = document.getElementById('showArchived');
              const rows = document.querySelectorAll('#productsTable tbody tr');
              function filterRows() {
                const query = searchInput.value.toLowerCase();
                const stock = stockFilter.value;
                rows.forEach(row => {
                  const name = row.dataset.name;
                  const sku = row.dataset.sku;
                  const vendor = row.dataset.vendor;
                  const rowStock = parseInt(row.dataset.stock, 10);
                  const matchesSearch = !query || name.includes(query) || sku.includes(query) || vendor.includes(query);
                  const matchesStock = !stock || (stock === 'in' && rowStock > 0) || (stock === 'out' && rowStock === 0);
                  row.style.display = matchesSearch && matchesStock ? '' : 'none';
                });
              }
              searchInput.addEventListener('input', filterRows);
              stockFilter.addEventListener('change', filterRows);
              showArchivedCheckbox.addEventListener('change', () => {
                const url = new URL(window.location.href);
                if (showArchivedCheckbox.checked) {
                  url.searchParams.set('showArchived', '1');
                } else {
                  url.searchParams.delete('showArchived');
                }
                window.location.href = url.toString();
              });
              const productRestrictions = <%- JSON.stringify(productRestrictions) %>;
              const productsData = <%- JSON.stringify(products) %>;
              function openEditModal(id) {
                const product = productsData.find(p => p.id === id);
                const modal = document.getElementById('editModal');
                const form = document.getElementById('editForm');
                form.action = `/shop/admin/product/${id}`;
                form.name.value = product.name;
                form.sku.value = product.sku;
                form.vendor_sku.value = product.vendor_sku;
                form.description.value = product.description || '';
                form.price.value = product.price;
                form.vip_price.value = product.vip_price !== null ? product.vip_price : '';
                form.stock.value = product.stock;
                form.category_id.value = product.category_id || '';
                const img = document.getElementById('editImagePreview');
                if (product.image_url) {
                  img.src = product.image_url;
                  img.style.display = 'block';
                } else {
                  img.style.display = 'none';
                }
                modal.style.display = 'flex';
              }
              function closeEditModal() {
                document.getElementById('editModal').style.display = 'none';
              }
              function openVisibilityModal(id) {
                const modal = document.getElementById('visibilityModal');
                const form = document.getElementById('visibilityForm');
                form.action = `/shop/admin/product/${id}/visibility`;
                const selected = (productRestrictions[id] || []).map(r => r.company_id);
                form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                  cb.checked = selected.includes(parseInt(cb.value, 10));
                });
                modal.style.display = 'flex';
              }
              function closeVisibilityModal() {
                document.getElementById('visibilityModal').style.display = 'none';
              }
            </script>
            <div id="editModal" class="modal" style="display:none;">
              <div class="modal-content" style="width:300px;">
                <h3>Edit Product</h3>
                <form id="editForm" method="post" enctype="multipart/form-data">
                  <label for="edit-name">Name</label>
                  <input type="text" id="edit-name" name="name" required>
                  <label for="edit-sku">SKU</label>
                  <input type="text" id="edit-sku" name="sku" required>
                  <label for="edit-vendor-sku">Vendor SKU</label>
                  <input type="text" id="edit-vendor-sku" name="vendor_sku" required>
                  <label for="edit-description">Description</label>
                  <textarea id="edit-description" name="description"></textarea>
                  <label for="edit-price">Price</label>
                  <input type="number" step="0.01" id="edit-price" name="price" required>
                  <label for="edit-vip-price">VIP Price</label>
                  <input type="number" step="0.01" id="edit-vip-price" name="vip_price">
                  <label for="edit-stock">Stock</label>
                  <input type="number" id="edit-stock" name="stock" required>
                  <label for="edit-category">Category</label>
                  <select id="edit-category" name="category_id">
                    <option value="">No Category</option>
                    <% categories.forEach(function(c){ %>
                      <option value="<%= c.id %>"><%= c.name %></option>
                    <% }) %>
                  </select>
                  <label for="edit-image">Image</label>
                  <img id="editImagePreview" src="" width="100" alt="" style="display:none;">
                  <input type="file" id="edit-image" name="image">
                  <button type="submit">Save</button>
                  <button type="button" onclick="closeEditModal()">Close</button>
                </form>
              </div>
            </div>
            <div id="visibilityModal" class="modal" style="display:none;">
              <div class="modal-content" style="width:300px;">
                <h3>Product Visibility</h3>
                <form id="visibilityForm" method="post">
                  <% allCompanies.forEach(function(c){ %>
                    <label><input type="checkbox" name="excluded" value="<%= c.id %>"> <%= c.name %></label><br>
                  <% }) %>
                  <button type="submit">Save</button>
                  <button type="button" onclick="closeVisibilityModal()">Close</button>
                </form>
              </div>
            </div>
          </section>
        </div>
        <% } %>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tabs = document.querySelectorAll('.tabs button');
      const contents = document.querySelectorAll('.tab-content');
      const ACTIVE_TAB_KEY = 'admin-active-tab';

      function activate(tabName) {
        tabs.forEach((t) => t.classList.toggle('active', t.dataset.tab === tabName));
        contents.forEach((c) => c.classList.toggle('active', c.id === tabName));
        localStorage.setItem(ACTIVE_TAB_KEY, tabName);
      }

      tabs.forEach(function (tab) {
        tab.addEventListener('click', function () {
          activate(tab.dataset.tab);
        });
      });

      let initialTab = window.location.hash
        ? window.location.hash.substring(1)
        : localStorage.getItem(ACTIVE_TAB_KEY) || 'companies';
      <% if (isSuperAdmin && selectedFormId && selectedCompanyId) { %>
      initialTab = 'form-permissions';
      <% } %>
      if (!document.querySelector(`.tabs button[data-tab="${initialTab}"]`)) {
        initialTab = tabs[0].dataset.tab;
      }
      activate(initialTab);
      const allCompanies = <%- JSON.stringify(allCompanies) %>;
      document.querySelectorAll('.add-sku-default').forEach(function(btn){
        btn.addEventListener('click', async function(){
          const appId = this.dataset.appId;
          const appName = this.dataset.appName;
          const list = allCompanies.map(c => `${c.id}: ${c.name}`).join('\n');
          const companyId = prompt(`Select company for ${appName}:\n${list}`);
          if(!companyId) return;
          const qty = prompt('Number of licenses purchased?');
          if(!qty) return;
          await fetch(`/apps/${appId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ companyId: parseInt(companyId,10), quantity: parseInt(qty,10) })
          });
          alert('App added to company');
        });
      });
      document.querySelectorAll('.add-sku-company').forEach(function(btn){
        btn.addEventListener('click', async function(){
          const appId = this.dataset.appId;
          const companyId = this.dataset.companyId;
          const companyName = this.dataset.companyName;
          const qty = prompt(`Number of licenses for ${companyName}?`);
          if(!qty) return;
          await fetch(`/apps/${appId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ companyId: parseInt(companyId,10), quantity: parseInt(qty,10) })
          });
          alert('App added to company');
        });
      });

      document.querySelectorAll('.unassign-btn').forEach(function(btn){
        btn.addEventListener('click', async function(){
          if(!confirm('Remove assignment?')) return;
          await fetch(`/admin/assign/${this.dataset.companyId}/${this.dataset.userId}`, { method: 'DELETE' });
          location.reload();
        });
      });
      document.querySelectorAll('.show-ips').forEach(function(link){
        link.addEventListener('click', function(e){
          e.preventDefault();
          const ips = JSON.parse(this.dataset.ips || '[]');
          const list = document.getElementById('ip-list');
          list.innerHTML = '';
          ips.forEach(function(ip){
            const li = document.createElement('li');
            li.textContent = ip.ip_address + ' (' + ip.usage_count + ')';
            list.appendChild(li);
          });
          document.getElementById('ip-modal').style.display = 'flex';
        });
      });
      document.getElementById('ip-modal-close')?.addEventListener('click', function(){
        document.getElementById('ip-modal').style.display = 'none';
      });
    });
  </script>
</body>
</html>
