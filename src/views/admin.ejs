<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Admin' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Admin</h1>
      <div class="admin-tabs">
        <div class="tabs">
          <button data-tab="companies" class="active">Companies</button>
          <button data-tab="assignments">Current Assignments</button>
          <% if (isSuperAdmin) { %>
            <button data-tab="apps">Apps</button>
            <button data-tab="api-keys">API Keys</button>
          <% } %>
        </div>
        <div id="companies" class="tab-content active">
          <% if (isSuperAdmin) { %>
          <section>
            <h2>Add Company</h2>
            <form action="/admin/company" method="post">
              <input type="text" name="name" placeholder="Company Name" required>
              <input type="text" name="syncroCompanyId" placeholder="Syncro Company ID">
              <input type="text" name="xeroId" placeholder="Xero ID">
              <label><input type="checkbox" name="isVip" value="1"> VIP</label>
              <button type="submit">Add</button>
            </form>
          </section>
          <section>
            <h2>Companies</h2>
            <table>
              <thead>
                <tr><th>Name</th><th>Syncro Company ID</th><th>Xero ID</th><th>VIP</th><th></th></tr>
              </thead>
              <tbody>
                <% allCompanies.forEach(function(c) { %>
                  <tr>
                    <td><%= c.name %></td>
                    <td><input type="text" name="syncroCompanyId" value="<%= c.syncro_company_id || '' %>" form="c<%= c.id %>"></td>
                    <td><input type="text" name="xeroId" value="<%= c.xero_id || '' %>" form="c<%= c.id %>"></td>
                    <td><input type="checkbox" name="isVip" value="1" <%= c.is_vip ? 'checked' : '' %> form="c<%= c.id %>"></td>
                    <td>
                      <form id="c<%= c.id %>" action="/admin/company/<%= c.id %>" method="post">
                        <button type="submit">Save</button>
                      </form>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </section>
          <% } %>
          <section>
            <h2>Add User</h2>
            <form action="/admin/user" method="post">
              <input type="email" name="email" placeholder="Email" required>
              <input type="password" name="password" placeholder="Password" required>
              <% if (isSuperAdmin) { %>
                <select name="companyId">
                  <% allCompanies.forEach(function(c) { %>
                    <option value="<%= c.id %>"><%= c.name %></option>
                  <% }); %>
                </select>
              <% } else { %>
                <input type="hidden" name="companyId" value="<%= currentCompanyId %>">
              <% } %>
              <button type="submit">Add User</button>
            </form>
          </section>
          <% if (isSuperAdmin) { %>
          <section>
            <h2>Assign Existing User to Company</h2>
            <form action="/admin/assign" method="post">
              <select name="userId">
                <% users.forEach(function(u) { %>
                  <option value="<%= u.id %>"><%= u.email %></option>
                <% }); %>
              </select>
              <select name="companyId">
                <% allCompanies.forEach(function(c) { %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }); %>
              </select>
              <button type="submit">Assign</button>
            </form>
          </section>
          <% } %>
        </div>
        <div id="assignments" class="tab-content">
          <section>
            <h2>Current Assignments</h2>
            <table>
              <thead>
                <tr><th>User</th><th>Company</th><th>Admin</th><th>Licenses</th><th>Order</th><th>Staff</th><th>Assets</th><th>Invoices</th><th>Shop</th></tr>
              </thead>
              <tbody>
              <% assignments.forEach(function(a) { %>
                <tr>
                  <td><%= a.email %></td>
                  <td><%= a.company_name %></td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="isAdmin" value="0">
                      <input type="checkbox" name="isAdmin" value="1" <%= a.is_admin ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageLicenses" value="0">
                      <input type="checkbox" name="canManageLicenses" value="1" <%= a.can_manage_licenses ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canOrderLicenses" value="0">
                      <input type="checkbox" name="canOrderLicenses" value="1" <%= a.can_order_licenses ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageStaff" value="0">
                      <input type="checkbox" name="canManageStaff" value="1" <%= a.can_manage_staff ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageAssets" value="0">
                      <input type="checkbox" name="canManageAssets" value="1" <%= a.can_manage_assets ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canManageInvoices" value="0">
                      <input type="checkbox" name="canManageInvoices" value="1" <%= a.can_manage_invoices ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                  <td>
                    <form action="/admin/permission" method="post">
                      <input type="hidden" name="userId" value="<%= a.user_id %>">
                      <input type="hidden" name="companyId" value="<%= a.company_id %>">
                      <input type="hidden" name="canAccessShop" value="0">
                      <input type="checkbox" name="canAccessShop" value="1" <%= a.can_access_shop ? 'checked' : '' %> onchange="this.form.submit()">
                    </form>
                  </td>
                </tr>
              <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <% if (isSuperAdmin) { %>
        <div id="apps" class="tab-content">
          <section>
            <h2>Add App</h2>
            <form action="/apps" method="post">
              <input type="text" name="sku" placeholder="SKU" required>
              <input type="text" name="name" placeholder="Name" required>
              <input type="number" step="0.01" name="price" placeholder="Default Price" required>
              <input type="text" name="contractTerm" placeholder="Contract Term" required>
              <button type="submit">Add App</button>
            </form>
          </section>
          <section>
            <h2>Apps</h2>
            <table>
              <thead>
                <tr><th>SKU</th><th>Name</th><th>Default Price</th><th>Contract Term</th><th>Actions</th></tr>
              </thead>
              <tbody>
              <% apps.forEach(function(a){ %>
                <tr>
                  <td><%= a.sku %></td>
                  <td><%= a.name %></td>
                  <td><%= a.default_price %></td>
                  <td><%= a.contract_term %></td>
                  <td><button class="add-sku-default" data-app-id="<%= a.id %>" data-app-name="<%= a.name %>">Add to Company</button></td>
                </tr>
              <% }); %>
              </tbody>
            </table>
          </section>
          <section>
            <h2>Company Pricing</h2>
            <form action="/apps/price" method="post">
              <select name="appId">
                <% apps.forEach(function(a){ %>
                  <option value="<%= a.id %>"><%= a.name %></option>
                <% }); %>
              </select>
              <select name="companyId">
                <% allCompanies.forEach(function(c){ %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }); %>
              </select>
              <input type="number" step="0.01" name="price" placeholder="Price" required>
              <button type="submit">Set Price</button>
            </form>
            <h3>Existing Company Prices</h3>
            <table>
              <thead>
                <tr><th>Company</th><th>SKU</th><th>App</th><th>Price</th><th>Actions</th></tr>
              </thead>
              <tbody>
              <% companyPrices.forEach(function(p){ %>
                <tr>
                  <td><%= p.company_name %></td>
                  <td><%= p.sku %></td>
                  <td><%= p.app_name %></td>
                  <td><%= p.price %></td>
                  <td><button class="add-sku-company" data-app-id="<%= p.app_id %>" data-company-id="<%= p.company_id %>" data-company-name="<%= p.company_name %>">Add to Company</button></td>
                </tr>
              <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <div id="api-keys" class="tab-content">
          <section>
            <h2>API Keys</h2>
            <form action="/admin/api-key" method="post">
              <input type="text" name="description" placeholder="Description">
              <input type="date" name="expiryDate">
              <button type="submit">Add API Key</button>
            </form>
            <table>
              <thead>
                <tr><th>Key</th><th>Description</th><th>Expiry</th><th></th></tr>
              </thead>
              <tbody>
              <% apiKeys.forEach(function(k) { %>
                <tr>
                  <td><%= k.api_key %></td>
                  <td><%= k.description %></td>
                  <td><%= k.expiry_date || '' %></td>
                  <td>
                    <form action="/admin/api-key/delete" method="post">
                      <input type="hidden" name="id" value="<%= k.id %>">
                      <button type="submit">Delete</button>
                    </form>
                  </td>
                </tr>
              <% }); %>
              </tbody>
            </table>
          </section>
        </div>
        <% } %>
      </div>
    </div>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const tabs = document.querySelectorAll('.tabs button');
      const contents = document.querySelectorAll('.tab-content');
      tabs.forEach(function (tab) {
        tab.addEventListener('click', function () {
          tabs.forEach(function (t) { t.classList.remove('active'); });
          contents.forEach(function (c) { c.classList.remove('active'); });
          tab.classList.add('active');
          document.getElementById(tab.dataset.tab).classList.add('active');
        });
      });
      const allCompanies = <%- JSON.stringify(allCompanies) %>;
      document.querySelectorAll('.add-sku-default').forEach(function(btn){
        btn.addEventListener('click', async function(){
          const appId = this.dataset.appId;
          const appName = this.dataset.appName;
          const list = allCompanies.map(c => `${c.id}: ${c.name}`).join('\n');
          const companyId = prompt(`Select company for ${appName}:\n${list}`);
          if(!companyId) return;
          const qty = prompt('Number of licenses purchased?');
          if(!qty) return;
          await fetch(`/apps/${appId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ companyId: parseInt(companyId,10), quantity: parseInt(qty,10) })
          });
          alert('App added to company');
        });
      });
      document.querySelectorAll('.add-sku-company').forEach(function(btn){
        btn.addEventListener('click', async function(){
          const appId = this.dataset.appId;
          const companyId = this.dataset.companyId;
          const companyName = this.dataset.companyName;
          const qty = prompt(`Number of licenses for ${companyName}?`);
          if(!qty) return;
          await fetch(`/apps/${appId}/add`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ companyId: parseInt(companyId,10), quantity: parseInt(qty,10) })
          });
          alert('App added to company');
        });
      });
    });
  </script>
</body>
</html>
