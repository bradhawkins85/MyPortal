<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Apps' }) %>
  <body>
    <div class="app-container">
      <%- include('partials/sidebar') %>
      <div class="content">
        <h1>Apps</h1>
        <form action="/apps" method="post">
          <input type="text" name="sku" placeholder="SKU" required>
          <input type="text" name="name" placeholder="Name" required>
          <input type="number" step="0.01" name="price" placeholder="Default Price" required>
          <input type="text" name="contractTerm" placeholder="Contract Term" required>
          <button type="submit">Add App</button>
        </form>
        <table>
          <thead>
            <tr><th>SKU</th><th>Name</th><th>Default Price</th><th>Contract Term</th><th>Actions</th></tr>
          </thead>
          <tbody>
          <% apps.forEach(function(a){ %>
            <tr>
              <td><%= a.sku %></td>
              <td><%= a.name %></td>
              <td><%= a.default_price %></td>
              <td><%= a.contract_term %></td>
              <td><button class="add-sku-default" data-app-id="<%= a.id %>" data-app-name="<%= a.name %>">Add to Company</button></td>
            </tr>
          <% }); %>
          </tbody>
        </table>
        <h2>Company Pricing</h2>
        <form action="/apps/price" method="post">
          <select name="appId">
            <% apps.forEach(function(a){ %>
              <option value="<%= a.id %>"><%= a.name %></option>
            <% }); %>
          </select>
          <select name="companyId">
            <% allCompanies.forEach(function(c){ %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% }); %>
          </select>
          <input type="number" step="0.01" name="price" placeholder="Price" required>
          <button type="submit">Set Price</button>
        </form>
          <h3>Existing Company Prices</h3>
          <table>
            <thead>
              <tr><th>Company</th><th>SKU</th><th>App</th><th>Price</th><th>Actions</th></tr>
            </thead>
            <tbody>
            <% companyPrices.forEach(function(p){ %>
              <tr>
                <td><%= p.company_name %></td>
                <td><%= p.sku %></td>
                <td><%= p.app_name %></td>
                <td><%= p.price %></td>
                <td><button class="add-sku-company" data-app-id="<%= p.app_id %>" data-company-id="<%= p.company_id %>" data-company-name="<%= p.company_name %>">Add to Company</button></td>
              </tr>
            <% }); %>
            </tbody>
          </table>
      </div>
    </div>
  <script>
    const allCompanies = <%- JSON.stringify(allCompanies) %>;
    document.querySelectorAll('.add-sku-default').forEach(function(btn){
      btn.addEventListener('click', async function(){
        const appId = this.dataset.appId;
        const appName = this.dataset.appName;
        const list = allCompanies.map(c => `${c.id}: ${c.name}`).join('\n');
        const companyId = prompt(`Select company for ${appName}:\n${list}`);
        if(!companyId) return;
        const qty = prompt('Number of licenses purchased?');
        if(!qty) return;
        await fetch(`/apps/${appId}/add`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ companyId: parseInt(companyId,10), quantity: parseInt(qty,10) })
        });
        alert('App added to company');
      });
    });
    document.querySelectorAll('.add-sku-company').forEach(function(btn){
      btn.addEventListener('click', async function(){
        const appId = this.dataset.appId;
        const companyId = this.dataset.companyId;
        const companyName = this.dataset.companyName;
        const qty = prompt(`Number of licenses for ${companyName}?`);
        if(!qty) return;
        await fetch(`/apps/${appId}/add`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ companyId: parseInt(companyId,10), quantity: parseInt(qty,10) })
        });
        alert('App added to company');
      });
    });
  </script>
  </body>
</html>
