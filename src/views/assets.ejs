<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Assets' }) %>
<body>
  <%- include('partials/app-shell-start', {
        pageTitle: 'Assets',
        pageSubtitle: 'Company Assets'
      }) %>
        <div class="asset-controls">
          <label for="asset-search" class="search-control">
            <span class="visually-hidden">Search assets</span>
            <i class="fas fa-search" aria-hidden="true"></i>
            <input type="text" id="asset-search" placeholder="Search assets" autocomplete="off" />
          </label>
          <section class="view-accordion" aria-label="Asset view options">
            <button
              type="button"
              id="view-accordion-toggle"
              class="view-accordion-toggle"
              aria-expanded="false"
              aria-controls="view-accordion-content"
            >
              <i class="fas fa-eye" aria-hidden="true"></i>
              <span>View options</span>
              <i class="fas fa-chevron-down accordion-chevron" aria-hidden="true"></i>
            </button>
            <div class="view-accordion-content" id="view-accordion-content" hidden>
              <p class="view-menu-title">Toggle columns</p>
              <ul>
                <% columns.forEach(function(col){ %>
                  <li>
                    <label>
                      <input type="checkbox" class="column-toggle" data-column="<%= col.key %>" <%= col.key === 'name' ? 'checked disabled' : 'checked' %>>
                      <span><%= col.label %></span>
                    </label>
                  </li>
                <% }); %>
              </ul>
            </div>
          </section>
        </div>
        <section class="asset-section">
          <table id="assets-table">
          <thead>
            <tr>
              <% columns.forEach(function(col){ %>
                <th data-column="<%= col.key %>"><%= col.label %></th>
              <% }); %>
              <% if (isSuperAdmin) { %><th data-column="actions">Actions</th><% } %>
            </tr>
          </thead>
          <tbody>
          <% assets.forEach(function(a) { %>
            <tr>
              <% columns.forEach(function(col){ %>
                <% const val = a[col.key]; %>
                <% if (col.key === 'last_sync') { %>
                  <td data-column="<%= col.key %>" data-date="datetime"><%= val || '' %></td>
                <% } else if (col.key === 'warranty_end_date') { %>
                  <td data-column="<%= col.key %>" data-date="date"><%= val || '' %></td>
                <% } else { %>
                  <td data-column="<%= col.key %>"><%= val || '' %></td>
                <% } %>
              <% }); %>
              <% if (isSuperAdmin) { %>
              <td data-column="actions"><button class="delete-btn" data-asset-id="<%= a.id %>">Delete</button></td>
              <% } %>
            </tr>
          <% }); %>
          </tbody>
          </table>
        </section>
  <%- include('partials/app-shell-end') %>
  <script>
    const table = document.getElementById('assets-table');
    const searchInput = document.getElementById('asset-search');
    const STORAGE_KEY = 'assetsTableColumns';
    const toggles = document.querySelectorAll('.column-toggle');
    const viewAccordion = document.querySelector('.view-accordion');
    const viewAccordionToggle = document.getElementById('view-accordion-toggle');
    const viewAccordionContent = document.getElementById('view-accordion-content');

    function setViewAccordionState(isOpen) {
      if (!viewAccordion || !viewAccordionToggle || !viewAccordionContent) return;
      viewAccordion.classList.toggle('open', isOpen);
      viewAccordionToggle.setAttribute('aria-expanded', String(isOpen));
      viewAccordionContent.hidden = !isOpen;
    }

    if (viewAccordion && viewAccordionToggle && viewAccordionContent) {
      viewAccordionToggle.addEventListener('click', (event) => {
        event.stopPropagation();
        const expanded = viewAccordionToggle.getAttribute('aria-expanded') === 'true';
        setViewAccordionState(!expanded);
      });

      document.addEventListener('click', (event) => {
        if (!viewAccordion.contains(event.target)) {
          setViewAccordionState(false);
        }
      });

      viewAccordionToggle.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          setViewAccordionState(false);
        }
      });

      viewAccordionContent.addEventListener('keydown', (event) => {
        if (event.key === 'Escape') {
          setViewAccordionState(false);
          viewAccordionToggle.focus();
        }
      });

      setViewAccordionState(false);
    }

    function toggleColumn(col, show) {
      table.querySelectorAll('[data-column="' + col + '"]').forEach((el) => {
        el.style.display = show ? '' : 'none';
      });
    }

    function applyPreferences() {
      let visible = [];
      try {
        visible = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
      } catch (e) {
        visible = [];
      }
      if (visible.length === 0) {
        visible = Array.from(toggles).map((t) => t.dataset.column);
        localStorage.setItem(STORAGE_KEY, JSON.stringify(visible));
      }
      toggles.forEach((t) => {
        const col = t.dataset.column;
        const show = col === 'name' ? true : visible.includes(col);
        t.checked = show;
        toggleColumn(col, show);
      });
    }

    toggles.forEach((t) => {
      t.addEventListener('change', () => {
        const visible = Array.from(toggles)
          .filter((t) => t.checked)
          .map((t) => t.dataset.column);
        if (!visible.includes('name')) visible.push('name');
        localStorage.setItem(STORAGE_KEY, JSON.stringify(visible));
        toggleColumn(t.dataset.column, t.checked);
        filterRows();
      });
    });

    function filterRows() {
      const term = searchInput.value.toLowerCase();
      table.querySelectorAll('tbody tr').forEach((row) => {
        const cells = Array.from(row.querySelectorAll('td')).filter(
          (td) => td.style.display !== 'none'
        );
        const match = cells.some((td) =>
          (td.textContent || '').toLowerCase().includes(term)
        );
        row.style.display = match ? '' : 'none';
      });
    }

    searchInput.addEventListener('input', filterRows);

    document.querySelectorAll('td[data-date]').forEach((td) => {
      const type = td.dataset.date;
      const value = td.textContent;
      if (!value) return;
      const date = new Date(value);
      if (isNaN(date)) return;
      td.textContent =
        type === 'date'
          ? new Intl.DateTimeFormat('en-CA').format(date)
          : date.toLocaleString();
    });

    applyPreferences();
    filterRows();
  </script>
<% if (isSuperAdmin) { %>
<script>
  document.querySelectorAll('.delete-btn').forEach(function(btn) {
    btn.addEventListener('click', async function() {
      if (!confirm('Delete asset?')) return;
      const res = await fetch(`/assets/${this.dataset.assetId}`, { method: 'DELETE' });
      if (res.ok) {
        location.reload();
      } else {
        alert('Failed to delete asset');
      }
    });
  });
</script>
<% } %>
</body>
</html>
