<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Staff' }) %>
<body>
  <%- include('partials/app-shell-start', {
        pageTitle: 'Staff',
        pageSubtitle: 'Manage employees and onboarding'
      }) %>
      <% if (isSuperAdmin && syncroCompanyId) { %>
      <section>
        <h2>Import from Syncro</h2>
        <button id="import-syncro-btn">Import Contacts</button>
      </section>
      <% } %>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Staff</h1>
      <style>
        #current-staff-section .pagination-controls {
          margin-top: 1rem;
          display: flex;
          flex-wrap: wrap;
          align-items: center;
          justify-content: space-between;
          gap: 1rem;
        }

        #current-staff-section .pagination-controls button {
          padding: 0.5rem 1rem;
          border: 1px solid #ccc;
          background-color: #f7f7f7;
          border-radius: 0.375rem;
          cursor: pointer;
        }

        #current-staff-section .pagination-controls button:disabled {
          opacity: 0.5;
          cursor: not-allowed;
        }

        #current-staff-section .pagination-status {
          display: flex;
          flex-wrap: wrap;
          align-items: center;
          gap: 0.75rem;
        }

        #current-staff-section .pagination-status label {
          display: flex;
          align-items: center;
          gap: 0.5rem;
          font-weight: 600;
        }

        #current-staff-section .pagination-status input[type='number'] {
          width: 4rem;
          padding: 0.35rem 0.5rem;
        }

        #current-staff-section .empty-message {
          margin-top: 1rem;
          font-style: italic;
          color: #555;
        }
      </style>
      <% if (isAdmin) { %>
      <section id="add-staff-section">
        <h2>Add Staff</h2>
        <form action="/staff" method="post">
          <%- include('partials/csrf-field') %>
          <input type="text" name="firstName" placeholder="First Name" required>
          <input type="text" name="lastName" placeholder="Last Name" required>
          <input type="email" name="email" placeholder="Email" required>
          <input type="tel" name="mobilePhone" placeholder="Mobile">
          <input type="text" name="department" placeholder="Department">
          <input type="date" name="dateOnboarded">
          <label><input type="checkbox" name="enabled" value="1" checked> Enabled</label>
          <button type="submit">Add</button>
        </form>
      </section>
      <% } %>
      <section id="current-staff-section">
        <h2>Current Staff</h2>
        <form id="filter-form" method="get" action="/staff">
          <label>Show
            <select name="enabled" data-submit-on-change>
              <option value="" <%= enabledFilter === '' ? 'selected' : '' %>>All</option>
              <option value="1" <%= enabledFilter === '1' ? 'selected' : '' %>>Enabled</option>
              <option value="0" <%= enabledFilter === '0' ? 'selected' : '' %>>Disabled</option>
            </select>
          </label>
          <% if (staffPermission === 3 && departments && departments.length) { %>
          <label>Department
            <select name="department" data-submit-on-change>
              <option value="" <%= departmentFilter === '' ? 'selected' : '' %>>All</option>
              <% departments.forEach(function(d) { %>
                <option value="<%= d %>" <%= departmentFilter === d ? 'selected' : '' %>><%= d %></option>
              <% }) %>
            </select>
          </label>
          <% } %>
        </form>
        <table id="staff-table">
          <thead>
            <tr><th>First Name</th><th>Last Name</th><th>Email</th><th>Mobile</th><th>Code</th><th>Date Onboarded</th><th>Enabled</th><th>Actions</th></tr>
          </thead>
          <tbody>
          <% staff.forEach(function(s) { %>
            <tr>
              <td><%= s.first_name %></td>
              <td><%= s.last_name %></td>
              <td><%= s.email %></td>
              <td><%= s.mobile_phone || '' %></td>
              <td class="verification-code"><%= s.verification_code || '' %></td>
              <td class="date-onboarded" data-date="<%= s.date_onboarded %>"><%= s.date_onboarded %></td>
              <td>
                <form action="/staff/enabled" method="post">
                  <%- include('partials/csrf-field') %>
                  <input type="hidden" name="staffId" value="<%= s.id %>">
                  <input type="checkbox" name="enabled" value="1" <%= s.enabled ? 'checked' : '' %> data-submit-on-change>
                </form>
              </td>
              <td>
                <% if (isSuperAdmin) { %>
                <button class="verify-btn" data-id="<%= s.id %>" <%= s.mobile_phone ? '' : 'disabled' %>>Verify</button>
                <% } %>
                <% if (isAdmin || isSuperAdmin) { %>
                <button class="invite-btn" data-id="<%= s.id %>">Invite</button>
                <% } %>
                <button
                  class="edit-btn"
                  data-id="<%= s.id %>"
                  data-first-name="<%= s.first_name %>"
                  data-last-name="<%= s.last_name %>"
                  data-email="<%= s.email %>"
                  data-mobile-phone="<%= s.mobile_phone || '' %>"
                  data-date-onboarded="<%= s.date_onboarded ? new Date(s.date_onboarded).toISOString().slice(0,10) : '' %>"
                  data-date-offboarded="<%= s.date_offboarded ? new Date(s.date_offboarded).toISOString().slice(0,16) : '' %>"
                  data-enabled="<%= s.enabled %>"
                  data-street="<%= s.street || '' %>"
                  data-city="<%= s.city || '' %>"
                  data-state="<%= s.state || '' %>"
                  data-postcode="<%= s.postcode || '' %>"
                  data-country="<%= s.country || '' %>"
                  data-department="<%= s.department || '' %>"
                  data-job-title="<%= s.job_title || '' %>"
                  data-company="<%= s.org_company || '' %>"
                  data-manager-name="<%= s.manager_name || '' %>"
                  data-account-action="<%= s.account_action || '' %>"
                >Edit</button>
                <% if (isSuperAdmin) { %>
                  <button class="delete-btn" data-id="<%= s.id %>">Delete</button>
                <% } %>
              </td>
            </tr>
          <% }); %>
          </tbody>
        </table>
        <p id="staff-empty-message" class="empty-message" hidden>No staff to display.</p>
        <div class="pagination-controls" id="pagination-controls" aria-live="polite">
          <button type="button" id="prev-page" class="pagination-button" aria-label="Previous page">Previous</button>
          <div class="pagination-status">
            <span id="pagination-info"></span>
            <label for="page-jump">
              Page
              <input type="number" id="page-jump" min="1" value="1" aria-label="Current page">
              <span id="pagination-total"></span>
            </label>
          </div>
          <button type="button" id="next-page" class="pagination-button" aria-label="Next page">Next</button>
        </div>
      </section>
  <%- include('partials/app-shell-end') %>
  <div id="edit-modal" class="modal" style="display:none;">
    <div class="modal-content">
      <span id="edit-close" class="close">&times;</span>
      <h2>Edit Staff</h2>
      <form id="edit-form">
        <label for="edit-first-name">First Name
          <input type="text" id="edit-first-name" <%= isSuperAdmin ? '' : 'readonly' %>>
        </label>
        <label for="edit-last-name">Last Name
          <input type="text" id="edit-last-name" <%= isSuperAdmin ? '' : 'readonly' %>>
        </label>
        <label for="edit-email">Email
          <input type="email" id="edit-email" <%= isSuperAdmin ? '' : 'readonly' %>>
        </label>
        <label for="edit-mobile-phone">Mobile Phone
          <input type="tel" id="edit-mobile-phone" <%= isSuperAdmin ? '' : 'readonly' %>>
        </label>
        <label for="edit-date-onboarded">Date Onboarded
          <input type="date" id="edit-date-onboarded" <%= isSuperAdmin ? '' : 'readonly' %>>
        </label>
        <label for="edit-date-offboarded">Offboard Date
          <input type="datetime-local" id="edit-date-offboarded" <%= isAdmin ? '' : 'readonly' %>>
        </label>
        <label for="edit-account-action">Account Action
          <select id="edit-account-action" <%= isSuperAdmin ? '' : 'disabled' %>>
            <option value="Onboard Requested">Onboard Requested</option>
            <option value="Onboard Approved">Onboard Approved</option>
            <option value="Onboarding In Progress">Onboarding In Progress</option>
            <option value="Onboarded">Onboarded</option>
            <option value="Offboard Requested">Offboard Requested</option>
            <option value="Offboard Approved">Offboard Approved</option>
            <option value="Offboard Scheduled">Offboard Scheduled</option>
            <option value="Offboarded">Offboarded</option>
          </select>
        </label>
        <label><input type="checkbox" id="edit-enabled" <%= isSuperAdmin ? '' : 'disabled' %>> Enabled</label>
        <fieldset>
          <legend>Address</legend>
          <label for="edit-street">Street
            <input type="text" id="edit-street" <%= isSuperAdmin ? '' : 'readonly' %>>
          </label>
          <label for="edit-city">City
            <input type="text" id="edit-city" <%= isSuperAdmin ? '' : 'readonly' %>>
          </label>
          <label for="edit-state">State
            <input type="text" id="edit-state" <%= isSuperAdmin ? '' : 'readonly' %>>
          </label>
          <label for="edit-postcode">Postcode
            <input type="text" id="edit-postcode" <%= isSuperAdmin ? '' : 'readonly' %>>
          </label>
          <label for="edit-country">Country
            <input type="text" id="edit-country" <%= isSuperAdmin ? '' : 'readonly' %>>
          </label>
        </fieldset>
        <fieldset>
          <legend>Organisation</legend>
          <label for="edit-department">Department
            <input type="text" id="edit-department" <%= isSuperAdmin ? '' : 'readonly' %>>
          </label>
          <label for="edit-job-title">Job Title
            <input type="text" id="edit-job-title" <%= isSuperAdmin ? '' : 'readonly' %>>
          </label>
          <label for="edit-company">Company
            <input type="text" id="edit-company" <%= isSuperAdmin ? '' : 'readonly' %>>
          </label>
          <label for="edit-manager-name">Manager's Name
            <input type="text" id="edit-manager-name" <%= isSuperAdmin ? '' : 'readonly' %>>
          </label>
        </fieldset>
        <button type="submit">Save</button>
      </form>
    </div>
  </div>

  <script>
    const isSuperAdmin = <%- JSON.stringify(isSuperAdmin) %>;
    const isAdmin = <%- JSON.stringify(isAdmin) %>;
    const editModal = document.getElementById('edit-modal');
    const editForm = document.getElementById('edit-form');
    let editingId = null;
    const staffTable = document.getElementById('staff-table');
    const staffTableBody = staffTable.querySelector('tbody');
    const staffRows = Array.from(staffTableBody.querySelectorAll('tr'));
    const paginationControls = document.getElementById('pagination-controls');
    const paginationInfo = document.getElementById('pagination-info');
    const paginationTotal = document.getElementById('pagination-total');
    const prevPageBtn = document.getElementById('prev-page');
    const nextPageBtn = document.getElementById('next-page');
    const pageJumpInput = document.getElementById('page-jump');
    const emptyMessage = document.getElementById('staff-empty-message');
    const MIN_ROWS_PER_PAGE = 5;
    let currentPage = 1;
    let rowsPerPage = computeRowsPerPage();

    renderPage(currentPage);

    prevPageBtn.addEventListener('click', function() {
      renderPage(currentPage - 1);
    });

    nextPageBtn.addEventListener('click', function() {
      renderPage(currentPage + 1);
    });

    function handlePageJump() {
      const requested = parseInt(pageJumpInput.value, 10);
      if (!Number.isNaN(requested)) {
        renderPage(requested);
      } else {
        pageJumpInput.value = String(currentPage);
      }
    }

    pageJumpInput.addEventListener('change', handlePageJump);
    pageJumpInput.addEventListener('keydown', function(event) {
      if (event.key === 'Enter') {
        event.preventDefault();
        handlePageJump();
      }
    });

    window.addEventListener(
      'resize',
      debounce(function() {
        const previousRowsPerPage = rowsPerPage;
        rowsPerPage = computeRowsPerPage();
        if (!staffRows.length) {
          return;
        }
        if (rowsPerPage !== previousRowsPerPage) {
          const firstVisibleIndex = (currentPage - 1) * previousRowsPerPage;
          const safeIndex = Math.max(0, Math.min(firstVisibleIndex, staffRows.length - 1));
          const recalculatedPage = Math.floor(safeIndex / rowsPerPage) + 1;
          renderPage(recalculatedPage);
        } else {
          renderPage(currentPage);
        }
      }, 150)
    );

    function renderPage(page) {
      const totalRows = staffRows.length;
      if (!totalRows) {
        paginationControls.hidden = true;
        emptyMessage.hidden = false;
        paginationInfo.textContent = '';
        pageJumpInput.value = '';
        return;
      }

      emptyMessage.hidden = true;
      paginationControls.hidden = false;

      const totalPages = Math.max(1, Math.ceil(totalRows / rowsPerPage));
      currentPage = Math.min(Math.max(page, 1), totalPages);
      const startIndex = (currentPage - 1) * rowsPerPage;
      const endIndex = Math.min(startIndex + rowsPerPage, totalRows);

      staffRows.forEach(function(row, index) {
        row.style.display = index >= startIndex && index < endIndex ? 'table-row' : 'none';
      });

      paginationInfo.textContent = `Showing ${startIndex + 1}-${endIndex} of ${totalRows}`;
      paginationTotal.textContent = `of ${totalPages}`;
      pageJumpInput.value = String(currentPage);
      pageJumpInput.disabled = totalPages <= 1;
      pageJumpInput.setAttribute('max', String(totalPages));
      prevPageBtn.disabled = currentPage === 1;
      nextPageBtn.disabled = currentPage === totalPages;
    }

    function computeRowsPerPage() {
      if (!staffRows.length) {
        return MIN_ROWS_PER_PAGE;
      }
      const viewportHeight = window.innerHeight || document.documentElement.clientHeight || 800;
      const tableRect = staffTable.getBoundingClientRect();
      const headerHeight = staffTable.querySelector('thead').getBoundingClientRect().height;
      const controlsHeight = paginationControls.getBoundingClientRect().height || 0;
      const availableHeight = viewportHeight - tableRect.top - controlsHeight - 32;
      const usableHeight = Math.max(0, availableHeight - headerHeight);
      const rowHeight = measureRowHeight();
      const calculated = Math.floor(usableHeight / rowHeight);
      return Math.max(MIN_ROWS_PER_PAGE, calculated || MIN_ROWS_PER_PAGE);
    }

    function measureRowHeight() {
      if (!staffRows.length) {
        return 48;
      }
      const templateRow = staffRows[0];
      const clone = templateRow.cloneNode(true);
      clone.removeAttribute('style');
      clone.style.position = 'absolute';
      clone.style.visibility = 'hidden';
      clone.style.pointerEvents = 'none';
      clone.style.display = 'table-row';
      staffTableBody.appendChild(clone);
      const height = clone.getBoundingClientRect().height || 48;
      staffTableBody.removeChild(clone);
      return height;
    }

    function debounce(fn, delay) {
      let timeoutId;
      return function() {
        const args = arguments;
        clearTimeout(timeoutId);
        timeoutId = setTimeout(function() {
          fn.apply(null, args);
        }, delay);
      };
    }

    if (isAdmin && !isSuperAdmin) {
      document.getElementById('edit-date-offboarded').addEventListener('change', function() {
        if (this.value) {
          alert('Warning: The offboard will be scheduled immediately for the requested date and time, any changes require contacting IT after saving changes.');
        }
      });
    }

    document.querySelectorAll('.date-onboarded').forEach(function(cell) {
      const value = cell.dataset.date;
      if (value) {
        cell.textContent = new Date(value).toLocaleDateString();
      }
    });

    document.querySelectorAll('.edit-btn').forEach(function(btn) {
      btn.addEventListener('click', function() {
        editingId = this.dataset.id;
        document.getElementById('edit-first-name').value = this.dataset.firstName;
        document.getElementById('edit-last-name').value = this.dataset.lastName;
        document.getElementById('edit-email').value = this.dataset.email;
        document.getElementById('edit-mobile-phone').value = this.dataset.mobilePhone || '';
        document.getElementById('edit-date-onboarded').value = this.dataset.dateOnboarded;
        document.getElementById('edit-date-offboarded').value = this.dataset.dateOffboarded || '';
        document.getElementById('edit-enabled').checked = this.dataset.enabled === '1';
        document.getElementById('edit-street').value = this.dataset.street || '';
        document.getElementById('edit-city').value = this.dataset.city || '';
        document.getElementById('edit-state').value = this.dataset.state || '';
        document.getElementById('edit-postcode').value = this.dataset.postcode || '';
        document.getElementById('edit-country').value = this.dataset.country || '';
        document.getElementById('edit-department').value = this.dataset.department || '';
        document.getElementById('edit-job-title').value = this.dataset.jobTitle || '';
        document.getElementById('edit-company').value = this.dataset.company || '';
        document.getElementById('edit-manager-name').value = this.dataset.managerName || '';
        document.getElementById('edit-account-action').value = this.dataset.accountAction || '';
        editModal.style.display = 'flex';
      });
    });

    <% if (isSuperAdmin) { %>
    document.querySelectorAll('.verify-btn').forEach(function(btn) {
      btn.addEventListener('click', async function() {
        const res = await fetch(`/staff/${this.dataset.id}/verify`, { method: 'POST' });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          const row = this.closest('tr');
          const codeCell = row.querySelector('.verification-code');
          if (codeCell) {
            codeCell.textContent = data.code || '';
            codeCell.style.color = data.status === 202 ? 'green' : 'black';
          }
          if (data.status !== 202) {
            alert('Failed to send code');
          }
        } else {
          alert(data.error || 'Failed to send code');
        }
      });
    });
    <% } %>

    document.querySelectorAll('.invite-btn').forEach(function(btn) {
      btn.addEventListener('click', async function() {
        if (!confirm('Send invitation to this staff member?')) return;
        const res = await fetch(`/staff/${this.dataset.id}/invite`, { method: 'POST' });
        const data = await res.json().catch(() => ({}));
        if (res.ok) {
          alert('Invitation sent');
        } else {
          alert(data.error || 'Failed to send invitation');
        }
      });
    });

    document.querySelectorAll('.delete-btn').forEach(function(btn) {
      btn.addEventListener('click', async function() {
        if (!confirm('Delete staff member?')) return;
        const res = await fetch(`/staff/${this.dataset.id}`, { method: 'DELETE' });
        if (res.ok) {
          location.reload();
        } else {
          alert('Failed to delete staff');
        }
      });
    });

    document.getElementById('edit-close').addEventListener('click', function() {
      editModal.style.display = 'none';
    });

    editForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      const payload = {
        firstName: document.getElementById('edit-first-name').value,
        lastName: document.getElementById('edit-last-name').value,
        email: document.getElementById('edit-email').value,
        mobilePhone: document.getElementById('edit-mobile-phone').value,
        dateOnboarded: document.getElementById('edit-date-onboarded').value,
        dateOffboarded: document.getElementById('edit-date-offboarded').value,
        enabled: document.getElementById('edit-enabled').checked,
        street: document.getElementById('edit-street').value,
        city: document.getElementById('edit-city').value,
        state: document.getElementById('edit-state').value,
        postcode: document.getElementById('edit-postcode').value,
        country: document.getElementById('edit-country').value,
        department: document.getElementById('edit-department').value,
        jobTitle: document.getElementById('edit-job-title').value,
        company: document.getElementById('edit-company').value,
        managerName: document.getElementById('edit-manager-name').value,
        accountAction: document.getElementById('edit-account-action').value,
      };
      const res = await fetch(`/staff/${editingId}`, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      if (res.ok) {
        location.reload();
      } else {
        alert('Failed to update staff');
      }
    });
  </script>
</body>
</html>
