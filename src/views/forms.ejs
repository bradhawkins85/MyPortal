<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Forms' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Forms</h1>
      <% if (forms.length > 0) { %>
        <% const initialForm = forms[0]; %>
        <div class="forms-menu">
          <% forms.forEach(function(f, idx){ %>
            <button
              data-open-form
              data-direct-url="<%= f.url %>"
              data-embed-url="<%= f.embedUrl ? f.embedUrl : '' %>"
              class="<%= idx === 0 ? 'active' : '' %>"
            >
              <%= f.name %>
            </button>
          <% }); %>
        </div>
        <div class="form-viewer">
          <div class="form-toolbar">
            <a
              id="form-open-link"
              class="button-link"
              href="<%= initialForm.url %>"
              target="_blank"
              rel="noopener noreferrer"
            >
              Open form in new tab
            </a>
          </div>
          <iframe
            id="form-frame"
            class="form-frame"
            src="<%= initialForm.embedUrl || 'about:blank' %>"
            <%= initialForm.embedUrl ? '' : 'hidden' %>
          ></iframe>
          <div
            id="form-unavailable"
            class="form-unavailable"
            <%= initialForm.embedUrl ? 'hidden' : '' %>
          >
            <p id="form-unavailable-message">
              <%= initialForm.embedUrl
                ? 'Loading formâ€¦'
                : 'This form must be opened in a new tab.' %>
            </p>
            <p class="form-unavailable-hint">
              Use the button above to open the form in a separate tab.
            </p>
          </div>
        </div>
      <% } else { %>
        <p>No forms available.</p>
      <% } %>
    </div>
  </div>
  <script>
    (function () {
      const buttons = Array.from(document.querySelectorAll('[data-open-form]'));
      if (!buttons.length) {
        return;
      }
      const iframe = document.getElementById('form-frame');
      const openLink = document.getElementById('form-open-link');
      const fallback = document.getElementById('form-unavailable');
      const fallbackMessage = document.getElementById('form-unavailable-message');

      function setActiveButton(activeButton) {
        buttons.forEach((button) => {
          button.classList.toggle('active', button === activeButton);
        });
      }

      function updateOpenLink(url) {
        if (!openLink) return;
        openLink.href = url || '#';
        const hasUrl = !!url;
        openLink.classList.toggle('is-disabled', !hasUrl);
        openLink.setAttribute('aria-disabled', hasUrl ? 'false' : 'true');
      }

      function showFallback(message) {
        if (!iframe || !fallback || !fallbackMessage) return;
        iframe.src = 'about:blank';
        iframe.hidden = true;
        fallback.hidden = false;
        fallbackMessage.textContent = message;
      }

      function showIframe(embedUrl) {
        if (!iframe || !fallback) return;
        if (embedUrl) {
          iframe.hidden = false;
          iframe.src = embedUrl;
          fallback.hidden = true;
        } else {
          showFallback('This form must be opened in a new tab.');
        }
      }

      function handleSelection(button) {
        const embedUrl = button.getAttribute('data-embed-url') || '';
        const directUrl = button.getAttribute('data-direct-url') || '';
        updateOpenLink(directUrl);
        setActiveButton(button);
        if (embedUrl) {
          showIframe(embedUrl);
        } else {
          showFallback('This form must be opened in a new tab.');
        }
      }

      buttons.forEach((button) => {
        button.addEventListener('click', () => handleSelection(button));
      });

      if (iframe) {
        iframe.addEventListener('load', () => {
          if (iframe.hidden) {
            return;
          }
          try {
            const doc = iframe.contentDocument;
            if (doc && doc.body?.dataset.formProxyError === 'true') {
              const message =
                doc.body.dataset.errorMessage ||
                'This form could not be embedded securely. Use the button above to open it in a new tab.';
              showFallback(message);
            }
          } catch (err) {
            // Ignore cross-origin access issues.
          }
        });
      }

      const initialButton =
        buttons.find((button) => button.classList.contains('active')) || buttons[0];
      if (initialButton) {
        handleSelection(initialButton);
      }
    })();
  </script>
</body>
</html>
