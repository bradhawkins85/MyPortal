<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Shop Admin' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Shop Admin</h1>
      <section>
        <h2>Categories</h2>
        <form action="/shop/admin/category" method="post">
          <input type="text" name="name" placeholder="Name" required>
          <button type="submit">Add</button>
        </form>
        <ul>
          <% categories.forEach(function(c){ %>
            <li>
              <%= c.name %>
              <form action="/shop/admin/category/<%= c.id %>/delete" method="post" style="display:inline" onsubmit="return confirm('Delete category?');">
                <button type="submit">Delete</button>
              </form>
            </li>
          <% }) %>
        </ul>
      </section>
      <section>
        <h2>Add Product</h2>
        <form action="/shop/admin/product" method="post" enctype="multipart/form-data">
          <input type="text" name="name" placeholder="Name" required>
          <input type="text" name="sku" placeholder="SKU" required>
          <input type="text" name="vendor_sku" placeholder="Vendor SKU" required>
          <textarea name="description" placeholder="Description"></textarea>
          <input type="number" step="0.01" name="price" placeholder="Price" required>
          <input type="number" step="0.01" name="vip_price" placeholder="VIP Price">
          <input type="number" name="stock" placeholder="Stock" required>
          <select name="category_id">
            <option value="">No Category</option>
            <% categories.forEach(function(c){ %>
              <option value="<%= c.id %>"><%= c.name %></option>
            <% }) %>
          </select>
          <input type="file" name="image">
          <button type="submit">Add</button>
        </form>
      </section>
      <section>
        <h2>Products</h2>
        <input type="text" id="search" placeholder="Search products">
        <select id="stockFilter">
          <option value="">All</option>
          <option value="in">In Stock</option>
          <option value="out">Out of Stock</option>
        </select>
        <label><input type="checkbox" id="showArchived" <%= showArchived ? 'checked' : '' %>> Show Archived</label>
        <table id="productsTable">
          <thead>
            <tr>
              <th>Image</th>
              <th>Name</th>
              <th>SKU</th>
              <th>Vendor SKU</th>
              <th>Price</th>
              <th>VIP Price</th>
              <th>Category</th>
              <th>Stock</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% products.forEach(function(p){ %>
              <tr
                data-name="<%= p.name.toLowerCase() %>"
                data-sku="<%= p.sku.toLowerCase() %>"
                data-vendor="<%= p.vendor_sku.toLowerCase() %>"
                data-stock="<%= p.stock %>"
              >
                <td><% if (p.image_url) { %><img src="<%= p.image_url %>" width="50" alt=""><% } %></td>
                <td><%= p.name %></td>
                <td><%= p.sku %></td>
                <td><%= p.vendor_sku %></td>
                <td><%= p.price %></td>
                <td><%= p.vip_price !== null ? p.vip_price : '' %></td>
                <td><%= p.category_name || '' %></td>
                <td><%= p.stock %></td>
                <td>
                  <button type="button" onclick="openEditModal(<%= p.id %>)">Edit</button>
                  <form action="/shop/admin/product/<%= p.id %>/<%= p.archived ? 'unarchive' : 'archive' %>" method="post" style="display:inline-block">
                    <button type="submit"><%= p.archived ? 'Unarchive' : 'Archive' %></button>
                  </form>
                  <form action="/shop/admin/product/<%= p.id %>/delete" method="post" style="display:inline-block" onsubmit="return confirm('Are you sure you want to delete this product?');">
                    <button type="submit">Delete</button>
                  </form>
                  <button type="button" onclick="openVisibilityModal(<%= p.id %>)">Visibility</button>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <script>
          const searchInput = document.getElementById('search');
          const stockFilter = document.getElementById('stockFilter');
          const showArchivedCheckbox = document.getElementById('showArchived');
          const rows = document.querySelectorAll('#productsTable tbody tr');
          function filterRows() {
            const query = searchInput.value.toLowerCase();
            const stock = stockFilter.value;
            rows.forEach(row => {
              const name = row.dataset.name;
              const sku = row.dataset.sku;
              const vendor = row.dataset.vendor;
              const rowStock = parseInt(row.dataset.stock, 10);
              const matchesSearch = !query || name.includes(query) || sku.includes(query) || vendor.includes(query);
              const matchesStock = !stock || (stock === 'in' && rowStock > 0) || (stock === 'out' && rowStock === 0);
              row.style.display = matchesSearch && matchesStock ? '' : 'none';
            });
          }
          searchInput.addEventListener('input', filterRows);
          stockFilter.addEventListener('change', filterRows);
          showArchivedCheckbox.addEventListener('change', () => {
            const url = new URL(window.location.href);
            if (showArchivedCheckbox.checked) {
              url.searchParams.set('showArchived', '1');
            } else {
              url.searchParams.delete('showArchived');
            }
            window.location.href = url.toString();
          });
          const productRestrictions = <%- JSON.stringify(productRestrictions) %>;
          const productsData = <%- JSON.stringify(products) %>;
          function openEditModal(id) {
            const product = productsData.find(p => p.id === id);
            const modal = document.getElementById('editModal');
            const form = document.getElementById('editForm');
            form.action = `/shop/admin/product/${id}`;
            form.name.value = product.name;
            form.sku.value = product.sku;
            form.vendor_sku.value = product.vendor_sku;
            form.description.value = product.description || '';
            form.price.value = product.price;
            form.vip_price.value = product.vip_price !== null ? product.vip_price : '';
            form.stock.value = product.stock;
            form.category_id.value = product.category_id || '';
            const img = document.getElementById('editImagePreview');
            if (product.image_url) {
              img.src = product.image_url;
              img.style.display = 'block';
            } else {
              img.style.display = 'none';
            }
            modal.style.display = 'flex';
          }
          function closeEditModal() {
            document.getElementById('editModal').style.display = 'none';
          }
          function openVisibilityModal(id) {
            const modal = document.getElementById('visibilityModal');
            const form = document.getElementById('visibilityForm');
            form.action = `/shop/admin/product/${id}/visibility`;
            const selected = (productRestrictions[id] || []).map(r => r.company_id);
            form.querySelectorAll('input[type="checkbox"]').forEach(cb => {
              cb.checked = selected.includes(parseInt(cb.value, 10));
            });
            modal.style.display = 'flex';
          }
          function closeVisibilityModal() {
            document.getElementById('visibilityModal').style.display = 'none';
          }
        </script>
        <div id="editModal" class="modal" style="display:none;">
          <div class="modal-content" style="width:300px;">
            <h3>Edit Product</h3>
            <form id="editForm" method="post" enctype="multipart/form-data">
              <label for="edit-name">Name</label>
              <input type="text" id="edit-name" name="name" required>
              <label for="edit-sku">SKU</label>
              <input type="text" id="edit-sku" name="sku" required>
              <label for="edit-vendor-sku">Vendor SKU</label>
              <input type="text" id="edit-vendor-sku" name="vendor_sku" required>
              <label for="edit-description">Description</label>
              <textarea id="edit-description" name="description"></textarea>
              <label for="edit-price">Price</label>
              <input type="number" step="0.01" id="edit-price" name="price" required>
              <label for="edit-vip-price">VIP Price</label>
              <input type="number" step="0.01" id="edit-vip-price" name="vip_price">
              <label for="edit-stock">Stock</label>
              <input type="number" id="edit-stock" name="stock" required>
              <label for="edit-category">Category</label>
              <select id="edit-category" name="category_id">
                <option value="">No Category</option>
                <% categories.forEach(function(c){ %>
                  <option value="<%= c.id %>"><%= c.name %></option>
                <% }) %>
              </select>
              <label for="edit-image">Image</label>
              <img id="editImagePreview" src="" width="100" alt="" style="display:none;">
              <input type="file" id="edit-image" name="image">
              <button type="submit">Save</button>
              <button type="button" onclick="closeEditModal()">Close</button>
            </form>
          </div>
        </div>
        <div id="visibilityModal" class="modal" style="display:none;">
          <div class="modal-content" style="width:300px;">
            <h3>Product Visibility</h3>
            <form id="visibilityForm" method="post">
              <% allCompanies.forEach(function(c){ %>
                <label><input type="checkbox" name="excluded" value="<%= c.id %>"> <%= c.name %></label><br>
              <% }) %>
              <button type="submit">Save</button>
              <button type="button" onclick="closeVisibilityModal()">Close</button>
            </form>
          </div>
        </div>
      </section>
    </div>
  </div>
</body>
</html>
