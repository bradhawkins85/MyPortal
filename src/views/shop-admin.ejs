<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Shop Admin' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Shop Admin</h1>
      <section>
        <h2>Add Product</h2>
        <form action="/shop/admin/product" method="post" enctype="multipart/form-data">
          <input type="text" name="name" placeholder="Name" required>
          <input type="text" name="sku" placeholder="SKU" required>
          <input type="text" name="vendor_sku" placeholder="Vendor SKU" required>
          <textarea name="description" placeholder="Description"></textarea>
          <input type="number" step="0.01" name="price" placeholder="Price" required>
          <input type="number" step="0.01" name="vip_price" placeholder="VIP Price">
          <input type="number" name="stock" placeholder="Stock" required>
          <input type="file" name="image">
          <button type="submit">Add</button>
        </form>
      </section>
      <section>
        <h2>Products</h2>
        <input type="text" id="search" placeholder="Search products">
        <select id="stockFilter">
          <option value="">All</option>
          <option value="in">In Stock</option>
          <option value="out">Out of Stock</option>
        </select>
        <label><input type="checkbox" id="showArchived" <%= showArchived ? 'checked' : '' %>> Show Archived</label>
        <table id="productsTable">
          <thead>
            <tr>
              <th>Name</th>
              <th>SKU</th>
              <th>Vendor SKU</th>
              <th>Description</th>
              <th>Price</th>
              <th>VIP Price</th>
              <th>Stock</th>
              <th>Image</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% products.forEach(function(p){ %>
              <tr
                data-name="<%= p.name.toLowerCase() %>"
                data-sku="<%= p.sku.toLowerCase() %>"
                data-vendor="<%= p.vendor_sku.toLowerCase() %>"
                data-stock="<%= p.stock %>"
              >
                <td><input form="form-<%= p.id %>" type="text" name="name" value="<%= p.name %>"></td>
                <td><input form="form-<%= p.id %>" type="text" name="sku" value="<%= p.sku %>"></td>
                <td><input form="form-<%= p.id %>" type="text" name="vendor_sku" value="<%= p.vendor_sku %>"></td>
                <td><textarea form="form-<%= p.id %>" name="description"><%= p.description %></textarea></td>
                <td><input form="form-<%= p.id %>" type="number" step="0.01" name="price" value="<%= p.price %>"></td>
                <td><input form="form-<%= p.id %>" type="number" step="0.01" name="vip_price" value="<%= p.vip_price !== null ? p.vip_price : '' %>"></td>
                <td><input form="form-<%= p.id %>" type="number" name="stock" value="<%= p.stock %>"></td>
                <td><% if (p.image_url) { %><img src="<%= p.image_url %>" width="50" alt=""><% } %></td>
                <td>
                  <input form="form-<%= p.id %>" type="file" name="image">
                  <button form="form-<%= p.id %>" type="submit">Update</button>
                  <form action="/shop/admin/product/<%= p.id %>/<%= p.archived ? 'unarchive' : 'archive' %>" method="post" style="display:inline-block">
                    <button type="submit"><%= p.archived ? 'Unarchive' : 'Archive' %></button>
                  </form>
                  <form action="/shop/admin/product/<%= p.id %>/delete" method="post" style="display:inline-block" onsubmit="return confirm('Are you sure you want to delete this product?');">
                    <button type="submit">Delete</button>
                  </form>
                  <form action="/shop/admin/product/<%= p.id %>/remove-company" method="post" style="display:inline-block">
                    <select name="company_id">
                      <% allCompanies.forEach(function(c){ %>
                        <option value="<%= c.id %>"><%= c.name %></option>
                      <% }) %>
                    </select>
                    <button type="submit">Remove for Company</button>
                  </form>
                  <% (productRestrictions[p.id] || []).forEach(function(r){ %>
                    <form action="/shop/admin/product/<%= p.id %>/add-company" method="post" style="display:inline-block">
                      <input type="hidden" name="company_id" value="<%= r.company_id %>">
                      <button type="submit">Add <%= r.company_name %></button>
                    </form>
                  <% }) %>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
        <% products.forEach(function(p){ %>
          <form id="form-<%= p.id %>" action="/shop/admin/product/<%= p.id %>" method="post" enctype="multipart/form-data"></form>
        <% }) %>
        <script>
          const searchInput = document.getElementById('search');
          const stockFilter = document.getElementById('stockFilter');
          const showArchivedCheckbox = document.getElementById('showArchived');
          const rows = document.querySelectorAll('#productsTable tbody tr');
          function filterRows() {
            const query = searchInput.value.toLowerCase();
            const stock = stockFilter.value;
            rows.forEach(row => {
              const name = row.dataset.name;
              const sku = row.dataset.sku;
              const vendor = row.dataset.vendor;
              const rowStock = parseInt(row.dataset.stock, 10);
              const matchesSearch = !query || name.includes(query) || sku.includes(query) || vendor.includes(query);
              const matchesStock = !stock || (stock === 'in' && rowStock > 0) || (stock === 'out' && rowStock === 0);
              row.style.display = matchesSearch && matchesStock ? '' : 'none';
            });
          }
          searchInput.addEventListener('input', filterRows);
          stockFilter.addEventListener('change', filterRows);
          showArchivedCheckbox.addEventListener('change', () => {
            const url = new URL(window.location.href);
            if (showArchivedCheckbox.checked) {
              url.searchParams.set('showArchived', '1');
            } else {
              url.searchParams.delete('showArchived');
            }
            window.location.href = url.toString();
          });
        </script>
      </section>
    </div>
  </div>
</body>
</html>
