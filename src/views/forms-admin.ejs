<!DOCTYPE html>
<html>
  <%- include('partials/head', { title: 'Forms Admin' }) %>
<body>
  <div class="app-container">
    <%- include('partials/sidebar') %>
    <div class="content">
      <h1>Forms Admin</h1>
      <% if (isSuperAdmin) { %>
      <section>
        <h2>Add Form</h2>
        <form action="/forms/admin" method="post">
          <input type="text" name="name" placeholder="Name" required>
          <input type="url" name="url" placeholder="URL" required>
          <input type="text" name="description" placeholder="Description">
          <button type="submit">Add</button>
        </form>
      </section>
      <% } %>

      <section>
        <h2>Existing Forms</h2>
        <table>
          <thead>
            <tr>
              <th>Name</th>
              <th>URL</th>
              <th>Description</th>
              <% if (isSuperAdmin) { %><th>Actions</th><% } %>
            </tr>
          </thead>
          <tbody>
            <% forms.forEach(function(f){ %>
            <tr>
              <td><input form="edit-form-<%= f.id %>" type="text" name="name" value="<%= f.name %>" <%= isSuperAdmin ? '' : 'disabled' %> required></td>
              <td><input form="edit-form-<%= f.id %>" type="url" name="url" value="<%= f.url %>" <%= isSuperAdmin ? '' : 'disabled' %> required></td>
              <td><input form="edit-form-<%= f.id %>" type="text" name="description" value="<%= f.description %>" <%= isSuperAdmin ? '' : 'disabled' %>></td>
              <% if (isSuperAdmin) { %>
              <td>
                <form id="edit-form-<%= f.id %>" action="/forms/admin/form/<%= f.id %>" method="post">
                  <button type="submit">Save</button>
                </form>
              </td>
              <% } %>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </section>

      <section>
        <h2>Manage Permissions</h2>
        <form action="/forms/admin" method="get">
          <select name="formId" onchange="this.form.submit()">
            <option value="">Select Form</option>
            <% forms.forEach(function(f){ %>
              <option value="<%= f.id %>" <%= selectedFormId === f.id ? 'selected' : '' %>><%= f.name %></option>
            <% }); %>
          </select>
          <% if (isSuperAdmin) { %>
          <select name="companyId" onchange="this.form.submit()">
            <option value="">Select Company</option>
            <% allCompanies.forEach(function(c){ %>
              <option value="<%= c.id %>" <%= selectedCompanyId === c.id ? 'selected' : '' %>><%= c.name %></option>
            <% }); %>
          </select>
          <% } else { %>
          <input type="hidden" name="companyId" value="<%= currentCompanyId %>">
          <% } %>
        </form>
        <% if (selectedFormId && selectedCompanyId) { %>
          <form action="/forms/admin/permissions" method="post">
            <input type="hidden" name="formId" value="<%= selectedFormId %>">
            <input type="hidden" name="companyId" value="<%= selectedCompanyId %>">
            <% users.forEach(function(u){ %>
              <label><input type="checkbox" name="userIds" value="<%= u.user_id %>" <%= permissions.includes(u.user_id) ? 'checked' : '' %>> <%= u.email %></label><br>
            <% }); %>
            <button type="submit">Save</button>
          </form>
        <% } %>
      </section>

      <section>
        <h2>Current Permissions</h2>
        <table>
          <thead>
            <tr>
              <th>Form</th>
              <th>Company</th>
              <th>User</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <% permissionDetails.forEach(function(p){ %>
            <tr>
              <td><%= p.form_name %></td>
              <td><%= p.company_name %></td>
              <td><%= p.user_name %></td>
              <td>
                <% if (isSuperAdmin || p.company_id === currentCompanyId) { %>
                <form action="/forms/admin/permissions/remove" method="post" style="display:inline;">
                  <input type="hidden" name="formId" value="<%= p.form_id %>">
                  <input type="hidden" name="userId" value="<%= p.user_id %>">
                  <button type="submit">Remove</button>
                </form>
                <% } %>
              </td>
            </tr>
            <% }); %>
          </tbody>
        </table>
      </section>
    </div>
  </div>
</body>
</html>
