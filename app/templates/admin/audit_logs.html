{% extends "base.html" %}

{% block sidebar_menu %}
  {{ super() }}
  <li class="menu__item">
    <a href="/admin/memberships">
      <span class="menu__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-3.33 0-10 1.67-10 5v1h20v-1c0-3.33-6.67-5-10-5z"/></svg>
      </span>
      <span class="menu__label">Memberships</span>
    </a>
  </li>
  <li class="menu__item">
    <a href="/admin/roles">
      <span class="menu__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false"><path d="M10.67 3.5a1 1 0 0 1 1.66 0l1.36 2.04a1 1 0 0 0 .63.43l2.35.5a1 1 0 0 1 .54 1.68l-1.67 1.8a1 1 0 0 0-.26.74l.2 2.4a1 1 0 0 1-1.4 1l-2.2-1a1 1 0 0 0-.84 0l-2.2 1a1 1 0 0 1-1.4-1l.2-2.4a1 1 0 0 0-.26-.74L6.39 8.15a1 1 0 0 1 .54-1.68l2.35-.5a1 1 0 0 0 .63-.43z"/></svg>
      </span>
      <span class="menu__label">Roles</span>
    </a>
  </li>
  <li class="menu__item">
    <a href="/admin/audit-logs" aria-current="page">
      <span class="menu__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false"><path d="M5 4h14a1 1 0 0 1 1 1v15l-8-3-8 3V5a1 1 0 0 1 1-1z"/></svg>
      </span>
      <span class="menu__label">Audit trail</span>
    </a>
  </li>
{% endblock %}

{% block content %}
<div class="admin-grid">
  <section class="card card--panel">
    <header class="card__header card__header--stacked">
      <div>
        <h2 class="card__title">Audit trail</h2>
        <p class="card__subtitle">Every change to memberships and roles is recorded to support compliance reviews.</p>
      </div>
      <form method="get" class="filter-grid">
        <div class="form-field">
          <label class="form-label" for="filter-entity-type">Entity type</label>
          <input class="form-input" id="filter-entity-type" name="entity_type" value="{{ filters.entity_type }}" />
        </div>
        <div class="form-field">
          <label class="form-label" for="filter-entity-id">Entity ID</label>
          <input class="form-input" id="filter-entity-id" name="entity_id" value="{{ filters.entity_id }}" />
        </div>
        <div class="form-field">
          <label class="form-label" for="filter-user-id">User ID</label>
          <input class="form-input" id="filter-user-id" name="user_id" value="{{ filters.user_id }}" />
        </div>
        <div class="form-field">
          <label class="form-label" for="filter-limit">Limit</label>
          <input class="form-input" id="filter-limit" type="number" min="1" max="500" name="limit" value="{{ filters.limit }}" />
        </div>
        <div class="form-actions form-actions--inline">
          <button type="submit" class="button">Apply filters</button>
          <a class="button button--ghost" href="/admin/audit-logs">Reset</a>
        </div>
      </form>
    </header>
    <div class="table-wrapper">
      <table class="table" id="audit-log-table" data-table>
        <thead>
          <tr>
            <th scope="col" data-sort="date">Timestamp</th>
            <th scope="col" data-sort="string">Actor</th>
            <th scope="col" data-sort="string">Action</th>
            <th scope="col" data-sort="string">Entity</th>
            <th scope="col" data-sort="string">Changes</th>
          </tr>
        </thead>
        <tbody>
          {% if logs %}
            {% for log in logs %}
              <tr>
                <td data-label="Timestamp" data-utc="{{ log.created_at_iso or '' }}" data-value="{{ log.created_at_iso or '' }}">{{ log.created_at_iso or '—' }}</td>
                <td data-label="Actor">
                  {% if log.user_email %}
                    <span class="stacked"><strong>{{ log.user_email }}</strong><span class="text-muted">User #{{ log.user_id }}</span></span>
                  {% else %}
                    <span class="text-muted">System</span>
                  {% endif %}
                </td>
                <td data-label="Action">{{ log.action }}</td>
                <td data-label="Entity">
                  {% if log.entity_type %}
                    <span class="tag">{{ log.entity_type }}</span>
                    {% if log.entity_id %}
                      <span class="text-muted">#{{ log.entity_id }}</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>
                <td data-label="Changes">
                  <details class="details">
                    <summary>View</summary>
                    <div class="code-block">
                      <strong>Previous:</strong>
                      <pre>{{ log.previous_value | tojson(indent=2) }}</pre>
                      <strong>New:</strong>
                      <pre>{{ log.new_value | tojson(indent=2) }}</pre>
                      {% if log.metadata %}
                        <strong>Metadata:</strong>
                        <pre>{{ log.metadata | tojson(indent=2) }}</pre>
                      {% endif %}
                    </div>
                  </details>
                </td>
              </tr>
            {% endfor %}
          {% else %}
            <tr>
              <td colspan="5" class="table__empty">No audit records match the selected filters.</td>
            </tr>
          {% endif %}
        </tbody>
      </table>
    </div>
  </section>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/admin.js" defer></script>
{% endblock %}
