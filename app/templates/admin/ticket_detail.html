{% extends "base.html" %}

{% block content %}
  {% if success_message or error_message %}
    <div class="alert-stack">
      {% if success_message %}
        <div class="alert" role="status">{{ success_message }}</div>
      {% endif %}
      {% if error_message %}
        <div class="alert alert--error" role="alert">{{ error_message }}</div>
      {% endif %}
    </div>
  {% endif %}

  <div class="management management--single" data-layout>
    <section class="management__content">
      <header class="management__header">
        <div>
          <h1 class="management__title">{{ ticket.subject }}</h1>
          {% set ticket_status = (ticket.status or 'open') %}
          {% set status_badge_map = {
            'open': 'badge--warning',
            'in_progress': 'badge--warning',
            'pending': 'badge--warning',
            'resolved': 'badge--success',
            'closed': 'badge--muted'
          } %}
          {% set ai_badge_map = {'succeeded': 'badge--success', 'error': 'badge--danger', 'skipped': 'badge--muted', 'unknown': 'badge--muted'} %}
          {% set resolution_label_map = {'likely_resolved': 'Likely Resolved', 'likely_in_progress': 'Likely In Progress'} %}
          {% set resolution_badge_map = {'likely_resolved': 'badge--success', 'likely_in_progress': 'badge--warning'} %}
          {% set ai_status_value = ticket.ai_summary_status if ticket.ai_summary_status is not none else 'skipped' %}
          {% set ai_status_lower = ai_status_value | lower %}
          {% set ai_status_label = ai_status_lower.replace('_', ' ') | title %}
          {% set tag_status_value = ticket.ai_tags_status if ticket.ai_tags_status is not none else 'skipped' %}
          {% set tag_status_lower = tag_status_value | lower %}
          <p class="management__subtitle">
            Ticket #{{ ticket.id }}
            <span class="badge {{ status_badge_map.get(ticket_status, 'badge--muted') }}">{{ ticket_status.replace('_', ' ') }}</span>
          </p>
        </div>
        <div class="management__header-actions">
          <a href="/admin/tickets" class="button button--ghost">Back to tickets</a>
          {% if can_delete_ticket %}
            <form
              action="/admin/tickets/{{ ticket.id }}/delete"
              method="post"
              class="inline-form"
              data-confirm="Delete ticket {{ ticket.id }}? This cannot be undone."
            >
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <button type="submit" class="button button--danger">Delete ticket</button>
            </form>
          {% endif %}
        </div>
      </header>

      <div class="management__body management__body--columns">
        <div class="management__column management__column--details">
          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Ticket details</h2>
            </header>
            <form action="/admin/tickets/{{ ticket.id }}/details" method="post" class="form card__form">
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <input type="hidden" name="returnUrl" value="{{ ticket_return_url }}" />
              <div class="form-field">
                <label class="form-label" for="ticket-status-detail">Status</label>
                <select id="ticket-status-detail" name="status" class="form-input">
                  {% for status_option in ticket_available_statuses %}
                    {% set status_value = status_option.lower() %}
                    <option value="{{ status_value }}" {% if status_value == ticket_status.lower() %}selected{% endif %}>
                      {{ status_option.replace('_', ' ') }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-priority-detail">Priority</label>
                <select id="ticket-priority-detail" name="priority" class="form-input">
                  {% for priority_option in ticket_priority_options %}
                    {% set priority_value = priority_option|lower %}
                    <option value="{{ priority_value }}" {% if priority_value == (ticket.priority or 'normal')|lower %}selected{% endif %}>
                      {{ priority_option.replace('_', ' ')|title() }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-requester-detail">Requester</label>
                <select
                  id="ticket-requester-detail"
                  name="requesterId"
                  class="form-input"
                  {% if not ticket.company_id %}disabled aria-disabled="true"{% endif %}
                >
                  <option value="">Not set</option>
                  {% for requester in ticket_requester_options %}
                    <option value="{{ requester.id }}" {% if requester.id == ticket.requester_id %}selected{% endif %}>
                      {{ requester.email }}
                    </option>
                  {% endfor %}
                </select>
                {% if not ticket.company_id %}
                  <p class="form-help">Link a company before selecting a requester.</p>
                {% elif not ticket_requester_options %}
                  <p class="form-help">No enabled staff members are available for the linked company.</p>
                {% endif %}
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-assigned-detail">Assigned to</label>
                <select id="ticket-assigned-detail" name="assignedUserId" class="form-input">
                  <option value="">Unassigned</option>
                  {% for user in ticket_user_options %}
                    <option value="{{ user.id }}" {% if user.id == ticket.assigned_user_id %}selected{% endif %}>
                      {{ user.email }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-company-detail">Company</label>
                <select id="ticket-company-detail" name="companyId" class="form-input">
                  <option value="">Not linked</option>
                  {% for company_option in ticket_company_options %}
                    <option value="{{ company_option.id }}" {% if company_option.id == ticket.company_id %}selected{% endif %}>
                      {{ company_option.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-category-detail">Category</label>
                <input
                  id="ticket-category-detail"
                  name="category"
                  class="form-input"
                  maxlength="64"
                  value="{{ ticket.category or '' }}"
                  placeholder="Networking, onboarding, escalation‚Ä¶"
                />
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-reference-detail">External reference</label>
                <input
                  id="ticket-reference-detail"
                  name="externalReference"
                  class="form-input"
                  maxlength="128"
                  value="{{ ticket.external_reference or '' }}"
                  placeholder="Syncro ID or external case"
                />
              </div>
              <div class="form-actions">
                <button type="submit" class="button button--primary">Save changes</button>
              </div>
            </form>
            <div class="card__body card__body--meta">
              <dl class="definition-list">
                {% if ticket.ai_tags_status or (ticket.ai_tags is not none and ticket.ai_tags|length > 0) %}
                  <div class="definition-list__item">
                    <dt>AI Tags</dt>
                    <dd>
                      {% if tag_status_lower == 'succeeded' and ticket.ai_tags %}
                        <div class="tag-list">
                          {% for tag in ticket.ai_tags %}
                            <span class="tag">{{ tag.replace('-', ' ') }}</span>
                          {% endfor %}
                        </div>
                      {% elif tag_status_lower == 'succeeded' %}
                        <span class="card__empty">Ollama did not return tags for this ticket.</span>
                      {% elif tag_status_lower == 'skipped' %}
                        <span class="card__empty">Enable the Ollama integration module to generate tags.</span>
                      {% elif tag_status_lower == 'error' %}
                        <span class="card__empty">AI tag generation failed. Check the Ollama module logs.</span>
                      {% else %}
                        <span class="card__empty">AI tags are not currently available.</span>
                      {% endif %}
                    </dd>
                  </div>
                {% endif %}
                <div class="definition-list__item">
                  <dt>Module</dt>
                  <dd>{{ ticket_module.name if ticket_module else (ticket.module_slug or '‚Äî') }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Created</dt>
                  <dd>{{ ticket.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if ticket.created_at else '‚Äî' }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Updated</dt>
                  <dd>{{ ticket.updated_at.astimezone().strftime('%Y-%m-%d %H:%M') if ticket.updated_at else '‚Äî' }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Watchers</dt>
                  <dd>
                    {% if ticket_watchers %}
                      <ul class="list">
                        {% for watcher in ticket_watchers %}
                          {% set watcher_user = watcher.user %}
                          <li class="list__item">
                            <strong>{{ watcher_user.email if watcher_user else 'User #' ~ watcher.user_id }}</strong>
                            {% if watcher.created_at %}
                              <div class="list__meta">Watching since {{ watcher.created_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</div>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <span class="card__empty">No watchers are subscribed to this ticket.</span>
                    {% endif %}
                  </dd>
                </div>
                <div class="definition-list__item">
                  <dt>Billable minutes</dt>
                  <dd data-ticket-billable-total>{{ ticket_billable_minutes }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Non-billable minutes</dt>
                  <dd data-ticket-non-billable-total>{{ ticket_non_billable_minutes }}</dd>
                </div>
              </dl>
            </div>
          </article>
        </div>

        <div class="management__column management__column--content">
          {% set description_html = ticket.description_html if ticket.description_html is defined else '' %}
          <details class="card card--panel card-collapsible" data-ticket-description-panel>
            <summary class="card__header card__header--collapsible">
              <h2 class="card__title">Description</h2>
              <div class="card__collapsible-meta">
                <span class="card__toggle-icon" aria-hidden="true"></span>
              </div>
            </summary>
            <div class="card-collapsible__content">
              <div class="card__body">
                <p
                  class="card__empty"
                  data-ticket-description-empty
                  {% if description_html %}hidden{% endif %}
                >
                  The ticket description does not contain displayable content.
                </p>
              </div>
              <form action="/admin/tickets/{{ ticket.id }}/description" method="post" class="form card__form">
                {% if csrf_token %}
                  <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                {% endif %}
                <input type="hidden" name="returnUrl" value="{{ ticket_return_url }}" />
                <div class="form-field">
                  <textarea
                    id="ticket-description-editor"
                    name="description"
                    class="form-input form-input--textarea"
                    rows="8"
                    data-ticket-description-input
                  >{{- (ticket.description or '')|replace('\r\n', '\n')|replace('\r', '\n') -}}</textarea>
                  <p class="form-help">Share customer notes, troubleshooting steps, or context for technicians.</p>
                </div>
                <div class="form-actions">
                  <button type="submit" class="button button--primary">Save description</button>
                </div>
              </form>
            </div>
          </details>

          {% if ticket.ai_summary or ticket.ai_summary_status %}
            <article class="card card--panel" data-ticket-ai-card>
              <header class="card__header">
                <div>
                  <h2 class="card__title">AI Summary</h2>
                  <p class="card__subtitle">
                    <span class="badge {{ ai_badge_map.get(ai_status_lower, 'badge--warning') }}">{{ ai_status_label }}</span>
                    {% if ticket.ai_summary_model %}
                      <span>{{ ticket.ai_summary_model }}</span>
                    {% endif %}
                    {% if ticket.ai_summary_updated_at %}
                      <span>Updated {{ ticket.ai_summary_updated_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</span>
                    {% endif %}
                  </p>
                </div>
                  <div class="button-group">
                    <button
                      type="button"
                      class="button button--ghost button--small"
                      data-ticket-ai-replace-description
                      data-ticket-id="{{ ticket.id }}"
                      data-processing-label="Replacing description‚Ä¶"
                      aria-label="Replace the ticket description with the AI summary"
                      title="Replace the ticket description with the AI summary"
                      {% if not ticket.ai_summary %}disabled aria-disabled="true"{% endif %}
                    >
                      <span data-button-label>Replace description</span>
                    </button>
                    <button
                      type="button"
                      class="button button--ghost button--small"
                      data-ticket-ai-refresh
                      data-ticket-id="{{ ticket.id }}"
                      data-processing-label="Reprocessing AI summary and AI tags‚Ä¶"
                      aria-label="Reprocess AI summary and AI tags"
                      title="Reprocess AI summary and AI tags"
                    >
                      <span class="sr-only" data-button-label>Reprocess AI summary and AI tags</span>
                      <span class="button__icon" aria-hidden="true" data-button-icon>
                        <svg viewBox="0 0 24 24" focusable="false">
                          <path d="M12 4a8 8 0 0 1 7.75 6.11 1 1 0 0 1-1.94.46A6 6 0 1 0 17 16h1.59l-1.3-1.29a1 1 0 1 1 1.42-1.42l3 3a1 1 0 0 1 0 1.42l-3 3a1 1 0 0 1-1.42-1.42L18.59 18H17a8 8 0 1 1-5-14Z" />
                        </svg>
                      </span>
                    </button>
                  </div>
              </header>
              <p
                class="form-help"
                role="status"
                aria-live="polite"
                data-ticket-ai-status
                hidden
              ></p>
              <div class="card__body">
                {% if ai_status_lower == 'succeeded' and ticket.ai_summary %}
                  {% set resolution_label = resolution_label_map.get(ticket.ai_resolution_state) %}
                  {% if resolution_label %}
                    <p>
                      <span class="badge {{ resolution_badge_map.get(ticket.ai_resolution_state, 'badge--muted') }}">
                        {{ resolution_label }}
                      </span>
                    </p>
                  {% endif %}
                  {% set paragraphs = ticket.ai_summary.split('\n\n') %}
                  {% for paragraph in paragraphs %}
                    {% set safe_paragraph = (paragraph | e).replace('\n', '<br />') %}
                    {% if safe_paragraph %}
                      <p>{{ safe_paragraph | safe }}</p>
                    {% endif %}
                  {% endfor %}
                {% elif ai_status_lower == 'succeeded' %}
                  <p class="card__empty">Ollama did not return a summary for this ticket.</p>
                {% elif ai_status_lower == 'skipped' %}
                  <p class="card__empty">Enable the Ollama integration module to generate summaries.</p>
                {% elif ai_status_lower == 'error' %}
                  <p class="card__empty">AI summary generation failed. Check the Ollama module logs.</p>
                {% else %}
                  <p class="card__empty">AI summary is not currently available.</p>
                {% endif %}

              </div>
            </article>
          {% endif %}

          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Add a reply</h2>
            </header>
            <form action="/admin/tickets/{{ ticket.id }}/replies" method="post" class="form card__form">
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <div class="form-field">
                <span class="form-label" id="ticket-reply-label">Reply</span>
                <div
                  class="rich-text-editor"
                  data-rich-text-editor
                  aria-labelledby="ticket-reply-label"
                >
                  <div class="rich-text-editor__toolbar" role="toolbar" aria-label="Formatting options">
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="bold"
                      aria-label="Bold"
                    >
                      <span aria-hidden="true">B</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="italic"
                      aria-label="Italic"
                    >
                      <span aria-hidden="true">I</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="underline"
                      aria-label="Underline"
                    >
                      <span aria-hidden="true">U</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="insertUnorderedList"
                      aria-label="Bulleted list"
                    >
                      <span aria-hidden="true">‚Ä¢</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="insertOrderedList"
                      aria-label="Numbered list"
                    >
                      <span aria-hidden="true">1.</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="formatBlock"
                      data-command-value="blockquote"
                      aria-label="Quote"
                    >
                      <span aria-hidden="true">‚Äú‚Äù</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="formatBlock"
                      data-command-value="pre"
                      aria-label="Code block"
                    >
                      <span aria-hidden="true">&lt;/&gt;</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="link"
                      aria-label="Insert link"
                    >
                      <span aria-hidden="true">üîó</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="removeFormat"
                      aria-label="Clear formatting"
                    >
                      <span aria-hidden="true">‚®Ø</span>
                    </button>
                  </div>
                  <div
                    id="ticket-reply-body"
                    class="rich-text-editor__surface"
                    data-rich-text-content
                    contenteditable="true"
                    role="textbox"
                    aria-labelledby="ticket-reply-label"
                    aria-multiline="true"
                    data-placeholder="Write your reply..."
                  ></div>
                  <input type="hidden" name="body" data-rich-text-value required />
                </div>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-reply-minutes">Minutes spent</label>
                <input
                  id="ticket-reply-minutes"
                  name="minutesSpent"
                  class="form-input"
                  type="number"
                  min="0"
                  max="1440"
                  step="1"
                  inputmode="numeric"
                />
                <p class="form-help">Log how many minutes this update required.</p>
              </div>
              <div class="form-grid form-grid--auto">
                <div class="form-field form-field--checkbox">
                  <label class="checkbox">
                    <input type="checkbox" name="isInternal" value="true" />
                    <span>Mark as internal note</span>
                  </label>
                </div>
                <div class="form-field form-field--checkbox">
                  <label class="checkbox">
                    <input type="checkbox" name="isBillable" value="true" />
                    <span>Billable</span>
                  </label>
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="button button--primary">Post reply</button>
              </div>
            </form>
          </article>

          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Conversation history</h2>
            </header>
            <div class="card__body">
              {% if ticket_replies %}
                <div class="timeline" data-ticket-timeline data-ticket-id="{{ ticket.id }}">
                  {% for reply in ticket_replies %}
                    <article
                      class="timeline__event"
                      data-ticket-reply
                      data-reply-id="{{ reply.id }}"
                      data-reply-minutes="{{ reply.minutes_spent if reply.minutes_spent is not none else '' }}"
                      data-reply-billable="{{ 'true' if reply.is_billable else 'false' }}"
                    >
                      <header class="timeline__header">
                        <div class="timeline__header-main">
                          <span class="timeline__timestamp">
                            {{ reply.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if reply.created_at else '‚Äî' }}
                          </span>
                          <span class="timeline__action">
                            {{ reply.author.email if reply.author else 'System' }}
                            {% if reply.is_internal %}
                              <span class="badge badge--muted">Internal</span>
                            {% endif %}
                          </span>
                          <span
                            class="timeline__meta text-muted"
                            data-reply-time-summary
                            {% if not reply.time_summary %}hidden{% endif %}
                          >
                            {{ reply.time_summary or '' }}
                          </span>
                        </div>
                        <div class="timeline__header-controls">
                          <button
                            type="button"
                            class="button button--ghost button--icon timeline__edit-button"
                            data-reply-edit
                            aria-label="Edit time entry"
                            aria-controls="reply-time-modal"
                            aria-haspopup="dialog"
                            title="Edit time entry"
                          >
                            <span class="visually-hidden">Edit time entry</span>
                            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                              <path d="M20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.3a1 1 0 0 0-1.41 0L6 14.25V18h3.75l10.96-10.96Z" />
                              <path d="M5 20h14a1 1 0 1 0 0-2H5a1 1 0 1 0 0 2Z" />
                            </svg>
                          </button>
                        </div>
                      </header>
                      <div class="timeline__body">
                        <div
                          class="timeline__message"
                          data-timeline-message
                        >
                          <div
                            class="rich-text-viewer timeline__message-content"
                            data-timeline-message-content
                          >
                            {{ reply.body | safe }}
                          </div>
                        </div>
                        <button
                          type="button"
                          class="button button--ghost button--small timeline__message-toggle"
                          data-timeline-message-toggle
                          data-more-label="Show more"
                          data-less-label="Show less"
                          hidden
                          aria-expanded="false"
                        >
                          Show more
                        </button>
                      </div>
                    </article>
                  {% endfor %}
                </div>
              {% else %}
                <p class="card__empty">No replies have been posted yet.</p>
              {% endif %}
            </div>
          </article>
        </div>
      </div>
    </section>
  </div>

  <div class="modal" id="reply-time-modal" role="dialog" aria-modal="true" hidden>
    <div class="modal__content" role="document">
      <button type="button" class="modal__close" data-modal-close>
        <span class="visually-hidden">Close time entry editor</span>
        &times;
      </button>
      <h2 class="modal__title">Edit time entry</h2>
      <form class="form-grid" data-reply-time-form novalidate>
        <p class="form-help">Adjust the minutes recorded for this reply and whether the work is billable.</p>
        <div class="form-field">
          <label class="form-label" for="reply-time-minutes">Minutes spent</label>
          <input
            class="form-input"
            id="reply-time-minutes"
            type="number"
            min="0"
            max="1440"
            step="1"
            inputmode="numeric"
            data-reply-time-minutes
          />
          <p class="form-help">Leave blank to remove the time entry from this update.</p>
        </div>
        <div class="form-field form-field--checkbox">
          <label class="checkbox">
            <input type="checkbox" data-reply-time-billable />
            <span>Billable</span>
          </label>
        </div>
        <p class="form-help form-help--error" data-reply-time-error role="alert" hidden></p>
        <div class="form-actions">
          <button type="submit" class="button button--primary" data-reply-time-submit>Save changes</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/admin.js" defer></script>
  <script src="/static/js/rich_text_editor.js" defer></script>
  <script src="/static/js/ticket_detail.js" defer></script>
{% endblock %}
