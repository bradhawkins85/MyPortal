{% extends "base.html" %}

{% block content %}
  {% if success_message or error_message %}
    <div class="alert-stack">
      {% if success_message %}
        <div class="alert" role="status">{{ success_message }}</div>
      {% endif %}
      {% if error_message %}
        <div class="alert alert--error" role="alert">{{ error_message }}</div>
      {% endif %}
    </div>
  {% endif %}

  <div class="management" data-layout>
    <aside class="management__sidebar">
      <h2 class="management__heading">Ticket controls</h2>
      <p class="management__intro">Update the ticket status and review who is watching the thread.</p>
      <form action="/admin/tickets/{{ ticket.id }}/status" method="post" class="form management__form">
        {% if csrf_token %}
          <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
        {% endif %}
        <input type="hidden" name="returnUrl" value="{{ ticket_return_url }}" />
        <div class="form-field">
          <label class="form-label" for="ticket-status-detail">Status</label>
          <select id="ticket-status-detail" name="status" class="form-input">
            {% for status_option in ticket_available_statuses %}
              <option value="{{ status_option }}" {% if status_option == (ticket.status or 'open') %}selected{% endif %}>{{ status_option.replace('_', ' ') }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-actions">
          <button type="submit" class="button button--primary">Update status</button>
        </div>
      </form>

      <section class="card card--panel">
        <header class="card__header">
          <h3 class="card__title">Watchers</h3>
        </header>
        <div class="card__body">
          {% if ticket_watchers %}
            <ul class="list">
              {% for watcher in ticket_watchers %}
                {% set watcher_user = watcher.user %}
                <li class="list__item">
                  <strong>{{ watcher_user.email if watcher_user else 'User #' ~ watcher.user_id }}</strong>
                  {% if watcher.created_at %}
                    <div class="list__meta">Watching since {{ watcher.created_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</div>
                  {% endif %}
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="card__empty">No watchers are subscribed to this ticket.</p>
          {% endif %}
        </div>
      </section>
    </aside>

    <section class="management__content">
      <header class="management__header">
        <div>
          <h1 class="management__title">{{ ticket.subject }}</h1>
          {% set ticket_status = (ticket.status or 'open') %}
          {% set status_badge_map = {
            'open': 'badge--warning',
            'in_progress': 'badge--warning',
            'pending': 'badge--warning',
            'resolved': 'badge--success',
            'closed': 'badge--muted'
          } %}
          <p class="management__subtitle">
            Ticket #{{ ticket.id }}
            <span class="badge {{ status_badge_map.get(ticket_status, 'badge--muted') }}">{{ ticket_status.replace('_', ' ') }}</span>
          </p>
        </div>
        <div class="management__header-actions">
          <a href="/admin/tickets" class="button button--ghost">Back to tickets</a>
        </div>
      </header>

      <div class="management__body management__body--stacked">
        <article class="card card--panel">
          <header class="card__header">
            <h2 class="card__title">Ticket details</h2>
          </header>
          <div class="card__body">
            <dl class="definition-list">
              <div class="definition-list__item">
                <dt>Status</dt>
                <dd><span class="badge {{ status_badge_map.get(ticket_status, 'badge--muted') }}">{{ ticket_status.replace('_', ' ').title() }}</span></dd>
              </div>
              <div class="definition-list__item">
                <dt>Priority</dt>
                <dd>{{ ticket.priority or 'normal' }}</dd>
              </div>
              <div class="definition-list__item">
                <dt>Requester</dt>
                <dd>{{ ticket_requester.email if ticket_requester else '—' }}</dd>
              </div>
              <div class="definition-list__item">
                <dt>Assigned to</dt>
                <dd>{{ ticket_assigned_user.email if ticket_assigned_user else '—' }}</dd>
              </div>
              <div class="definition-list__item">
                <dt>Company</dt>
                <dd>{{ ticket_company.name if ticket_company else (ticket.company_id or '—') }}</dd>
              </div>
              <div class="definition-list__item">
                <dt>Module</dt>
                <dd>{{ ticket_module.name if ticket_module else (ticket.module_slug or '—') }}</dd>
              </div>
              <div class="definition-list__item">
                <dt>Category</dt>
                <dd>{{ ticket.category or '—' }}</dd>
              </div>
              <div class="definition-list__item">
                <dt>External reference</dt>
                <dd>{{ ticket.external_reference or '—' }}</dd>
              </div>
              <div class="definition-list__item">
                <dt>Created</dt>
                <dd>{{ ticket.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if ticket.created_at else '—' }}</dd>
              </div>
              <div class="definition-list__item">
                <dt>Updated</dt>
                <dd>{{ ticket.updated_at.astimezone().strftime('%Y-%m-%d %H:%M') if ticket.updated_at else '—' }}</dd>
              </div>
            </dl>
          </div>
        </article>

        {% if ticket.description %}
          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Description</h2>
            </header>
            <div class="card__body">
              {% set safe_description = (ticket.description | e).replace('\n', '<br />') %}
              <p>{{ safe_description | safe }}</p>
            </div>
          </article>
        {% endif %}

        <article class="card card--panel">
          <header class="card__header">
            <h2 class="card__title">Add a reply</h2>
          </header>
          <form action="/admin/tickets/{{ ticket.id }}/replies" method="post" class="form card__form">
            {% if csrf_token %}
              <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
            {% endif %}
            <div class="form-field">
              <label class="form-label" for="ticket-reply-body">Reply</label>
              <textarea id="ticket-reply-body" name="body" class="form-input" rows="4" required></textarea>
            </div>
            <div class="form-field form-field--checkbox">
              <label class="checkbox">
                <input type="checkbox" name="isInternal" value="true" />
                <span>Mark as internal note</span>
              </label>
            </div>
            <div class="form-actions">
              <button type="submit" class="button button--primary">Post reply</button>
            </div>
          </form>
        </article>

        <article class="card card--panel">
          <header class="card__header">
            <h2 class="card__title">Conversation history</h2>
          </header>
          <div class="card__body">
            {% if ticket_replies %}
              <div class="timeline">
                {% for reply in ticket_replies %}
                  <article class="timeline__event">
                    <header class="timeline__header">
                      <span class="timeline__timestamp">
                        {{ reply.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if reply.created_at else '—' }}
                      </span>
                      <span class="timeline__action">
                        {{ reply.author.email if reply.author else 'System' }}
                        {% if reply.is_internal %}
                          <span class="badge badge--muted">Internal</span>
                        {% endif %}
                      </span>
                    </header>
                    <div class="timeline__body">
                      {% set safe_body = (reply.body | e).replace('\n', '<br />') %}
                      <p>{{ safe_body | safe }}</p>
                    </div>
                  </article>
                {% endfor %}
              </div>
            {% else %}
              <p class="card__empty">No replies have been posted yet.</p>
            {% endif %}
          </div>
        </article>
      </div>
    </section>
  </div>
{% endblock %}
