{% extends "base.html" %}

{% block content %}
  {% if success_message or error_message %}
    <div class="alert-stack">
      {% if success_message %}
        <div class="alert" role="status">{{ success_message }}</div>
      {% endif %}
      {% if error_message %}
        <div class="alert alert--error" role="alert">{{ error_message }}</div>
      {% endif %}
    </div>
  {% endif %}

  <div class="management management--single" data-layout>
    <section class="management__content">
      <header class="management__header">
        <div>
          <h1 class="management__title">{{ ticket.subject }}</h1>
          {% set ticket_status = (ticket.status or 'open') %}
          {% set status_badge_map = {
            'open': 'badge--warning',
            'in_progress': 'badge--warning',
            'pending': 'badge--warning',
            'resolved': 'badge--success',
            'closed': 'badge--muted'
          } %}
          <p class="management__subtitle">
            Ticket #{{ ticket.id }}
            <span class="badge {{ status_badge_map.get(ticket_status, 'badge--muted') }}">{{ ticket_status.replace('_', ' ') }}</span>
          </p>
        </div>
        <div class="management__header-actions">
          <a href="/admin/tickets" class="button button--ghost">Back to tickets</a>
        </div>
      </header>

      <div class="management__body management__body--columns">
        <div class="management__column management__column--details">
          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Ticket details</h2>
            </header>
            <form action="/admin/tickets/{{ ticket.id }}/details" method="post" class="form card__form">
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <input type="hidden" name="returnUrl" value="{{ ticket_return_url }}" />
              <div class="form-field">
                <label class="form-label" for="ticket-status-detail">Status</label>
                <select id="ticket-status-detail" name="status" class="form-input">
                  {% for status_option in ticket_available_statuses %}
                    {% set status_value = status_option.lower() %}
                    <option value="{{ status_value }}" {% if status_value == ticket_status.lower() %}selected{% endif %}>
                      {{ status_option.replace('_', ' ') }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-priority-detail">Priority</label>
                <select id="ticket-priority-detail" name="priority" class="form-input">
                  {% for priority_option in ticket_priority_options %}
                    {% set priority_value = priority_option|lower %}
                    <option value="{{ priority_value }}" {% if priority_value == (ticket.priority or 'normal')|lower %}selected{% endif %}>
                      {{ priority_option.replace('_', ' ')|title() }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-requester-detail">Requester</label>
                <select
                  id="ticket-requester-detail"
                  name="requesterId"
                  class="form-input"
                  {% if not ticket.company_id %}disabled aria-disabled="true"{% endif %}
                >
                  <option value="">Not set</option>
                  {% for requester in ticket_requester_options %}
                    <option value="{{ requester.id }}" {% if requester.id == ticket.requester_id %}selected{% endif %}>
                      {{ requester.email }}
                    </option>
                  {% endfor %}
                </select>
                {% if not ticket.company_id %}
                  <p class="form-help">Link a company before selecting a requester.</p>
                {% elif not ticket_requester_options %}
                  <p class="form-help">No enabled staff members are available for the linked company.</p>
                {% endif %}
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-assigned-detail">Assigned to</label>
                <select id="ticket-assigned-detail" name="assignedUserId" class="form-input">
                  <option value="">Unassigned</option>
                  {% for user in ticket_user_options %}
                    <option value="{{ user.id }}" {% if user.id == ticket.assigned_user_id %}selected{% endif %}>
                      {{ user.email }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-company-detail">Company</label>
                <select id="ticket-company-detail" name="companyId" class="form-input">
                  <option value="">Not linked</option>
                  {% for company_option in ticket_company_options %}
                    <option value="{{ company_option.id }}" {% if company_option.id == ticket.company_id %}selected{% endif %}>
                      {{ company_option.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-category-detail">Category</label>
                <input
                  id="ticket-category-detail"
                  name="category"
                  class="form-input"
                  maxlength="64"
                  value="{{ ticket.category or '' }}"
                  placeholder="Networking, onboarding, escalation…"
                />
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-reference-detail">External reference</label>
                <input
                  id="ticket-reference-detail"
                  name="externalReference"
                  class="form-input"
                  maxlength="128"
                  value="{{ ticket.external_reference or '' }}"
                  placeholder="Syncro ID or external case"
                />
              </div>
              <div class="form-actions">
                <button type="submit" class="button button--primary">Save changes</button>
              </div>
            </form>
            <div class="card__body card__body--meta">
              <dl class="definition-list">
                <div class="definition-list__item">
                  <dt>Module</dt>
                  <dd>{{ ticket_module.name if ticket_module else (ticket.module_slug or '—') }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Created</dt>
                  <dd>{{ ticket.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if ticket.created_at else '—' }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Updated</dt>
                  <dd>{{ ticket.updated_at.astimezone().strftime('%Y-%m-%d %H:%M') if ticket.updated_at else '—' }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Watchers</dt>
                  <dd>
                    {% if ticket_watchers %}
                      <ul class="list">
                        {% for watcher in ticket_watchers %}
                          {% set watcher_user = watcher.user %}
                          <li class="list__item">
                            <strong>{{ watcher_user.email if watcher_user else 'User #' ~ watcher.user_id }}</strong>
                            {% if watcher.created_at %}
                              <div class="list__meta">Watching since {{ watcher.created_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</div>
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    {% else %}
                      <span class="card__empty">No watchers are subscribed to this ticket.</span>
                    {% endif %}
                  </dd>
                </div>
              </dl>
            </div>
          </article>
        </div>

        <div class="management__column management__column--content">
          {% if ticket.description %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">Description</h2>
              </header>
              <div class="card__body">
                {% set safe_description = (ticket.description | e).replace('\n', '<br />') %}
                <p>{{ safe_description | safe }}</p>
              </div>
            </article>
          {% endif %}

          {% set ai_status_value = ticket.ai_summary_status if ticket.ai_summary_status is not none else 'skipped' %}
          {% set ai_status_lower = ai_status_value | lower %}
          {% set ai_status_label = ai_status_lower.replace('_', ' ') | title %}
          {% set ai_badge_map = {'succeeded': 'badge--success', 'error': 'badge--danger', 'skipped': 'badge--muted', 'unknown': 'badge--muted'} %}
          {% set resolution_label_map = {'likely_resolved': 'Likely Resolved', 'likely_in_progress': 'Likely In Progress'} %}
          {% set resolution_badge_map = {'likely_resolved': 'badge--success', 'likely_in_progress': 'badge--warning'} %}
          {% if ticket.ai_summary or ticket.ai_summary_status %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">AI Summary</h2>
                <p class="card__subtitle">
                  <span class="badge {{ ai_badge_map.get(ai_status_lower, 'badge--warning') }}">{{ ai_status_label }}</span>
                  {% if ticket.ai_summary_model %}
                    <span>{{ ticket.ai_summary_model }}</span>
                  {% endif %}
                  {% if ticket.ai_summary_updated_at %}
                    <span>Updated {{ ticket.ai_summary_updated_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</span>
                  {% endif %}
                </p>
              </header>
              <div class="card__body">
                {% if ai_status_lower == 'succeeded' and ticket.ai_summary %}
                  {% set resolution_label = resolution_label_map.get(ticket.ai_resolution_state) %}
                  {% if resolution_label %}
                    <p>
                      <span class="badge {{ resolution_badge_map.get(ticket.ai_resolution_state, 'badge--muted') }}">
                        {{ resolution_label }}
                      </span>
                    </p>
                  {% endif %}
                  {% set paragraphs = ticket.ai_summary.split('\n\n') %}
                  {% for paragraph in paragraphs %}
                    {% set safe_paragraph = (paragraph | e).replace('\n', '<br />') %}
                    {% if safe_paragraph %}
                      <p>{{ safe_paragraph | safe }}</p>
                    {% endif %}
                  {% endfor %}
                {% elif ai_status_lower == 'succeeded' %}
                  <p class="card__empty">Ollama did not return a summary for this ticket.</p>
                {% elif ai_status_lower == 'skipped' %}
                  <p class="card__empty">Enable the Ollama integration module to generate summaries.</p>
                {% elif ai_status_lower == 'error' %}
                  <p class="card__empty">AI summary generation failed. Check the Ollama module logs.</p>
                {% else %}
                  <p class="card__empty">AI summary is not currently available.</p>
                {% endif %}
              </div>
            </article>
          {% endif %}

          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Add a reply</h2>
            </header>
            <form action="/admin/tickets/{{ ticket.id }}/replies" method="post" class="form card__form">
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <div class="form-field">
                <label class="form-label" for="ticket-reply-body">Reply</label>
                <textarea id="ticket-reply-body" name="body" class="form-input" rows="4" required></textarea>
              </div>
              <div class="form-field form-field--checkbox">
                <label class="checkbox">
                  <input type="checkbox" name="isInternal" value="true" />
                  <span>Mark as internal note</span>
                </label>
              </div>
              <div class="form-actions">
                <button type="submit" class="button button--primary">Post reply</button>
              </div>
            </form>
          </article>

          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Conversation history</h2>
            </header>
            <div class="card__body">
              {% if ticket_replies %}
                <div class="timeline">
                  {% for reply in ticket_replies %}
                    <article class="timeline__event">
                      <header class="timeline__header">
                        <span class="timeline__timestamp">
                          {{ reply.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if reply.created_at else '—' }}
                        </span>
                        <span class="timeline__action">
                          {{ reply.author.email if reply.author else 'System' }}
                          {% if reply.is_internal %}
                            <span class="badge badge--muted">Internal</span>
                          {% endif %}
                        </span>
                      </header>
                      <div class="timeline__body">
                        {% set safe_body = (reply.body | e).replace('\n', '<br />') %}
                        <p>{{ safe_body | safe }}</p>
                      </div>
                    </article>
                  {% endfor %}
                </div>
              {% else %}
                <p class="card__empty">No replies have been posted yet.</p>
              {% endif %}
            </div>
          </article>
        </div>
      </div>
    </section>
  </div>
{% endblock %}
