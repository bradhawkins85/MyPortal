{% extends "base.html" %}

{% block content %}
  <div class="management management--single" data-layout>
    <section class="management__content">
      <header class="management__header">
        <div>
          <h1 class="management__title">{{ ticket.subject }}</h1>
          {% set ticket_status = (ticket.status or 'open') %}
          {% set status_badge_map = {
            'open': 'badge--warning',
            'in_progress': 'badge--warning',
            'pending': 'badge--warning',
            'resolved': 'badge--success',
            'closed': 'badge--muted'
          } %}
          {% set ai_badge_map = {'succeeded': 'badge--success', 'error': 'badge--danger', 'skipped': 'badge--muted', 'unknown': 'badge--muted'} %}
          {% set resolution_label_map = {'likely_resolved': 'Likely Resolved', 'likely_in_progress': 'Likely In Progress'} %}
          {% set resolution_badge_map = {'likely_resolved': 'badge--success', 'likely_in_progress': 'badge--warning'} %}
          {% set ai_status_value = ticket.ai_summary_status if ticket.ai_summary_status is not none else 'skipped' %}
          {% set ai_status_lower = ai_status_value | lower %}
          {% set ai_status_label = ai_status_lower.replace('_', ' ') | title %}
          {% set tag_status_value = ticket.ai_tags_status if ticket.ai_tags_status is not none else 'skipped' %}
          {% set tag_status_lower = tag_status_value | lower %}
          {% set ticket_status_label = ticket_status_label_map.get(ticket_status, ticket_status.replace('_', ' ').title()) %}
          <p class="management__subtitle">
            Ticket #{{ ticket.id }}
            <span class="badge {{ status_badge_map.get(ticket_status, 'badge--muted') }}">{{ ticket_status_label }}</span>
          </p>
        </div>
        <div class="management__header-actions">
          <a href="/admin/tickets" class="button button--ghost">Back to tickets</a>
          {% if can_delete_ticket %}
            <form
              action="/admin/tickets/{{ ticket.id }}/delete"
              method="post"
              class="inline-form"
              data-confirm="Delete ticket {{ ticket.id }}? This cannot be undone."
            >
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <button type="submit" class="button button--danger">Delete ticket</button>
            </form>
          {% endif %}
        </div>
      </header>

      <div class="management__body management__body--columns">
        <div class="management__column management__column--details">
          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Ticket details</h2>
            </header>
            <form action="/admin/tickets/{{ ticket.id }}/details" method="post" class="form card__form">
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <input type="hidden" name="returnUrl" value="{{ ticket_return_url }}" />
              <div class="form-field">
                <label class="form-label" for="ticket-status-detail">Status</label>
                <select id="ticket-status-detail" name="status" class="form-input">
                  {% if ticket_status not in ticket_status_label_map %}
                    <option value="{{ ticket_status }}" selected>{{ ticket_status_label }}</option>
                  {% endif %}
                  {% for status_option in ticket_status_definitions %}
                    <option value="{{ status_option.tech_status }}" {% if status_option.tech_status == ticket_status %}selected{% endif %}>
                      {{ status_option.tech_label }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-priority-detail">Priority</label>
                <select id="ticket-priority-detail" name="priority" class="form-input">
                  {% for priority_option in ticket_priority_options %}
                    {% set priority_value = priority_option|lower %}
                    <option value="{{ priority_value }}" {% if priority_value == (ticket.priority or 'normal')|lower %}selected{% endif %}>
                      {{ priority_option.replace('_', ' ')|title() }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-requester-detail">Requester</label>
                <select
                  id="ticket-requester-detail"
                  name="requesterId"
                  class="form-input"
                  {% if not ticket.company_id %}disabled aria-disabled="true"{% endif %}
                >
                  <option value="">Not set</option>
                  {% for requester in ticket_requester_options %}
                    <option value="{{ requester.id }}" {% if requester.id == ticket.requester_id %}selected{% endif %}>
                      {{ requester.email }}
                    </option>
                  {% endfor %}
                </select>
                {% if not ticket.company_id %}
                  <p class="form-help">Link a company before selecting a requester.</p>
                {% elif not ticket_requester_options %}
                  <p class="form-help">No enabled staff members are available for the linked company.</p>
                {% endif %}
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-assigned-detail">Assigned to</label>
                <select id="ticket-assigned-detail" name="assignedUserId" class="form-input">
                  <option value="">Unassigned</option>
                  {% for user in ticket_user_options %}
                    <option value="{{ user.id }}" {% if user.id == ticket.assigned_user_id %}selected{% endif %}>
                      {{ user.email }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-company-detail">Company</label>
                <select id="ticket-company-detail" name="companyId" class="form-input">
                  <option value="">Not linked</option>
                  {% for company_option in ticket_company_options %}
                    <option value="{{ company_option.id }}" {% if company_option.id == ticket.company_id %}selected{% endif %}>
                      {{ company_option.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-category-detail">Category</label>
                <input
                  id="ticket-category-detail"
                  name="category"
                  class="form-input"
                  maxlength="64"
                  value="{{ ticket.category or '' }}"
                  placeholder="Networking, onboarding, escalation‚Ä¶"
                />
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-reference-detail">External reference</label>
                <input
                  id="ticket-reference-detail"
                  name="externalReference"
                  class="form-input"
                  maxlength="128"
                  value="{{ ticket.external_reference or '' }}"
                  placeholder="Syncro ID or external case"
                />
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-assets">Assets</label>
                <select
                  id="ticket-assets"
                  class="form-input"
                  data-ticket-asset-selector
                  data-assets-endpoint-template="/api/companies/{companyId}/assets"
                  data-initial-options="{{ ticket_asset_options | tojson | forceescape }}"
                  data-selected-assets="{{ ticket_asset_selection | tojson | forceescape }}"
                  data-placeholder="Select an asset to link"
                  data-initial-company-id="{{ ticket.company_id or '' }}"
                  {% if not ticket.company_id %}disabled aria-disabled="true"{% endif %}
                >
                  <option value="">Select an asset to link</option>
                  {% for option in ticket_asset_options %}
                    <option value="{{ option.id }}">{{ option.label }}</option>
                  {% endfor %}
                </select>
                <p
                  class="form-help"
                  data-ticket-asset-help
                  data-help-enabled="Choose an asset to link. Linked devices appear below."
                  data-help-disabled="Link the ticket to a company before selecting assets."
                  data-help-empty="No assets are available for the linked company."
                  data-help-exhausted="All company assets are already linked to this ticket."
                >
                  {% if not ticket.company_id %}
                    Link the ticket to a company before selecting assets.
                  {% elif not ticket_asset_options %}
                    No assets are available for the linked company.
                  {% else %}
                    Choose an asset to link. Linked devices appear below.
                  {% endif %}
                </p>
                <div
                  class="ticket-assets-linked"
                  data-ticket-linked-assets
                  data-initial-linked="{{ ticket_asset_linked_data | tojson | forceescape }}"
                  data-tactical-base-url="{{ tacticalrmm_base_url or '' }}"
                  data-empty-message="No assets are linked to this ticket yet."
                >
                  <ul class="ticket-assets-linked__list" data-linked-assets-list>
                    {% for asset in ticket_assets %}
                      {% set serial_value = asset.serial_number %}
                      {% set status_value = asset.status %}
                      {% set status_label = status_value.replace('_', ' ').title() if status_value %}
                      {% set meta_parts = [] %}
                      {% if status_label %}
                        {% set _ = meta_parts.append(status_label) %}
                      {% endif %}
                      {% set base_name = asset.name or ('Asset ' ~ asset.asset_id) %}
                      {% set display_name = base_name | trim %}
                      {% if not display_name %}
                        {% set display_name = 'Asset ' ~ asset.asset_id %}
                      {% endif %}
                      {% set tooltip_label = display_name %}
                      {% if meta_parts %}
                        {% set tooltip_label = display_name ~ ' ¬∑ ' ~ (meta_parts | join(' ¬∑ ')) %}
                      {% endif %}
                      {% set tactical_link = None %}
                      {% if tacticalrmm_base_url and asset.tactical_asset_id %}
                        {% set tactical_link = tacticalrmm_base_url ~ '/web/agents/' ~ (asset.tactical_asset_id | urlencode) %}
                      {% endif %}
                      <li
                        class="ticket-assets-linked__item"
                        data-linked-asset
                        data-asset-id="{{ asset.asset_id }}"
                        data-tactical-id="{{ asset.tactical_asset_id or '' }}"
                      >
                        <input type="hidden" name="assetIds" value="{{ asset.asset_id }}" />
                        {% if tactical_link %}
                          <a
                            href="{{ tactical_link }}"
                            target="_blank"
                            rel="noreferrer noopener"
                            class="ticket-assets-linked__name"
                            data-linked-asset-name
                            title="{{ tooltip_label }}"
                          >
                            {{ display_name }}
                          </a>
                        {% else %}
                          <span class="ticket-assets-linked__name" data-linked-asset-name title="{{ tooltip_label }}">
                            {{ display_name }}
                          </span>
                        {% endif %}
                        {% if meta_parts %}
                          <p class="ticket-assets-linked__meta">{{ meta_parts | join(' ¬∑ ') }}</p>
                        {% endif %}
                        <button
                          type="button"
                          class="button button--ghost button--icon ticket-assets-linked__remove"
                          data-linked-asset-remove
                        >
                          <span class="visually-hidden">Remove asset</span>
                          √ó
                        </button>
                      </li>
                    {% endfor %}
                  </ul>
                  <p class="ticket-assets-linked__empty" data-linked-assets-empty {% if ticket_assets %}hidden{% endif %}>
                    No assets are linked to this ticket yet.
                  </p>
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="button button--primary">Save changes</button>
              </div>
            </form>
          </article>

          {% if relevant_services %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">Related Service Status</h2>
              </header>
              <div class="card__body">
                <ul class="list">
                  {% for service in relevant_services %}
                    {% set status_meta = service_status_lookup.get(service.status) %}
                    {% set status_variant = status_meta.variant if status_meta else 'status--neutral' %}
                    {% set status_label = status_meta.label if status_meta else (service.status | replace('_', ' ') | title) %}
                    <li class="list__item">
                      <div style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
                        <div style="flex: 1;">
                          <strong>{{ service.name }}</strong>
                          {% if service.description %}
                            <div class="list__meta">{{ service.description }}</div>
                          {% endif %}
                        </div>
                        <div style="display: flex; align-items: center; gap: 0.5rem;">
                          <span class="status {{ status_variant }}">{{ status_label }}</span>
                        </div>
                      </div>
                      {% if service.status_message %}
                        <div class="list__meta" style="margin-top: 0.5rem;">
                          {{ service.status_message }}
                        </div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </article>
          {% endif %}

          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Additional details</h2>
            </header>
            <div class="card__body card__body--meta">
              <dl class="definition-list">
                {% if ticket.ai_tags_status or (ticket.ai_tags is not none and ticket.ai_tags|length > 0) %}
                  <div class="definition-list__item">
                    <dt>AI Tags</dt>
                    <dd>
                      {% if tag_status_lower == 'succeeded' and ticket.ai_tags %}
                        <div class="tag-list" id="ai-tags-container">
                          {% for tag in ticket.ai_tags %}
                            <span class="tag" data-tag-slug="{{ tag }}">
                              {{ tag.replace('-', ' ') }}
                              {% if is_super_admin %}
                                <button 
                                  type="button" 
                                  class="tag__remove" 
                                  onclick="removeTag('{{ tag }}')"
                                  aria-label="Remove tag {{ tag }}"
                                  title="Remove this tag"
                                >√ó</button>
                              {% endif %}
                            </span>
                          {% endfor %}
                        </div>
                      {% elif tag_status_lower == 'succeeded' %}
                        <span class="card__empty">Ollama did not return tags for this ticket.</span>
                      {% elif tag_status_lower == 'skipped' %}
                        <span class="card__empty">Enable the Ollama integration module to generate tags.</span>
                      {% elif tag_status_lower == 'error' %}
                        <span class="card__empty">AI tag generation failed. Check the Ollama module logs.</span>
                      {% else %}
                        <span class="card__empty">AI tags are not currently available.</span>
                      {% endif %}
                    </dd>
                  </div>
                {% endif %}
                <div class="definition-list__item">
                  <dt>Module</dt>
                  <dd>{{ ticket_module.name if ticket_module else (ticket.module_slug or '‚Äî') }}</dd>
                </div>
                {% if ticket_assets %}
                  <div class="definition-list__item">
                    <dt>Assets</dt>
                    <dd>
                      <div class="tag-list">
                        {% for asset in ticket_assets %}
                      {% set asset_label = asset.name %}
                          <span class="tag">{{ asset_label }}</span>
                        {% endfor %}
                      </div>
                    </dd>
                  </div>
                {% endif %}
                <div class="definition-list__item">
                  <dt>Created</dt>
                  <dd>{{ ticket.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if ticket.created_at else '‚Äî' }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Updated</dt>
                  <dd>{{ ticket.updated_at.astimezone().strftime('%Y-%m-%d %H:%M') if ticket.updated_at else '‚Äî' }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Watchers</dt>
                  <dd>
                    <div data-watchers-container>
                      {% if ticket_watchers %}
                        <ul class="list" data-watchers-list>
                          {% for watcher in ticket_watchers %}
                            {% set watcher_user = watcher.user %}
                            {% set watcher_email = watcher.email %}
                            {% set display_text = watcher_user.email if watcher_user else (watcher_email if watcher_email else 'User #' ~ watcher.user_id) %}
                            <li class="list__item" data-watcher-item 
                                data-user-id="{{ watcher.user_id if watcher.user_id else '' }}"
                                data-watcher-email="{{ watcher_email if watcher_email else '' }}">
                              <div style="display: flex; align-items: center; justify-content: space-between;">
                                <div>
                                  <strong>{{ display_text }}</strong>
                                  {% if watcher.created_at %}
                                    <div class="list__meta">Watching since {{ watcher.created_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</div>
                                  {% endif %}
                                </div>
                                <button
                                  type="button"
                                  class="button button--small button--ghost"
                                  data-remove-watcher
                                  data-user-id="{{ watcher.user_id if watcher.user_id else '' }}"
                                  data-watcher-email="{{ watcher_email if watcher_email else '' }}"
                                  data-user-display="{{ display_text }}"
                                  title="Remove watcher"
                                >
                                  Remove
                                </button>
                              </div>
                            </li>
                          {% endfor %}
                        </ul>
                      {% else %}
                        <ul class="list" data-watchers-list style="display: none;"></ul>
                        <span class="card__empty" data-watchers-empty>No watchers are subscribed to this ticket.</span>
                      {% endif %}
                      <div style="margin-top: 12px; display: flex; gap: 8px; align-items: flex-start; flex-direction: column;">
                        <div style="display: flex; gap: 8px; align-items: center; width: 100%;">
                          <select class="form-input" data-watcher-select style="flex: 1;">
                            <option value="">Select a staff member to add...</option>
                            {% if ticket_watcher_staff_options %}
                              {% for staff_user in ticket_watcher_staff_options %}
                                {% set is_watching = namespace(value=false) %}
                                {% for watcher in ticket_watchers %}
                                  {% if watcher.user_id == staff_user.id %}
                                    {% set is_watching.value = true %}
                                  {% endif %}
                                {% endfor %}
                                {% if not is_watching.value %}
                                  <option value="{{ staff_user.id }}">{{ staff_user.email }}</option>
                                {% endif %}
                              {% endfor %}
                            {% endif %}
                          </select>
                          <button
                            type="button"
                            class="button button--primary"
                            data-add-watcher
                            disabled
                          >
                            Add
                          </button>
                        </div>
                        {% if ticket.company_id %}
                          <div style="display: flex; gap: 8px; align-items: center; width: 100%;">
                            <input
                              type="email"
                              class="form-input"
                              data-watcher-email-input
                              placeholder="Or enter email address..."
                              style="flex: 1;"
                            />
                            <button
                              type="button"
                              class="button button--primary"
                              data-add-watcher-email
                              disabled
                            >
                              Add
                            </button>
                          </div>
                          <p class="form-help" style="margin-top: 4px;">
                            Add company staff from the dropdown, or enter any email address to notify them about ticket updates.
                          </p>
                        {% else %}
                          <p class="form-help" style="margin-top: 4px;">
                            Link a company to this ticket to add watchers from the company staff.
                          </p>
                        {% endif %}
                      </div>
                    </div>
                  </dd>
                </div>
                <div class="definition-list__item">
                  <dt>Billable minutes</dt>
                  <dd data-ticket-billable-total>{{ ticket_billable_minutes }}</dd>
                </div>
                <div class="definition-list__item">
                  <dt>Non-billable minutes</dt>
                  <dd data-ticket-non-billable-total>{{ ticket_non_billable_minutes }}</dd>
                </div>
              </dl>
            </div>
          </article>

          {% if ticket_assigned_user and ticket_assigned_user.booking_link_url %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">Book a Call</h2>
              </header>
              <div class="card__body">
                <p class="text-muted" style="margin-bottom: 1rem;">
                  Schedule a call with {{ ticket_assigned_user.email }} to discuss this ticket.
                </p>
                <button
                  data-cal-link="{{ ticket_assigned_user.booking_link_url }}"
                  data-cal-namespace="ticket-booking-{{ ticket.id }}"
                  data-ticket-id="{{ ticket.id }}"
                  data-ticket-subject="{{ ticket.subject | e }}"
                  data-user-name="{{ user.first_name or '' }} {{ user.last_name or '' }}"
                  data-user-email="{{ user.email or '' }}"
                  data-user-phone="{{ user.mobile_phone or '' }}"
                  class="button button--primary"
                >
                  Book a Call
                </button>
              </div>
            </article>
          {% endif %}

          {% if ticket.xero_invoice_number %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">Xero Invoice</h2>
              </header>
              <div class="card__body">
                <dl class="definition-list definition-list--vertical">
                  <div class="definition-list__item">
                    <dt>Invoice Number</dt>
                    <dd>
                      <strong>{{ ticket.xero_invoice_number }}</strong>
                    </dd>
                  </div>
                  {% if ticket.billed_at %}
                  <div class="definition-list__item">
                    <dt>Billed At</dt>
                    <dd>{{ ticket.billed_at.strftime('%Y-%m-%d %H:%M') if ticket.billed_at }}</dd>
                  </div>
                  {% endif %}
                </dl>
                <p class="card__help" style="margin-top: 1rem;">
                  This ticket has been billed and closed. No further time can be added.
                </p>
              </div>
            </article>
          {% endif %}

          {% if relevant_kb_articles %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">Related Knowledge Base Articles</h2>
              </header>
              <div class="card__body">
                <ul class="list">
                  {% for article in relevant_kb_articles %}
                    <li class="list__item">
                      <a href="/knowledge-base?slug={{ article.slug }}" target="_blank" rel="noopener noreferrer">
                        <strong>{{ article.title }}</strong>
                      </a>
                      {% if article.summary %}
                        <div class="list__meta">{{ article.summary }}</div>
                      {% endif %}
                      {% if article.matching_tags_count %}
                        <div class="list__meta">
                          <span class="badge badge--muted">{{ article.matching_tags_count }} matching tag{{ 's' if article.matching_tags_count > 1 else '' }}</span>
                        </div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </article>
          {% endif %}
        </div>

        <div class="management__column management__column--content">
          {% set description_html = ticket.description_html if ticket.description_html is defined else '' %}
          <details class="card card--panel card-collapsible" data-ticket-description-panel>
            <summary class="card__header card__header--collapsible">
              <h2 class="card__title">Description</h2>
              <div class="card__collapsible-meta">
                <span class="card__toggle-icon" aria-hidden="true"></span>
              </div>
            </summary>
            <div class="card-collapsible__content">
              <div class="card__body">
                <p
                  class="card__empty"
                  data-ticket-description-empty
                  {% if description_html %}hidden{% endif %}
                >
                  The ticket description does not contain displayable content.
                </p>
              </div>
              <form action="/admin/tickets/{{ ticket.id }}/description" method="post" class="form card__form">
                {% if csrf_token %}
                  <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                {% endif %}
                <input type="hidden" name="returnUrl" value="{{ ticket_return_url }}" />
                <div class="form-field">
                  <textarea
                    id="ticket-description-editor"
                    name="description"
                    class="form-input form-input--textarea"
                    rows="8"
                    data-ticket-description-input
                  >{{- (ticket.description or '')|replace('\r\n', '\n')|replace('\r', '\n') -}}</textarea>
                  <p class="form-help">Share customer notes, troubleshooting steps, or context for technicians.</p>
                </div>
                <div class="form-actions">
                  <button type="submit" class="button button--primary">Save description</button>
                </div>
              </form>
            </div>
          </details>

          {% if ticket.ai_summary or ticket.ai_summary_status %}
            <details class="card card--panel card-collapsible" data-ticket-ai-card open>
              <summary class="card__header card__header--collapsible">
                <div>
                  <h2 class="card__title">AI Summary</h2>
                  <p class="card__subtitle">
                    <span class="badge {{ ai_badge_map.get(ai_status_lower, 'badge--warning') }}">{{ ai_status_label }}</span>
                    {% if ticket.ai_summary_model %}
                      <span>{{ ticket.ai_summary_model }}</span>
                    {% endif %}
                    {% if ticket.ai_summary_updated_at %}
                      <span>Updated {{ ticket.ai_summary_updated_at.astimezone().strftime('%Y-%m-%d %H:%M') }}</span>
                    {% endif %}
                  </p>
                </div>
                <div class="card__collapsible-meta">
                  <div class="button-group">
                    <button
                      type="button"
                      class="button button--ghost button--small"
                      data-ticket-ai-replace-description
                      data-ticket-id="{{ ticket.id }}"
                      data-processing-label="Replacing description‚Ä¶"
                      aria-label="Replace the ticket description with the AI summary"
                      title="Replace the ticket description with the AI summary"
                      {% if not ticket.ai_summary %}disabled aria-disabled="true"{% endif %}
                    >
                      <span data-button-label>Replace description</span>
                    </button>
                    <button
                      type="button"
                      class="button button--ghost button--small"
                      data-ticket-ai-refresh
                      data-ticket-id="{{ ticket.id }}"
                      data-processing-label="Reprocessing AI summary and AI tags‚Ä¶"
                      aria-label="Reprocess AI summary and AI tags"
                      title="Reprocess AI summary and AI tags"
                    >
                      <span class="sr-only" data-button-label>Reprocess AI summary and AI tags</span>
                      <span class="button__icon" aria-hidden="true" data-button-icon>
                        <svg viewBox="0 0 24 24" focusable="false">
                          <path d="M12 4a8 8 0 0 1 7.75 6.11 1 1 0 0 1-1.94.46A6 6 0 1 0 17 16h1.59l-1.3-1.29a1 1 0 1 1 1.42-1.42l3 3a1 1 0 0 1 0 1.42l-3 3a1 1 0 0 1-1.42-1.42L18.59 18H17a8 8 0 1 1-5-14Z" />
                        </svg>
                      </span>
                    </button>
                  </div>
                  <span class="card__toggle-icon" aria-hidden="true"></span>
                </div>
              </summary>
              <div class="card-collapsible__content">
                <p
                  class="form-help"
                  role="status"
                  aria-live="polite"
                  data-ticket-ai-status
                  hidden
                ></p>
                <div class="card__body">
                  {% if ai_status_lower == 'succeeded' and ticket.ai_summary %}
                    {% set resolution_label = resolution_label_map.get(ticket.ai_resolution_state) %}
                    {% if resolution_label %}
                      <p>
                        <span class="badge {{ resolution_badge_map.get(ticket.ai_resolution_state, 'badge--muted') }}">
                          {{ resolution_label }}
                        </span>
                      </p>
                    {% endif %}
                    {% set paragraphs = ticket.ai_summary.split('\n\n') %}
                    {% for paragraph in paragraphs %}
                      {% set safe_paragraph = (paragraph | e).replace('\n', '<br />') %}
                      {% if safe_paragraph %}
                        <p>{{ safe_paragraph | safe }}</p>
                      {% endif %}
                    {% endfor %}
                  {% elif ai_status_lower == 'succeeded' %}
                    <p class="card__empty">Ollama did not return a summary for this ticket.</p>
                  {% elif ai_status_lower == 'skipped' %}
                    <p class="card__empty">Enable the Ollama integration module to generate summaries.</p>
                  {% elif ai_status_lower == 'error' %}
                    <p class="card__empty">AI summary generation failed. Check the Ollama module logs.</p>
                  {% else %}
                    <p class="card__empty">AI summary is not currently available.</p>
                  {% endif %}

                </div>
              </div>
            </details>
          {% endif %}

          <details class="card card--panel card-collapsible" data-ticket-tasks-card>
            <summary class="card__header card__header--collapsible">
              <h2 class="card__title">Tasks <span data-tasks-count-badge hidden></span></h2>
              <div class="card__collapsible-meta">
                <div class="button-group">
                  <button
                    type="button"
                    class="button button--ghost button--small"
                    data-add-task-button
                    data-ticket-id="{{ ticket.id }}"
                    aria-label="Add a new task"
                  >
                    Add task
                  </button>
                </div>
                <span class="card__toggle-icon" aria-hidden="true"></span>
              </div>
            </summary>
            <div class="card-collapsible__content">
              <div class="card__body">
                <ul class="task-list" data-task-list data-ticket-id="{{ ticket.id }}">
                  <!-- Tasks will be loaded dynamically -->
                </ul>
                <p class="card__empty" data-tasks-empty hidden>No tasks have been added yet.</p>
              </div>
            </div>
          </details>

          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Add a reply</h2>
            </header>
            <form action="/admin/tickets/{{ ticket.id }}/replies" method="post" class="form card__form">
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <div class="form-field">
                <span class="form-label" id="ticket-reply-label">Reply</span>
                <div
                  class="rich-text-editor"
                  data-rich-text-editor
                  aria-labelledby="ticket-reply-label"
                >
                  <div class="rich-text-editor__toolbar" role="toolbar" aria-label="Formatting options">
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="bold"
                      aria-label="Bold"
                    >
                      <span aria-hidden="true">B</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="italic"
                      aria-label="Italic"
                    >
                      <span aria-hidden="true">I</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="underline"
                      aria-label="Underline"
                    >
                      <span aria-hidden="true">U</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="insertUnorderedList"
                      aria-label="Bulleted list"
                    >
                      <span aria-hidden="true">‚Ä¢</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="insertOrderedList"
                      aria-label="Numbered list"
                    >
                      <span aria-hidden="true">1.</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="formatBlock"
                      data-command-value="blockquote"
                      aria-label="Quote"
                    >
                      <span aria-hidden="true">‚Äú‚Äù</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="formatBlock"
                      data-command-value="pre"
                      aria-label="Code block"
                    >
                      <span aria-hidden="true">&lt;/&gt;</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="link"
                      aria-label="Insert link"
                    >
                      <span aria-hidden="true">üîó</span>
                    </button>
                    <button
                      type="button"
                      class="rich-text-editor__button"
                      data-rich-text-button
                      data-command="removeFormat"
                      aria-label="Clear formatting"
                    >
                      <span aria-hidden="true">‚®Ø</span>
                    </button>
                  </div>
                  <div
                    id="ticket-reply-body"
                    class="rich-text-editor__surface"
                    data-rich-text-content
                    contenteditable="true"
                    role="textbox"
                    aria-labelledby="ticket-reply-label"
                    aria-multiline="true"
                    data-placeholder="Write your reply..."
                  ></div>
                  <input type="hidden" name="body" data-rich-text-value required />
                </div>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-reply-minutes">Minutes spent</label>
                <input
                  id="ticket-reply-minutes"
                  name="minutesSpent"
                  class="form-input"
                  type="number"
                  min="0"
                  max="1440"
                  step="1"
                  inputmode="numeric"
                />
                <p class="form-help">Log how many minutes this update required.</p>
              </div>
              <div class="form-field">
                <label class="form-label" for="ticket-reply-labour">Labour type</label>
                <select id="ticket-reply-labour" name="labourTypeId" class="form-input">
                  <option value="">No labour type</option>
                  {% for labour_type in ticket_labour_types %}
                    <option value="{{ labour_type.id }}">
                      {{ labour_type.name }}{% if labour_type.code %} ({{ labour_type.code }}){% endif %}
                    </option>
                  {% endfor %}
                </select>
                <p class="form-help">Select the labour code to synchronise with Xero invoices.</p>
              </div>
              <div class="form-grid form-grid--auto">
                <div class="form-field form-field--checkbox">
                  <label class="checkbox">
                    <input type="checkbox" name="isInternal" value="true" />
                    <span>Mark as internal note</span>
                  </label>
                </div>
                <div class="form-field form-field--checkbox">
                  <label class="checkbox">
                    <input type="checkbox" name="isBillable" value="true" />
                    <span>Billable</span>
                  </label>
                </div>
              </div>
              <div class="form-actions">
                <button type="submit" class="button button--primary">Post reply</button>
              </div>
            </form>
          </article>

          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Conversation history</h2>
            </header>
            <div class="card__body">
              {% if ticket_replies or ticket_call_recordings %}
                <div class="timeline" data-ticket-timeline data-ticket-id="{{ ticket.id }}">
                  {% for reply in ticket_replies %}
                    <article
                      class="timeline__event"
                      data-ticket-reply
                  data-reply-id="{{ reply.id }}"
                  data-reply-minutes="{{ reply.minutes_spent if reply.minutes_spent is not none else '' }}"
                  data-reply-billable="{{ 'true' if reply.is_billable else 'false' }}"
                  data-reply-labour="{{ reply.labour_type_id if reply.labour_type_id is not none else '' }}"
                >
                      <header class="timeline__header">
                        <div class="timeline__header-main">
                          <span class="timeline__timestamp">
                            {{ reply.created_at.astimezone().strftime('%Y-%m-%d %H:%M') if reply.created_at else '‚Äî' }}
                          </span>
                          <span class="timeline__action">
                            {{ reply.author.email if reply.author else 'System' }}
                            {% if reply.is_internal %}
                              <span class="badge badge--muted">Internal</span>
                            {% endif %}
                            {% if reply.has_email_tracking %}
                              {% if reply.is_email_opened %}
                                <span class="badge badge--success" title="Email opened {{ reply.email_open_count }} time{{ 's' if reply.email_open_count > 1 else '' }}">‚úì Read</span>
                              {% else %}
                                <span class="badge badge--muted" title="Email sent, not yet opened">üìß Sent</span>
                              {% endif %}
                            {% endif %}
                          </span>
                          <span
                            class="timeline__meta text-muted"
                            data-reply-time-summary
                            {% if not reply.time_summary %}hidden{% endif %}
                          >
                            {{ reply.time_summary or '' }}
                          </span>
                        </div>
                        <div class="timeline__header-controls">
                          <button
                            type="button"
                            class="button button--ghost button--icon timeline__edit-button"
                            data-reply-edit
                            aria-label="Edit time entry"
                            aria-controls="reply-time-modal"
                            aria-haspopup="dialog"
                            title="Edit time entry"
                          >
                            <span class="visually-hidden">Edit time entry</span>
                            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                              <path d="M20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.3a1 1 0 0 0-1.41 0L6 14.25V18h3.75l10.96-10.96Z" />
                              <path d="M5 20h14a1 1 0 1 0 0-2H5a1 1 0 1 0 0 2Z" />
                            </svg>
                          </button>
                        </div>
                      </header>
                      <div class="timeline__body">
                        <div
                          class="timeline__message"
                          data-timeline-message
                        >
                          <div
                            class="rich-text-viewer timeline__message-content"
                            data-timeline-message-content
                          >
                            {{ reply.body | safe }}
                          </div>
                        </div>
                        <button
                          type="button"
                          class="button button--ghost button--small timeline__message-toggle"
                          data-timeline-message-toggle
                          data-more-label="Show more"
                          data-less-label="Show less"
                          hidden
                          aria-expanded="false"
                        >
                          Show more
                        </button>
                      </div>
                    </article>
                  {% endfor %}
                  
                  {% for recording in ticket_call_recordings %}
                    <article
                      class="timeline__event timeline__event--call-recording"
                      data-call-recording
                      data-recording-id="{{ recording.id }}"
                      data-recording-minutes="{{ recording.minutes_spent if recording.minutes_spent is not none else '' }}"
                      data-recording-billable="{{ 'true' if recording.is_billable else 'false' }}"
                      data-recording-labour="{{ recording.labour_type_id if recording.labour_type_id is not none else '' }}"
                    >
                      <header class="timeline__header">
                        <div class="timeline__header-main">
                          <span class="timeline__timestamp">
                            {{ recording.call_date.astimezone().strftime('%Y-%m-%d %H:%M') if recording.call_date else '‚Äî' }}
                          </span>
                          <span class="timeline__action">
                            <strong>üìû Call Recording:</strong> {{ recording.caller_name or 'Unknown' }} ‚Üí {{ recording.callee_name or 'Unknown' }}
                          </span>
                          <span
                            class="timeline__meta text-muted"
                            data-recording-time-summary
                            {% if not recording.time_summary %}hidden{% endif %}
                          >
                            {{ recording.time_summary or '' }}
                          </span>
                        </div>
                        <div class="timeline__header-controls">
                          <button
                            type="button"
                            class="button button--ghost button--icon timeline__edit-button"
                            data-recording-edit
                            aria-label="Edit time entry"
                            aria-controls="recording-time-modal"
                            aria-haspopup="dialog"
                            title="Edit time entry"
                          >
                            <span class="visually-hidden">Edit time entry</span>
                            <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                              <path d="M20.71 7.04a1 1 0 0 0 0-1.41L18.37 3.3a1 1 0 0 0-1.41 0L6 14.25V18h3.75l10.96-10.96Z" />
                              <path d="M5 20h14a1 1 0 1 0 0-2H5a1 1 0 1 0 0 2Z" />
                            </svg>
                          </button>
                        </div>
                      </header>
                      <div class="timeline__body">
                        <div class="timeline__message" data-timeline-message>
                          <p><strong>File:</strong> {{ recording.file_name }}</p>
                          {% if recording.duration_seconds %}
                            <p><strong>Duration:</strong> {{ recording.duration_seconds }} seconds</p>
                          {% endif %}
                          {% if recording.transcription %}
                            <div class="timeline__message-content" data-timeline-message-content>
                              <p><strong>Transcription:</strong></p>
                              <div class="rich-text-viewer">{{ recording.transcription }}</div>
                            </div>
                            <button
                              type="button"
                              class="button button--ghost button--small timeline__message-toggle"
                              data-timeline-message-toggle
                              data-more-label="Show transcription"
                              data-less-label="Hide transcription"
                              hidden
                              aria-expanded="false"
                            >
                              Show transcription
                            </button>
                          {% else %}
                            <p class="text-muted">No transcription available.</p>
                          {% endif %}
                        </div>
                      </div>
                    </article>
                  {% endfor %}
                </div>
              {% else %}
                <p class="card__empty">No replies or call recordings have been posted yet.</p>
              {% endif %}
            </div>
          </article>
        </div>
      </div>
    </section>
  </div>

  <div class="modal" id="reply-time-modal" role="dialog" aria-modal="true" hidden>
    <div class="modal__content" role="document">
      <button type="button" class="modal__close" data-modal-close>
        <span class="visually-hidden">Close time entry editor</span>
        &times;
      </button>
      <h2 class="modal__title">Edit time entry</h2>
      <form class="form-grid" data-reply-time-form novalidate>
        <p class="form-help">Adjust the minutes recorded for this reply and whether the work is billable.</p>
        <div class="form-field">
          <label class="form-label" for="reply-time-minutes">Minutes spent</label>
          <input
            class="form-input"
            id="reply-time-minutes"
            type="number"
            min="0"
            max="1440"
            step="1"
            inputmode="numeric"
            data-reply-time-minutes
          />
          <p class="form-help">Leave blank to remove the time entry from this update.</p>
        </div>
        <div class="form-field form-field--checkbox">
          <label class="checkbox">
            <input type="checkbox" data-reply-time-billable />
            <span>Billable</span>
          </label>
        </div>
        <div class="form-field">
          <label class="form-label" for="reply-time-labour">Labour type</label>
          <select id="reply-time-labour" class="form-input" data-reply-time-labour>
            <option value="">No labour type</option>
            {% for labour_type in ticket_labour_types %}
              <option value="{{ labour_type.id }}">
                {{ labour_type.name }}{% if labour_type.code %} ({{ labour_type.code }}){% endif %}
              </option>
            {% endfor %}
          </select>
        </div>
        <p class="form-help form-help--error" data-reply-time-error role="alert" hidden></p>
        <div class="form-actions">
          <button type="submit" class="button button--primary" data-reply-time-submit>Save changes</button>
        </div>
      </form>
    </div>
  </div>
  
  <div class="modal" id="recording-time-modal" role="dialog" aria-modal="true" hidden>
    <div class="modal__content" role="document">
      <button type="button" class="modal__close" data-modal-close>
        <span class="visually-hidden">Close time entry editor</span>
        &times;
      </button>
      <h2 class="modal__title">Edit call recording time entry</h2>
      <form class="form-grid" data-recording-time-form novalidate>
        <p class="form-help">Adjust the minutes recorded for this call and whether the work is billable.</p>
        <div class="form-field">
          <label class="form-label" for="recording-time-minutes">Minutes spent</label>
          <input
            class="form-input"
            id="recording-time-minutes"
            type="number"
            min="0"
            max="1440"
            step="1"
            inputmode="numeric"
            data-recording-time-minutes
          />
          <p class="form-help">Leave blank to remove the time entry from this call recording.</p>
        </div>
        <div class="form-field form-field--checkbox">
          <label class="checkbox">
            <input type="checkbox" data-recording-time-billable />
            <span>Billable</span>
          </label>
        </div>
        <div class="form-field">
          <label class="form-label" for="recording-time-labour">Labour type</label>
          <select id="recording-time-labour" class="form-input" data-recording-time-labour>
            <option value="">No labour type</option>
            {% for labour_type in ticket_labour_types %}
              <option value="{{ labour_type.id }}">
                {{ labour_type.name }}{% if labour_type.code %} ({{ labour_type.code }}){% endif %}
              </option>
            {% endfor %}
          </select>
        </div>
        <p class="form-help form-help--error" data-recording-time-error role="alert" hidden></p>
        <div class="form-actions">
          <button type="submit" class="button button--primary" data-recording-time-submit>Save changes</button>
        </div>
      </form>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/admin.js" defer></script>
  <script src="/static/js/rich_text_editor.js" defer></script>
  <script src="/static/js/ticket_detail.js" defer></script>
  {% if ticket_assigned_user and ticket_assigned_user.booking_link_url %}
    <!-- Cal.com embed initialization script -->
    <!-- This script dynamically loads the Cal.com embed library and initializes it for inline booking -->
    <!-- Documentation: https://cal.com/docs/platform/embed/inline -->
    <script>
      (function (C, A, L) {
        let p = function (a, ar) {
          a.q.push(ar);
        };
        let d = C.document;
        C.Cal = C.Cal || function () {
          let cal = C.Cal;
          let ar = arguments;
          if (!cal.loaded) {
            cal.ns = {};
            cal.q = cal.q || [];
            d.head.appendChild(d.createElement("script")).src = A;
            cal.loaded = true;
          }
          if (ar[0] === L) {
            const api = function () {
              p(api, arguments);
            };
            const namespace = ar[1];
            api.q = api.q || [];
            typeof namespace === "string" ? (cal.ns[namespace] = api) && p(api, ar) : p(cal, ar);
            return api;
          }
          p(cal, ar);
        };
      })(window, "https://app.cal.com/embed/embed.js", "init");
      Cal("init", {origin:"https://cal.com"});
    </script>
  {% endif %}
  <script>
    async function removeTag(tagSlug) {
      if (!confirm(`Remove tag "${tagSlug.replace('-', ' ')}" from this ticket?`)) {
        return;
      }

      try {
        const response = await fetch(`/api/tag-exclusions/tickets/{{ ticket.id }}/remove-tag`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ tag_slug: tagSlug }),
        });

        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Failed to remove tag');
        }

        // Remove the tag from the UI
        const tagElement = document.querySelector(`[data-tag-slug="${tagSlug}"]`);
        if (tagElement) {
          tagElement.remove();
        }

        // Check if there are any tags left
        const container = document.getElementById('ai-tags-container');
        if (container && container.children.length === 0) {
          container.innerHTML = '<span class="card__empty">No AI tags remaining.</span>';
        }
      } catch (error) {
        console.error('Error removing tag:', error);
        alert(error.message || 'Failed to remove tag. Please try again.');
      }
    }
  </script>
{% endblock %}
