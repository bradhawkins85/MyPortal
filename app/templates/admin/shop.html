{% extends "base.html" %}

{% block header_title %}
  <div class="header__title-content">
    <span class="header__title-text">Shop admin</span>
    <div class="header__title-actions">
      <a class="button button--ghost button--small header__title-button" href="/admin/shop/categories">
        Product categories
      </a>
      <a class="button button--primary button--small header__title-button" href="/admin/shop/products/new">
        Add product
      </a>
      <button
        type="button"
        class="button button--ghost button--small header__title-button"
        data-import-product-modal-open
        aria-haspopup="dialog"
        aria-controls="import-product-modal"
      >
        Import product
      </button>
    </div>
  </div>
{% endblock %}

{% block header_actions %}
  <a class="button button--ghost" href="/admin/shop/packages">Package admin</a>
{% endblock %}

{% block content %}
<div class="admin-grid">
  <section class="card card--panel">
    <header class="card__header card__header--stacked">
      <div>
        <h2 class="card__title">Product catalogue</h2>
        <p class="card__subtitle">Filter, sort, and manage catalogue items with real-time previews.</p>
      </div>
      <div class="card__controls">
        <input
          type="search"
          class="form-input card__control"
          placeholder="Search products"
          aria-label="Search products"
          data-table-filter="admin-products-table"
        />
        <select class="form-input card__control" id="stock-filter">
          <option value="">All stock</option>
          <option value="in">In stock</option>
          <option value="out">Out of stock</option>
        </select>
        <label class="checkbox card__control">
          <input type="checkbox" id="show-archived" {% if show_archived %}checked{% endif %} />
          <span>Show archived</span>
        </label>
      </div>
    </header>
    <div class="table-wrapper">
      <table class="table" id="admin-products-table" data-table>
        <thead>
          <tr>
            <th scope="col">Image</th>
            <th scope="col" data-sort="string">Name</th>
            <th scope="col" data-sort="string">SKU</th>
            <th scope="col" data-sort="string">Vendor SKU</th>
            <th scope="col" data-sort="number">Price</th>
            <th scope="col" data-sort="number">VIP</th>
            <th scope="col" data-sort="string">Category</th>
            <th scope="col" data-sort="number">Stock</th>
            <th scope="col" class="table__actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
            <tr data-product-id="{{ product.id }}" data-stock="{{ product.stock }}" data-archived="{{ 'true' if product.archived else 'false' }}">
              <td data-label="Image">
                {% if product.image_url %}
                  <img src="{{ product.image_url }}" alt="" class="product-thumb" loading="lazy" />
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td data-label="Name">{{ product.name }}</td>
              <td data-label="SKU">{{ product.sku }}</td>
              <td data-label="Vendor SKU">{{ product.vendor_sku }}</td>
              <td data-label="Price" data-value="{{ product.price }}">${{ '%.2f'|format(product.price) }}</td>
              <td data-label="VIP" data-value="{{ product.vip_price if product.vip_price is not none else '' }}">
                {% if product.vip_price is not none %}
                  ${{ '%.2f'|format(product.vip_price) }}
                {% else %}
                  <span class="text-muted">—</span>
                {% endif %}
              </td>
              <td data-label="Category">{{ product.category_name or '—' }}</td>
              <td data-label="Stock" data-value="{{ product.stock }}">{{ product.stock }}</td>
              <td class="table__actions">
                <div class="table__action-buttons">
                  <button type="button" class="button button--ghost" data-product-edit="{{ product.id }}">Edit</button>
                  <form action="/shop/admin/product/{{ product.id }}/{{ 'unarchive' if product.archived else 'archive' }}" method="post" class="inline-form">
                    {% if csrf_token %}
                    <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                    {% endif %}
                    <button type="submit" class="button button--ghost">{{ 'Unarchive' if product.archived else 'Archive' }}</button>
                  </form>
                  <form action="/shop/admin/product/{{ product.id }}/delete" method="post" class="inline-form" data-confirm="Delete this product?">
                    {% if csrf_token %}
                    <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                    {% endif %}
                    <button type="submit" class="button button--danger">Delete</button>
                  </form>
                  <button type="button" class="button button--ghost" data-product-visibility="{{ product.id }}">Visibility</button>
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="9" class="table__empty">No products found.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
</div>

<div
  class="modal"
  id="import-product-modal"
  role="dialog"
  aria-modal="true"
  aria-labelledby="import-product-modal-title"
  hidden
>
  <div class="modal__content" role="document">
    <button type="button" class="modal__close" data-modal-close>
      <span class="visually-hidden">Close product import</span>
      &times;
    </button>
    <h2 class="modal__title" id="import-product-modal-title">Import product</h2>
    <p class="modal__subtitle">Pull catalogue data from upstream vendors via their SKU.</p>
    <form action="/shop/admin/product/import" method="post" class="form-grid">
      {% if csrf_token %}
      <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
      {% endif %}
      <div class="form-field">
        <label class="form-label" for="import-vendor-sku">Vendor SKU</label>
        <input class="form-input" id="import-vendor-sku" name="vendor_sku" required />
      </div>
      <div class="form-actions">
        <button type="submit" class="button">Import</button>
        <button type="button" class="button button--ghost" data-modal-close>Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="product-edit-modal" role="dialog" aria-modal="true" hidden>
  <div class="modal__content" role="document">
    <button type="button" class="modal__close" data-modal-close>
      <span class="visually-hidden">Close product editor</span>
      &times;
    </button>
    <h2 class="modal__title">Edit product</h2>
    <form id="product-edit-form" method="post" enctype="multipart/form-data" class="form-grid">
      {% if csrf_token %}
      <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
      {% endif %}
      <input type="hidden" id="edit-product-id" />
      <div class="form-field">
        <label class="form-label" for="edit-product-name">Name</label>
        <input class="form-input" id="edit-product-name" name="name" required />
      </div>
      <div class="form-field">
        <label class="form-label" for="edit-product-sku">SKU</label>
        <input class="form-input" id="edit-product-sku" name="sku" required />
      </div>
      <div class="form-field">
        <label class="form-label" for="edit-product-vendor">Vendor SKU</label>
        <input class="form-input" id="edit-product-vendor" name="vendor_sku" required />
      </div>
      <div class="form-field form-field--wide">
        <label class="form-label" for="edit-product-cross-sell">Cross-sell products</label>
        <select
          class="form-input form-input--multiselect"
          id="edit-product-cross-sell"
          name="cross_sell_product_ids"
          multiple
          size="6"
          data-recommendation-select="cross"
        >
        </select>
        <p class="form-helper">Choose add-ons from the same category as this product.</p>
      </div>
      <div class="form-field form-field--wide">
        <label class="form-label" for="edit-product-upsell">Up-sell products</label>
        <select
          class="form-input form-input--multiselect"
          id="edit-product-upsell"
          name="upsell_product_ids"
          multiple
          size="6"
          data-recommendation-select="upsell"
        >
        </select>
        <p class="form-helper">Offer upgrade paths that remain in the same category.</p>
      </div>
      <div class="form-field form-field--wide">
        <label class="form-label" for="edit-product-description">Description</label>
        <textarea class="form-input form-input--textarea" id="edit-product-description" name="description"></textarea>
      </div>
      <div class="form-field">
        <label class="form-label" for="edit-product-price">Price</label>
        <input class="form-input" id="edit-product-price" name="price" type="number" step="0.01" required />
      </div>
      <div class="form-field">
        <label class="form-label" for="edit-product-vip">VIP price</label>
        <input class="form-input" id="edit-product-vip" name="vip_price" type="number" step="0.01" />
      </div>
      <div class="form-field">
        <label class="form-label" for="edit-product-stock">Stock</label>
        <input class="form-input" id="edit-product-stock" name="stock" type="number" required />
      </div>
      <div class="form-field">
        <label class="form-label" for="edit-product-category">Category</label>
        <select class="form-input" id="edit-product-category" name="category_id">
          <option value="">No category</option>
          {% for category in categories %}
            <option value="{{ category.id }}">{% if category.parent_id %}└─ {% endif %}{{ category.name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-field">
        <label class="form-label" for="edit-product-subscription-category">Subscription category</label>
        <select class="form-input" id="edit-product-subscription-category" name="subscription_category_id">
          <option value="">No subscription category</option>
          {% for sub_category in subscription_categories %}
            <option value="{{ sub_category.id }}">{{ sub_category.name }}</option>
          {% endfor %}
        </select>
        <p class="form-helper">Products in the same subscription category can co-term together.</p>
      </div>
      <div class="form-field">
        <label class="form-label" for="edit-product-term-days">Term days</label>
        <input class="form-input" id="edit-product-term-days" name="term_days" type="number" min="1" value="365" required />
        <p class="form-helper">Length of the subscription term in days (default: 365).</p>
      </div>
      <div class="form-field form-field--wide">
        <label class="form-label" for="edit-product-features-filter">Features</label>
        <div class="form-actions form-actions--inline">
          <input
            type="search"
            class="form-input"
            id="edit-product-features-filter"
            placeholder="Filter features"
            aria-label="Filter features"
            data-table-filter="edit-product-features-table"
          />
          <button type="button" class="button" id="add-product-feature">Add feature</button>
        </div>
        <div class="table-wrapper">
          <table class="table" id="edit-product-features-table" data-table>
            <thead>
              <tr>
                <th scope="col" data-sort="string">Feature</th>
                <th scope="col" data-sort="string">Value</th>
                <th scope="col" class="table__actions">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
        <input type="hidden" name="features" id="edit-product-features-data" value="[]" />
      </div>
      <div class="form-field">
        <label class="form-label" for="edit-product-image">Image</label>
        <input class="form-input" id="edit-product-image" name="image" type="file" accept="image/*" />
        <img id="edit-product-preview" alt="Current product image" class="product-preview" hidden />
      </div>
      <div class="form-actions">
        <button type="submit" class="button">Save product</button>
        <button type="button" class="button button--ghost" data-modal-close>Cancel</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="product-visibility-modal" role="dialog" aria-modal="true" hidden>
  <div class="modal__content" role="document">
    <button type="button" class="modal__close" data-modal-close>
      <span class="visually-hidden">Close visibility modal</span>
      &times;
    </button>
    <h2 class="modal__title">Product visibility</h2>
    <form id="product-visibility-form" method="post" class="form-grid">
      {% if csrf_token %}
      <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
      {% endif %}
      <div class="visibility-grid">
        {% for company in all_companies %}
          <label class="checkbox visibility-grid__item">
            <input type="checkbox" name="excluded" value="{{ company.id }}" />
            <span>{{ company.name }}</span>
          </label>
        {% endfor %}
      </div>
      <div class="form-actions">
        <button type="submit" class="button">Save visibility</button>
        <button type="button" class="button button--ghost" data-modal-close>Cancel</button>
      </div>
    </form>
  </div>
</div>

<script type="application/json" id="admin-products-data">{{ products | tojson }}</script>
<script type="application/json" id="admin-product-restrictions">{{ product_restrictions | tojson }}</script>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/shop_admin.js" defer></script>
{% endblock %}
