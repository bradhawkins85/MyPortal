{% extends "base.html" %}

{% block content %}
  {% if error_message or success_message %}
    <div class="stacked" style="margin-bottom: 1.5rem; gap: 1rem;">
      {% if success_message %}
        <div class="alert" role="status">{{ success_message }}</div>
      {% endif %}
      {% if error_message %}
        <div class="alert alert--error" role="alert">{{ error_message }}</div>
      {% endif %}
    </div>
  {% endif %}

  <div class="admin-grid admin-grid--columns">
    <section class="card card--panel admin-grid__full">
      <header class="card__header card__header--actions">
        <div class="stacked">
          <h2 class="card__title">{{ form_data.name or company.name }}</h2>
          <p class="card__subtitle">Manage identifiers, email domains, and VIP status for this company.</p>
        </div>
        <div class="card__controls">
          <a class="button button--ghost" href="/admin/companies">Back to companies</a>
        </div>
      </header>
      <div class="card__body card__body--stacked">
        <form action="/admin/companies/{{ company.id }}" method="post" class="form" autocomplete="off">
          {% include "partials/csrf.html" %}
          <div class="form-field">
            <label class="form-label" for="edit-company-name">Company name</label>
            <input
              id="edit-company-name"
              name="name"
              class="form-input"
              value="{{ form_data.name }}"
              maxlength="255"
              required
            />
          </div>
          <div class="form-field">
            <label class="form-label" for="edit-company-syncro">Syncro company ID</label>
            <input
              id="edit-company-syncro"
              name="syncroCompanyId"
              class="form-input"
              value="{{ form_data.syncro_company_id }}"
              maxlength="255"
            />
          </div>
          <div class="form-field">
            <label class="form-label" for="edit-company-xero">Xero ID</label>
            <input
              id="edit-company-xero"
              name="xeroId"
              class="form-input"
              value="{{ form_data.xero_id }}"
              maxlength="255"
            />
          </div>
          <div class="form-field">
            <label class="form-label" for="edit-company-email-domains">Email domains</label>
            <input
              id="edit-company-email-domains"
              name="emailDomains"
              class="form-input"
              type="text"
              placeholder="example.com, example.org"
              value="{{ form_data.email_domains }}"
            />
            <p class="form-help">Use commas to list domains. Domains are matched case-insensitively.</p>
          </div>
          <div class="form-field form-field--checkbox">
            <label class="checkbox" for="edit-company-vip">
              <input
                id="edit-company-vip"
                type="checkbox"
                name="isVip"
                value="1"
                {% if form_data.is_vip %}checked{% endif %}
              />
              <span>VIP pricing</span>
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" class="button">Save changes</button>
          </div>
        </form>
      </div>
    </section>
    {% if is_super_admin %}
      <details class="card card--panel card-collapsible admin-grid__full">
        <summary class="card__header card__header--collapsible card__header--stacked">
          <div>
            <h2 class="card__title">Assign staff access</h2>
            <p class="card__subtitle">
              Grant or update company permissions for existing team members without sending invitations.
            </p>
          </div>
          <div class="card__collapsible-meta" aria-hidden="true">
            <span class="card__toggle-icon"></span>
          </div>
        </summary>
        <div class="card-collapsible__content">
          <form
            action="/admin/companies/assign"
            method="post"
            class="form-grid"
            autocomplete="off"
            data-company-assign-form
            data-initial-company-id="{{ assign_form.company_id }}"
            data-initial-user-id="{{ assign_form.user_value or '' }}"
          >
            {% include "partials/csrf.html" %}
            <input type="hidden" name="sourceCompanyId" value="{{ company.id }}" />
            <div class="form-field">
              <label class="form-label" for="assign-company">Company</label>
              <select
                id="assign-company"
                name="companyId"
                class="form-input"
                required
                data-company-select
              >
                {% for managed in managed_companies %}
                  <option value="{{ managed.id }}" {% if managed.id == assign_form.company_id %}selected{% endif %}>
                    {{ managed.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field">
              <label class="form-label" for="assign-user">User</label>
              <select id="assign-user" name="userId" class="form-input" required data-user-select>
                <option
                  value=""
                  disabled
                  {% if not assign_form.user_value %}selected{% endif %}
                  data-placeholder
                >
                  Select a user
                </option>
                {% for option in assign_user_options %}
                  <option
                    value="{{ option.value }}"
                    {% if option.value == assign_form.user_value %}selected{% endif %}
                    {% if option.staff_id is not none %}data-staff-id="{{ option.staff_id }}"{% endif %}
                    {% if option.user_id is not none %}data-user-id="{{ option.user_id }}"{% endif %}
                    data-has-user="{% if option.has_user %}1{% else %}0{% endif %}"
                  >
                    {{ option.label }}
                  </option>
                {% endfor %}
              </select>
            </div>
            {% if role_options %}
              <div class="form-field">
                <label class="form-label" for="assign-role">Membership role</label>
                <select id="assign-role" name="role_id" class="form-input">
                  <option value="" {% if not assign_form.role_id %}selected{% endif %}>Default membership role</option>
                  {% for role in role_options %}
                    <option value="{{ role.id }}" {% if role.id == assign_form.role_id %}selected{% endif %}>
                      {{ role.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}
            <div class="form-field">
              <label class="form-label" for="assign-staff-permission">Staff access level</label>
              <select id="assign-staff-permission" name="staffPermission" class="form-input">
                {% for option in staff_permission_options %}
                  <option value="{{ option.value }}" {% if option.value == assign_form.staff_permission %}selected{% endif %}>
                    {{ option.label }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field form-field--checkbox">
              <label class="checkbox" for="assign-manage-staff">
                <input
                  id="assign-manage-staff"
                  type="checkbox"
                  name="can_manage_staff"
                  value="1"
                  {% if assign_form.can_manage_staff %}checked{% endif %}
                />
                <span>Allow manual staff management</span>
              </label>
              <p class="form-help">
                Enable to give management controls without requiring an elevated staff access tier.
              </p>
            </div>
            <div class="form-field form-field--wide">
              <span class="form-label">Company permissions</span>
              <div class="form-grid">
                {% for column in permission_columns %}
                  <div class="form-field form-field--checkbox">
                    <label class="checkbox" for="assign-{{ column.field }}">
                      <input
                        id="assign-{{ column.field }}"
                        type="checkbox"
                        name="{{ column.field }}"
                        value="1"
                        {% if assign_form.permissions.get(column.field) %}checked{% endif %}
                      />
                      <span>{{ column.label }}</span>
                    </label>
                  </div>
                {% endfor %}
              </div>
            </div>
            <div class="form-actions form-field--wide">
              <button type="submit" class="button">Save access</button>
            </div>
          </form>
        </div>
      </details>

      <section class="card card--panel admin-grid__full">
        <header class="card__header card__header--stacked">
          <div>
            <h2 class="card__title">Company memberships</h2>
            <p class="card__subtitle">Manage staff access and permissions for this company.</p>
          </div>
          <div class="card__controls">
            <input
              type="search"
              class="form-input"
              placeholder="Filter memberships"
              aria-label="Filter memberships"
              data-table-filter="company-assignments"
            />
          </div>
        </header>
        <div class="table-wrapper">
          <table class="table" id="company-assignments" data-table>
            <thead>
              <tr>
                <th scope="col" data-sort="string">User</th>
                <th scope="col" data-sort="string">Role</th>
                <th scope="col" data-sort="string">Staff</th>
                {% for column in permission_columns %}
                  <th scope="col" data-sort="string">{{ column.label }}</th>
                {% endfor %}
                <th scope="col" class="table__actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if assignments %}
                {% for assignment in assignments %}
                  <tr>
                    <td data-label="User">
                      <div class="stacked">
                        <strong>{{ assignment.email }}</strong>
                        <span class="text-muted">{{ assignment.first_name or '' }} {{ assignment.last_name or '' }}</span>
                        {% if assignment.is_pending %}
                          <span class="badge badge--warning">Pending staff access</span>
                          {% if assignment.pending_requires_account %}
                            <span class="text-muted">Awaiting portal account</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </td>
                    <td data-label="Role">
                      {% if assignment.is_pending %}
                        {% if assignment.membership_role_name %}
                          <span>{{ assignment.membership_role_name }}</span>
                        {% elif assignment.membership_role_id %}
                          <span>Role ID {{ assignment.membership_role_id }}</span>
                        {% else %}
                          <span class="text-muted">Pending role assignment</span>
                        {% endif %}
                      {% elif assignment.membership_id and role_options %}
                        <select
                          class="form-input"
                          data-membership-role
                          data-company-id="{{ assignment.company_id }}"
                          data-user-id="{{ assignment.user_id }}"
                          data-membership-id="{{ assignment.membership_id }}"
                          data-current-role="{{ assignment.membership_role_id or '' }}"
                        >
                          {% for role in role_options %}
                            <option value="{{ role.id }}" {% if role.id == assignment.membership_role_id %}selected{% endif %}>
                              {{ role.name }}
                            </option>
                          {% endfor %}
                        </select>
                      {% elif assignment.membership_id %}
                        <span>{{ assignment.membership_role_name or 'Role unavailable' }}</span>
                      {% else %}
                        <span class="text-muted">No membership record</span>
                      {% endif %}
                    </td>
                    <td data-label="Staff">
                      {% if assignment.is_pending %}
                        <span class="text-muted">{{ assignment.staff_permission_label }}</span>
                      {% else %}
                        <select
                          class="form-input"
                          data-staff-permission
                          data-company-id="{{ assignment.company_id }}"
                          data-user-id="{{ assignment.user_id }}"
                        >
                          {% for option in staff_permission_options %}
                            <option value="{{ option.value }}" {% if option.value == assignment.staff_permission %}selected{% endif %}>
                              {{ option.label }}
                            </option>
                          {% endfor %}
                        </select>
                      {% endif %}
                    </td>
                    {% for column in permission_columns %}
                      {% set field = column.field %}
                      <td data-label="{{ column.label }}">
                        <label class="checkbox">
                          <input
                            type="checkbox"
                            {% if not assignment.is_pending %}
                              data-company-permission
                              data-company-id="{{ assignment.company_id }}"
                              data-user-id="{{ assignment.user_id }}"
                              data-field="{{ field }}"
                            {% endif %}
                            {% if assignment.is_pending %}disabled{% endif %}
                            {% if assignment[field] %}checked{% endif %}
                          />
                          <span class="visually-hidden">Toggle {{ column.label }}</span>
                        </label>
                      </td>
                    {% endfor %}
                    <td class="table__actions">
                      {% if assignment.is_pending %}
                        <div class="stacked">
                          <span class="text-muted">Pending sign-up</span>
                          {% if assignment.staff_id %}
                            <button
                              type="button"
                              class="button button--danger button--small"
                              data-remove-pending-assignment
                              data-company-id="{{ assignment.company_id }}"
                              data-staff-id="{{ assignment.staff_id }}"
                            >
                              Cancel pending access
                            </button>
                          {% endif %}
                        </div>
                      {% else %}
                        <button
                          type="button"
                          class="button button--danger"
                          data-remove-assignment
                          data-company-id="{{ assignment.company_id }}"
                          data-user-id="{{ assignment.user_id }}"
                        >
                          Remove
                        </button>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  {% set empty_columns = 4 + permission_columns|length %}
                  <td colspan="{{ empty_columns }}" class="table__empty">
                    No memberships are assigned to this company yet.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </section>
    {% endif %}
  </div>
  {% if is_super_admin %}
    <script type="application/json" id="company-assign-user-options">
      {{ company_user_options | tojson | safe }}
    </script>
  {% endif %}
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/admin.js" defer></script>
{% endblock %}
