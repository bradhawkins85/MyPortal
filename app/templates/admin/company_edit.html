{% extends "base.html" %}

{% block content %}
  <div data-company-id="{{ company.id }}">
  <div class="admin-grid admin-grid--columns">
    <section class="card card--panel admin-grid__full">
      <header class="card__header card__header--actions">
        <div class="stacked">
          <h2 class="card__title">{{ form_data.name or company.name }}</h2>
          <p class="card__subtitle">Manage identifiers, email domains, and VIP status for this company.</p>
        </div>
        <div class="card__controls">
          <a class="button button--ghost" href="/admin/companies">Back to companies</a>
        </div>
      </header>
      <div class="card__body card__body--stacked">
        <form action="/admin/companies/{{ company.id }}" method="post" class="form" autocomplete="off">
          {% include "partials/csrf.html" %}
          <div class="form-field">
            <label class="form-label" for="edit-company-name">Company name</label>
            <input
              id="edit-company-name"
              name="name"
              class="form-input"
              value="{{ form_data.name }}"
              maxlength="255"
              required
            />
          </div>
          <div class="form-field">
            <label class="form-label" for="edit-company-syncro">Syncro company ID</label>
            <input
              id="edit-company-syncro"
              name="syncroCompanyId"
              class="form-input"
              value="{{ form_data.syncro_company_id }}"
              maxlength="255"
            />
          </div>
          <div class="form-field">
            <label class="form-label" for="edit-company-tactical">Tactical RMM client ID</label>
            <div class="form-field__group">
              <input
                id="edit-company-tactical"
                name="tacticalClientId"
                class="form-input"
                value="{{ form_data.tacticalrmm_client_id }}"
                maxlength="255"
              />
              <button
                type="button"
                class="button button--ghost"
                data-lookup-tactical-id
                title="Lookup Tactical RMM client ID"
                aria-label="Lookup Tactical RMM client ID from API"
              >
                <span class="button__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false">
                    <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"/>
                    <path d="M20 12h2a10 10 0 0 0-10-10v2a8 8 0 0 1 8 8z"/>
                    <path d="M12 20v2a10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8z"/>
                    <path d="M4 12H2a10 10 0 0 0 10 10v-2a8 8 0 0 1-8-8z"/>
                  </svg>
                </span>
              </button>
            </div>
          </div>
          <div class="form-field">
            <label class="form-label" for="edit-company-xero">Xero ID</label>
            <div class="form-field__group">
              <input
                id="edit-company-xero"
                name="xeroId"
                class="form-input"
                value="{{ form_data.xero_id }}"
                maxlength="255"
              />
              <button
                type="button"
                class="button button--ghost"
                data-lookup-xero-id
                title="Lookup Xero contact ID"
                aria-label="Lookup Xero contact ID from API"
              >
                <span class="button__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" focusable="false">
                    <path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"/>
                    <path d="M20 12h2a10 10 0 0 0-10-10v2a8 8 0 0 1 8 8z"/>
                    <path d="M12 20v2a10 10 0 0 0 10-10h-2a8 8 0 0 1-8 8z"/>
                    <path d="M4 12H2a10 10 0 0 0 10 10v-2a8 8 0 0 1-8-8z"/>
                  </svg>
                </span>
              </button>
            </div>
          </div>
          <div class="form-field">
            <label class="form-label" for="edit-company-email-domains">Email domains</label>
            <input
              id="edit-company-email-domains"
              name="emailDomains"
              class="form-input"
              type="text"
              placeholder="example.com, example.org"
              value="{{ form_data.email_domains }}"
            />
            <p class="form-help">Use commas to list domains. Domains are matched case-insensitively.</p>
          </div>
          <div class="form-field form-field--checkbox">
            <label class="checkbox" for="edit-company-vip">
              <input
                id="edit-company-vip"
                type="checkbox"
                name="isVip"
                value="1"
                {% if form_data.is_vip %}checked{% endif %}
              />
              <span>VIP pricing</span>
            </label>
          </div>
          <div class="form-actions">
            <button type="submit" class="button">Save changes</button>
          </div>
        </form>
      </div>
    </section>
    {% if is_super_admin %}
      <details class="card card--panel card-collapsible admin-grid__full" data-billing-contacts-panel open>
        <summary class="card__header card__header--collapsible card__header--stacked">
          <div>
            <h2 class="card__title">Billing contacts</h2>
            <p class="card__subtitle">Manage users who receive billing notifications for this company, including subscription price changes.</p>
          </div>
          <div class="card__collapsible-meta" aria-hidden="true">
            <span class="card__toggle-icon"></span>
          </div>
        </summary>
        <div class="card-collapsible__content">
          <div class="form-field">
            <label class="form-label" for="billing-contact-select">Add billing contact</label>
            <select class="form-input" id="billing-contact-select" data-billing-contact-select>
              <option value="">Select a user...</option>
              {% for user in company_users %}
                <option value="{{ user.user_id }}" data-email="{{ user.email }}" data-name="{{ user.first_name }} {{ user.last_name }}">
                  {{ user.email }} - {{ user.first_name }} {{ user.last_name }}
                </option>
              {% endfor %}
            </select>
            <p class="form-helper">Select a user to add as a billing contact for price change notifications.</p>
          </div>
          <div class="billing-contacts-list" id="billing-contacts-list">
            {% if billing_contacts %}
              {% for contact in billing_contacts %}
                <div class="billing-contact-item" data-user-id="{{ contact.user_id }}">
                  <div class="billing-contact-info">
                    <span class="billing-contact-email">{{ contact.email }}</span>
                    {% if contact.first_name or contact.last_name %}
                      <span class="billing-contact-name">{{ contact.first_name }} {{ contact.last_name }}</span>
                    {% endif %}
                  </div>
                  <button 
                    type="button" 
                    class="button button--ghost button--small" 
                    data-billing-contact-remove="{{ contact.user_id }}"
                    title="Remove billing contact"
                  >
                    Remove
                  </button>
                </div>
              {% endfor %}
            {% else %}
              <p class="text-muted" data-empty-message>No billing contacts configured yet.</p>
            {% endif %}
          </div>
        </div>
      </details>

      <details class="card card--panel card-collapsible admin-grid__full" data-company-automations open>
        <summary class="card__header card__header--collapsible card__header--stacked">
          <div>
            <h2 class="card__title">Company automations</h2>
            <p class="card__subtitle">Schedule and monitor automations dedicated to this company.</p>
          </div>
          <div class="card__collapsible-meta" aria-hidden="true">
            <span class="card__toggle-icon"></span>
          </div>
        </summary>
        <div class="card-collapsible__content">
          <div class="card__controls">
            <input
              type="search"
              class="form-input"
              placeholder="Filter automations"
              aria-label="Filter company automations"
              data-table-filter="company-automation-tasks"
            />
            <button type="button" class="button button--primary" data-task-create>New automation</button>
          </div>
          <div class="table-wrapper">
            <table class="table" id="company-automation-tasks" data-table>
              <thead>
                <tr>
                  <th scope="col" data-sort="string">Name</th>
                  <th scope="col" data-sort="string">Command</th>
                  <th scope="col" data-sort="string">Cron</th>
                  <th scope="col" data-sort="string">Active</th>
                  <th scope="col" data-sort="date">Last run</th>
                  <th scope="col" data-sort="string">Status</th>
                  <th scope="col" class="table__actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if company_automation_tasks %}
                  {% for task in company_automation_tasks %}
                    <tr data-task='{{ task | tojson }}'>
                      <td data-label="Name">{{ task.name }}</td>
                      <td data-label="Command">{{ task.command }}</td>
                      <td data-label="Cron">{{ task.cron }}</td>
                      <td data-label="Active">
                        <span class="tag {{ 'tag--success' if task.active else 'tag--muted' }}">{{ 'Yes' if task.active else 'No' }}</span>
                      </td>
                      <td data-label="Last run" data-value="{{ task.last_run_iso or '' }}">
                        {% if task.last_run_iso %}
                          <span data-utc="{{ task.last_run_iso }}"></span>
                        {% else %}
                          <span class="text-muted">Never</span>
                        {% endif %}
                      </td>
                      <td data-label="Status">{{ task.last_status or 'â€”' }}</td>
                      <td class="table__actions">
                        <div class="table__action-buttons">
                          <button type="button" class="button button--ghost" data-task-edit>Edit</button>
                          <button type="button" class="button button--ghost" data-task-run>Run now</button>
                          <button type="button" class="button button--ghost" data-task-logs>View logs</button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="7" class="table__empty">No automations are configured for this company yet.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div class="table-pagination" data-pagination="company-automation-tasks">
            <div class="table-pagination__group">
              <button type="button" class="button button--ghost table-pagination__button" data-page-prev disabled>
                Previous
              </button>
              <button type="button" class="button button--ghost table-pagination__button" data-page-next>
                Next
              </button>
            </div>
            <p class="table-pagination__status" data-page-info aria-live="polite"></p>
          </div>
        </div>
      </details>

      <details class="card card--panel card-collapsible admin-grid__full" data-recurring-invoice-items-panel>
        <summary class="card__header card__header--collapsible card__header--stacked">
          <div>
            <h2 class="card__title">Recurring invoice items</h2>
            <p class="card__subtitle">
              Configure items that will be automatically added to Xero invoices when the sync automation runs.
            </p>
          </div>
          <div class="card__collapsible-meta" aria-hidden="true">
            <span class="card__toggle-icon"></span>
          </div>
        </summary>
        <div class="card-collapsible__content">
          <div class="card__controls">
            <input
              type="search"
              class="form-input"
              placeholder="Filter items"
              aria-label="Filter recurring invoice items"
              data-table-filter="recurring-invoice-items-table"
            />
            <button type="button" class="button button--primary" data-recurring-item-create>Add item</button>
          </div>
          <div class="table-wrapper">
            <table class="table" id="recurring-invoice-items-table" data-table>
              <thead>
                <tr>
                  <th scope="col" data-sort="string">Product Code</th>
                  <th scope="col" data-sort="string">Description</th>
                  <th scope="col" data-sort="string">Qty Expression</th>
                  <th scope="col" data-sort="number">Price Override</th>
                  <th scope="col" data-sort="string">Active</th>
                  <th scope="col" class="table__actions">Actions</th>
                </tr>
              </thead>
              <tbody>
                {% if recurring_invoice_items %}
                  {% for item in recurring_invoice_items %}
                    <tr data-recurring-item='{{ item | tojson | e }}'>
                      <td data-label="Product Code">{{ item.product_code }}</td>
                      <td data-label="Description" class="text-truncate" style="max-width: 300px;">
                        {{ item.description_template }}
                      </td>
                      <td data-label="Qty Expression">{{ item.qty_expression }}</td>
                      <td data-label="Price Override">
                        {% if item.price_override %}
                          ${{ "%.2f"|format(item.price_override) }}
                        {% else %}
                          <span class="text-muted">Use Xero default</span>
                        {% endif %}
                      </td>
                      <td data-label="Active">
                        <span class="tag {{ 'tag--success' if item.active else 'tag--muted' }}">
                          {{ 'Yes' if item.active else 'No' }}
                        </span>
                      </td>
                      <td class="table__actions">
                        <div class="table__action-buttons">
                          <button type="button" class="button button--ghost" data-recurring-item-edit>Edit</button>
                          <button type="button" class="button button--ghost button--danger" data-recurring-item-delete>Delete</button>
                        </div>
                      </td>
                    </tr>
                  {% endfor %}
                {% else %}
                  <tr>
                    <td colspan="6" class="table__empty">No recurring invoice items configured yet.</td>
                  </tr>
                {% endif %}
              </tbody>
            </table>
          </div>
          <div class="table-pagination" data-pagination="recurring-invoice-items-table">
            <div class="table-pagination__group">
              <button type="button" class="button button--ghost table-pagination__button" data-page-prev disabled>
                Previous
              </button>
              <button type="button" class="button button--ghost table-pagination__button" data-page-next>
                Next
              </button>
            </div>
            <p class="table-pagination__status" data-page-info aria-live="polite"></p>
          </div>
          <div class="card__help">
            <h3 class="card__help-title">Variable Substitution</h3>
            <p class="card__help-text">
              Use variables in the description and quantity fields to dynamically populate invoice data.
            </p>
            <p class="card__help-text">
              <strong>Available variables:</strong>
            </p>
            <ul class="card__help-list">
              <li><code>{active_agents}</code> - Total count of all active devices (synced in last 30 days)</li>
              <li><code>{active_workstations}</code> - Count of active Workstation devices</li>
              <li><code>{active_servers}</code> - Count of active Server devices</li>
              <li><code>{active_users}</code> - Count of active User devices</li>
              <li><code>{company_name}</code> - Name of the company</li>
            </ul>
            <p class="card__help-text">
              If no price override is specified, the price will be retrieved from Xero using the product code.
            </p>
          </div>
        </div>
      </details>
      <details class="card card--panel card-collapsible admin-grid__full">
        <summary class="card__header card__header--collapsible card__header--stacked">
          <div>
            <h2 class="card__title">Assign staff access</h2>
            <p class="card__subtitle">
              Grant or update company permissions for existing team members without sending invitations.
            </p>
          </div>
          <div class="card__collapsible-meta" aria-hidden="true">
            <span class="card__toggle-icon"></span>
          </div>
        </summary>
        <div class="card-collapsible__content">
          <form
            action="/admin/companies/assign"
            method="post"
            class="form-grid"
            autocomplete="off"
            data-company-assign-form
            data-initial-company-id="{{ assign_form.company_id }}"
            data-initial-user-id="{{ assign_form.user_value or '' }}"
          >
            {% include "partials/csrf.html" %}
            <input type="hidden" name="sourceCompanyId" value="{{ company.id }}" />
            <div class="form-field">
              <label class="form-label" for="assign-company">Company</label>
              <select
                id="assign-company"
                name="companyId"
                class="form-input"
                required
                data-company-select
              >
                {% for managed in managed_companies %}
                  <option value="{{ managed.id }}" {% if managed.id == assign_form.company_id %}selected{% endif %}>
                    {{ managed.name }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field">
              <label class="form-label" for="assign-user">User</label>
              <select id="assign-user" name="userId" class="form-input" required data-user-select>
                <option
                  value=""
                  disabled
                  {% if not assign_form.user_value %}selected{% endif %}
                  data-placeholder
                >
                  Select a user
                </option>
                {% for option in assign_user_options %}
                  <option
                    value="{{ option.value }}"
                    {% if option.value == assign_form.user_value %}selected{% endif %}
                    {% if option.staff_id is not none %}data-staff-id="{{ option.staff_id }}"{% endif %}
                    {% if option.user_id is not none %}data-user-id="{{ option.user_id }}"{% endif %}
                    data-has-user="{% if option.has_user %}1{% else %}0{% endif %}"
                  >
                    {{ option.label }}
                  </option>
                {% endfor %}
              </select>
            </div>
            {% if role_options %}
              <div class="form-field">
                <label class="form-label" for="assign-role">Membership role</label>
                <select id="assign-role" name="role_id" class="form-input">
                  <option value="" {% if not assign_form.role_id %}selected{% endif %}>Default membership role</option>
                  {% for role in role_options %}
                    <option value="{{ role.id }}" {% if role.id == assign_form.role_id %}selected{% endif %}>
                      {{ role.name }}
                    </option>
                  {% endfor %}
                </select>
              </div>
            {% endif %}
            <div class="form-field">
              <label class="form-label" for="assign-staff-permission">Staff access level</label>
              <select id="assign-staff-permission" name="staffPermission" class="form-input">
                {% for option in staff_permission_options %}
                  <option value="{{ option.value }}" {% if option.value == assign_form.staff_permission %}selected{% endif %}>
                    {{ option.label }}
                  </option>
                {% endfor %}
              </select>
            </div>
            <div class="form-actions form-field--wide">
              <button type="submit" class="button">Save access</button>
            </div>
          </form>
        </div>
      </details>

    <details class="card card--panel card-collapsible admin-grid__full" data-company-memberships-panel>
      <summary class="card__header card__header--collapsible card__header--stacked">
        <div>
          <h2 class="card__title">Company memberships</h2>
          <p class="card__subtitle">Manage staff access and permissions for this company.</p>
        </div>
        <div class="card__collapsible-meta" aria-hidden="true">
          <span class="card__toggle-icon"></span>
        </div>
      </summary>
      <div class="card-collapsible__content">
        <div class="card__controls card__controls--align-end">
          <input
            type="search"
            class="form-input"
            placeholder="Filter memberships"
            aria-label="Filter memberships"
            data-table-filter="company-assignments"
          />
        </div>
        <div class="table-wrapper">
          <table class="table" id="company-assignments" data-table>
            <thead>
              <tr>
                <th scope="col" data-sort="string">User</th>
                <th scope="col" data-sort="string">Role</th>
                <th scope="col" data-sort="string">Staff</th>
                <th scope="col" class="table__actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if assignments %}
                {% for assignment in assignments %}
                  <tr>
                    <td data-label="User">
                      <div class="stacked">
                        <strong>{{ assignment.email }}</strong>
                        <span class="text-muted">{{ assignment.first_name or '' }} {{ assignment.last_name or '' }}</span>
                        {% if assignment.is_pending %}
                          <span class="badge badge--warning">Pending staff access</span>
                          {% if assignment.pending_requires_account %}
                            <span class="text-muted">Awaiting portal account</span>
                          {% endif %}
                        {% endif %}
                      </div>
                    </td>
                    <td data-label="Role">
                      {% if assignment.is_pending %}
                        {% if assignment.membership_role_name %}
                          <span>{{ assignment.membership_role_name }}</span>
                        {% elif assignment.membership_role_id %}
                          <span>Role ID {{ assignment.membership_role_id }}</span>
                        {% else %}
                          <span class="text-muted">Pending role assignment</span>
                        {% endif %}
                      {% elif assignment.membership_id and role_options %}
                        <select
                          class="form-input"
                          data-membership-role
                          data-company-id="{{ assignment.company_id }}"
                          data-user-id="{{ assignment.user_id }}"
                          data-membership-id="{{ assignment.membership_id }}"
                          data-current-role="{{ assignment.membership_role_id or '' }}"
                        >
                          {% for role in role_options %}
                            <option value="{{ role.id }}" {% if role.id == assignment.membership_role_id %}selected{% endif %}>
                              {{ role.name }}
                            </option>
                          {% endfor %}
                        </select>
                      {% elif assignment.membership_id %}
                        <span>{{ assignment.membership_role_name or 'Role unavailable' }}</span>
                      {% else %}
                        <span class="text-muted">No membership record</span>
                      {% endif %}
                    </td>
                    <td data-label="Staff">
                      {% if assignment.is_pending %}
                        <span class="text-muted">{{ assignment.staff_permission_label }}</span>
                      {% else %}
                        <select
                          class="form-input"
                          data-staff-permission
                          data-company-id="{{ assignment.company_id }}"
                          data-user-id="{{ assignment.user_id }}"
                        >
                          {% for option in staff_permission_options %}
                            <option value="{{ option.value }}" {% if option.value == assignment.staff_permission %}selected{% endif %}>
                              {{ option.label }}
                            </option>
                          {% endfor %}
                        </select>
                      {% endif %}
                    </td>
                    <td class="table__actions">
                      {% if assignment.is_pending %}
                        <div class="stacked">
                          <span class="text-muted">Pending sign-up</span>
                          {% if assignment.staff_id %}
                            <button
                              type="button"
                              class="button button--danger button--small"
                              data-remove-pending-assignment
                              data-company-id="{{ assignment.company_id }}"
                              data-staff-id="{{ assignment.staff_id }}"
                            >
                              Cancel pending access
                            </button>
                          {% endif %}
                        </div>
                      {% else %}
                        <button
                          type="button"
                          class="button button--danger"
                          data-remove-assignment
                          data-company-id="{{ assignment.company_id }}"
                          data-user-id="{{ assignment.user_id }}"
                        >
                          Remove
                        </button>
                      {% endif %}
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="4" class="table__empty">
                    No memberships are assigned to this company yet.
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </details>
    {% endif %}
  </div>
  {% if is_super_admin %}
    <script type="application/json" id="company-assign-user-options">
      {{ company_user_options | tojson | safe }}
    </script>
    <div class="modal" id="task-editor-modal" role="dialog" aria-modal="true" hidden>
      <div class="modal__content" role="document">
        <button type="button" class="modal__close" data-modal-close>
          <span class="visually-hidden">Close automation editor</span>
        </button>
        <h2 class="modal__title">Company automation</h2>
        <div class="modal__body">
          <form id="scheduled-task-form" class="form" autocomplete="off">
            <input type="hidden" name="task_id" id="task-id" />
            <div class="form-field">
              <label class="form-label" for="task-name-display">Automation name</label>
              <input
                class="form-input"
                id="task-name-display"
                type="text"
                value=""
                readonly
                aria-readonly="true"
                tabindex="-1"
                data-initial-focus
              />
              <p class="form-help">Generated from the selected command for this company.</p>
              <input type="hidden" id="task-name" name="name" />
            </div>
            <div class="form-field">
              <label class="form-label" for="task-command">Command</label>
              <select class="form-input" id="task-command" name="command" required>
                {% for option in automation_command_options %}
                  <option value="{{ option.value }}">{{ option.label }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="form-field">
              <label class="form-label" for="task-company-display">Company</label>
              <input
                class="form-input"
                id="task-company-display"
                type="text"
                value="{{ (automation_company_options[0].label if automation_company_options else 'All companies') }}"
                readonly
                aria-readonly="true"
                tabindex="-1"
              />
              <p class="form-help">Automations created here run only for this company.</p>
              <input
                type="hidden"
                id="task-company"
                name="companyId"
                value="{{ (automation_company_options[0].value if automation_company_options else '') }}"
                data-company-name="{{ (automation_company_options[0].label if automation_company_options else 'All companies') }}"
                data-default-value="{{ (automation_company_options[0].value if automation_company_options else '') }}"
                data-default-name="{{ (automation_company_options[0].label if automation_company_options else 'All companies') }}"
              />
            </div>
            <div class="form-field">
              <label class="form-label" for="task-cron">Cron expression</label>
              <input
                class="form-input"
                id="task-cron"
                name="cron"
                required
                placeholder="0 2 * * *"
                pattern="^[^\s]+(\s+[^\s]+){4,5}$"
              />
              <p class="form-help">Crontab syntax in UTC. Use five fields for minute through weekday.</p>
            </div>
            <div class="form-field" id="task-description-field">
              <label class="form-label" for="task-description">Description</label>
              <textarea class="form-input form-input--textarea" id="task-description" name="description" rows="3"></textarea>
              <p class="form-help" id="task-description-help">Optional description or notes about this automation.</p>
            </div>
            <div class="form-field" id="task-json-payload-field" style="display: none;">
              <label class="form-label" for="task-json-payload">JSON Payload</label>
              <textarea class="form-input form-input--textarea" id="task-json-payload" name="jsonPayload" rows="8" placeholder='{"subject": "Example ticket", "description": "Ticket details", "priority": "normal", "status": "open"}'></textarea>
              <p class="form-help">JSON configuration for ticket creation. Required fields: subject. Optional: description, priority, status, category, requester_id, assigned_user_id.</p>
            </div>
            <div class="form-field form-field--inline">
              <label class="form-label" for="task-max-retries">Max retries</label>
              <input class="form-input" id="task-max-retries" name="maxRetries" type="number" min="0" value="12" />
            </div>
            <div class="form-field form-field--inline">
              <label class="form-label" for="task-backoff">Retry backoff (seconds)</label>
              <input class="form-input" id="task-backoff" name="retryBackoffSeconds" type="number" min="30" value="300" />
            </div>
            <div class="form-field form-field--checkbox">
              <label class="form-checkbox">
                <input type="checkbox" id="task-active" name="active" checked />
                <span>Automation active</span>
              </label>
            </div>
            <div class="form-actions">
              <div class="form-actions__group">
                <button type="submit" class="button">Save automation</button>
                <button type="button" class="button button--ghost" data-task-reset>Clear form</button>
              </div>
              <button
                type="button"
                class="button button--danger"
                data-task-delete-modal
                hidden
                aria-hidden="true"
              >
                Delete automation
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div class="modal" id="task-logs-modal" role="dialog" aria-modal="true" hidden>
      <div class="modal__content" role="document">
        <button type="button" class="modal__close" data-modal-close>
          <span class="visually-hidden">Close automation logs</span>
        </button>
        <h2 class="modal__title" id="task-logs-title">Automation run history</h2>
        <div class="modal__body">
          <p id="task-logs-description" class="modal__subtitle text-muted">
            View the most recent executions for this automation. All timestamps are displayed in your local timezone.
          </p>
          <div class="modal__controls">
            <input
              type="search"
              class="form-input"
              placeholder="Filter runs"
              aria-label="Filter automation runs"
              data-table-filter="task-logs-table"
            />
          </div>
          <div class="table-wrapper">
            <table class="table" id="task-logs-table" data-table>
              <thead>
                <tr>
                  <th scope="col" data-sort="string">Status</th>
                  <th scope="col" data-sort="date">Started</th>
                  <th scope="col" data-sort="date">Finished</th>
                  <th scope="col" data-sort="number">Duration (ms)</th>
                  <th scope="col" data-sort="string">Details</th>
                </tr>
              </thead>
              <tbody id="task-logs-body">
                <tr>
                  <td colspan="5" class="table__empty" id="task-logs-empty">Select an automation to view its recent runs.</td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <div class="modal" id="recurring-item-editor-modal" role="dialog" aria-modal="true" hidden>
      <div class="modal__content" role="document">
        <button type="button" class="modal__close" data-modal-close>
          <span class="visually-hidden">Close recurring item editor</span>
        </button>
        <h2 class="modal__title">Recurring invoice item</h2>
        <div class="modal__body">
          <form id="recurring-item-form" class="form" autocomplete="off">
            <input type="hidden" name="item_id" id="recurring-item-id" />
            <div class="form-field">
              <label class="form-label" for="recurring-item-product-code">Product code</label>
              <input
                class="form-input"
                id="recurring-item-product-code"
                name="product_code"
                type="text"
                required
                placeholder="LABOR-MANAGED-SERVICES"
                data-initial-focus
              />
              <p class="form-help">The product code from your Xero account.</p>
            </div>
            <div class="form-field">
              <label class="form-label" for="recurring-item-description">Description template</label>
              <textarea
                class="form-input form-input--textarea"
                id="recurring-item-description"
                name="description_template"
                rows="3"
                required
                placeholder="Monthly managed services for {company_name}"
              ></textarea>
              <p class="form-help">Supports variable substitution using {variable_name} syntax.</p>
            </div>
            <div class="form-field">
              <label class="form-label" for="recurring-item-qty">Quantity expression</label>
              <input
                class="form-input"
                id="recurring-item-qty"
                name="qty_expression"
                type="text"
                required
                placeholder="1"
              />
              <p class="form-help">Static number (e.g., "5") or variable (e.g., "{active_agents}").</p>
            </div>
            <div class="form-field">
              <label class="form-label" for="recurring-item-price">Price override (optional)</label>
              <input
                class="form-input"
                id="recurring-item-price"
                name="price_override"
                type="number"
                step="0.01"
                min="0"
                placeholder="Leave empty to use Xero default"
              />
              <p class="form-help">Override the price from Xero, or leave blank to use the default price.</p>
            </div>
            <div class="form-field form-field--checkbox">
              <label class="checkbox">
                <input type="checkbox" id="recurring-item-active" name="active" checked />
                <span>Item active</span>
              </label>
            </div>
            <div class="form-actions">
              <div class="form-actions__group">
                <button type="submit" class="button">Save item</button>
                <button type="button" class="button button--ghost" data-recurring-item-reset>Clear form</button>
                <button type="button" class="button button--ghost" data-modal-close>Cancel</button>
              </div>
              <button
                type="button"
                class="button button--danger"
                data-recurring-item-delete-modal
                hidden
                aria-hidden="true"
              >
                Delete item
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>
  {% endif %}
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/admin.js" defer></script>
  {% if is_super_admin %}
    <script src="/static/js/automation.js" defer></script>
    <script>
      // Billing contacts management
      document.addEventListener('DOMContentLoaded', function() {
        const companyId = {{ company.id }};
        const select = document.getElementById('billing-contact-select');
        const list = document.getElementById('billing-contacts-list');
        
        if (!select || !list) return;
        
        // Handle adding billing contact
        select.addEventListener('change', async function() {
          const userId = this.value;
          if (!userId) return;
          
          const option = this.options[this.selectedIndex];
          const email = option.dataset.email || '';
          const name = option.dataset.name || '';
          
          try {
            const response = await fetch(`/admin/companies/${companyId}/billing-contacts/add`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('input[name="_csrf"]')?.value || ''
              },
              body: JSON.stringify({ user_id: userId })
            });
            
            if (response.ok) {
              const data = await response.json();
              addBillingContactToList(data.contact);
              this.value = '';  // Reset select
            } else {
              const error = await response.json();
              alert(error.detail || 'Failed to add billing contact');
            }
          } catch (err) {
            console.error('Error adding billing contact:', err);
            alert('Failed to add billing contact');
          }
        });
        
        // Handle removing billing contact
        list.addEventListener('click', async function(e) {
          const btn = e.target.closest('[data-billing-contact-remove]');
          if (!btn) return;
          
          const userId = btn.dataset.billingContactRemove;
          const item = btn.closest('.billing-contact-item');
          
          try {
            const response = await fetch(`/admin/companies/${companyId}/billing-contacts/${userId}/remove`, {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': document.querySelector('input[name="_csrf"]')?.value || ''
              }
            });
            
            if (response.ok) {
              item.remove();
              // Show empty message if no contacts left
              if (list.querySelectorAll('.billing-contact-item').length === 0) {
                list.innerHTML = '<p class="text-muted" data-empty-message>No billing contacts configured yet.</p>';
              }
            } else {
              alert('Failed to remove billing contact');
            }
          } catch (err) {
            console.error('Error removing billing contact:', err);
            alert('Failed to remove billing contact');
          }
        });
        
        function addBillingContactToList(contact) {
          // Remove empty message if it exists
          const emptyMsg = list.querySelector('[data-empty-message]');
          if (emptyMsg) emptyMsg.remove();
          
          const fullName = [contact.first_name, contact.last_name].filter(Boolean).join(' ');
          const item = document.createElement('div');
          item.className = 'billing-contact-item';
          item.dataset.userId = contact.user_id;
          item.innerHTML = `
            <div class="billing-contact-info">
              <span class="billing-contact-email">${escapeHtml(contact.email)}</span>
              ${fullName ? `<span class="billing-contact-name">${escapeHtml(fullName)}</span>` : ''}
            </div>
            <button 
              type="button" 
              class="button button--ghost button--small" 
              data-billing-contact-remove="${contact.user_id}"
              title="Remove billing contact"
            >
              Remove
            </button>
          `;
          list.appendChild(item);
        }
        
        function escapeHtml(text) {
          const div = document.createElement('div');
          div.textContent = text;
          return div.innerHTML;
        }
      });
    </script>
  {% endif %}
{% endblock %}
