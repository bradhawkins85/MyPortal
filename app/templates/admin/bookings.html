{% extends "base.html" %}

{% block content %}
<div class="content">
  <div class="page-header">
    <h1 class="page-header__title">Booking System</h1>
    <div class="page-header__actions">
      <a href="/admin/bookings/event-types/new" class="button button--primary">
        <span class="button__icon">+</span>
        New Event Type
      </a>
    </div>
  </div>

  {% if success_message %}
  <div class="alert alert--success" role="alert">
    {{ success_message }}
  </div>
  {% endif %}

  {% if error_message %}
  <div class="alert alert--error" role="alert">
    {{ error_message }}
  </div>
  {% endif %}

  <div class="tabs" data-tabs>
    <div class="tabs__header">
      <button class="tabs__tab tabs__tab--active" data-tab-trigger="event-types">
        Event Types
      </button>
      <button class="tabs__tab" data-tab-trigger="bookings">
        Bookings
      </button>
      <button class="tabs__tab" data-tab-trigger="webhooks">
        Webhooks
      </button>
    </div>

    <div class="tabs__panel tabs__panel--active" data-tab-panel="event-types">
      <div class="card">
        <div class="card__header">
          <h2 class="card__title">Event Types</h2>
          <p class="card__subtitle">Define meeting types with durations and availability rules</p>
        </div>
        <div class="card__body">
          {% if event_types %}
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Slug</th>
                  <th>Duration</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for event_type in event_types %}
                <tr>
                  <td>{{ event_type.title }}</td>
                  <td><code>{{ event_type.slug }}</code></td>
                  <td>{{ event_type.duration_minutes }} min</td>
                  <td>
                    <span class="badge {% if event_type.is_active %}badge--success{% else %}badge--muted{% endif %}">
                      {{ 'Active' if event_type.is_active else 'Inactive' }}
                    </span>
                  </td>
                  <td>
                    <div class="button-group">
                      <a href="/admin/bookings/event-types/{{ event_type.id }}/edit" class="button button--small">
                        Edit
                      </a>
                      <form method="post" action="/admin/bookings/event-types/{{ event_type.id }}/delete" style="display: inline;">
                        {% if csrf_token %}
                        <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                        {% endif %}
                        <button type="submit" class="button button--small button--danger" onclick="return confirm('Delete this event type?')">
                          Delete
                        </button>
                      </form>
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state">
            <p class="empty-state__message">No event types defined yet</p>
            <p class="empty-state__hint">Create an event type to start accepting bookings</p>
            <a href="/admin/bookings/event-types/new" class="button button--primary">
              Create Event Type
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="tabs__panel" data-tab-panel="bookings">
      <div class="card">
        <div class="card__header">
          <h2 class="card__title">Bookings</h2>
          <p class="card__subtitle">View and manage scheduled bookings</p>
        </div>
        <div class="card__body">
          {% if bookings %}
          <div class="table-container">
            <table class="table">
              <thead>
                <tr>
                  <th>Title</th>
                  <th>Attendee</th>
                  <th>Start Time</th>
                  <th>Duration</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for booking in bookings %}
                <tr>
                  <td>{{ booking.title }}</td>
                  <td>
                    {% if booking.attendees and booking.attendees|length > 0 %}
                      {{ booking.attendees[0].name }}<br>
                      <small class="text-muted">{{ booking.attendees[0].email }}</small>
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>{{ booking.start_time.strftime('%Y-%m-%d %H:%M') if booking.start_time else '—' }}</td>
                  <td>
                    {% if booking.start_time and booking.end_time %}
                      {{ ((booking.end_time - booking.start_time).total_seconds() / 60) | int }} min
                    {% else %}
                      —
                    {% endif %}
                  </td>
                  <td>
                    <span class="badge {% if booking.status == 'accepted' %}badge--success{% elif booking.status == 'cancelled' %}badge--muted{% else %}badge--warning{% endif %}">
                      {{ booking.status | capitalize }}
                    </span>
                  </td>
                  <td>
                    <div class="button-group">
                      <a href="/admin/bookings/{{ booking.id }}" class="button button--small">
                        View
                      </a>
                      {% if booking.status != 'cancelled' %}
                      <form method="post" action="/admin/bookings/{{ booking.id }}/cancel" style="display: inline;">
                        {% if csrf_token %}
                        <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                        {% endif %}
                        <button type="submit" class="button button--small button--danger" onclick="return confirm('Cancel this booking?')">
                          Cancel
                        </button>
                      </form>
                      {% endif %}
                    </div>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="empty-state">
            <p class="empty-state__message">No bookings yet</p>
            <p class="empty-state__hint">Bookings will appear here once they are created</p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="tabs__panel" data-tab-panel="webhooks">
      <div class="card">
        <div class="card__header">
          <h2 class="card__title">Webhooks</h2>
          <p class="card__subtitle">Configure webhook notifications for booking events</p>
        </div>
        <div class="card__body">
          <div class="alert alert--info" role="alert">
            <strong>Coming Soon:</strong> Webhook management interface will be available in the next release.
            Use the API endpoints at <code>/v2/webhooks</code> to manage webhooks programmatically.
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<style>
  .tabs {
    margin-top: 1.5rem;
  }
  
  .tabs__header {
    display: flex;
    gap: 0.5rem;
    border-bottom: 2px solid var(--color-border);
    margin-bottom: 1.5rem;
  }
  
  .tabs__tab {
    background: transparent;
    border: none;
    padding: 0.75rem 1.5rem;
    font-size: 0.875rem;
    font-weight: 500;
    color: var(--color-text-muted);
    cursor: pointer;
    border-bottom: 2px solid transparent;
    margin-bottom: -2px;
    transition: all 0.2s;
  }
  
  .tabs__tab:hover {
    color: var(--color-text);
  }
  
  .tabs__tab--active {
    color: var(--color-primary);
    border-bottom-color: var(--color-primary);
  }
  
  .tabs__panel {
    display: none;
  }
  
  .tabs__panel--active {
    display: block;
  }
  
  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
  }
  
  .empty-state__message {
    font-size: 1.125rem;
    font-weight: 500;
    margin-bottom: 0.5rem;
  }
  
  .empty-state__hint {
    color: var(--color-text-muted);
    margin-bottom: 1.5rem;
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    const tabsContainer = document.querySelector('[data-tabs]');
    if (!tabsContainer) return;
    
    const triggers = tabsContainer.querySelectorAll('[data-tab-trigger]');
    const panels = tabsContainer.querySelectorAll('[data-tab-panel]');
    
    triggers.forEach(trigger => {
      trigger.addEventListener('click', function() {
        const targetId = this.dataset.tabTrigger;
        
        // Update triggers
        triggers.forEach(t => t.classList.remove('tabs__tab--active'));
        this.classList.add('tabs__tab--active');
        
        // Update panels
        panels.forEach(panel => {
          if (panel.dataset.tabPanel === targetId) {
            panel.classList.add('tabs__panel--active');
          } else {
            panel.classList.remove('tabs__panel--active');
          }
        });
      });
    });
  });
</script>
{% endblock %}
