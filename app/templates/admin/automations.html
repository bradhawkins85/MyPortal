{% extends "base.html" %}

{% block content %}
  {% if success_message or error_message %}
    <div class="alert-stack">
      {% if success_message %}
        <div class="alert" role="status">{{ success_message }}</div>
      {% endif %}
      {% if error_message %}
        <div class="alert alert--error" role="alert">{{ error_message }}</div>
      {% endif %}
    </div>
  {% endif %}

  <div class="management" data-layout>
    <aside class="management__sidebar">
      <h2 class="management__heading">Automation workspace</h2>
      <p class="management__intro">Review configured automations and keep orchestration aligned with your operating cadence.</p>
      <div class="management__quick-actions">
        <a class="button button--primary" href="/admin/automations/create/scheduled">
          <span class="button__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false"><path d="M5 4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v1h2V4a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v2h1a1 1 0 0 1 0 2h-1v10a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V8H4a1 1 0 0 1 0-2h1zm2 2v10a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V6h-2v1a1 1 0 0 1-2 0V6H9v1a1 1 0 0 1-2 0V6zm5 5a1 1 0 0 1 1 1v2h2a1 1 0 1 1 0 2h-2v2a1 1 0 1 1-2 0v-2H9a1 1 0 1 1 0-2h2v-2a1 1 0 0 1 1-1z"/></svg>
          </span>
          Create scheduled automation
        </a>
        <a class="button button--ghost" href="/admin/automations/create/event">
          <span class="button__icon" aria-hidden="true">
            <svg viewBox="0 0 24 24" focusable="false"><path d="M12 2a3 3 0 0 1 2.83 2H18a2 2 0 0 1 2 2v3.17a2.99 2.99 0 0 1 0 5.66V18a2 2 0 0 1-2 2h-3.17A3 3 0 0 1 9 20H6a2 2 0 0 1-2-2v-3.17a3 3 0 0 1 0-5.66V6a2 2 0 0 1 2-2h3.17A3 3 0 0 1 12 2zm0 2a1 1 0 0 0-1 1v1.5a1 1 0 0 1-.76.97A3.01 3.01 0 0 0 7.47 9.3a1 1 0 0 1-.97.76H5a1 1 0 0 0-1 1v1.5a1 1 0 0 1 .76.97 3.01 3.01 0 0 0 1.77 2.83 1 1 0 0 1 .47.85V18a1 1 0 0 0 1 1h1.5a1 1 0 0 1 .97.76 3.01 3.01 0 0 0 3.46 0 1 1 0 0 1 .97-.76H15a1 1 0 0 0 1-1v-1.5a1 1 0 0 1 .76-.97 3.01 3.01 0 0 0 1.77-2.83 1 1 0 0 1 .47-.85H19a1 1 0 0 0 1-1V10a1 1 0 0 1-.76-.97 3.01 3.01 0 0 0-1.77-2.83 1 1 0 0 1-.47-.85V6a1 1 0 0 0-1-1h-1.5a1 1 0 0 1-.97-.76A3.01 3.01 0 0 0 12 4z"/></svg>
          </span>
          Create event automation
        </a>
      </div>
      <nav class="management__nav" aria-label="Automation navigation">
        <ul class="management__list">
          <li class="management__list-item management__list-item--current">
            <a class="management__nav-link" href="/admin/automations" aria-current="page">
              <span class="management__nav-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false"><path d="M5 5a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v1h2V5a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v2h1a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-3a2 2 0 0 1-2-2v-1h-2v1a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h1V10H7a2 2 0 0 1-2-2zm2 0v3h3V5zm7 0v3h3V5zm-7 11v3h3v-3zm7 0v3h3v-3z"/></svg>
              </span>
              <span class="management__nav-text">
                <span class="management__nav-title">Automation overview</span>
                <span class="management__nav-subtitle">List of configured workflows</span>
              </span>
            </a>
          </li>
          <li class="management__list-item">
            <a class="management__nav-link" href="/admin/automations/create/scheduled">
              <span class="management__nav-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false"><path d="M6 2a2 2 0 0 0-2 2v3a1 1 0 0 0 1 1h1v2H5a1 1 0 0 0-1 1v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8a1 1 0 0 0-1-1h-1V8h1a1 1 0 0 0 1-1V4a2 2 0 0 0-2-2h-3a2 2 0 0 0-2 2v1h-2V4a2 2 0 0 0-2-2zm0 6h12v7H6zm0 9v1h12v-1zm9-13h2v2h-2zm-9 0h2v2H6zm5 5a1 1 0 0 1 1 1v2h2a1 1 0 1 1 0 2h-2v2a1 1 0 1 1-2 0v-2H9a1 1 0 1 1 0-2h2V9a1 1 0 0 1 1-1z"/></svg>
              </span>
              <span class="management__nav-text">
                <span class="management__nav-title">Scheduled workflows</span>
                <span class="management__nav-subtitle">Create cadence-driven tasks</span>
              </span>
            </a>
          </li>
          <li class="management__list-item">
            <a class="management__nav-link" href="/admin/automations/create/event">
              <span class="management__nav-icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false"><path d="M12 2a3 3 0 0 1 3 3v.18a3 3 0 0 1 2.12 2.12H17a3 3 0 0 1 3 3v.18a3 3 0 0 1 0 5.03V16a3 3 0 0 1-3 3h-.18a3 3 0 0 1-2.12 2.12V21a3 3 0 0 1-6 0v-.88A3 3 0 0 1 7.12 19H7a3 3 0 0 1-3-3v-.67a3 3 0 0 1 0-4.66V9a3 3 0 0 1 3-3h.18A3 3 0 0 1 9.3 3.18V3a3 3 0 0 1 3-3zm0 2a1 1 0 0 0-1 1v1.5a1 1 0 0 1-.76.97 3 3 0 0 0-2.29 2.29 1 1 0 0 1-.97.76H7a1 1 0 0 0-1 1v1.5a1 1 0 0 1 .76.97 3 3 0 0 0 2.29 2.29 1 1 0 0 1 .97.76V17a1 1 0 0 0 1 1h1.5a1 1 0 0 1 .97.76 3 3 0 0 0 2.29 2.29 1 1 0 0 1 .76.97V23a1 1 0 0 0 2 0v-1.5a1 1 0 0 1 .76-.97 3 3 0 0 0 2.29-2.29 1 1 0 0 1 .97-.76H19a1 1 0 0 0 1-1v-1.5a1 1 0 0 1-.76-.97 3 3 0 0 0-2.29-2.29 1 1 0 0 1-.97-.76V9a1 1 0 0 0-1-1h-1.5a1 1 0 0 1-.97-.76 3 3 0 0 0-2.29-2.29 1 1 0 0 1-.76-.97V3a1 1 0 0 0-1-1z"/></svg>
              </span>
              <span class="management__nav-text">
                <span class="management__nav-title">Event-driven flows</span>
                <span class="management__nav-subtitle">Respond to inbound signals</span>
              </span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>

    <section class="management__content">
      <header class="management__header">
        <div>
          <h1 class="management__title">Automation orchestration</h1>
          <p class="management__subtitle">Review schedules, trigger conditions, and module connectivity for every automation workflow.</p>
        </div>
        <div class="management__header-actions">
          <a class="button button--primary" href="/admin/automations/create/scheduled">
            <span class="button__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false"><path d="M6 4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v1h2V4a2 2 0 0 1 2-2h3a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-1v2h1a2 2 0 0 1 2 2v3a2 2 0 0 1-2 2h-3a2 2 0 0 1-2-2v-1h-2v1a2 2 0 0 1-2 2H8a2 2 0 0 1-2-2v-3a2 2 0 0 1 2-2h1v-2H8a2 2 0 0 1-2-2zm2 0v3h3V4zm7 0v3h3V4zm-7 11v3h3v-3zm7 0v3h3v-3z"/></svg>
            </span>
            New scheduled automation
          </a>
          <a class="button button--ghost" href="/admin/automations/create/event">
            <span class="button__icon" aria-hidden="true">
              <svg viewBox="0 0 24 24" focusable="false"><path d="M12 2a3 3 0 0 1 3 3v.18a3 3 0 0 1 2.12 2.12H17a3 3 0 0 1 3 3v.18a3 3 0 0 1 0 5.03V16a3 3 0 0 1-3 3h-.18a3 3 0 0 1-2.12 2.12V21a3 3 0 0 1-6 0v-.88A3 3 0 0 1 7.12 19H7a3 3 0 0 1-3-3v-.67a3 3 0 0 1 0-4.66V9a3 3 0 0 1 3-3h.18A3 3 0 0 1 9.3 3.18V3a3 3 0 0 1 3-3z"/></svg>
            </span>
            New event automation
          </a>
        </div>
        <form method="get" class="management__filters">
          <label class="visually-hidden" for="automation-filter-status">Status</label>
          <select id="automation-filter-status" name="status" class="form-input">
            <option value="">All statuses</option>
            <option value="active" {% if automation_filters.status == 'active' %}selected{% endif %}>Active</option>
            <option value="inactive" {% if automation_filters.status == 'inactive' %}selected{% endif %}>Inactive</option>
          </select>
          <label class="visually-hidden" for="automation-filter-kind">Kind</label>
          <select id="automation-filter-kind" name="kind" class="form-input">
            <option value="">All kinds</option>
            <option value="scheduled" {% if automation_filters.kind == 'scheduled' %}selected{% endif %}>Scheduled</option>
            <option value="event" {% if automation_filters.kind == 'event' %}selected{% endif %}>Event</option>
          </select>
          <button type="submit" class="button">Apply filters</button>
        </form>
      </header>

      <div class="management__body">
        <div class="management__stats">
          <article class="stat-card">
            <h3 class="stat-card__title">Active</h3>
            <p class="stat-card__value">{{ automation_status_counts.get('active', 0) }}</p>
          </article>
          <article class="stat-card">
            <h3 class="stat-card__title">Inactive</h3>
            <p class="stat-card__value">{{ automation_status_counts.get('inactive', 0) }}</p>
          </article>
          <article class="stat-card">
            <h3 class="stat-card__title">Scheduled</h3>
            <p class="stat-card__value">{{ automation_kind_counts.get('scheduled', 0) }}</p>
          </article>
          <article class="stat-card">
            <h3 class="stat-card__title">Event driven</h3>
            <p class="stat-card__value">{{ automation_kind_counts.get('event', 0) }}</p>
          </article>
        </div>

        <div class="management__toolbar">
          <input type="search" class="form-input" placeholder="Filter automations" aria-label="Filter automations" data-table-filter="automations-table" />
        </div>

        <div class="table-wrapper">
          <table class="table" id="automations-table" data-table>
            <thead>
              <tr>
                <th scope="col" data-sort="int">ID</th>
                <th scope="col" data-sort="string">Name</th>
                <th scope="col" data-sort="string">Kind</th>
                <th scope="col" data-sort="string">Schedule</th>
                <th scope="col" data-sort="string">Module</th>
                <th scope="col" data-sort="string">Status</th>
                <th scope="col" data-sort="string">Next run</th>
                <th scope="col" data-sort="string">Last run</th>
                <th scope="col" class="table__actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if automations %}
                {% for automation in automations %}
                  <tr>
                    <td data-label="ID">{{ automation.id }}</td>
                    <td data-label="Name">{{ automation.name }}</td>
                    <td data-label="Kind">{{ automation.kind }}</td>
                    <td data-label="Schedule">
                      {% if automation.cron_expression %}
                        {{ automation.cron_expression }}
                      {% elif automation.cadence %}
                        {{ automation.cadence }}
                      {% else %}
                        —
                      {% endif %}
                    </td>
                    <td data-label="Module">
                      {% set trigger_actions = automation.action_payload.get('actions') if automation.action_payload else [] %}
                      {% if trigger_actions %}
                        {% if trigger_actions | length == 1 %}
                          {{ trigger_actions[0].module }}
                        {% else %}
                          {{ trigger_actions | length }} actions
                        {% endif %}
                      {% else %}
                        {{ automation.action_module or '—' }}
                      {% endif %}
                    </td>
                    <td data-label="Status">{{ automation.status }}</td>
                    <td data-label="Next run">{{ automation.next_run_at.astimezone().strftime('%Y-%m-%d %H:%M') if automation.next_run_at else '—' }}</td>
                    <td data-label="Last run">{{ automation.last_run_at.astimezone().strftime('%Y-%m-%d %H:%M') if automation.last_run_at else '—' }}</td>
                    <td class="table__actions">
                      <form action="/admin/automations/{{ automation.id }}/status" method="post" class="inline-form">
                        {% if csrf_token %}
                          <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                        {% endif %}
                        <label class="visually-hidden" for="automation-status-{{ automation.id }}">Status</label>
                        <select id="automation-status-{{ automation.id }}" name="status" class="form-input form-input--compact">
                          <option value="active" {% if automation.status == 'active' %}selected{% endif %}>Active</option>
                          <option value="inactive" {% if automation.status != 'active' %}selected{% endif %}>Inactive</option>
                        </select>
                        <button type="submit" class="button button--ghost">Update</button>
                      </form>
                      <form action="/admin/automations/{{ automation.id }}/execute" method="post" class="inline-form">
                        {% if csrf_token %}
                          <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                        {% endif %}
                        <button type="submit" class="button button--ghost">Run now</button>
                      </form>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="9" class="table__empty">No automations configured.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/automation.js" defer></script>
{% endblock %}
