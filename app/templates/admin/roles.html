{% extends "base.html" %}

{% block sidebar_menu %}
  {{ super() }}
  <li class="menu__item">
    <a href="/admin/memberships">
      <span class="menu__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false"><path d="M12 12a5 5 0 1 0-5-5 5 5 0 0 0 5 5zm0 2c-3.33 0-10 1.67-10 5v1h20v-1c0-3.33-6.67-5-10-5z"/></svg>
      </span>
      <span class="menu__label">Memberships</span>
    </a>
  </li>
  <li class="menu__item">
    <a href="/admin/roles" aria-current="page">
      <span class="menu__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false"><path d="M10.67 3.5a1 1 0 0 1 1.66 0l1.36 2.04a1 1 0 0 0 .63.43l2.35.5a1 1 0 0 1 .54 1.68l-1.67 1.8a1 1 0 0 0-.26.74l.2 2.4a1 1 0 0 1-1.4 1l-2.2-1a1 1 0 0 0-.84 0l-2.2 1a1 1 0 0 1-1.4-1l.2-2.4a1 1 0 0 0-.26-.74L6.39 8.15a1 1 0 0 1 .54-1.68l2.35-.5a1 1 0 0 0 .63-.43z"/></svg>
      </span>
      <span class="menu__label">Roles</span>
    </a>
  </li>
  <li class="menu__item">
    <a href="/admin/audit-logs">
      <span class="menu__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false"><path d="M5 4h14a1 1 0 0 1 1 1v15l-8-3-8 3V5a1 1 0 0 1 1-1z"/></svg>
      </span>
      <span class="menu__label">Audit trail</span>
    </a>
  </li>
{% endblock %}

{% block content %}
<div class="admin-grid">
  <section class="card card--panel">
    <header class="card__header">
      <div>
        <h2 class="card__title">Defined roles</h2>
        <p class="card__subtitle">Manage reusable permission sets for company memberships.</p>
      </div>
      <input
        type="search"
        class="form-input"
        placeholder="Filter roles"
        aria-label="Filter roles"
        data-table-filter="roles-table"
      />
    </header>
    <div class="table-wrapper">
      <table class="table" id="roles-table" data-table>
        <thead>
          <tr>
            <th scope="col" data-sort="string">Name</th>
            <th scope="col" data-sort="string">Description</th>
            <th scope="col" data-sort="string">Permissions</th>
            <th scope="col" data-sort="string">System</th>
            <th scope="col" class="table__actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for role in roles %}
            <tr
              data-role-id="{{ role.id }}"
              data-role-name="{{ role.name }}"
              data-role-description="{{ role.description or '' }}"
              data-role-permissions='{{ role.permissions | tojson }}'
              data-role-system="{{ 'true' if role.is_system else 'false' }}"
            >
              <td data-label="Name">{{ role.name }}</td>
              <td data-label="Description">{{ role.description or 'â€”' }}</td>
              <td data-label="Permissions">
                {% if role.permissions %}
                  <span class="tag-list">
                    {% for perm in role.permissions %}
                      <span class="tag">{{ perm }}</span>
                    {% endfor %}
                  </span>
                {% else %}
                  <span class="text-muted">None</span>
                {% endif %}
              </td>
              <td data-label="System">{{ 'Yes' if role.is_system else 'No' }}</td>
              <td class="table__actions">
                <div class="table__action-buttons">
                  <button type="button" class="button button--ghost" data-role-edit>Edit</button>
                  {% if not role.is_system %}
                    <button type="button" class="button button--danger" data-role-delete>Delete</button>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="5" class="table__empty">No roles have been defined yet.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>

  <section class="card card--panel">
    <header class="card__header">
      <div>
        <h2 class="card__title">Create or update a role</h2>
        <p class="card__subtitle">Editing a role updates permissions for every assigned member immediately.</p>
      </div>
    </header>
    <form id="role-form" class="form" autocomplete="off">
      <input type="hidden" name="role_id" id="role-id" />
      <div class="form-field">
        <label class="form-label" for="role-name">Role name</label>
        <input class="form-input" id="role-name" name="name" required minlength="2" maxlength="100" />
      </div>
      <div class="form-field">
        <label class="form-label" for="role-description">Description</label>
        <textarea class="form-input form-input--textarea" id="role-description" name="description" rows="3"></textarea>
      </div>
      <div class="form-field">
        <label class="form-label" for="role-permissions">Permissions</label>
        <input
          class="form-input"
          id="role-permissions"
          name="permissions"
          placeholder="membership.manage, audit.view"
          aria-describedby="role-permissions-help"
        />
        <p class="form-help" id="role-permissions-help">Provide a comma separated list of permission keys.</p>
      </div>
      <div class="form-actions">
        <button type="submit" class="button">Save role</button>
        <button type="button" class="button button--ghost" data-role-reset>Clear form</button>
      </div>
      <p class="form-hint">System roles cannot be deleted and their names are fixed to retain portal integrity.</p>
    </form>
  </section>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/admin.js" defer></script>
{% endblock %}
