{% extends "base.html" %}

{% block header_title %}
  {% set show_ticket_automations = is_super_admin %}
  {% set show_syncro_import = syncro_module_enabled and (is_super_admin or (is_helpdesk_technician | default(false))) %}
  {% set show_ticket_status_editor = is_super_admin %}
  {% set show_ticket_tools = show_ticket_automations or show_syncro_import or show_ticket_status_editor %}
  <div class="header-title-menu">
    <span class="header-title-menu__label">Ticketing workspace</span>
    {% if show_ticket_tools %}
      <details class="header-title-menu__dropdown" data-header-menu>
        <summary class="header-title-menu__toggle" data-header-menu-toggle aria-haspopup="true">
          Ticket tools
          <svg aria-hidden="true" focusable="false" viewBox="0 0 24 24" class="header-title-menu__icon">
            <path d="M6.2 8.2a1 1 0 0 1 1.4 0L12 12.6l4.4-4.4a1 1 0 0 1 1.4 1.4l-5.1 5.1a1 1 0 0 1-1.4 0L6.2 9.6a1 1 0 0 1 0-1.4z" />
          </svg>
          <span class="visually-hidden">Toggle ticket tools menu</span>
        </summary>
        <ul class="header-title-menu__list" role="menu">
          {% if show_ticket_automations %}
            <li class="header-title-menu__item" role="none">
              <a href="/admin/automations" class="header-title-menu__link" role="menuitem">Ticket automations</a>
            </li>
          {% endif %}
          {% if show_syncro_import %}
            <li class="header-title-menu__item" role="none">
              <a href="/admin/tickets/syncro-import" class="header-title-menu__link" role="menuitem">Syncro ticket import</a>
            </li>
          {% endif %}
          {% if show_ticket_status_editor %}
            <li class="header-title-menu__item" role="none">
              <button
                type="button"
                class="header-title-menu__link"
                role="menuitem"
                data-edit-ticket-statuses-open
                aria-haspopup="dialog"
                aria-controls="edit-ticket-statuses-modal"
              >
                Edit statuses
              </button>
            </li>
          {% endif %}
        </ul>
      </details>
    {% endif %}
  </div>
{% endblock %}

{% block content %}
  {% if success_message or error_message %}
    <div class="alert-stack">
      {% if success_message %}
        <div class="alert" role="status">{{ success_message }}</div>
      {% endif %}
      {% if error_message %}
        <div class="alert alert--error" role="alert">{{ error_message }}</div>
      {% endif %}
    </div>
  {% endif %}

  <div class="management management--single" data-layout>
    <section class="management__content">
      <header class="management__header">
        <div>
          <h1 class="management__title">Ticketing workspace</h1>
          <p class="management__subtitle">Monitor service demand, reply queues, and integration outcomes across connected modules.</p>
        </div>
        <div class="management__header-actions">
          <button
            type="button"
            class="button button--primary"
            data-create-ticket-modal-open
            aria-haspopup="dialog"
            aria-controls="create-ticket-modal"
          >
            New ticket
          </button>
        </div>
      </header>

      <div class="management__body">
        <div class="ticket-dashboard__overview">
          <form method="get" class="management__filters ticket-dashboard__filters">
            <label class="visually-hidden" for="ticket-filter-status">Status</label>
            <select id="ticket-filter-status" name="status" class="form-input">
              <option value="">All statuses</option>
              {% set status_namespace = namespace(seen=[]) %}
              {% for status_option in ticket_status_definitions %}
                {% set option_value = status_option.tech_status %}
                <option value="{{ option_value }}" {% if ticket_filters.status == option_value %}selected{% endif %}>{{ status_option.tech_label }}</option>
                {% set status_namespace.seen = status_namespace.seen + [option_value] %}
              {% endfor %}
              {% for status_option in ticket_available_statuses %}
                {% if status_option not in status_namespace.seen %}
                  {% set fallback_label = ticket_status_label_map.get(status_option, status_option.replace('_', ' ').title()) %}
                  <option value="{{ status_option }}" {% if ticket_filters.status == status_option %}selected{% endif %}>{{ fallback_label }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <label class="visually-hidden" for="ticket-filter-module">Module</label>
            <select id="ticket-filter-module" name="module" class="form-input">
              <option value="">All modules</option>
              {% for module in ticket_modules %}
                <option value="{{ module.slug }}" {% if ticket_filters.module == module.slug %}selected{% endif %}>{{ module.name }}</option>
              {% endfor %}
            </select>
            <button type="submit" class="button">Apply filters</button>
          </form>

          <div class="ticket-dashboard__stats management__stats" data-ticket-stats>
            <article class="stat-card">
              <h3 class="stat-card__title">Open tickets</h3>
              <p class="stat-card__value" data-ticket-stat="open">{{ ticket_status_counts.get('open', 0) }}</p>
            </article>
            <article class="stat-card">
              <h3 class="stat-card__title">In progress</h3>
              <p class="stat-card__value" data-ticket-stat="in_progress">
                {{ ticket_status_counts.get('in_progress', 0) + ticket_status_counts.get('pending', 0) }}
              </p>
            </article>
            <article class="stat-card">
              <h3 class="stat-card__title">Resolved</h3>
              <p class="stat-card__value" data-ticket-stat="resolved">
                {{ ticket_status_counts.get('resolved', 0) + ticket_status_counts.get('closed', 0) }}
              </p>
            </article>
            <article class="stat-card">
              <h3 class="stat-card__title">Total</h3>
              <p class="stat-card__value" data-ticket-stat="total">{{ ticket_total }}</p>
            </article>
          </div>
        </div>

        <div class="management__toolbar">
          <div class="management__toolbar-search">
            <input type="search" class="form-input" placeholder="Filter tickets" aria-label="Filter tickets" data-table-filter="tickets-table" />
          </div>
          {% if can_bulk_delete_tickets %}
            {% set current_query = request.url.query %}
            <form
              id="tickets-bulk-delete-form"
              action="/admin/tickets/bulk-delete"
              method="post"
              class="management__bulk-delete"
              data-bulk-delete-form
            >
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <input
                type="hidden"
                name="returnUrl"
                value="{{ request.url.path }}{% if current_query %}?{{ current_query }}{% endif %}"
              />
              <button type="submit" class="button button--danger" data-bulk-delete-submit disabled>
                Delete selected
              </button>
              <span class="text-muted" data-bulk-delete-count hidden>0 selected</span>
            </form>
          {% endif %}
        </div>

        <div class="table-wrapper">
          <table
            class="table tickets-table"
            id="tickets-table"
            data-table
            data-bulk-delete-table
            data-table-refresh-url="{{ ticket_dashboard_endpoint or '' }}"
            data-table-refresh-topics="{{ (ticket_refresh_topics or []) | join(',') }}"
            data-table-refresh-handler="tickets"
            data-table-refresh-success="Tickets updated."
            data-table-refresh-error="Unable to refresh tickets automatically."
            data-ticket-status-options='{{ ticket_status_definitions | tojson }}'
            data-csrf-token="{{ csrf_token or '' }}"
            data-can-bulk-delete="{{ 'true' if can_bulk_delete_tickets else 'false' }}"
            data-bulk-delete-form-id="tickets-bulk-delete-form"
            data-table-empty-label="No tickets found for the selected filters."
          >
            <thead>
              <tr>
                {% if can_bulk_delete_tickets %}
                  <th scope="col" class="table__select tickets-table__column tickets-table__column--select">
                    <input
                      type="checkbox"
                      aria-label="Select all tickets"
                      data-bulk-select-all
                      form="tickets-bulk-delete-form"
                    />
                  </th>
                {% endif %}
                <th scope="col" data-sort="int" class="tickets-table__column tickets-table__column--id">ID</th>
                <th
                  scope="col"
                  data-sort="string"
                  data-mobile-priority="essential"
                  class="tickets-table__column tickets-table__column--subject"
                >
                  Subject
                </th>
                <th scope="col" data-sort="string" class="tickets-table__column tickets-table__column--status">Status</th>
                <th scope="col" data-sort="string" class="tickets-table__column tickets-table__column--priority">Priority</th>
                <th scope="col" data-sort="string" class="tickets-table__column tickets-table__column--company">Company</th>
                <th scope="col" data-sort="string" class="tickets-table__column tickets-table__column--assigned">Assigned</th>
                <th scope="col" data-sort="string" class="tickets-table__column tickets-table__column--updated">Updated</th>
                <th scope="col" class="table__actions tickets-table__column tickets-table__column--actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if tickets %}
                {% set company_lookup = ticket_company_lookup or {} %}
                {% set user_lookup = ticket_user_lookup or {} %}
                {% for ticket in tickets %}
                  {% set company = company_lookup.get(ticket.company_id) %}
                  {% set assigned = user_lookup.get(ticket.assigned_user_id) %}
                  <tr>
                    {% if can_bulk_delete_tickets %}
                      <td data-label="Select" class="table__select tickets-table__cell tickets-table__cell--select">
                        <input
                          type="checkbox"
                          name="ticketIds"
                          value="{{ ticket.id }}"
                          aria-label="Select ticket {{ ticket.id }}"
                          data-bulk-delete-checkbox
                          form="tickets-bulk-delete-form"
                        />
                      </td>
                    {% endif %}
                    <td data-label="ID" class="tickets-table__cell tickets-table__cell--id">{{ ticket.id }}</td>
                    <td
                      data-label="Subject"
                      data-mobile-priority="essential"
                      class="tickets-table__cell tickets-table__cell--subject"
                    >
                      <a href="/admin/tickets/{{ ticket.id }}">{{ ticket.subject }}</a>
                    </td>
                    {% set ticket_status = (ticket.status or 'open') %}
                    {% set status_label = ticket_status_label_map.get(ticket_status, ticket_status.replace('_', ' ').title()) %}
                    {% set status_badge_map = {
                      'open': 'badge--warning',
                      'in_progress': 'badge--warning',
                      'pending': 'badge--warning',
                      'resolved': 'badge--success',
                      'closed': 'badge--muted'
                    } %}
                    <td data-label="Status" data-value="{{ ticket_status }}" class="tickets-table__cell tickets-table__cell--status">
                      <div class="ticket-status">
                        <span class="visually-hidden" id="ticket-status-label-{{ ticket.id }}">Ticket status</span>
                        <form
                          id="ticket-status-form-{{ ticket.id }}"
                          action="/admin/tickets/{{ ticket.id }}/status"
                          method="post"
                          class="inline-form ticket-status__form"
                          data-ticket-status-form
                          aria-labelledby="ticket-status-label-{{ ticket.id }}"
                        >
                          {% if csrf_token %}
                            <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                          {% endif %}
                          <label class="visually-hidden" for="ticket-status-{{ ticket.id }}">Status</label>
                          <select
                            id="ticket-status-{{ ticket.id }}"
                            name="status"
                            class="form-input form-input--compact"
                            data-ticket-status-select
                          >
                            {% if ticket_status not in ticket_status_label_map %}
                              <option value="{{ ticket_status }}" selected>{{ status_label }}</option>
                            {% endif %}
                            {% for status_option in ticket_status_definitions %}
                              <option value="{{ status_option.tech_status }}" {% if status_option.tech_status == ticket_status %}selected{% endif %}>{{ status_option.tech_label }}</option>
                            {% endfor %}
                          </select>
                        </form>
                      </div>
                    </td>
                    <td data-label="Priority" class="tickets-table__cell tickets-table__cell--priority">{{ ticket.priority or 'normal' }}</td>
                    <td data-label="Company" class="tickets-table__cell tickets-table__cell--company">{{ company.name if company else (ticket.company_id or '—') }}</td>
                    <td data-label="Assigned" class="tickets-table__cell tickets-table__cell--assigned">{{ assigned.email if assigned else '—' }}</td>
                    <td data-label="Updated" class="tickets-table__cell tickets-table__cell--updated">{{ ticket.updated_at.astimezone().strftime('%Y-%m-%d %H:%M') if ticket.updated_at else '—' }}</td>
                    <td class="table__actions tickets-table__cell tickets-table__cell--actions">
                      <a href="/admin/tickets/{{ ticket.id }}" class="button button--ghost">Open</a>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="{{ 9 + (1 if can_bulk_delete_tickets else 0) }}" class="table__empty">No tickets found for the selected filters.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <div
    class="modal"
    id="create-ticket-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="create-ticket-title"
    aria-hidden="true"
    hidden
  >
    <div class="modal__content" role="document">
      <button type="button" class="modal__close" data-modal-close>
        <span class="visually-hidden">Close create ticket form</span>
        &times;
      </button>
      <h2 class="modal__title" id="create-ticket-title">Create ticket</h2>
      <p class="modal__subtitle">Create a ticket that can be routed to automation modules or manual analysts.</p>
      <form action="/admin/tickets" method="post" class="form" autocomplete="off">
        {% include "partials/csrf.html" %}
        <div class="form-field">
          <label class="form-label" for="modal-ticket-subject">Subject</label>
          <input id="modal-ticket-subject" name="subject" class="form-input" maxlength="255" required />
        </div>
        <div class="form-field">
          <label class="form-label" for="modal-ticket-description">Description</label>
          <textarea
            id="modal-ticket-description"
            name="description"
            class="form-input form-input--textarea"
            rows="5"
            placeholder="Include the customer request or diagnostic notes"
          ></textarea>
        </div>
        <div class="form-grid">
          <div class="form-field">
            <label class="form-label" for="modal-ticket-priority">Priority</label>
            <select id="modal-ticket-priority" name="priority" class="form-input">
              <option value="urgent">Urgent</option>
              <option value="high">High</option>
              <option value="normal" selected>Normal</option>
              <option value="low">Low</option>
            </select>
          </div>
          <div class="form-field">
            <label class="form-label" for="modal-ticket-status">Initial status</label>
            <select id="modal-ticket-status" name="status" class="form-input">
              {% if ticket_status_definitions %}
                {% for status_option in ticket_status_definitions %}
                  <option value="{{ status_option.tech_status }}" {% if loop.first %}selected{% endif %}>{{ status_option.tech_label }}</option>
                {% endfor %}
              {% else %}
                <option value="open" selected>Open</option>
                <option value="in_progress">In progress</option>
                <option value="pending">Pending</option>
                <option value="resolved">Resolved</option>
                <option value="closed">Closed</option>
              {% endif %}
            </select>
          </div>
        </div>
        <div class="form-field">
          <label class="form-label" for="modal-ticket-module">Module</label>
          <select id="modal-ticket-module" name="moduleSlug" class="form-input">
            <option value="">Unassigned</option>
            {% for module in ticket_modules %}
              <option value="{{ module.slug }}">{{ module.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-field">
          <label class="form-label" for="modal-ticket-company">Company</label>
          <select id="modal-ticket-company" name="companyId" class="form-input">
            <option value="">Not linked</option>
            {% for company in ticket_company_options %}
              <option value="{{ company.id }}">{{ company.name }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-field">
          <label class="form-label" for="modal-ticket-assigned">Assign to</label>
          <select id="modal-ticket-assigned" name="assignedUserId" class="form-input">
            <option value="">Unassigned</option>
            {% for user in ticket_user_options %}
              <option value="{{ user.id }}">{{ user.email }}</option>
            {% endfor %}
          </select>
        </div>
        <div class="form-field">
          <label class="form-label" for="modal-ticket-category">Category</label>
          <input
            id="modal-ticket-category"
            name="category"
            class="form-input"
            maxlength="64"
            placeholder="Networking, onboarding, escalation…"
          />
        </div>
        <div class="form-field">
          <label class="form-label" for="modal-ticket-reference">External reference</label>
          <input
            id="modal-ticket-reference"
            name="externalReference"
            class="form-input"
            maxlength="128"
            placeholder="Syncro ID or external case"
          />
        </div>
        <div class="form-actions">
          <button type="submit" class="button button--primary">Create ticket</button>
          <button type="button" class="button button--ghost" data-modal-close>Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <div
    class="modal"
    id="edit-ticket-statuses-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="edit-ticket-statuses-title"
    aria-hidden="true"
    hidden
  >
    <div class="modal__content" role="document">
      <button type="button" class="modal__close" data-modal-close>
        <span class="visually-hidden">Close ticket status editor</span>
        &times;
      </button>
      <h2 class="modal__title" id="edit-ticket-statuses-title">Edit ticket statuses</h2>
      <p class="modal__subtitle">Define the technician-facing labels and public labels for each ticket status.</p>
      <div class="alert alert--error" role="alert" data-status-error hidden></div>
      <form action="/admin/tickets/statuses" method="post" class="form" data-ticket-statuses-form>
        {% include "partials/csrf.html" %}
        <div class="table-wrapper">
          <table class="table table--compact" data-ticket-statuses-table>
            <thead>
              <tr>
                <th scope="col">Tech status (technician label)</th>
                <th scope="col">Public status (customer label)</th>
                <th scope="col" class="table__actions">Actions</th>
              </tr>
            </thead>
            <tbody data-statuses-list>
              {% if ticket_status_definitions %}
                {% for status_option in ticket_status_definitions %}
                  <tr data-status-row>
                    <td data-label="Tech status">
                      <label class="visually-hidden" for="status-tech-{{ loop.index0 }}">Tech status</label>
                      <input
                        id="status-tech-{{ loop.index0 }}"
                        name="techLabel"
                        class="form-input"
                        maxlength="128"
                        value="{{ status_option.tech_label }}"
                        required
                      />
                      <input type="hidden" name="existingSlug" value="{{ status_option.tech_status }}" />
                    </td>
                    <td data-label="Public status">
                      <label class="visually-hidden" for="status-public-{{ loop.index0 }}">Public status</label>
                      <input
                        id="status-public-{{ loop.index0 }}"
                        name="publicLabel"
                        class="form-input"
                        maxlength="128"
                        value="{{ status_option.public_status }}"
                        required
                      />
                    </td>
                    <td class="table__actions">
                      <button
                        type="button"
                        class="button button--ghost"
                        data-status-remove
                        {% if ticket_status_definitions | length <= 1 %}disabled{% endif %}
                      >
                        Remove
                      </button>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr data-status-row>
                  <td data-label="Tech status">
                    <label class="visually-hidden" for="status-tech-0">Tech status</label>
                    <input id="status-tech-0" name="techLabel" class="form-input" maxlength="128" required />
                    <input type="hidden" name="existingSlug" value="" />
                  </td>
                  <td data-label="Public status">
                    <label class="visually-hidden" for="status-public-0">Public status</label>
                    <input id="status-public-0" name="publicLabel" class="form-input" maxlength="128" required />
                  </td>
                  <td class="table__actions">
                    <button type="button" class="button button--ghost" data-status-remove disabled>Remove</button>
                  </td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div class="form-actions form-actions--secondary">
          <button type="button" class="button button--ghost" data-add-status>Add status</button>
        </div>
        <div class="form-actions">
          <button type="submit" class="button button--primary">Save changes</button>
          <button type="button" class="button button--ghost" data-modal-close>Cancel</button>
        </div>
      </form>
      <template id="ticket-status-row-template">
        <tr data-status-row>
          <td data-label="Tech status">
            <label class="visually-hidden">Tech status</label>
            <input name="techLabel" class="form-input" maxlength="128" required />
            <input type="hidden" name="existingSlug" value="" />
          </td>
          <td data-label="Public status">
            <label class="visually-hidden">Public status</label>
            <input name="publicLabel" class="form-input" maxlength="128" required />
          </td>
          <td class="table__actions">
            <button type="button" class="button button--ghost" data-status-remove>Remove</button>
          </td>
        </tr>
      </template>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/admin.js" defer></script>
{% endblock %}

