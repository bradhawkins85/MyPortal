{% extends "base.html" %}

{% block content %}
  {% if success_message or error_message %}
    <div class="alert-stack">
      {% if success_message %}
        <div class="alert" role="status">{{ success_message }}</div>
      {% endif %}
      {% if error_message %}
        <div class="alert alert--error" role="alert">{{ error_message }}</div>
      {% endif %}
    </div>
  {% endif %}

  <div class="management management--single" data-layout>
    <section class="management__content">
      <header class="management__header">
        <div>
          <h1 class="management__title">Integration modules</h1>
          <p class="management__subtitle">Synchronise credentials and delivery endpoints for Syncro, Ollama, SMTP, TacticalRMM, ntfy, Uptime Kuma, and ChatGPT.</p>
        </div>
      </header>

      <div class="management__body management__body--cards">
        {% for module in modules %}
          {% set settings = module.settings or {} %}
          {% set module_feedback = ((success_message or '') ~ ' ' ~ (error_message or '')).lower() %}
          {% set highlight_module = module.slug == 'syncro' and 'syncro' in module_feedback %}
          <details class="card card--panel card-collapsible" data-module-card id="module-{{ module.slug }}" {% if highlight_module %}open{% endif %}>
            <summary class="card__header card__header--collapsible card__header--module-summary">
              <span class="card__module-icon card__module-icon--summary" aria-hidden="true">
                {{ module.icon or 'ðŸ”Œ' }}
              </span>
              <h2 class="card__title">{{ module.name }}</h2>
              <div class="card__collapsible-meta">
                <span
                  class="badge {{ 'badge--success' if module.enabled else 'badge--danger' }}"
                  aria-label="Module status"
                >
                  {{ 'Enabled' if module.enabled else 'Disabled' }}
                </span>
                <span class="card__toggle-icon" aria-hidden="true"></span>
              </div>
            </summary>
            <div class="card-collapsible__content">
              {% if module.slug == 'syncro' %}
                {% set syncro_is_ready = module.enabled %}
                <div class="alert-stack" data-syncro-company-import-status hidden></div>
              {% endif %}
              <header class="card__header card__header--module card__header--module-expanded">
                <div class="card__module-info">
                  <p class="card__subtitle">{{ module.description }}</p>
                </div>
                <div class="card__module-actions">
                  <form action="/admin/modules/{{ module.slug }}/test" method="post" class="card__module-test">
                    {% if csrf_token %}
                      <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                    {% endif %}
                    <button type="submit" class="button button--ghost button--small">Run test</button>
                  </form>
                </div>
              </header>
              <form action="/admin/modules/{{ module.slug }}" method="post" class="form card__form">
              {% if csrf_token %}
                <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
              {% endif %}
              <div class="form-field form-field--checkbox">
                <label class="toggle">
                  <input type="checkbox" name="enabled" value="1" {% if module.enabled %}checked{% endif %} />
                  <span>Module enabled</span>
                </label>
              </div>

              {% if module.slug == 'syncro' %}
                <div class="form-field">
                  <label class="form-label" for="syncro-base-url">Base URL</label>
                  <input id="syncro-base-url" name="settings.base_url" class="form-input" value="{{ settings.base_url or '' }}" placeholder="https://example.syncromsp.com" />
                  <p class="form-help">Enter the Syncro tenant base URL without the trailing <code>/api/v1</code>.</p>
                </div>
                <div class="form-field">
                  <label class="form-label" for="syncro-api-key">API key</label>
                  <input id="syncro-api-key" name="settings.api_key" class="form-input" type="password" autocomplete="off" placeholder="Enter a new API key" />
                  <p class="form-help">Keys are stored securely. Leave blank to keep the existing value.</p>
                </div>
                <div class="form-field">
                  <label class="form-label" for="syncro-rate-limit">Rate limit (requests per minute)</label>
                  <input id="syncro-rate-limit" name="settings.rate_limit_per_minute" class="form-input" type="number" min="1" max="600" value="{{ settings.rate_limit_per_minute or 180 }}" />
                </div>
              {% elif module.slug == 'ollama' %}
                <div class="form-field">
                  <label class="form-label" for="ollama-base-url">Base URL</label>
                  <input id="ollama-base-url" name="settings.base_url" class="form-input" value="{{ settings.base_url or '' }}" placeholder="http://127.0.0.1:11434" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="ollama-model">Model</label>
                  <input id="ollama-model" name="settings.model" class="form-input" value="{{ settings.model or '' }}" placeholder="llama3" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="ollama-prompt">Prompt</label>
                  <textarea id="ollama-prompt" name="settings.prompt" class="form-input" rows="3" placeholder="Override summary instructions">{{ settings.prompt or '' }}</textarea>
                </div>
              {% elif module.slug == 'smtp' %}
                <div class="form-field">
                  <label class="form-label" for="smtp-from">From address</label>
                  <input id="smtp-from" name="settings.from_address" class="form-input" value="{{ settings.from_address or '' }}" placeholder="no-reply@example.com" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="smtp-recipients">Default recipients (comma separated)</label>
                  <input id="smtp-recipients" name="settings.default_recipients" class="form-input" value="{{ ', '.join(settings.default_recipients) if settings.default_recipients else '' }}" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="smtp-prefix">Subject prefix</label>
                  <input id="smtp-prefix" name="settings.subject_prefix" class="form-input" value="{{ settings.subject_prefix or '' }}" />
                </div>
              {% elif module.slug == 'imap' %}
                <p class="form-help">Manage mailbox credentials, folders, and schedules from the dedicated IMAP workspace.</p>
                <div class="form-actions">
                  <a class="button" href="{{ settings.manage_url or '/admin/modules/imap' }}">Open IMAP workspace</a>
                </div>
              {% elif module.slug == 'tacticalrmm' %}
                <div class="form-field">
                  <label class="form-label" for="rmm-base-url">Base URL</label>
                  <input id="rmm-base-url" name="settings.base_url" class="form-input" value="{{ settings.base_url or '' }}" placeholder="https://rmm.example.com" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="rmm-api-key">API key</label>
                  <input
                    id="rmm-api-key"
                    name="settings.api_key"
                    class="form-input"
                    type="password"
                    autocomplete="off"
                    placeholder="Enter a new API key"
                  />
                  <p class="form-help">Keys are stored securely. Leave blank to keep the existing value.</p>
                </div>
                <div class="form-field form-field--checkbox">
                  <label class="checkbox">
                    <input type="checkbox" name="settings.verify_ssl" value="true" {% if settings.verify_ssl is not defined or settings.verify_ssl %}checked{% endif %} />
                    <span>Verify SSL certificates</span>
                  </label>
                </div>
              {% elif module.slug == 'ntfy' %}
                <div class="form-field">
                  <label class="form-label" for="ntfy-base-url">Base URL</label>
                  <input id="ntfy-base-url" name="settings.base_url" class="form-input" value="{{ settings.base_url or '' }}" placeholder="https://ntfy.sh" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="ntfy-topic">Topic</label>
                  <input id="ntfy-topic" name="settings.topic" class="form-input" value="{{ settings.topic or '' }}" placeholder="service-alerts" />
                </div>
                <div class="form-field">
                  <label class="form-label" for="ntfy-token">Auth token</label>
                  <input
                    id="ntfy-token"
                    name="settings.auth_token"
                    class="form-input"
                    type="password"
                    autocomplete="off"
                    placeholder="Enter a new auth token"
                  />
                  <p class="form-help">Tokens are stored securely. Leave blank to keep the existing value.</p>
                </div>
              {% elif module.slug == 'uptimekuma' %}
                <div class="form-field">
                  <label class="form-label" for="uptimekuma-webhook">Webhook URL</label>
                  <input id="uptimekuma-webhook" class="form-input" value="{{ request.url_for('uptimekuma_receive_alert') }}" readonly />
                  <p class="form-help">Configure this endpoint as the HTTP POST target inside Uptime Kuma.</p>
                </div>
                <div class="form-field">
                  <label class="form-label" for="uptimekuma-secret">Shared secret</label>
                  <input id="uptimekuma-secret" name="settings.shared_secret" class="form-input" type="password" autocomplete="off" placeholder="Enter a new shared secret" />
                  <p class="form-help">Secrets are stored as SHA-256 hashes. Provide the same value as a <code>Bearer</code> token or <code>?token=</code> query in Uptime Kuma.</p>
                </div>
              {% elif module.slug == 'chatgpt-mcp' %}
                <div class="form-field">
                  <label class="form-label" for="chatgpt-secret">Shared secret</label>
                  <input id="chatgpt-secret" name="settings.shared_secret" class="form-input" type="password" autocomplete="off" placeholder="Enter a new shared secret" />
                  <p class="form-help">Secrets are stored as SHA-256 hashes. Leave blank to keep the existing value.</p>
                </div>
                <fieldset class="form-field">
                  <legend class="form-label">Enabled tools</legend>
                  <div class="form-field__group form-field__group--stacked">
                    {% set available_tools = ['listTickets', 'getTicket', 'createTicketReply', 'updateTicket'] %}
                    {% for tool in available_tools %}
                      <label class="checkbox">
                        <input type="checkbox" name="settings.allowed_actions" value="{{ tool }}" {% if settings.allowed_actions and tool in settings.allowed_actions %}checked{% endif %} />
                        <span>{{ tool }}</span>
                      </label>
                    {% endfor %}
                  </div>
                </fieldset>
                <div class="form-field">
                  <label class="form-label" for="chatgpt-max-results">Maximum tickets returned</label>
                  <input id="chatgpt-max-results" name="settings.max_results" class="form-input" type="number" min="1" max="200" value="{{ settings.max_results or 50 }}" />
                </div>
                <div class="form-field form-field--checkbox">
                  <label class="toggle">
                    <input type="checkbox" name="settings.allow_ticket_updates" value="true" {% if settings.allow_ticket_updates %}checked{% endif %} />
                    <span>Allow ChatGPT to update tickets</span>
                  </label>
                </div>
                <div class="form-field">
                  <label class="form-label" for="chatgpt-statuses">Allowed ticket statuses</label>
                  <input id="chatgpt-statuses" name="settings.allowed_statuses" class="form-input" value="{{ settings.allowed_statuses|join(', ') if settings.allowed_statuses else '' }}" placeholder="open, pending, in_progress" />
                  <p class="form-help">Comma-separated list used to validate update requests.</p>
                </div>
                <div class="form-field">
                  <label class="form-label" for="chatgpt-system-user">Default reply author (user ID)</label>
                  <input id="chatgpt-system-user" name="settings.system_user_id" class="form-input" value="{{ settings.system_user_id or '' }}" placeholder="123" />
                  <p class="form-help">The ticket reply author when ChatGPT posts updates. Override per request by sending author_id.</p>
                </div>
              {% else %}
                {% for key, value in settings.items() %}
                  <div class="form-field">
                    <label class="form-label">{{ key }}</label>
                    <input class="form-input" name="settings.{{ key }}" value="{{ value }}" />
                  </div>
                {% endfor %}
              {% endif %}
              <div class="form-actions">
                <button type="submit" class="button button--primary">Update module</button>
              </div>
            </form>
            {% if module.slug == 'syncro' %}
              <form
                action="/admin/syncro/import-companies"
                method="post"
                class="form card__form"
                data-syncro-company-import
              >
                {% if csrf_token %}
                  <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                {% endif %}
                <div class="form-field">
                  <p class="form-help">
                    Pull the complete Syncro customer list. Existing companies are matched by Syncro ID or name
                    and updated in place.
                  </p>
                </div>
                <div class="form-field">
                  <p class="form-help">
                    The importer will create new companies, update addresses, and attach Syncro identifiers where
                    missing.
                  </p>
                </div>
                {% if not syncro_is_ready %}
                  <div class="form-field">
                    <p class="form-help form-help--error">
                      Enable the Syncro module and configure the base URL and API key before running imports.
                    </p>
                  </div>
                {% endif %}
                <div class="form-actions">
                  <button
                    type="submit"
                    class="button button--secondary"
                    {% if not syncro_is_ready %}disabled{% endif %}
                  >
                    Import Syncro companies
                  </button>
                </div>
              </form>
            {% endif %}
            {% if module.slug == 'tacticalrmm' %}
              <form action="/admin/modules/tacticalrmm/push-companies" method="post" class="form card__form">
                {% if csrf_token %}
                  <input type="hidden" name="_csrf" value="{{ csrf_token }}" />
                {% endif %}
                <div class="form-field">
                  <p class="form-help">
                    Push all companies from My Portal to Tactical RMM. Missing clients will be created with a
                    <strong>Default</strong> site, and existing clients gain the Default site when absent.
                  </p>
                </div>
                <div class="form-actions">
                  <button type="submit" class="button button--secondary">Push companies to Tactical RMM</button>
                </div>
              </form>
            {% endif %}
            </div>
          </details>
        {% endfor %}
      </div>
    </section>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/admin.js" defer></script>
{% endblock %}

