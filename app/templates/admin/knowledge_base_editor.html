{% extends "base.html" %}

{% set scope_labels = {
  "anonymous": "Public",
  "user": "Specific users",
  "company": "Company members",
  "company_admin": "Company admins",
  "super_admin": "Super admins"
} %}

{% set editor_heading = 'Compose article' %}
{% if kb_initial_article %}
  {% set heading_source = kb_initial_article.title or kb_initial_article.slug %}
  {% set editor_heading = 'Edit “' ~ heading_source ~ '”' %}
{% endif %}

{% block header_actions %}
  <a class="button button--ghost" href="/admin/knowledge-base">
    <span class="button__icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" focusable="false"><path d="M15.707 5.293a1 1 0 0 1 0 1.414L11.414 11H20a1 1 0 1 1 0 2h-8.586l4.293 4.293a1 1 0 0 1-1.414 1.414l-6-6a1 1 0 0 1 0-1.414l6-6a1 1 0 0 1 1.414 0z"/></svg>
    </span>
    <span class="button__label">Back to catalogue</span>
  </a>
  {% if kb_initial_article and kb_initial_article.slug %}
    <a class="button" href="/knowledge-base?slug={{ kb_initial_article.slug }}" target="_blank" rel="noopener noreferrer">
      <span class="button__icon" aria-hidden="true">
        <svg viewBox="0 0 24 24" focusable="false"><path d="M5 5a3 3 0 0 1 3-3h11a3 3 0 0 1 3 3v11a3 3 0 0 1-3 3h-3v-2h3a1 1 0 0 0 1-1V5a1 1 0 0 0-1-1H8a1 1 0 0 0-1 1v3H5V5zm-2 6a3 3 0 0 1 3-3h7a3 3 0 0 1 3 3v7a3 3 0 0 1-3 3H6a3 3 0 0 1-3-3v-7zm3-1a1 1 0 0 0-1 1v7a1 1 0 0 0 1 1h7a1 1 0 0 0 1-1v-7a1 1 0 0 0-1-1H6z"/></svg>
      </span>
      <span class="button__label">View article</span>
    </a>
  {% endif %}
{% endblock %}

{% block content %}
<div class="kb-admin">
  <div class="kb-admin__grid">
    <section class="card card--panel kb-admin__panel" data-kb-editor>
      <header class="card__header card__header--stacked">
        <div>
          <h2 class="card__title" data-kb-editor-title>{{ editor_heading }}</h2>
          <p class="card__subtitle">Draft new knowledge base entries or update existing content with granular visibility controls.</p>
        </div>
        <div class="card__controls">
          <label class="switch">
            <input type="checkbox" id="kb-article-published" />
            <span class="switch__label">Published</span>
          </label>
        </div>
      </header>
      <form id="kb-article-form" class="form-grid form-grid--vertical" autocomplete="off" data-kb-mode="{{ kb_form_mode }}">
        <input type="hidden" id="kb-article-id" />
        <div class="form-field">
          <label class="form-label" for="kb-article-slug">Slug</label>
          <input class="form-input" id="kb-article-slug" name="slug" required minlength="1" maxlength="191" />
          <p class="form-help">Use a unique, URL-friendly slug. Existing links update automatically after saving changes.</p>
        </div>
        <div class="form-field">
          <label class="form-label" for="kb-article-title">Title</label>
          <input class="form-input" id="kb-article-title" name="title" required maxlength="255" />
        </div>
        <div class="form-field">
          <label class="form-label" for="kb-article-summary">Summary</label>
          <textarea class="form-input form-input--textarea" id="kb-article-summary" name="summary" rows="3" maxlength="2000"></textarea>
          <p class="form-help">Summaries appear beside article titles and improve search relevance.</p>
        </div>
        <div class="form-field form-field--wide">
          <div class="kb-admin__sections-header">
            <label class="form-label" for="kb-article-sections">Sections</label>
            <button type="button" class="button button--ghost" data-kb-add-section>
              <span class="button__icon" aria-hidden="true">
                <svg viewBox="0 0 24 24" focusable="false"><path d="M11 5a1 1 0 0 1 2 0v6h6a1 1 0 0 1 0 2h-6v6a1 1 0 0 1-2 0v-6H5a1 1 0 0 1 0-2h6z"/></svg>
              </span>
              <span class="button__label">Add section</span>
            </button>
          </div>
          <p class="form-help">Compose rich content in ordered sections. Drag the toolbar buttons to format text, add lists, or insert links. Reorder or delete sections without losing content.</p>
          <div class="kb-admin__sections" id="kb-article-sections" data-kb-sections>
            <p class="kb-admin__sections-empty" data-kb-sections-empty>No sections added yet. Start by creating the introduction.</p>
          </div>
        </div>
        <div class="form-field">
          <label class="form-label" for="kb-article-scope">Permission scope</label>
          <select class="form-input" id="kb-article-scope" name="permission_scope">
            <option value="anonymous">Public</option>
            <option value="user">Specific users</option>
            <option value="company">Company members</option>
            <option value="company_admin">Company admins</option>
            <option value="super_admin">Super admins</option>
          </select>
          <p class="form-help kb-admin__scope-help" data-kb-scope-help>Public articles are visible to anyone with the URL.</p>
        </div>
        <div class="form-field" data-kb-user-select hidden>
          <label class="form-label" for="kb-article-users">Allow specific users</label>
          <select class="form-input" id="kb-article-users" name="allowed_user_ids" multiple size="6"></select>
          <p class="form-help">Hold Ctrl (Windows) or Command (macOS) to select multiple users. Leave empty to revoke access.</p>
        </div>
        <div class="form-field" data-kb-company-select hidden>
          <label class="form-label" for="kb-article-companies">Allow specific companies</label>
          <select class="form-input" id="kb-article-companies" name="allowed_company_ids" multiple size="6"></select>
          <p class="form-help" data-kb-company-help>Leave empty to grant access to every company membership within the selected scope.</p>
        </div>
        <div class="form-actions">
          <button type="submit" class="button" data-kb-save>Save article</button>
          <button type="button" class="button button--ghost" data-kb-reset>Reset</button>
          <button type="button" class="button button--danger" data-kb-delete hidden>Delete</button>
        </div>
        <p class="form-help kb-admin__status" role="status" aria-live="polite" data-kb-status></p>
      </form>
    </section>

    <section class="card card--panel kb-admin__panel">
      <header class="card__header card__header--stacked">
        <div>
          <h2 class="card__title">Preview &amp; metadata</h2>
          <p class="card__subtitle">Inspect the rendered article, confirm scopes, and verify timestamps before publishing.</p>
        </div>
        <div class="kb-admin__meta" data-kb-preview-meta></div>
      </header>
      <div class="card__body kb-admin__preview" data-kb-preview>
        <p class="text-muted">Compose sections to preview the article content here.</p>
      </div>
    </section>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="application/json" id="kb-admin-articles">{{ kb_catalogue_payload | tojson }}</script>
  <script type="application/json" id="kb-admin-user-options">{{ kb_user_options | tojson }}</script>
  <script type="application/json" id="kb-admin-company-options">{{ kb_company_options | tojson }}</script>
  <script type="application/json" id="kb-admin-active-article">{{ kb_initial_article | tojson }}</script>
  <script src="/static/js/knowledge_base_admin.js" defer></script>
{% endblock %}
