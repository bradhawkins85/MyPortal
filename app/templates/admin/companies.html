{% extends "base.html" %}

{% block content %}
  {% if error_message or success_message %}
    <div class="stacked" style="margin-bottom: 1.5rem; gap: 1rem;">
      {% if success_message %}
        <div class="alert" role="status">{{ success_message }}</div>
      {% endif %}
      {% if error_message %}
        <div class="alert alert--error" role="alert">{{ error_message }}</div>
      {% endif %}
    </div>
  {% endif %}

  <div class="admin-grid admin-grid--columns">
    {% if is_super_admin %}
      <section class="card card--panel admin-grid__full">
        <header class="card__header">
          <div class="stacked">
            <h2 class="card__title">Companies</h2>
            <p class="card__subtitle">Review the customer directory and open a company to edit identifiers or VIP status.</p>
          </div>
          <div class="card__controls">
            <input
              type="search"
              class="form-input card__control"
              placeholder="Filter companies"
              aria-label="Filter companies"
              data-table-filter="companies-table"
            />
            <button
              type="button"
              class="button"
              data-add-company-modal-open
              aria-haspopup="dialog"
              aria-controls="add-company-modal"
            >
              Add Company
            </button>
          </div>
        </header>
        <div class="table-wrapper">
          <table class="table" id="companies-table" data-table data-page-size-max="25">
            <thead>
              <tr>
                <th scope="col" data-sort="string">Name</th>
                <th scope="col" data-sort="string">Syncro ID</th>
                <th scope="col" data-sort="string">Xero ID</th>
                <th scope="col" data-sort="string">Email domains</th>
                <th scope="col" data-sort="number">VIP</th>
                <th scope="col" class="table__actions">Actions</th>
              </tr>
            </thead>
            <tbody>
              {% if managed_companies %}
                {% for company in managed_companies %}
                  <tr>
                    <td data-label="Name">{{ company.name }}</td>
                    <td data-label="Syncro ID" data-value="{{ company.syncro_company_id or '' }}">
                      {% if company.syncro_company_id %}
                        {{ company.syncro_company_id }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td data-label="Xero ID" data-value="{{ company.xero_id or '' }}">
                      {% if company.xero_id %}
                        {{ company.xero_id }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    <td data-label="Email domains" data-value="{{ company.email_domains | join(', ') }}">
                      {% if company.email_domains %}
                        {{ company.email_domains | join(', ') }}
                      {% else %}
                        <span class="text-muted">—</span>
                      {% endif %}
                    </td>
                    {% set is_vip = 1 if company.is_vip else 0 %}
                    <td data-label="VIP" data-value="{{ is_vip }}">
                      {% if company.is_vip %}
                        <span class="tag tag--success">VIP</span>
                      {% else %}
                        <span class="tag tag--muted">Standard</span>
                      {% endif %}
                    </td>
                    <td class="table__actions">
                      <div class="table__action-buttons">
                        <a class="button button--ghost" href="/admin/companies/{{ company.id }}/edit">
                          Edit
                        </a>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              {% else %}
                <tr>
                  <td colspan="6" class="table__empty">No companies have been registered.</td>
                </tr>
              {% endif %}
            </tbody>
          </table>
        </div>
        <div class="table-pagination" data-pagination="companies-table">
          <div class="table-pagination__group">
            <button
              type="button"
              class="button button--ghost table-pagination__button"
              data-page-prev
              disabled
            >
              Previous
            </button>
            <button
              type="button"
              class="button button--ghost table-pagination__button"
              data-page-next
            >
              Next
            </button>
          </div>
          <p class="table-pagination__status" data-page-info aria-live="polite"></p>
        </div>
      </section>
      <div
        class="modal"
        id="add-company-modal"
        role="dialog"
        aria-modal="true"
        aria-labelledby="add-company-title"
        aria-hidden="true"
        hidden
      >
        <div class="modal__content" role="document">
          <button type="button" class="modal__close" data-modal-close>
            <span class="visually-hidden">Close add company form</span>
            &times;
          </button>
          <h2 class="modal__title" id="add-company-title">Add a company</h2>
          <p class="modal__subtitle">Create a new customer record with optional Syncro and Xero identifiers.</p>
          <form action="/admin/companies" method="post" class="form" autocomplete="off">
            {% include "partials/csrf.html" %}
            <div class="form-field">
              <label class="form-label" for="company-name">Company name</label>
              <input id="company-name" name="name" class="form-input" required maxlength="255" />
            </div>
            <div class="form-field">
              <label class="form-label" for="company-syncro">Syncro company ID</label>
              <input id="company-syncro" name="syncroCompanyId" class="form-input" maxlength="255" />
            </div>
            <div class="form-field">
              <label class="form-label" for="company-xero">Xero ID</label>
              <input id="company-xero" name="xeroId" class="form-input" maxlength="255" />
            </div>
            <div class="form-field">
              <label class="form-label" for="company-email-domains">Email domains</label>
              <textarea
                id="company-email-domains"
                name="emailDomains"
                class="form-input form-input--textarea"
                rows="2"
                placeholder="example.com, example.org"
              ></textarea>
              <p class="form-help">Use commas or new lines to list domains for automatic company matching.</p>
            </div>
            <div class="form-field form-field--checkbox">
              <label class="checkbox" for="company-vip">
                <input id="company-vip" type="checkbox" name="isVip" value="1" />
                <span>VIP pricing</span>
              </label>
            </div>
            <div class="form-actions">
              <button type="submit" class="button">Create company</button>
            </div>
          </form>
        </div>
      </div>
    {% endif %}

    {% if is_super_admin and user_options and managed_companies %}
      <section class="card card--panel admin-grid__full">
        <header class="card__header card__header--stacked">
          <div>
            <h2 class="card__title">Assign staff access</h2>
            <p class="card__subtitle">
              Grant or update company permissions for existing team members without sending invitations.
            </p>
          </div>
        </header>
        <form action="/admin/companies/assign" method="post" class="form-grid" autocomplete="off">
          {% include "partials/csrf.html" %}
          <div class="form-field">
            <label class="form-label" for="assign-user">User</label>
            <select id="assign-user" name="userId" class="form-input" required>
              <option value="" disabled selected>Select a user</option>
              {% for option in user_options %}
                <option value="{{ option.id }}">{{ option.email }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-field">
            <label class="form-label" for="assign-company">Company</label>
            <select id="assign-company" name="companyId" class="form-input" required>
              {% for company in managed_companies %}
                <option value="{{ company.id }}" {% if company.id == selected_company_id %}selected{% endif %}>
                  {{ company.name }}
                </option>
              {% endfor %}
            </select>
          </div>
          {% if role_options %}
            <div class="form-field">
              <label class="form-label" for="assign-role">Membership role</label>
              <select id="assign-role" name="role_id" class="form-input">
                <option value="">Default membership role</option>
                {% for role in role_options %}
                  <option value="{{ role.id }}">{{ role.name }}</option>
                {% endfor %}
              </select>
            </div>
          {% endif %}
          <div class="form-field">
            <label class="form-label" for="assign-staff-permission">Staff access level</label>
            <select id="assign-staff-permission" name="staffPermission" class="form-input">
              {% for option in staff_permission_options %}
                <option value="{{ option.value }}">{{ option.label }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="form-field form-field--checkbox">
            <label class="checkbox" for="assign-manage-staff">
              <input id="assign-manage-staff" type="checkbox" name="can_manage_staff" value="1" />
              <span>Allow manual staff management</span>
            </label>
            <p class="form-help">
              Enable to give management controls without requiring an elevated staff access tier.
            </p>
          </div>
          <div class="form-field form-field--wide">
            <span class="form-label">Company permissions</span>
            <div class="form-grid">
              {% for column in permission_columns %}
                <div class="form-field form-field--checkbox">
                  <label class="checkbox" for="assign-{{ column.field }}">
                    <input id="assign-{{ column.field }}" type="checkbox" name="{{ column.field }}" value="1" />
                    <span>{{ column.label }}</span>
                  </label>
                </div>
              {% endfor %}
            </div>
          </div>
          <div class="form-actions form-field--wide">
            <button type="submit" class="button">Save access</button>
          </div>
        </form>
      </section>
    {% endif %}

  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/admin.js" defer></script>
{% endblock %}
