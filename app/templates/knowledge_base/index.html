{% extends "base.html" %}

{% set scope_labels = {
  "anonymous": "Public",
  "user": "Specific users",
  "company": "Company members",
  "company_admin": "Company admins",
  "super_admin": "Super admins"
} %}

{% block title %}Knowledge base{% endblock %}

{% block header_title %}
  <span class="header__title-text">Knowledge base</span>
{% endblock %}

{% block sidebar_menu %}
  {% if has_authenticated_user %}
    {{ super() }}
  {% else %}
    <li class="menu__item">
      <a href="/login">
        <span class="menu__icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false"><path d="M10 4h10a1 1 0 0 1 1 1v14a1 1 0 0 1-1 1H10a1 1 0 0 1-1-1v-3h2v2h8V6h-8v2H9V5a1 1 0 0 1 1-1zm-1.707 7.293 2.586-2.586L12.293 10.12 10.414 12l1.879 1.879-1.414 1.414-2.586-2.586a1 1 0 0 1 0-1.414z"/></svg>
        </span>
        <span class="menu__label">Sign in</span>
      </a>
    </li>
    <li class="menu__item">
      <a href="/knowledge-base" aria-current="page">
        <span class="menu__icon" aria-hidden="true">
          <svg viewBox="0 0 24 24" focusable="false"><path d="M6 3a3 3 0 0 1 3-3h9a2 2 0 0 1 2 2v19.5a.5.5 0 0 1-.74.44L15 20l-4.26 1.94A.5.5 0 0 1 10 21.5V5a1 1 0 0 0-1-1H6v15.5a.5.5 0 0 1-.74.44L3 19.94V4a1 1 0 0 1 1-1z"/></svg>
        </span>
        <span class="menu__label">Knowledge base</span>
      </a>
    </li>
  {% endif %}
{% endblock %}

{% block header_actions %}
  <form id="knowledge-base-search-form" class="header-search" data-knowledge-base-search>
    <label for="knowledge-base-search" class="visually-hidden">Search knowledge base</label>
    <input
      type="search"
      id="knowledge-base-search"
      name="query"
      class="input input--compact"
      placeholder="Search knowledge base"
      autocomplete="off"
      required
    />
    <button type="submit" class="button button--ghost">Search</button>
  </form>
  {% if kb_is_super_admin %}
    <a class="button button--ghost" href="/admin/knowledge-base">Knowledge base admin</a>
  {% endif %}
{% endblock %}

{% block content %}
<div class="knowledge-base">
  <section class="card card--panel knowledge-base__list">
    <header class="card__header">
      <div>
        <h2 class="card__title">Knowledge base articles</h2>
        <p class="card__subtitle">Browse curated documentation with scoped visibility.</p>
      </div>
    </header>
    <div class="knowledge-base__filters">
      <label for "knowledge-base-filter" class="visually-hidden">Filter articles</label>
      <input
        type="search"
        id="knowledge-base-filter"
        class="input"
        placeholder="Filter articles"
        data-table-filter="knowledge-base-table"
        autocomplete="off"
      />
    </div>
    {% if kb_articles %}
    <div class="table-wrapper table-wrapper--short">
      <table class="table table--compact" id="knowledge-base-table" data-table>
        <thead>
          <tr>
            <th scope="col" data-sort="string" data-mobile-priority="essential">Title</th>
            <th scope="col" data-sort="string" data-mobile-priority="essential">Scope</th>
            <th scope="col" data-sort="string" data-mobile-priority="essential">Status</th>
            <th scope="col" data-sort="date" data-mobile-priority="essential">Updated</th>
          </tr>
        </thead>
        <tbody>
          {% for article in kb_articles %}
          <tr data-article-row data-article-slug="{{ article.slug }}">
            <td data-label="Title">
              <a href="/knowledge-base/articles/{{ article.slug }}" class="knowledge-base__link">{{ article.title }}</a>
              {% if article.summary %}
                <p class="knowledge-base__summary">{{ article.summary }}</p>
              {% endif %}
            </td>
            <td data-label="Scope" data-value="{{ article.permission_scope }}">
              <span class="tag">{{ scope_labels.get(article.permission_scope, article.permission_scope|title) }}</span>
            </td>
            <td data-label="Status" data-value="{{ 'Published' if article.is_published else 'Draft' }}">
              {% if article.is_published %}
                <span class="status status--success">Published</span>
              {% else %}
                <span class="status status--warning">Draft</span>
              {% endif %}
            </td>
            <td data-label="Updated" data-value="{{ article.updated_at_iso or '' }}">
              <span data-utc="{{ article.updated_at_iso or '' }}">{{ article.updated_at_iso or 'â€”' }}</span>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
    <p class="knowledge-base__empty">No knowledge base articles are available yet.</p>
    {% endif %}
  </section>
</div>
{% endblock %}

{% block scripts %}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/knowledge_base.js" defer></script>
{% endblock %}
