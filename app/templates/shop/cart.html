{% extends "base.html" %}

{% block header_actions %}
  <a class="button button--ghost" href="{{ request.url_for('shop_page') }}">Continue shopping</a>
{% endblock %}

{% block content %}
<section class="card card--panel cart-card">
  <header class="card__header card__header--stacked">
    <div>
      <h2 class="card__title">Cart</h2>
      <p class="card__subtitle">Review quantities, remove items, and submit a purchase order.</p>
    </div>
    {% if cart_items %}
    <div class="card__controls">
      <input
        type="search"
        class="form-input card__control"
        placeholder="Filter cart"
        aria-label="Filter cart items"
        data-table-filter="cart-table"
      />
    </div>
    {% endif %}
  </header>

  {% if cart_error %}
    <div class="alert alert--error" role="alert">{{ cart_error }}</div>
  {% endif %}

  {% if cart_message %}
    <div class="alert alert--success" role="alert">{{ cart_message }}</div>
  {% endif %}

  {% if order_message %}
    <div class="alert alert--info" role="alert">{{ order_message }}</div>
  {% endif %}

  {% if cart_items %}
    <form action="{{ request.url_for('cart_update_items') }}" method="post" class="cart-items-form">
      {% include "partials/csrf.html" %}
      <div class="table-wrapper">
        <table class="table" id="cart-table" data-table>
          <thead>
            <tr>
              <th scope="col">Remove</th>
              <th scope="col">Image</th>
              <th scope="col" data-sort="string">Name</th>
              <th scope="col" data-sort="string">SKU</th>
              <th scope="col" data-sort="number">Unit price</th>
              <th scope="col" data-sort="number">Quantity</th>
              <th scope="col" data-sort="number">Line total</th>
            </tr>
          </thead>
          <tbody>
            {% for item in cart_items %}
              <tr>
                <td data-label="Remove">
                  <label class="checkbox checkbox--table">
                    <input type="checkbox" name="remove" value="{{ item.product_id }}" />
                    <span class="visually-hidden">Remove {{ item.product_name }}</span>
                  </label>
                </td>
                <td data-label="Image" class="cart-table__image">
                  {% if item.product_image_url %}
                    <img src="{{ item.product_image_url }}" alt="" class="product-thumb" loading="lazy" />
                  {% else %}
                    <span class="text-muted">â€”</span>
                  {% endif %}
                </td>
                <td data-label="Name">
                  <button
                    type="button"
                    class="link-button"
                    data-cart-product-modal="{{ item.product_id }}"
                    aria-haspopup="dialog"
                  >
                    {{ item.product_name }}
                  </button>
                </td>
                <td data-label="SKU">{{ item.product_sku }}</td>
                <td data-label="Unit price" data-value="{{ item.unit_price }}">${{ '%.2f'|format(item.unit_price) }}</td>
                <td data-label="Quantity" data-value="{{ item.quantity }}">
                  <input
                    class="form-input form-input--sm"
                    type="number"
                    min="0"
                    max="9999"
                    step="1"
                    name="quantity_{{ item.product_id }}"
                    value="{{ item.quantity }}"
                    aria-label="Quantity for {{ item.product_name }}"
                    required
                  />
                </td>
                <td data-label="Line total" data-value="{{ item.line_total }}">${{ '%.2f'|format(item.line_total) }}</td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      <div class="form-actions form-actions--inline">
        <button type="submit" class="button">Update quantities</button>
        <button
          type="submit"
          class="button button--ghost"
          formaction="{{ request.url_for('cart_remove_items') }}"
        >
          Remove selected
        </button>
      </div>
    </form>

    <form action="{{ request.url_for('cart_place_order') }}" method="post" class="cart-checkout form-grid">
      {% include "partials/csrf.html" %}
      <div class="form-field">
        <label class="form-label" for="cart-po-number">PO number</label>
        <input
          class="form-input"
          id="cart-po-number"
          name="poNumber"
          maxlength="100"
          placeholder="Optional purchase order reference"
        />
      </div>
      <div class="cart-checkout__actions">
        <div class="cart-summary">
          <dl class="cart-summary__totals">
            <div>
              <dt>Total</dt>
              <dd>${{ '%.2f'|format(cart_total) }}</dd>
            </div>
          </dl>
        </div>
        <div class="form-actions">
          <button type="submit" class="button">Place order</button>
        </div>
      </div>
    </form>
  {% else %}
    <p class="text-muted">Your cart is empty.</p>
  {% endif %}
</section>

{% set recommendations = cart_recommendations or {'cross_sell': [], 'upsell': []} %}
{% set cross_recommendations = recommendations.cross_sell %}
{% set upsell_recommendations = recommendations.upsell %}
{% if cart_items and (cross_recommendations or upsell_recommendations) %}
  <section class="card card--panel cart-recommendations">
    <header class="card__header card__header--stacked">
      <div>
        <h2 class="card__title">Recommended add-ons</h2>
        <p class="card__subtitle">Boost your order with curated upgrades and companion products.</p>
      </div>
    </header>

    {% if upsell_recommendations %}
      <div class="cart-recommendations__section">
        <h3 class="cart-recommendations__heading">Upgrade options</h3>
        <div class="cart-recommendations__grid">
          {% for item in upsell_recommendations %}
            <article class="cart-recommendations__item">
              {% if item.image_url %}
                <img src="{{ item.image_url }}" alt="" class="cart-recommendations__image" loading="lazy" />
              {% endif %}
              <h4 class="cart-recommendations__name">{{ item.name }}</h4>
              <p class="cart-recommendations__price">${{ '%.2f'|format(item.price) }}</p>
              {% if item.source_names %}
                <p class="cart-recommendations__meta">Upgrade for {{ item.source_names | join(', ') }}</p>
              {% endif %}
              <form action="{{ request.url_for('add_to_cart') }}" method="post" class="cart-recommendations__form">
                {% include "partials/csrf.html" %}
                <input type="hidden" name="productId" value="{{ item.product_id }}" />
                <input type="hidden" name="quantity" value="1" />
                {% if item.source_product_ids %}
                  {% for source_id in item.source_product_ids %}
                    <input type="hidden" name="upgradeFrom" value="{{ source_id }}" />
                  {% endfor %}
                {% endif %}
                <button type="submit" class="button button--primary">Upgrade</button>
              </form>
            </article>
          {% endfor %}
        </div>
      </div>
    {% endif %}

    {% if cross_recommendations %}
      <div class="cart-recommendations__section">
        <h3 class="cart-recommendations__heading">Suggested add-ons</h3>
        <div class="cart-recommendations__grid">
          {% for item in cross_recommendations %}
            <article class="cart-recommendations__item">
              {% if item.image_url %}
                <img src="{{ item.image_url }}" alt="" class="cart-recommendations__image" loading="lazy" />
              {% endif %}
              <h4 class="cart-recommendations__name">{{ item.name }}</h4>
              <p class="cart-recommendations__price">${{ '%.2f'|format(item.price) }}</p>
              {% if item.source_names %}
                <p class="cart-recommendations__meta">Pairs with {{ item.source_names | join(', ') }}</p>
              {% endif %}
              <form action="{{ request.url_for('add_to_cart') }}" method="post" class="cart-recommendations__form">
                {% include "partials/csrf.html" %}
                <input type="hidden" name="productId" value="{{ item.product_id }}" />
                <input type="hidden" name="quantity" value="1" />
                <button type="submit" class="button">Add</button>
              </form>
            </article>
          {% endfor %}
        </div>
      </div>
    {% endif %}
  </section>
{% endif %}

<div
  class="modal"
  id="cart-product-details-modal"
  role="dialog"
  aria-modal="true"
  aria-labelledby="cart-product-details-title"
  hidden
>
  <div class="modal__content" role="document">
    <button type="button" class="modal__close" data-modal-close aria-label="Close product details">
      <span aria-hidden="true">&times;</span>
    </button>
    <h2 class="modal__title" id="cart-product-details-title">Product details</h2>
    <div id="cart-product-details-body" class="modal__body"></div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script type="application/json" id="cart-items-data">{{ cart_items_payload | tojson }}</script>
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/cart.js" defer></script>
{% endblock %}
