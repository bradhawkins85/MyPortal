{% extends "base.html" %}

{% block header_actions %}
  <a class="button button--ghost" href="/cart">
    View cart{% if cart_summary.total_quantity %} ({{ cart_summary.total_quantity }}){% endif %}
  </a>
{% endblock %}

{% block content %}
{% macro shop_query(category_id=None) -%}
  {%- set ns = namespace(params=[]) -%}
  {%- if category_id is not none -%}
    {%- set ns.params = ns.params + ['category=' ~ category_id] -%}
  {%- endif -%}
  {%- if search_term -%}
    {%- set ns.params = ns.params + ['q=' ~ (search_term | urlencode)] -%}
  {%- endif -%}
  {%- if show_out_of_stock -%}
    {%- set ns.params = ns.params + ['showOutOfStock=1'] -%}
  {%- endif -%}
  {%- if ns.params -%}?{{ ns.params | join('&') }}{%- endif -%}
{%- endmacro %}

{% if cart_error %}
  <div class="alert alert--error" role="alert">{{ cart_error }}</div>
{% endif %}

<div class="shop-layout">
  <aside class="card card--panel shop-layout__sidebar">
    <header class="card__header card__header--stacked">
      <div>
        <h2 class="card__title">Categories</h2>
        <p class="card__subtitle">Choose a catalogue section to focus the product list.</p>
      </div>
    </header>
    <nav class="shop-categories" aria-label="Product categories">
      <a
        class="shop-categories__link {% if not current_category %}is-active{% endif %}"
        href="{{ request.url_for('shop_page') }}{{ shop_query() }}"
        {% if not current_category %}aria-current="page"{% endif %}
      >
        <span class="shop-categories__icon" aria-hidden="true"></span>
        <span>All products</span>
      </a>
      {% for category in categories %}
        <a
          class="shop-categories__link {% if current_category and current_category == category.id %}is-active{% endif %}"
          href="{{ request.url_for('shop_page') }}{{ shop_query(category.id) }}"
          {% if current_category and current_category == category.id %}aria-current="page"{% endif %}
        >
          <span class="shop-categories__icon" aria-hidden="true"></span>
          <span>{{ category.name }}</span>
        </a>
      {% endfor %}
    </nav>
  </aside>

  <section class="card card--panel shop-layout__content">
    <header class="card__header">
      <div>
        <h2 class="card__title">Available products</h2>
        <p class="card__subtitle">Add items directly to your cart or review detailed specifications.</p>
      </div>
      <div class="card__controls shop-toolbar">
        <form class="shop-toolbar__form" method="get">
          {% if current_category %}
            <input type="hidden" name="category" value="{{ current_category }}" />
          {% endif %}
          <label class="visually-hidden" for="shop-search">Search products</label>
          <input
            class="form-input shop-toolbar__search"
            id="shop-search"
            name="q"
            type="search"
            value="{{ search_term | default('') }}"
            placeholder="Search by name or SKU"
          />
          <label class="checkbox shop-toolbar__checkbox">
            <input
              type="checkbox"
              name="showOutOfStock"
              value="1"
              {% if show_out_of_stock %}checked{% endif %}
              data-submit-on-change
            />
            <span>Show out of stock</span>
          </label>
          <button type="submit" class="button">Search</button>
        </form>
        <input
          type="search"
          class="form-input card__control"
          placeholder="Quick filter products"
          aria-label="Filter products"
          data-table-filter="shop-table"
        />
      </div>
    </header>
    <div class="table-wrapper">
      <table class="table" id="shop-table" data-table>
        <thead>
          <tr>
            <th scope="col">Image</th>
            <th scope="col" data-sort="string">Name</th>
            <th scope="col" data-sort="string">SKU</th>
            <th scope="col" data-sort="number">Price</th>
            <th scope="col" data-sort="number">Stock</th>
            <th scope="col" class="table__actions">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for product in products %}
            <tr data-product-id="{{ product.id }}" data-stock="{{ product.stock }}">
              <td data-label="Image">
                {% if product.image_url %}
                  <button type="button" class="link-button" data-image-preview data-image-url="{{ product.image_url }}">
                    <img src="{{ product.image_url }}" alt="" class="product-thumb" loading="lazy" />
                  </button>
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>
              <td data-label="Name">{{ product.name }}</td>
              <td data-label="SKU">{{ product.sku }}</td>
              <td data-label="Price" data-value="{{ product.price }}">${{ '%.2f'|format(product.price) }}</td>
              <td data-label="Stock" data-value="{{ product.stock }}">
                <span class="badge {% if product.stock == 0 %}badge--danger{% elif product.stock < 5 %}badge--warning{% else %}badge--success{% endif %}">
                  {{ product.stock }}
                </span>
              </td>
              <td class="table__actions">
                <div class="table__action-buttons">
                  <button type="button" class="button button--ghost" data-product-details="{{ product.id }}">Details</button>
                  {% if product.stock > 0 %}
                  <form action="/cart/add" method="post" class="inline-form">
                      {% include "partials/csrf.html" %}
                      <input type="hidden" name="productId" value="{{ product.id }}" />
                      <label class="visually-hidden" for="quantity-{{ product.id }}">Quantity for {{ product.name }}</label>
                      <input
                        class="form-input form-input--sm"
                        id="quantity-{{ product.id }}"
                        type="number"
                        name="quantity"
                        min="1"
                        max="{{ product.stock }}"
                        value="1"
                      />
                      <button type="submit" class="button">Add to cart</button>
                    </form>
                  {% else %}
                    <span class="badge badge--muted">Out of stock</span>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="6" class="table__empty">No products are currently available.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="table-pagination" data-pagination="shop-table">
      <div class="table-pagination__group">
        <button
          type="button"
          class="button button--ghost table-pagination__button"
          data-page-prev
          disabled
        >
          Previous
        </button>
        <button
          type="button"
          class="button button--ghost table-pagination__button"
          data-page-next
        >
          Next
        </button>
      </div>
      <p class="table-pagination__status" data-page-info aria-live="polite"></p>
    </div>
  </section>
</div>

<div class="modal" id="product-image-modal" role="dialog" aria-modal="true" hidden>
  <div class="modal__content" role="document">
    <button type="button" class="modal__close" data-modal-close>
      <span class="visually-hidden">Close image preview</span>
      &times;
    </button>
    <img src="" alt="Selected product image" id="product-image-preview" />
  </div>
</div>

<div class="modal" id="product-details-modal" role="dialog" aria-modal="true" hidden>
  <div class="modal__content" role="document">
    <button type="button" class="modal__close" data-modal-close>
      <span class="visually-hidden">Close product details</span>
      &times;
    </button>
    <div id="product-details-body" class="modal__body"></div>
  </div>
</div>

<script type="application/json" id="shop-products-data">{{ products | tojson }}</script>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/shop.js" defer></script>
{% endblock %}
