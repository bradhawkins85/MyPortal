{% extends "base.html" %}
{% import "partials/stock_status.html" as stock_helpers %}

{% set cart_allowed = (can_access_cart | default(false)) %}
{% if not cart_allowed %}
  {% set cart_allowed = (is_super_admin | default(current_user and current_user.get('is_super_admin'))) or (active_membership and active_membership.get('can_access_cart')) %}
{% endif %}

{% set is_shop_super_admin = is_super_admin | default(current_user and current_user.get('is_super_admin')) %}

{% block header_title_content %}
  <div class="header__title-content">
    <span class="header__title-text">{{ super() }}</span>
  </div>
{% endblock %}

{% block header_actions %}
  <a class="button button--ghost" href="/shop">Products</a>
  {% if cart_allowed %}
    <a class="button button--ghost" href="/cart">
      View cart{% if cart_summary.total_quantity %} ({{ cart_summary.total_quantity }}){% endif %}
    </a>
  {% endif %}
  {% if is_shop_super_admin %}
    <a class="button button--ghost" href="/admin/shop/packages">Package admin</a>
  {% endif %}
{% endblock %}

{% block content %}
{% if cart_error %}
  <div class="alert alert--error" role="alert">{{ cart_error }}</div>
{% endif %}

<div class="shop-layout shop-layout--single">
  <section class="card card--panel shop-layout__content">
    <header class="card__header">
      <div>
        <h2 class="card__title">Available packages</h2>
        <p class="card__subtitle">Choose a package to automatically add multiple products to your order.</p>
      </div>
      <div class="card__controls shop-toolbar">
        <input
          type="search"
          class="form-input card__control"
          placeholder="Filter packages"
          aria-label="Filter packages"
          data-table-filter="shop-packages-table"
        />
      </div>
    </header>
    <div class="table-wrapper">
      <table class="table" id="shop-packages-table" data-table>
        <thead>
          <tr>
            <th scope="col" data-sort="string" data-mobile-priority="essential">Name</th>
            <th scope="col" data-sort="string" data-mobile-priority="supporting">SKU</th>
            <th scope="col" data-sort="number" data-mobile-priority="supporting">Items</th>
            <th scope="col" data-sort="number" data-mobile-priority="essential">Price</th>
            <th scope="col" data-sort="number" data-mobile-priority="essential">Stock</th>
            <th scope="col" class="table__actions" data-mobile-priority="essential">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for package in packages if package.is_available %}
            <tr data-package-id="{{ package.id }}" data-stock="{{ package.stock_level }}">
              <td data-label="Name">
                <div class="package-name">
                  <strong>{{ package.name }}</strong>
                  <details class="package-details">
                    <summary>Included products</summary>
                    <ul class="list list--bullet package-products">
                      {% for item in package["items"] %}
                        {% set resolved = item.resolved_product %}
                        {% set display_name = resolved.product_name if resolved else item.product_name %}
                        {% set display_sku = resolved.product_sku if resolved else item.product_sku %}
                        <li class="package-product">
                          <button
                            type="button"
                            class="link-button package-product__button"
                            data-package-product-details="{{ package.id }}:{{ item.id }}"
                          >
                            <span class="package-product__name">{{ display_name }}</span>
                            <span class="package-product__sku">({{ display_sku }})</span>
                            <span class="package-product__quantity">Ã— {{ item.quantity }}</span>
                            {% if item.is_substituted %}
                              <span class="badge badge--info package-product__badge">Alternate</span>
                            {% endif %}
                          </button>
                        </li>
                      {% endfor %}
                    </ul>
                  </details>
                </div>
              </td>
              <td data-label="SKU">{{ package.sku }}</td>
              <td data-label="Items" data-value="{{ package.product_count }}">{{ package.product_count }}</td>
              <td data-label="Price" data-value="{{ package.price_total }}">${{ '%.2f'|format(package.price_total) }}</td>
              <td data-label="Stock" data-value="{{ package.stock_level }}">
                {{ stock_helpers.stock_status_badge(package.stock_level, low_stock_threshold) }}
              </td>
              <td class="table__actions">
                <div class="table__action-buttons">
                  {% if package.stock_level > 0 %}
                    {% if cart_allowed %}
                      <form action="/cart/add-package" method="post" class="inline-form">
                        {% include "partials/csrf.html" %}
                        <input type="hidden" name="packageId" value="{{ package.id }}" />
                        <label class="visually-hidden" for="package-qty-{{ package.id }}">Quantity for {{ package.name }}</label>
                        <input
                          class="form-input form-input--sm"
                          id="package-qty-{{ package.id }}"
                          type="number"
                          name="quantity"
                          min="1"
                          max="{{ package.stock_level }}"
                          value="1"
                          data-stock-limit="{{ package.stock_level }}"
                        />
                        <button type="submit" class="button">Add to cart</button>
                      </form>
                    {% else %}
                      <span class="badge badge--muted">Cart access required</span>
                    {% endif %}
                  {% else %}
                    <span class="badge badge--muted">Out of stock</span>
                  {% endif %}
                </div>
              </td>
            </tr>
          {% else %}
            <tr>
              <td colspan="6" class="table__empty">No packages are currently available.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <div class="table-pagination" data-pagination="shop-packages-table">
      <div class="table-pagination__group">
        <button type="button" class="button button--ghost table-pagination__button" data-page-prev disabled>Previous</button>
        <button type="button" class="button button--ghost table-pagination__button" data-page-next>Next</button>
      </div>
      <p class="table-pagination__status" data-page-info aria-live="polite"></p>
    </div>
  </section>
</div>

<div
  class="modal"
  id="package-product-details-modal"
  role="dialog"
  aria-modal="true"
  aria-labelledby="package-product-details-title"
  hidden
>
  <div class="modal__content" role="document">
    <button type="button" class="modal__close" data-modal-close>
      <span class="visually-hidden">Close product details</span>
      &times;
    </button>
    <div class="modal__body">
      <h2 class="modal__title" id="package-product-details-title">Product details</h2>
      <div id="package-product-details-body" class="modal__details"></div>
    </div>
  </div>
</div>

<script type="application/json" id="shop-package-items-data">{{ packages_json | tojson }}</script>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/shop_packages.js" defer></script>
{% endblock %}
