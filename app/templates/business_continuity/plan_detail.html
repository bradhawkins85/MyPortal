{% extends "business_continuity/base.html" %}
{% set current_page = 'plans' %}
{% set page_title = plan.title %}

{% block bc_header_title %}
  <div class="plan-header">
    <span class="header__title-text">{{ plan.title }}</span>
    {% if plan.status == 'draft' %}
      <span class="status status--warning">Draft</span>
    {% elif plan.status == 'in_review' %}
      <span class="status status--info">In Review</span>
    {% elif plan.status == 'active' %}
      <span class="status status--success">Active</span>
    {% elif plan.status == 'archived' %}
      <span class="status status--neutral">Archived</span>
    {% endif %}
  </div>
{% endblock %}

{% block bc_header_actions %}
  <div class="action-menu">
    <a href="/business-continuity/plans/{{ plan.id }}/edit" class="button button--secondary">
      <span class="button__icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg></span>
      <span class="button__label">Edit</span>
    </a>
    
    {% if plan.status == 'draft' and can_edit %}
    <button type="button" class="button" onclick="submitForReview()">
      <span class="button__label">Submit for Review</span>
    </button>
    {% endif %}
    
    {% if plan.status == 'in_review' and can_approve %}
    <button type="button" class="button button--success" onclick="approvePlan()">
      <span class="button__label">Approve</span>
    </button>
    <button type="button" class="button button--warning" onclick="requestChanges()">
      <span class="button__label">Request Changes</span>
    </button>
    {% endif %}
    
    <div class="dropdown">
      <button type="button" class="button button--secondary" data-dropdown-toggle>
        <span class="button__label">Export</span>
        <span class="button__icon"><svg viewBox="0 0 24 24" fill="currentColor"><path d="M7 10l5 5 5-5z"/></svg></span>
      </button>
      <div class="dropdown__menu" data-dropdown-menu>
        <button type="button" class="dropdown__item" onclick="exportPlan('docx')">Export as DOCX</button>
        <button type="button" class="dropdown__item" onclick="exportPlan('pdf')">Export as PDF</button>
      </div>
    </div>
    
    <a href="/business-continuity/plans/{{ plan.id }}/audit" class="button button--secondary">
      <span class="button__label">View Audit</span>
    </a>
    
    {% if plan.status == 'active' %}
    <button type="button" class="button" onclick="showAcknowledgeDialog()">
      <span class="button__label">Acknowledge</span>
    </button>
    {% endif %}
  </div>
{% endblock %}

{% block bc_content %}
<!-- Tabs -->
<div class="tabs" role="tablist">
  <button type="button" class="tabs__tab tabs__tab--active" role="tab" aria-selected="true" data-tab="content">
    Content
  </button>
  <button type="button" class="tabs__tab" role="tab" aria-selected="false" data-tab="versions">
    Version History
  </button>
  <button type="button" class="tabs__tab" role="tab" aria-selected="false" data-tab="reviews">
    Reviews
  </button>
  <button type="button" class="tabs__tab" role="tab" aria-selected="false" data-tab="acknowledgments">
    Acknowledgments
  </button>
  <button type="button" class="tabs__tab" role="tab" aria-selected="false" data-tab="attachments">
    Attachments
  </button>
</div>

<!-- Tab Panels -->
<div class="tab-panels">
  <!-- Content Tab -->
  <div class="tab-panel tab-panel--active" id="panel-content" role="tabpanel">
    <section class="card">
      <header class="card__header">
        <div>
          <h2 class="card__title">Plan Details</h2>
          <p class="card__subtitle">Version {{ plan.current_version_number|default('1.0') }}</p>
        </div>
      </header>
      <div class="card__body">
        <dl class="detail-list">
          <div class="detail-list__item">
            <dt class="detail-list__label">Plan Type</dt>
            <dd class="detail-list__value">
              {% if plan.plan_type == 'disaster_recovery' %}Disaster Recovery
              {% elif plan.plan_type == 'incident_response' %}Incident Response
              {% elif plan.plan_type == 'business_continuity' %}Business Continuity
              {% else %}{{ plan.plan_type|title }}
              {% endif %}
            </dd>
          </div>
          <div class="detail-list__item">
            <dt class="detail-list__label">Owner</dt>
            <dd class="detail-list__value">{{ plan.owner_name|default('â€”') }}</dd>
          </div>
          <div class="detail-list__item">
            <dt class="detail-list__label">Last Updated</dt>
            <dd class="detail-list__value"><time datetime="{{ plan.updated_at }}">{{ plan.updated_at }}</time></dd>
          </div>
          <div class="detail-list__item">
            <dt class="detail-list__label">Template</dt>
            <dd class="detail-list__value">{{ plan.template_name|default('â€”') }}</dd>
          </div>
        </dl>
        
        <!-- Acknowledgment Summary -->
        {% if plan.status == 'active' or plan.status == 'approved' %}
        <div class="acknowledgment-summary" id="acknowledgment-summary">
          <div class="ack-summary__header">
            <h3>Acknowledgment Status</h3>
            <div class="ack-summary__actions">
              <button type="button" class="button button--small button--secondary" onclick="refreshAckSummary()">
                <span class="button__icon">â†»</span>
                <span class="button__label">Refresh</span>
              </button>
            </div>
          </div>
          <div class="ack-summary__stats" id="ack-stats">
            <div class="stat-card stat-card--loading">
              <div class="stat-card__value">â€”</div>
              <div class="stat-card__label">Total Users</div>
            </div>
            <div class="stat-card stat-card--loading">
              <div class="stat-card__value">â€”</div>
              <div class="stat-card__label">Acknowledged</div>
            </div>
            <div class="stat-card stat-card--loading">
              <div class="stat-card__value">â€”</div>
              <div class="stat-card__label">Pending</div>
            </div>
          </div>
          <div class="ack-summary__pending" id="ack-pending" style="display: none;">
            <div class="ack-pending__header">
              <h4>Users Pending Acknowledgment</h4>
              <button type="button" class="button button--small" onclick="notifyPendingUsers()">
                <span class="button__icon">ðŸ“§</span>
                <span class="button__label">Notify All</span>
              </button>
            </div>
            <div class="ack-pending__list" id="pending-users-list">
              <!-- Will be populated dynamically -->
            </div>
          </div>
        </div>
        {% endif %}
        
        <div class="plan-content">
          <h3>Plan Content</h3>
          <div class="rich-text">
            {{ plan.content_html|safe if plan.content_html else plan.content|default('No content available.')|e }}
          </div>
        </div>
      </div>
    </section>
  </div>
  
  <!-- Versions Tab -->
  <div class="tab-panel" id="panel-versions" role="tabpanel" hidden>
    <section class="card">
      <header class="card__header">
        <h2 class="card__title">Version History</h2>
      </header>
      <div class="card__body">
        <div class="timeline">
          {% for version in versions %}
          <div class="timeline__item">
            <div class="timeline__marker {% if version.id == plan.current_version_id %}timeline__marker--active{% endif %}"></div>
            <div class="timeline__content">
              <div class="version-card">
                <div class="version-card__header">
                  <div>
                    <h3 class="version-card__title">Version {{ version.version_number }}</h3>
                    <p class="version-card__meta">
                      By {{ version.author_name }} â€¢ <time datetime="{{ version.created_at }}">{{ version.created_at }}</time>
                    </p>
                  </div>
                  <div class="version-card__actions">
                    {% if version.id == plan.current_version_id %}
                      <span class="badge badge--success">Current</span>
                    {% else %}
                      <button type="button" class="button button--small" onclick="viewVersion({{ version.id }})">View</button>
                      <button type="button" class="button button--small button--secondary" onclick="compareVersions({{ plan.current_version_id }}, {{ version.id }})">Compare</button>
                    {% endif %}
                  </div>
                </div>
                {% if version.change_summary %}
                <p class="version-card__summary">{{ version.change_summary }}</p>
                {% endif %}
              </div>
            </div>
          </div>
          {% else %}
          <p class="empty-message">No version history available.</p>
          {% endfor %}
        </div>
      </div>
    </section>
  </div>
  
  <!-- Reviews Tab -->
  <div class="tab-panel" id="panel-reviews" role="tabpanel" hidden>
    <section class="card">
      <header class="card__header">
        <h2 class="card__title">Review History</h2>
      </header>
      <div class="card__body">
        {% if reviews %}
        <div class="reviews-list">
          {% for review in reviews %}
          <div class="review-card">
            <div class="review-card__header">
              <div>
                <strong>{{ review.reviewer_name }}</strong>
                <span class="review-card__status review-card__status--{{ review.status }}">
                  {{ review.status|title }}
                </span>
              </div>
              <time datetime="{{ review.reviewed_at }}">{{ review.reviewed_at }}</time>
            </div>
            {% if review.notes %}
            <div class="review-card__notes">
              {{ review.notes }}
            </div>
            {% endif %}
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="empty-message">No reviews yet.</p>
        {% endif %}
      </div>
    </section>
  </div>
  
  <!-- Acknowledgments Tab -->
  <div class="tab-panel" id="panel-acknowledgments" role="tabpanel" hidden>
    <section class="card">
      <header class="card__header">
        <div>
          <h2 class="card__title">Acknowledgments</h2>
          <p class="card__subtitle">Track who has acknowledged this plan.</p>
        </div>
        <button type="button" class="button button--secondary" onclick="inviteToAcknowledge()">
          Invite Users
        </button>
      </header>
      <div class="card__body">
        {% if acknowledgments %}
        <table class="table">
          <thead>
            <tr>
              <th scope="col">User</th>
              <th scope="col">Version</th>
              <th scope="col">Acknowledged At</th>
            </tr>
          </thead>
          <tbody>
            {% for ack in acknowledgments %}
            <tr>
              <td>{{ ack.user_name }}</td>
              <td>v{{ ack.version_number }}</td>
              <td><time datetime="{{ ack.acknowledged_at }}">{{ ack.acknowledged_at }}</time></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <p class="empty-message">No acknowledgments yet.</p>
        {% endif %}
      </div>
    </section>
  </div>
  
  <!-- Attachments Tab -->
  <div class="tab-panel" id="panel-attachments" role="tabpanel" hidden>
    <section class="card">
      <header class="card__header">
        <div>
          <h2 class="card__title">Attachments</h2>
          <p class="card__subtitle">Supporting documents and files.</p>
        </div>
        <button type="button" class="button button--secondary" onclick="uploadAttachment()">
          Upload File
        </button>
      </header>
      <div class="card__body">
        {% if attachments %}
        <div class="attachments-grid">
          {% for attachment in attachments %}
          <div class="attachment-card">
            <div class="attachment-card__icon">
              <svg viewBox="0 0 24 24" fill="currentColor">
                <path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8l-6-6z"/>
                <path d="M14 2v6h6"/>
              </svg>
            </div>
            <div class="attachment-card__info">
              <p class="attachment-card__name">{{ attachment.filename }}</p>
              <p class="attachment-card__meta">
                {{ attachment.file_size|filesizeformat }} â€¢ {{ attachment.file_type }}
              </p>
            </div>
            <div class="attachment-card__actions">
              <button type="button" class="button button--small" onclick="downloadAttachment({{ attachment.id }})">Download</button>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <p class="empty-message">No attachments.</p>
        {% endif %}
      </div>
    </section>
  </div>
</div>


{% endblock %}

{% block bc_scripts %}
<script>
(function() {
  const planId = {{ plan.id }};
  
  // Tab functionality
  const tabs = document.querySelectorAll('.tabs__tab');
  const panels = document.querySelectorAll('.tab-panel');
  
  tabs.forEach(tab => {
    tab.addEventListener('click', () => {
      const targetPanel = tab.dataset.tab;
      
      // Update tabs
      tabs.forEach(t => {
        t.classList.remove('tabs__tab--active');
        t.setAttribute('aria-selected', 'false');
      });
      tab.classList.add('tabs__tab--active');
      tab.setAttribute('aria-selected', 'true');
      
      // Update panels
      panels.forEach(panel => {
        panel.classList.remove('tab-panel--active');
        panel.hidden = true;
      });
      const panel = document.getElementById(`panel-${targetPanel}`);
      if (panel) {
        panel.classList.add('tab-panel--active');
        panel.hidden = false;
      }
    });
  });
  
  // Dropdown functionality
  document.querySelectorAll('[data-dropdown-toggle]').forEach(toggle => {
    toggle.addEventListener('click', (e) => {
      e.stopPropagation();
      const menu = toggle.nextElementSibling;
      menu.classList.toggle('dropdown__menu--open');
    });
  });
  
  document.addEventListener('click', () => {
    document.querySelectorAll('.dropdown__menu').forEach(menu => {
      menu.classList.remove('dropdown__menu--open');
    });
  });
  
  // Actions
  window.submitForReview = async function() {
    if (!confirm('Submit this plan for review?')) return;
    
    try {
      const response = await fetch(`/api/bc/plans/${planId}/submit-for-review`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (response.ok) {
        location.reload();
      } else {
        alert('Failed to submit for review');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to submit for review');
    }
  };
  
  window.approvePlan = async function() {
    const notes = prompt('Add approval notes (optional):');
    if (notes === null) return;
    
    try {
      const response = await fetch(`/api/bc/plans/${planId}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes })
      });
      
      if (response.ok) {
        location.reload();
      } else {
        alert('Failed to approve plan');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to approve plan');
    }
  };
  
  window.requestChanges = async function() {
    const notes = prompt('Describe the changes needed:');
    if (!notes) return;
    
    try {
      const response = await fetch(`/api/bc/plans/${planId}/request-changes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes })
      });
      
      if (response.ok) {
        location.reload();
      } else {
        alert('Failed to request changes');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to request changes');
    }
  };
  
  window.exportPlan = async function(format) {
    try {
      const response = await fetch(`/api/bc/plans/${planId}/export/${format}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (response.ok) {
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `plan_${planId}.${format}`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
        document.body.removeChild(a);
      } else {
        alert('Failed to export plan');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to export plan');
    }
  };
  
  window.viewVersion = function(versionId) {
    window.location.href = `/business-continuity/plans/${planId}/versions/${versionId}`;
  };
  
  window.compareVersions = function(v1, v2) {
    window.location.href = `/business-continuity/plans/${planId}/compare?v1=${v1}&v2=${v2}`;
  };
  
  window.showAcknowledgeDialog = async function() {
    if (!confirm('Acknowledge that you have reviewed and understand this plan?')) return;
    
    try {
      const response = await fetch(`/api/bc/plans/${planId}/acknowledge`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' }
      });
      
      if (response.ok) {
        alert('Plan acknowledged successfully');
        location.reload();
      } else {
        alert('Failed to acknowledge plan');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to acknowledge plan');
    }
  };
  
  window.inviteToAcknowledge = function() {
    window.location.href = `/business-continuity/plans/${planId}/invite-acknowledge`;
  };
  
  window.uploadAttachment = function() {
    window.location.href = `/business-continuity/plans/${planId}/attachments/upload`;
  };
  
  window.downloadAttachment = function(attachmentId) {
    window.location.href = `/api/bc/plans/${planId}/attachments/${attachmentId}/download`;
  };
  
  // Acknowledgment summary functions
  window.refreshAckSummary = async function() {
    try {
      // Fetch acknowledgment summary
      const summaryResponse = await fetch(`/api/bc/plans/${planId}/acknowledgments/summary`);
      if (!summaryResponse.ok) {
        console.error('Failed to fetch acknowledgment summary');
        return;
      }
      
      const summary = await summaryResponse.json();
      
      // Update stats
      const statsContainer = document.getElementById('ack-stats');
      if (statsContainer) {
        statsContainer.innerHTML = `
          <div class="stat-card">
            <div class="stat-card__value">${summary.total_users}</div>
            <div class="stat-card__label">Total Users</div>
          </div>
          <div class="stat-card">
            <div class="stat-card__value">${summary.acknowledged_users}</div>
            <div class="stat-card__label">Acknowledged</div>
          </div>
          <div class="stat-card ${summary.pending_users > 0 ? 'stat-card--warning' : ''}">
            <div class="stat-card__value">${summary.pending_users}</div>
            <div class="stat-card__label">Pending</div>
          </div>
        `;
      }
      
      // Fetch and display pending users if there are any
      if (summary.pending_users > 0) {
        const pendingResponse = await fetch(`/api/bc/plans/${planId}/acknowledgments/pending`);
        if (pendingResponse.ok) {
          const pendingUsers = await pendingResponse.json();
          displayPendingUsers(pendingUsers);
        }
      } else {
        const pendingContainer = document.getElementById('ack-pending');
        if (pendingContainer) {
          pendingContainer.style.display = 'none';
        }
      }
    } catch (error) {
      console.error('Error refreshing acknowledgment summary:', error);
    }
  };
  
  function displayPendingUsers(users) {
    const pendingContainer = document.getElementById('ack-pending');
    const listContainer = document.getElementById('pending-users-list');
    
    if (!pendingContainer || !listContainer) return;
    
    if (users.length === 0) {
      pendingContainer.style.display = 'none';
      return;
    }
    
    pendingContainer.style.display = 'block';
    
    listContainer.innerHTML = users.map(user => `
      <div class="pending-user-item" data-user-id="${user.id}">
        <div class="pending-user-item__info">
          <p class="pending-user-item__name">${user.name || 'Unknown'}</p>
          <p class="pending-user-item__email">${user.email}</p>
        </div>
        <div class="pending-user-item__action">
          <button type="button" class="button button--small button--secondary" onclick="notifyUser(${user.id})">
            Notify
          </button>
        </div>
      </div>
    `).join('');
  }
  
  window.notifyUser = async function(userId) {
    if (!confirm('Send acknowledgment notification to this user?')) return;
    
    try {
      const response = await fetch(`/api/bc/plans/${planId}/acknowledgments/notify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_ids: [userId] })
      });
      
      if (response.ok) {
        alert('Notification sent successfully');
      } else {
        const error = await response.json();
        alert(`Failed to send notification: ${error.detail || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('Error sending notification:', error);
      alert('Failed to send notification');
    }
  };
  
  window.notifyPendingUsers = async function() {
    try {
      // Get all pending users
      const response = await fetch(`/api/bc/plans/${planId}/acknowledgments/pending`);
      if (!response.ok) {
        alert('Failed to fetch pending users');
        return;
      }
      
      const pendingUsers = await response.json();
      if (pendingUsers.length === 0) {
        alert('No pending users to notify');
        return;
      }
      
      if (!confirm(`Send acknowledgment notifications to ${pendingUsers.length} user(s)?`)) {
        return;
      }
      
      const userIds = pendingUsers.map(u => u.id);
      const notifyResponse = await fetch(`/api/bc/plans/${planId}/acknowledgments/notify`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ user_ids: userIds })
      });
      
      if (notifyResponse.ok) {
        const result = await notifyResponse.json();
        alert(`Notifications queued for ${result.notified_users} user(s)`);
      } else {
        const error = await notifyResponse.json();
        alert(`Failed to send notifications: ${error.detail || 'Unknown error'}`);
      }
    } catch (error) {
      console.error('Error notifying users:', error);
      alert('Failed to send notifications');
    }
  };
  
  // Load acknowledgment summary on page load if the section exists
  if (document.getElementById('acknowledgment-summary')) {
    refreshAckSummary();
  }
})();
</script>
{% endblock %}
