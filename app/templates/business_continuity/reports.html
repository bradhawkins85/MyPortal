{% extends "business_continuity/base.html" %}
{% set current_page = 'reports' %}
{% set page_title = 'Reports' %}

{% block bc_content %}
<section class="card">
  <header class="card__header">
    <div>
      <h2 class="card__title">Business Continuity Reports</h2>
      <p class="card__subtitle">Generate and view reports on plan status, reviews, and compliance.</p>
    </div>
  </header>
  
  <div class="card__body">
    <!-- Summary Stats -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card__label">Total Plans</div>
        <div class="stat-card__value">{{ stats.total_plans|default(0) }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__label">Active Plans</div>
        <div class="stat-card__value">{{ stats.active_plans|default(0) }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__label">Plans in Review</div>
        <div class="stat-card__value">{{ stats.plans_in_review|default(0) }}</div>
      </div>
      <div class="stat-card">
        <div class="stat-card__label">Draft Plans</div>
        <div class="stat-card__value">{{ stats.draft_plans|default(0) }}</div>
      </div>
    </div>
    
    <!-- Report Options -->
    <div class="report-options">
      <h3 class="report-options__title">Generate Report</h3>
      <div class="form-grid">
        <div class="form-group">
          <label for="report-type" class="form-label">Report Type</label>
          <select id="report-type" class="form-select">
            <option value="summary">Plan Summary</option>
            <option value="reviews">Review Activity</option>
            <option value="acknowledgments">Acknowledgment Status</option>
            <option value="compliance">Compliance Overview</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="date-from" class="form-label">From Date</label>
          <input type="date" id="date-from" class="form-input" />
        </div>
        
        <div class="form-group">
          <label for="date-to" class="form-label">To Date</label>
          <input type="date" id="date-to" class="form-input" />
        </div>
        
        <div class="form-group">
          <label for="format" class="form-label">Format</label>
          <select id="format" class="form-select">
            <option value="pdf">PDF</option>
            <option value="xlsx">Excel</option>
            <option value="csv">CSV</option>
          </select>
        </div>
      </div>
      
      <button type="button" class="button" onclick="generateReport()">
        <span class="button__icon">
          <svg viewBox="0 0 24 24" fill="currentColor">
            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
          </svg>
        </span>
        <span class="button__label">Generate Report</span>
      </button>
    </div>
    
    <!-- Recent Reports -->
    <div class="recent-reports">
      <h3 class="recent-reports__title">Recent Reports</h3>
      {% if recent_reports %}
      <table class="table">
        <thead>
          <tr>
            <th scope="col">Report Type</th>
            <th scope="col">Generated</th>
            <th scope="col">Generated By</th>
            <th scope="col">Format</th>
            <th scope="col">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for report in recent_reports %}
          <tr>
            <td data-label="Report Type">{{ report.type|title }}</td>
            <td data-label="Generated"><time datetime="{{ report.created_at }}">{{ report.created_at }}</time></td>
            <td data-label="Generated By">{{ report.user_name }}</td>
            <td data-label="Format"><span class="badge badge--neutral">{{ report.format|upper }}</span></td>
            <td data-label="Actions">
              <a href="/api/bc/reports/{{ report.id }}/download" class="button button--small button--secondary">Download</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="empty-message">No reports generated yet.</p>
      {% endif %}
    </div>
  </div>
</section>

<style>
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 2rem;
}

.stat-card {
  background: #f9fafb;
  padding: 1.5rem;
  border-radius: 0.5rem;
  border: 1px solid #e5e7eb;
}

.stat-card__label {
  font-size: 0.875rem;
  color: #6b7280;
  margin-bottom: 0.5rem;
}

.stat-card__value {
  font-size: 2rem;
  font-weight: 600;
  color: #111827;
}

.report-options {
  padding: 1.5rem 0;
  border-top: 1px solid #e5e7eb;
  border-bottom: 1px solid #e5e7eb;
  margin-bottom: 2rem;
}

.report-options__title {
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: 1rem;
}

.form-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 1rem;
  margin-bottom: 1rem;
}

.recent-reports__title {
  font-size: 1.125rem;
  font-weight: 600;
  margin-bottom: 1rem;
}

.empty-message {
  text-align: center;
  color: #6b7280;
  padding: 2rem;
}
</style>
{% endblock %}

{% block bc_scripts %}
<script>
window.generateReport = async function() {
  const reportType = document.getElementById('report-type').value;
  const dateFrom = document.getElementById('date-from').value;
  const dateTo = document.getElementById('date-to').value;
  const format = document.getElementById('format').value;
  
  try {
    const params = new URLSearchParams({
      type: reportType,
      format: format
    });
    
    if (dateFrom) params.append('from', dateFrom);
    if (dateTo) params.append('to', dateTo);
    
    const response = await fetch(`/api/bc/reports/generate?${params}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' }
    });
    
    if (response.ok) {
      const blob = await response.blob();
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `bc_report_${reportType}_${Date.now()}.${format}`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      setTimeout(() => location.reload(), 1000);
    } else {
      alert('Failed to generate report');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Failed to generate report');
  }
};
</script>
{% endblock %}
