{% extends "business_continuity/base.html" %}
{% set current_page = 'plans' %}
{% set page_title = 'Plans' %}

{% block bc_header_actions %}
  <button type="button" class="button button--secondary" onclick="location.href='/business-continuity/plans/new'">
    <span class="button__icon" aria-hidden="true">
      <svg viewBox="0 0 24 24" focusable="false"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
    </span>
    <span class="button__label">New Plan</span>
  </button>
{% endblock %}

{% block bc_content %}
<section class="card">
  <header class="card__header">
    <div>
      <h2 class="card__title">Business Continuity Plans</h2>
      <p class="card__subtitle">Manage disaster recovery, incident response, and business continuity plans.</p>
    </div>
    <div class="card__controls">
      <div class="filter-group">
        <input
          type="search"
          class="form-input"
          id="search-plans"
          placeholder="Search plans..."
          aria-label="Search plans"
        />
        <select class="form-select" id="filter-status" aria-label="Filter by status">
          <option value="">All Status</option>
          <option value="draft">Draft</option>
          <option value="in_review">In Review</option>
          <option value="active">Active</option>
          <option value="archived">Archived</option>
        </select>
        <select class="form-select" id="filter-owner" aria-label="Filter by owner">
          <option value="">All Owners</option>
          {% for user in users %}
          <option value="{{ user.id }}">{{ user.email }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </header>
  
  <div class="table-wrapper">
    <table class="table table--hover" id="plans-table">
      <thead>
        <tr>
          <th scope="col" data-sort="string">
            <button type="button" class="table-sort">
              Title
              <span class="table-sort__icon" aria-hidden="true"></span>
            </button>
          </th>
          <th scope="col" data-sort="string">
            <button type="button" class="table-sort">
              Type
              <span class="table-sort__icon" aria-hidden="true"></span>
            </button>
          </th>
          <th scope="col" data-sort="string">
            <button type="button" class="table-sort">
              Version
              <span class="table-sort__icon" aria-hidden="true"></span>
            </button>
          </th>
          <th scope="col" data-sort="string">
            <button type="button" class="table-sort">
              Status
              <span class="table-sort__icon" aria-hidden="true"></span>
            </button>
          </th>
          <th scope="col" data-sort="string">
            <button type="button" class="table-sort">
              Owner
              <span class="table-sort__icon" aria-hidden="true"></span>
            </button>
          </th>
          <th scope="col" data-sort="date">
            <button type="button" class="table-sort">
              Last Updated
              <span class="table-sort__icon" aria-hidden="true"></span>
            </button>
          </th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for plan in plans %}
        <tr data-plan-id="{{ plan.id }}" data-status="{{ plan.status }}" data-owner="{{ plan.owner_id }}">
          <td data-label="Title">
            <a href="/business-continuity/plans/{{ plan.id }}" class="link-primary">
              <strong>{{ plan.title }}</strong>
            </a>
          </td>
          <td data-label="Type">
            <span class="badge badge--{{ plan.plan_type }}">
              {% if plan.plan_type == 'disaster_recovery' %}Disaster Recovery
              {% elif plan.plan_type == 'incident_response' %}Incident Response
              {% elif plan.plan_type == 'business_continuity' %}Business Continuity
              {% else %}{{ plan.plan_type|title }}
              {% endif %}
            </span>
          </td>
          <td data-label="Version">
            <span class="badge badge--neutral">v{{ plan.current_version_number|default('1.0') }}</span>
          </td>
          <td data-label="Status">
            {% if plan.status == 'draft' %}
              <span class="status status--warning">Draft</span>
            {% elif plan.status == 'in_review' %}
              <span class="status status--info">In Review</span>
            {% elif plan.status == 'active' %}
              <span class="status status--success">Active</span>
            {% elif plan.status == 'archived' %}
              <span class="status status--neutral">Archived</span>
            {% else %}
              <span class="status">{{ plan.status|title }}</span>
            {% endif %}
          </td>
          <td data-label="Owner">
            {{ plan.owner_name|default('—') }}
          </td>
          <td data-label="Last Updated" data-value="{{ plan.updated_at|default('')  }}">
            <time datetime="{{ plan.updated_at }}">{{ plan.updated_at|default('—') }}</time>
          </td>
          <td data-label="Actions">
            <div class="button-group">
              <a href="/business-continuity/plans/{{ plan.id }}" class="button button--small button--secondary">View</a>
              <a href="/business-continuity/plans/{{ plan.id }}/edit" class="button button--small">Edit</a>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="7" class="table__empty">
            <div class="empty-state">
              <svg class="empty-state__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
              <p class="empty-state__text">No plans found</p>
              <button type="button" class="button" onclick="location.href='/business-continuity/plans/new'">Create Your First Plan</button>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  
  {% if pagination and pagination.total_pages > 1 %}
  <footer class="card__footer">
    <div class="pagination">
      <button type="button" class="pagination__button" {% if pagination.page <= 1 %}disabled{% endif %} onclick="changePage({{ pagination.page - 1 }})">
        Previous
      </button>
      <span class="pagination__info">Page {{ pagination.page }} of {{ pagination.total_pages }}</span>
      <button type="button" class="pagination__button" {% if pagination.page >= pagination.total_pages %}disabled{% endif %} onclick="changePage({{ pagination.page + 1 }})">
        Next
      </button>
    </div>
  </footer>
  {% endif %}
</section>

<style>
.filter-group {
  display: flex;
  gap: 0.5rem;
  flex-wrap: wrap;
}

.filter-group .form-input,
.filter-group .form-select {
  min-width: 150px;
}

.table-sort {
  background: none;
  border: none;
  padding: 0;
  font: inherit;
  color: inherit;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 0.25rem;
  width: 100%;
}

.table-sort:hover {
  color: #1d4ed8;
}

.table-sort__icon::after {
  content: '⇅';
  opacity: 0.3;
}

.table-sort--asc .table-sort__icon::after {
  content: '↑';
  opacity: 1;
}

.table-sort--desc .table-sort__icon::after {
  content: '↓';
  opacity: 1;
}

.badge {
  display: inline-block;
  padding: 0.25rem 0.75rem;
  border-radius: 9999px;
  font-size: 0.75rem;
  font-weight: 500;
  line-height: 1;
}

.badge--disaster_recovery {
  background: #fee2e2;
  color: #991b1b;
}

.badge--incident_response {
  background: #fef3c7;
  color: #92400e;
}

.badge--business_continuity {
  background: #dbeafe;
  color: #1e40af;
}

.badge--neutral {
  background: #f3f4f6;
  color: #6b7280;
}

.status {
  display: inline-flex;
  align-items: center;
  padding: 0.25rem 0.75rem;
  border-radius: 0.375rem;
  font-size: 0.75rem;
  font-weight: 500;
  line-height: 1;
}

.status--success {
  background: #d1fae5;
  color: #065f46;
}

.status--warning {
  background: #fef3c7;
  color: #92400e;
}

.status--info {
  background: #dbeafe;
  color: #1e40af;
}

.status--neutral {
  background: #f3f4f6;
  color: #6b7280;
}

.empty-state {
  text-align: center;
  padding: 3rem 1rem;
}

.empty-state__icon {
  width: 4rem;
  height: 4rem;
  margin: 0 auto 1rem;
  color: #9ca3af;
}

.empty-state__text {
  color: #6b7280;
  font-size: 1rem;
  margin-bottom: 1rem;
}

.button-group {
  display: flex;
  gap: 0.5rem;
}

.pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 1rem;
}

.pagination__button {
  padding: 0.5rem 1rem;
  background: white;
  border: 1px solid #d1d5db;
  border-radius: 0.375rem;
  cursor: pointer;
  font-size: 0.875rem;
}

.pagination__button:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.pagination__info {
  font-size: 0.875rem;
  color: #6b7280;
}
</style>
{% endblock %}

{% block bc_scripts %}
<script>
(function() {
  const searchInput = document.getElementById('search-plans');
  const statusFilter = document.getElementById('filter-status');
  const ownerFilter = document.getElementById('filter-owner');
  const tableBody = document.querySelector('#plans-table tbody');
  const rows = Array.from(tableBody.querySelectorAll('tr[data-plan-id]'));
  
  // Filter functionality
  function filterTable() {
    const searchTerm = searchInput.value.toLowerCase();
    const statusValue = statusFilter.value;
    const ownerValue = ownerFilter.value;
    
    rows.forEach(row => {
      const text = row.textContent.toLowerCase();
      const status = row.dataset.status;
      const owner = row.dataset.owner;
      
      const matchesSearch = !searchTerm || text.includes(searchTerm);
      const matchesStatus = !statusValue || status === statusValue;
      const matchesOwner = !ownerValue || owner === ownerValue;
      
      row.style.display = matchesSearch && matchesStatus && matchesOwner ? '' : 'none';
    });
  }
  
  searchInput?.addEventListener('input', filterTable);
  statusFilter?.addEventListener('change', filterTable);
  ownerFilter?.addEventListener('change', filterTable);
  
  // Table sorting
  const sortButtons = document.querySelectorAll('.table-sort');
  let sortState = {};
  
  sortButtons.forEach(button => {
    button.addEventListener('click', () => {
      const th = button.closest('th');
      const sortType = th.dataset.sort;
      const columnIndex = Array.from(th.parentElement.children).indexOf(th);
      
      // Toggle sort direction
      const currentDirection = sortState[columnIndex] || 'none';
      const newDirection = currentDirection === 'asc' ? 'desc' : 'asc';
      sortState = { [columnIndex]: newDirection };
      
      // Update UI
      sortButtons.forEach(btn => {
        btn.classList.remove('table-sort--asc', 'table-sort--desc');
      });
      button.classList.add(`table-sort--${newDirection}`);
      
      // Sort rows
      const sortedRows = rows.sort((a, b) => {
        const aCell = a.children[columnIndex];
        const bCell = b.children[columnIndex];
        
        let aValue = aCell.textContent.trim();
        let bValue = bCell.textContent.trim();
        
        if (sortType === 'date') {
          aValue = aCell.dataset.value || '';
          bValue = bCell.dataset.value || '';
        }
        
        const comparison = aValue.localeCompare(bValue, undefined, { numeric: true });
        return newDirection === 'asc' ? comparison : -comparison;
      });
      
      sortedRows.forEach(row => tableBody.appendChild(row));
    });
  });
  
  // Pagination
  window.changePage = function(page) {
    const url = new URL(window.location.href);
    url.searchParams.set('page', page);
    window.location.href = url.toString();
  };
})();
</script>
{% endblock %}
