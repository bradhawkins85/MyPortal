{% extends "business_continuity/base.html" %}
{% set current_page = 'reviews' %}
{% set page_title = 'Reviews' %}

{% block bc_content %}
<section class="card">
  <header class="card__header">
    <div>
      <h2 class="card__title">Plan Reviews</h2>
      <p class="card__subtitle">Review and approve business continuity plans.</p>
    </div>
    <div class="card__controls">
      <select class="form-select" id="filter-status" aria-label="Filter by status">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="approved">Approved</option>
        <option value="changes_requested">Changes Requested</option>
      </select>
    </div>
  </header>
  
  <div class="table-wrapper">
    <table class="table table--hover">
      <thead>
        <tr>
          <th scope="col">Plan</th>
          <th scope="col">Submitted By</th>
          <th scope="col">Submitted At</th>
          <th scope="col">Status</th>
          <th scope="col">Reviewer</th>
          <th scope="col">Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for review in reviews %}
        <tr data-status="{{ review.status }}">
          <td data-label="Plan">
            <a href="/business-continuity/plans/{{ review.plan_id }}" class="link-primary">
              <strong>{{ review.plan_title }}</strong>
            </a>
          </td>
          <td data-label="Submitted By">
            {{ review.submitted_by_name }}
          </td>
          <td data-label="Submitted At">
            <time datetime="{{ review.submitted_at }}">{{ review.submitted_at }}</time>
          </td>
          <td data-label="Status">
            {% if review.status == 'pending' %}
              <span class="status status--warning">Pending</span>
            {% elif review.status == 'approved' %}
              <span class="status status--success">Approved</span>
            {% elif review.status == 'changes_requested' %}
              <span class="status status--info">Changes Requested</span>
            {% endif %}
          </td>
          <td data-label="Reviewer">
            {{ review.reviewer_name|default('â€”') }}
          </td>
          <td data-label="Actions">
            <div class="button-group">
              <a href="/business-continuity/plans/{{ review.plan_id }}" class="button button--small button--secondary">View</a>
              {% if review.status == 'pending' and can_review %}
              <button type="button" class="button button--small button--success" onclick="approveReview({{ review.id }})">Approve</button>
              <button type="button" class="button button--small button--warning" onclick="requestChanges({{ review.id }})">Request Changes</button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="table__empty">
            <div class="empty-state">
              <svg class="empty-state__icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
              </svg>
              <p class="empty-state__text">No reviews pending</p>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</section>

<style>
.link-primary {
  color: #1d4ed8;
  text-decoration: none;
}

.link-primary:hover {
  text-decoration: underline;
}
</style>
{% endblock %}

{% block bc_scripts %}
<script>
(function() {
  const filterStatus = document.getElementById('filter-status');
  
  filterStatus?.addEventListener('change', () => {
    const value = filterStatus.value;
    const rows = document.querySelectorAll('tbody tr[data-status]');
    
    rows.forEach(row => {
      if (!value || row.dataset.status === value) {
        row.style.display = '';
      } else {
        row.style.display = 'none';
      }
    });
  });
  
  window.approveReview = async function(reviewId) {
    const notes = prompt('Add approval notes (optional):');
    if (notes === null) return;
    
    try {
      const response = await fetch(`/api/bc/reviews/${reviewId}/approve`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes })
      });
      
      if (response.ok) {
        location.reload();
      } else {
        alert('Failed to approve review');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to approve review');
    }
  };
  
  window.requestChanges = async function(reviewId) {
    const notes = prompt('Describe the changes needed:');
    if (!notes) return;
    
    try {
      const response = await fetch(`/api/bc/reviews/${reviewId}/request-changes`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ notes })
      });
      
      if (response.ok) {
        location.reload();
      } else {
        alert('Failed to request changes');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('Failed to request changes');
    }
  };
})();
</script>
{% endblock %}
