{% extends "base.html" %}

{% block header_actions %}
  <a class="button button--ghost" href="/tickets">All tickets</a>
{% endblock %}

{% block content %}
  <div class="management management--single">
    <section class="management__content">
      <header class="management__header">
        <div>
          <h1 class="management__title">{{ ticket.subject or 'Ticket' }}</h1>
          <p class="management__subtitle">
            Ticket #{{ ticket.id }}
            <span class="badge {{ ticket.status_badge }}">{{ ticket.status_label }}</span>
          </p>
        </div>
        <div class="management__header-actions">
          <a class="button button--ghost" href="/tickets">Back to tickets</a>
        </div>
      </header>
      <div class="management__body management__body--columns">
        <div class="management__column management__column--details">
          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Ticket details</h2>
            </header>
            <div class="card__body">
              <dl class="description-list">
                <div class="description-list__row">
                  <dt>Status</dt>
                  <dd><span class="badge {{ ticket.status_badge }}">{{ ticket.status_label }}</span></dd>
                </div>
                <div class="description-list__row">
                  <dt>Priority</dt>
                  <dd>{{ ticket.priority_label }}</dd>
                </div>
                {% if ticket.company_name %}
                  <div class="description-list__row">
                    <dt>Company</dt>
                    <dd>{{ ticket.company_name }}</dd>
                  </div>
                {% endif %}
                {% if ticket.requester_label %}
                  <div class="description-list__row">
                    <dt>Requester</dt>
                    <dd>{{ ticket.requester_label }}</dd>
                  </div>
                {% endif %}
                {% if ticket.assigned_label %}
                  <div class="description-list__row">
                    <dt>Assigned to</dt>
                    <dd>{{ ticket.assigned_label }}</dd>
                  </div>
                {% endif %}
                <div class="description-list__row">
                  <dt>Created</dt>
                  <dd>
                    {% if ticket.created_iso %}
                      <span data-utc="{{ ticket.created_iso }}"></span>
                    {% else %}
                      <span class="text-muted">â€”</span>
                    {% endif %}
                  </dd>
                </div>
                <div class="description-list__row">
                  <dt>Updated</dt>
                  <dd>
                    {% if ticket.updated_iso %}
                      <span data-utc="{{ ticket.updated_iso }}"></span>
                    {% else %}
                      <span class="text-muted">â€”</span>
                    {% endif %}
                  </dd>
                </div>
                {% if ticket.xero_invoice_number %}
                  <div class="description-list__row">
                    <dt>Invoice Number</dt>
                    <dd><strong>{{ ticket.xero_invoice_number }}</strong></dd>
                  </div>
                {% endif %}
                {% if ticket.billed_at_iso %}
                  <div class="description-list__row">
                    <dt>Billed At</dt>
                    <dd>
                      <span data-utc="{{ ticket.billed_at_iso }}"></span>
                    </dd>
                  </div>
                {% endif %}
                {% if ticket_watchers %}
                  <div class="description-list__row">
                    <dt>Watchers</dt>
                    <dd>
                      <ul class="list list--inline">
                        {% for watcher in ticket_watchers %}
                          <li>{{ watcher.label }}</li>
                        {% endfor %}
                      </ul>
                    </dd>
                  </div>
                {% endif %}
              </dl>
            </div>
          </article>

          {% if assigned_user and assigned_user.booking_link_url %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">Schedule a call</h2>
              </header>
              <div class="card__body">
                <p class="text-muted">Book a call with {{ ticket.assigned_label }} to discuss this ticket.</p>
                <button 
                  type="button" 
                  class="button"
                  data-booking-link="{{ assigned_user.booking_link_url }}"
                  data-booking-modal-trigger
                >
                  Book a call
                </button>
              </div>
            </article>
          {% endif %}

          {% if ticket_assets %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">Linked Assets</h2>
              </header>
              <div class="card__body">
                <ul class="list">
                  {% for asset in ticket_assets %}
                    <li class="list__item">
                      <strong>{{ asset.name }}</strong>
                      {% if asset.type %}
                        <div class="list__meta">Type: {{ asset.type }}</div>
                      {% endif %}
                      {% if asset.serial_number %}
                        <div class="list__meta">Serial: {{ asset.serial_number }}</div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </article>
          {% endif %}

          {% if relevant_services %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">Associated Service Statuses</h2>
              </header>
              <div class="card__body">
                <ul class="list">
                  {% for service in relevant_services %}
                    {% set status_meta = service_status_lookup.get(service.status) %}
                    {% set status_variant = status_meta.variant if status_meta else 'status--neutral' %}
                    {% set status_label = status_meta.label if status_meta else (service.status | replace('_', ' ') | title) %}
                    <li class="list__item">
                      <strong>{{ service.name }}</strong>
                      {% if service.status %}
                        <div class="list__meta">
                          <span class="status {{ status_variant }}">{{ status_label }}</span>
                        </div>
                      {% endif %}
                      {% if service.status_message %}
                        <div class="list__meta">{{ service.status_message }}</div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </article>
          {% endif %}

          {% if relevant_kb_articles %}
            <article class="card card--panel">
              <header class="card__header">
                <h2 class="card__title">Related Knowledge Base Articles</h2>
              </header>
              <div class="card__body">
                <ul class="list">
                  {% for article in relevant_kb_articles %}
                    <li class="list__item">
                      <a href="/knowledge-base?slug={{ article.slug }}" target="_blank" rel="noopener noreferrer">
                        <strong>{{ article.title }}</strong>
                      </a>
                      {% if article.summary %}
                        <div class="list__meta">{{ article.summary }}</div>
                      {% endif %}
                      {% if article.matching_tags_count %}
                        <div class="list__meta">
                          <span class="badge badge--muted">{{ article.matching_tags_count }} matching tag{{ 's' if article.matching_tags_count > 1 else '' }}</span>
                        </div>
                      {% endif %}
                    </li>
                  {% endfor %}
                </ul>
              </div>
            </article>
          {% endif %}
        </div>
        <div class="management__column management__column--timeline">
          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Description</h2>
            </header>
            <div class="card__body">
              {% if ticket.description_has_content %}
                <div class="rich-text-viewer">{{ ticket.description_html | safe }}</div>
              {% else %}
                <p class="card__empty">No description has been provided yet.</p>
              {% endif %}
            </div>
          </article>

          {% if has_helpdesk_access %}
          <article class="card card--panel" data-ticket-tasks-card>
            <header class="card__header">
              <h2 class="card__title">Tasks</h2>
              {% if can_reply %}
                <div class="button-group">
                  <button
                    type="button"
                    class="button button--ghost button--small"
                    data-add-task-button
                    data-ticket-id="{{ ticket.id }}"
                    aria-label="Add a new task"
                  >
                    Add task
                  </button>
                </div>
              {% endif %}
            </header>
            <div class="card__body">
              <ul class="task-list" data-task-list data-ticket-id="{{ ticket.id }}">
                <!-- Tasks will be loaded dynamically -->
              </ul>
              <p class="card__empty" data-tasks-empty hidden>No tasks have been added yet.</p>
            </div>
          </article>
          {% endif %}

          <article class="card card--panel">
            <header class="card__header">
              <h2 class="card__title">Reply</h2>
            </header>
            <div class="card__body">
              {% if can_reply %}
                {% if reply_error %}
                  <div class="alert alert--error" role="alert">{{ reply_error }}</div>
                {% endif %}
                <form action="/tickets/{{ ticket.id }}/replies" method="post" class="form" novalidate enctype="multipart/form-data" data-ticket-reply-form>
                  {% include "partials/csrf.html" %}
                  <div class="form-field">
                    <span class="form-label" id="ticket-reply-label">Message</span>
                    <div
                      class="rich-text-editor"
                      data-rich-text-editor
                      aria-labelledby="ticket-reply-label"
                    >
                      <div class="rich-text-editor__toolbar" role="toolbar" aria-label="Formatting options">
                        <button
                          type="button"
                          class="rich-text-editor__button"
                          data-rich-text-button
                          data-command="bold"
                          aria-label="Bold"
                        >
                          <span aria-hidden="true">B</span>
                        </button>
                        <button
                          type="button"
                          class="rich-text-editor__button"
                          data-rich-text-button
                          data-command="italic"
                          aria-label="Italic"
                        >
                          <span aria-hidden="true">I</span>
                        </button>
                        <button
                          type="button"
                          class="rich-text-editor__button"
                          data-rich-text-button
                          data-command="underline"
                          aria-label="Underline"
                        >
                          <span aria-hidden="true">U</span>
                        </button>
                        <button
                          type="button"
                          class="rich-text-editor__button"
                          data-rich-text-button
                          data-command="insertUnorderedList"
                          aria-label="Bulleted list"
                        >
                          <span aria-hidden="true">â€¢</span>
                        </button>
                        <button
                          type="button"
                          class="rich-text-editor__button"
                          data-rich-text-button
                          data-command="insertOrderedList"
                          aria-label="Numbered list"
                        >
                          <span aria-hidden="true">1.</span>
                        </button>
                        <button
                          type="button"
                          class="rich-text-editor__button"
                          data-rich-text-button
                          data-command="formatBlock"
                          data-command-value="blockquote"
                          aria-label="Quote"
                        >
                          <span aria-hidden="true">""</span>
                        </button>
                        <button
                          type="button"
                          class="rich-text-editor__button"
                          data-rich-text-button
                          data-command="formatBlock"
                          data-command-value="pre"
                          aria-label="Code block"
                        >
                          <span aria-hidden="true">&lt;/&gt;</span>
                        </button>
                        <button
                          type="button"
                          class="rich-text-editor__button"
                          data-rich-text-button
                          data-command="link"
                          aria-label="Insert link"
                        >
                          <span aria-hidden="true">ðŸ”—</span>
                        </button>
                        <button
                          type="button"
                          class="rich-text-editor__button"
                          data-rich-text-button
                          data-command="removeFormat"
                          aria-label="Clear formatting"
                        >
                          <span aria-hidden="true">â¨¯</span>
                        </button>
                      </div>
                      <div
                        id="ticket-reply-body"
                        class="rich-text-editor__surface"
                        data-rich-text-content
                        contenteditable="true"
                        role="textbox"
                        aria-labelledby="ticket-reply-label"
                        aria-multiline="true"
                        data-placeholder="Write your reply..."
                      >{{ reply_body }}</div>
                    </div>
                    <textarea
                      id="ticket-reply-body-hidden"
                      name="body"
                      class="visually-hidden"
                      aria-hidden="true"
                      required
                    >{{ reply_body }}</textarea>
                  </div>
                  <div class="form-field">
                    <label class="form-label" for="ticket-reply-attachments">Attachments (optional)</label>
                    <input
                      type="file"
                      id="ticket-reply-attachments"
                      name="attachments"
                      class="form-input"
                      multiple
                      accept="*/*"
                      data-ticket-attachments
                    />
                    <p class="form-help">You can upload multiple files. Maximum file size: 10MB per file.</p>
                  </div>
                  <div class="form-actions">
                    <button type="submit" class="button button--primary">Post reply</button>
                  </div>
                </form>
              {% elif is_watcher %}
                <p class="text-muted">You're watching this ticket. Reach out to the requester if you need to add further context.</p>
              {% else %}
                <p class="text-muted">Only the original requester can reply to this ticket.</p>
              {% endif %}
            </div>
          </article>

          <article class="card card--panel" id="conversation">
            <header class="card__header">
              <h2 class="card__title">Conversation history</h2>
            </header>
            <div class="card__body">
              {% if ticket_replies %}
                <div class="timeline" data-ticket-timeline data-ticket-id="{{ ticket.id }}">
                  {% for reply in ticket_replies %}
                    {% if reply.type == 'call_recording' %}
                    <article class="timeline__event timeline__event--call-recording" data-recording-id="{{ reply.id }}">
                      <header class="timeline__header">
                        <div class="timeline__header-main">
                          <span class="timeline__timestamp">
                            {% if reply.created_iso %}
                              <span data-utc="{{ reply.created_iso }}"></span>
                            {% else %}
                              <span class="text-muted">â€”</span>
                            {% endif %}
                          </span>
                          <span class="timeline__action">
                            <strong>ðŸ“ž Call Recording:</strong> {{ reply.caller_name }} â†’ {{ reply.callee_name }}
                          </span>
                          {% if reply.time_summary %}
                            <span class="timeline__meta text-muted">{{ reply.time_summary }}</span>
                          {% endif %}
                        </div>
                      </header>
                      <div class="timeline__body">
                        <div class="timeline__message" data-timeline-message>
                          <p><strong>File:</strong> {{ reply.file_name }}</p>
                          {% if reply.duration_seconds %}
                            <p><strong>Duration:</strong> {{ reply.duration_seconds }} seconds</p>
                          {% endif %}
                          {% if reply.transcription %}
                            <div class="timeline__message-content" data-timeline-message-content>
                              <p><strong>Transcription:</strong></p>
                              <div class="rich-text-viewer">{{ reply.transcription }}</div>
                            </div>
                            <button
                              type="button"
                              class="button button--ghost button--small timeline__message-toggle"
                              data-timeline-message-toggle
                              data-more-label="Show transcription"
                              data-less-label="Hide transcription"
                              hidden
                              aria-expanded="false"
                            >
                              Show transcription
                            </button>
                          {% else %}
                            <p class="text-muted">No transcription available.</p>
                          {% endif %}
                        </div>
                      </div>
                    </article>
                    {% else %}
                    <article class="timeline__event">
                      <header class="timeline__header">
                        <div class="timeline__header-main">
                          <span class="timeline__timestamp">
                            {% if reply.created_iso %}
                              <span data-utc="{{ reply.created_iso }}"></span>
                            {% else %}
                              <span class="text-muted">â€”</span>
                            {% endif %}
                          </span>
                          <span class="timeline__action">
                            {{ reply.author_label }}
                            {% if reply.is_internal %}
                              <span class="badge badge--muted">Internal</span>
                            {% endif %}
                            {% if reply.has_email_tracking %}
                              {% if reply.is_email_opened %}
                                <span class="badge badge--success" title="Email opened {{ reply.email_open_count }} time{{ 's' if reply.email_open_count > 1 else '' }}">âœ“ Read</span>
                              {% else %}
                                <span class="badge badge--muted" title="Email sent, not yet opened">ðŸ“§ Sent</span>
                              {% endif %}
                            {% endif %}
                          </span>
                          {% if reply.time_summary %}
                            <span class="timeline__meta text-muted">{{ reply.time_summary }}</span>
                          {% endif %}
                        </div>
                      </header>
                      <div class="timeline__body">
                        {% if reply.has_content %}
                          <div class="timeline__message" data-timeline-message>
                            <div class="rich-text-viewer timeline__message-content" data-timeline-message-content>
                              {{ reply.body_html | safe }}
                            </div>
                          </div>
                          <button
                            type="button"
                            class="button button--ghost button--small timeline__message-toggle"
                            data-timeline-message-toggle
                            data-more-label="Show more"
                            data-less-label="Show less"
                            hidden
                            aria-expanded="false"
                          >
                            Show more
                          </button>
                        {% else %}
                          <p class="text-muted">No content provided.</p>
                        {% endif %}
                      </div>
                    </article>
                    {% endif %}
                  {% endfor %}
                </div>
              {% else %}
                <p class="card__empty">No replies have been posted yet.</p>
              {% endif %}
            </div>
          </article>
        </div>
      </div>
    </section>
  </div>

  <!-- Booking Link Modal -->
  <div id="booking-modal" class="modal" hidden>
    <div class="modal__overlay" data-modal-close></div>
    <div class="modal__content modal__content--large">
      <header class="modal__header">
        <h2 class="modal__title">Book a call</h2>
        <button type="button" class="modal__close" data-modal-close aria-label="Close">Ã—</button>
      </header>
      <div class="modal__body">
        <iframe 
          id="booking-iframe" 
          src="" 
          style="width: 100%; height: 600px; border: none;"
          title="Booking calendar"
        ></iframe>
      </div>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script src="/static/js/tables.js" defer></script>
  <script src="/static/js/rich_text_editor.js" defer></script>
  <script src="/static/js/ticket_detail.js" defer></script>
{% endblock %}
