{% extends "base.html" %}

{% block title %}{{ control.name }} - Requirements{% endblock %}

{% block header_actions %}
  <div class="header-actions">
    <a href="/compliance" class="button button--ghost button--small">
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width="16"
        height="16"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
        aria-hidden="true"
      >
        <path d="M19 12H5M12 19l-7-7 7-7" />
      </svg>
      Back to controls
    </a>
  </div>
{% endblock %}

{% block content %}
<div class="management management--single compliance" data-layout>
  <section class="management__content">
    <header class="management__header compliance__header">
      <div>
        <h1 class="management__title">{{ control.name }}</h1>
        <p class="management__subtitle">{{ control.description }}</p>
      </div>
      {% if company %}
      <div class="management__header-actions compliance__header-actions">
        <span class="tag tag--muted">{{ company.name }}</span>
        {% if company_compliance %}
        <span class="badge badge--status-{{ company_compliance.status }}">
          {% if company_compliance.status == 'not_started' %}Not started
          {% elif company_compliance.status == 'in_progress' %}In progress
          {% elif company_compliance.status == 'compliant' %}Compliant
          {% elif company_compliance.status == 'non_compliant' %}Non-compliant
          {% elif company_compliance.status == 'not_applicable' %}Not applicable
          {% endif %}
        </span>
        <span class="badge badge--maturity-{{ company_compliance.maturity_level }}">
          {% if company_compliance.maturity_level == 'ml0' %}ML0
          {% elif company_compliance.maturity_level == 'ml1' %}ML1
          {% elif company_compliance.maturity_level == 'ml2' %}ML2
          {% elif company_compliance.maturity_level == 'ml3' %}ML3
          {% endif %}
        </span>
        {% endif %}
      </div>
      {% endif %}
    </header>

    <div class="card card--panel compliance-summary-card">
      <div class="compliance-summary__grid">
        <div class="compliance-summary__item">
          <span class="compliance-summary__label">Total requirements</span>
          <span class="compliance-summary__value">{{ requirements_ml1|length + requirements_ml2|length + requirements_ml3|length }}</span>
        </div>
        <div class="compliance-summary__item">
          <span class="compliance-summary__label">Compliant</span>
          <span class="compliance-summary__value">{% set compliant_count = requirement_compliance_map.values()|selectattr('status', 'equalto', 'compliant')|list|length %}{{ compliant_count }}</span>
        </div>
        <div class="compliance-summary__item">
          <span class="compliance-summary__label">In progress</span>
          <span class="compliance-summary__value">{% set in_progress_count = requirement_compliance_map.values()|selectattr('status', 'equalto', 'in_progress')|list|length %}{{ in_progress_count }}</span>
        </div>
        <div class="compliance-summary__item">
          <span class="compliance-summary__label">Non-compliant</span>
          <span class="compliance-summary__value">{% set non_compliant_count = requirement_compliance_map.values()|selectattr('status', 'equalto', 'non_compliant')|list|length %}{{ non_compliant_count }}</span>
        </div>
        <div class="compliance-summary__item">
          <span class="compliance-summary__label">Not applicable</span>
          <span class="compliance-summary__value">{% set not_applicable_count = requirement_compliance_map.values()|selectattr('status', 'equalto', 'not_applicable')|list|length %}{{ not_applicable_count }}</span>
        </div>
        <div class="compliance-summary__item">
          <span class="compliance-summary__label">Not started</span>
          <span class="compliance-summary__value">
            {% set total_reqs = requirements_ml1|length + requirements_ml2|length + requirements_ml3|length %}
            {% set tracked_count = requirement_compliance_map|length %}
            {% set not_started_count = requirement_compliance_map.values()|selectattr('status', 'equalto', 'not_started')|list|length + (total_reqs - tracked_count) %}
            {{ not_started_count }}
          </span>
        </div>
      </div>
      <div class="alert alert--info compliance__note">
        <strong>Note:</strong> The control is considered <strong>Compliant</strong> when all requirements are either <strong>Compliant</strong> or <strong>Not applicable</strong>.
      </div>
    </div>

    <div class="compliance-requirements">
      <section class="card card--panel compliance-requirements__group" data-level="ml1">
        <div class="compliance-requirements__header">
          <h2 class="compliance-requirements__title">Maturity level 1 (ML1)</h2>
          <button type="button" class="button button--ghost button--small" data-expand-all="ml1" data-expanded="false">Expand all</button>
        </div>
        <div class="compliance-requirements__list">
          {% for req in requirements_ml1 %}
          {% set req_compliance = requirement_compliance_map.get(req.id) %}
          <details class="requirement-item card-collapsible" data-requirement-id="{{ req.id }}">
            <summary class="card__header card__header--collapsible requirement-item__header">
              <div class="requirement-item__number">{{ req.requirement_order }}</div>
              <p class="requirement-item__description">{{ req.description }}</p>
              <div class="card__collapsible-meta">
                <div class="requirement-item__status">
                  {% if req_compliance %}
                  <span class="badge badge--status-{{ req_compliance.status }}" data-requirement-status>
                    {% if req_compliance.status == 'not_started' %}Not started
                    {% elif req_compliance.status == 'in_progress' %}In progress
                    {% elif req_compliance.status == 'compliant' %}✓ Compliant
                    {% elif req_compliance.status == 'non_compliant' %}✗ Non-compliant
                    {% elif req_compliance.status == 'not_applicable' %}N/A
                    {% endif %}
                  </span>
                  {% else %}
                  <span class="badge badge--status-not_started" data-requirement-status>Not started</span>
                  {% endif %}
                </div>
                <span class="card__toggle-icon" aria-hidden="true"></span>
              </div>
            </summary>
            <div class="card-collapsible__content requirement-item__details" id="requirement-details-{{ req.id }}" data-requirement-details>
              <form class="compliance-form" data-requirement-form="{{ req.id }}">
                <div class="form-field">
                  <label for="req-status-{{ req.id }}" class="form-label">Status</label>
                  <select id="req-status-{{ req.id }}" class="form-input" required>
                    <option value="not_started" {% if req_compliance and req_compliance.status == 'not_started' %}selected{% endif %}>Not started</option>
                    <option value="in_progress" {% if req_compliance and req_compliance.status == 'in_progress' %}selected{% endif %}>In progress</option>
                    <option value="compliant" {% if req_compliance and req_compliance.status == 'compliant' %}selected{% endif %}>Compliant</option>
                    <option value="non_compliant" {% if req_compliance and req_compliance.status == 'non_compliant' %}selected{% endif %}>Non-compliant</option>
                    <option value="not_applicable" {% if req_compliance and req_compliance.status == 'not_applicable' %}selected{% endif %}>Not applicable</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="req-evidence-{{ req.id }}" class="form-label">Evidence</label>
                  <textarea id="req-evidence-{{ req.id }}" class="form-input form-input--textarea" rows="2" placeholder="Links to documentation, screenshots, etc.">{% if req_compliance %}{{ req_compliance.evidence or '' }}{% endif %}</textarea>
                </div>
                <div class="form-field">
                  <label for="req-notes-{{ req.id }}" class="form-label">Notes</label>
                  <textarea id="req-notes-{{ req.id }}" class="form-input form-input--textarea" rows="2" placeholder="Implementation details, outstanding items, etc.">{% if req_compliance %}{{ req_compliance.notes or '' }}{% endif %}</textarea>
                </div>
                <div class="form-field">
                  <label for="req-reviewed-{{ req.id }}" class="form-label">Last reviewed date</label>
                  <input type="date" id="req-reviewed-{{ req.id }}" class="form-input" value="{% if req_compliance and req_compliance.last_reviewed_date %}{{ req_compliance.last_reviewed_date }}{% endif %}" />
                </div>
                <div class="compliance-form__actions">
                  <button type="button" class="button button--primary button--small" data-save-requirement="{{ req.id }}">Save</button>
                </div>
              </form>
            </div>
          </details>
          {% endfor %}
        </div>
      </section>

      <section class="card card--panel compliance-requirements__group" data-level="ml2">
        <div class="compliance-requirements__header">
          <h2 class="compliance-requirements__title">Maturity level 2 (ML2)</h2>
          <button type="button" class="button button--ghost button--small" data-expand-all="ml2" data-expanded="false">Expand all</button>
        </div>
        <div class="compliance-requirements__list">
          {% for req in requirements_ml2 %}
          {% set req_compliance = requirement_compliance_map.get(req.id) %}
          <details class="requirement-item card-collapsible" data-requirement-id="{{ req.id }}">
            <summary class="card__header card__header--collapsible requirement-item__header">
              <div class="requirement-item__number">{{ req.requirement_order }}</div>
              <p class="requirement-item__description">{{ req.description }}</p>
              <div class="card__collapsible-meta">
                <div class="requirement-item__status">
                  {% if req_compliance %}
                  <span class="badge badge--status-{{ req_compliance.status }}" data-requirement-status>
                    {% if req_compliance.status == 'not_started' %}Not started
                    {% elif req_compliance.status == 'in_progress' %}In progress
                    {% elif req_compliance.status == 'compliant' %}✓ Compliant
                    {% elif req_compliance.status == 'non_compliant' %}✗ Non-compliant
                    {% elif req_compliance.status == 'not_applicable' %}N/A
                    {% endif %}
                  </span>
                  {% else %}
                  <span class="badge badge--status-not_started" data-requirement-status>Not started</span>
                  {% endif %}
                </div>
                <span class="card__toggle-icon" aria-hidden="true"></span>
              </div>
            </summary>
            <div class="card-collapsible__content requirement-item__details" id="requirement-details-{{ req.id }}" data-requirement-details>
              <form class="compliance-form" data-requirement-form="{{ req.id }}">
                <div class="form-field">
                  <label for="req-status-{{ req.id }}" class="form-label">Status</label>
                  <select id="req-status-{{ req.id }}" class="form-input" required>
                    <option value="not_started" {% if req_compliance and req_compliance.status == 'not_started' %}selected{% endif %}>Not started</option>
                    <option value="in_progress" {% if req_compliance and req_compliance.status == 'in_progress' %}selected{% endif %}>In progress</option>
                    <option value="compliant" {% if req_compliance and req_compliance.status == 'compliant' %}selected{% endif %}>Compliant</option>
                    <option value="non_compliant" {% if req_compliance and req_compliance.status == 'non_compliant' %}selected{% endif %}>Non-compliant</option>
                    <option value="not_applicable" {% if req_compliance and req_compliance.status == 'not_applicable' %}selected{% endif %}>Not applicable</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="req-evidence-{{ req.id }}" class="form-label">Evidence</label>
                  <textarea id="req-evidence-{{ req.id }}" class="form-input form-input--textarea" rows="2" placeholder="Links to documentation, screenshots, etc.">{% if req_compliance %}{{ req_compliance.evidence or '' }}{% endif %}</textarea>
                </div>
                <div class="form-field">
                  <label for="req-notes-{{ req.id }}" class="form-label">Notes</label>
                  <textarea id="req-notes-{{ req.id }}" class="form-input form-input--textarea" rows="2" placeholder="Implementation details, outstanding items, etc.">{% if req_compliance %}{{ req_compliance.notes or '' }}{% endif %}</textarea>
                </div>
                <div class="form-field">
                  <label for="req-reviewed-{{ req.id }}" class="form-label">Last reviewed date</label>
                  <input type="date" id="req-reviewed-{{ req.id }}" class="form-input" value="{% if req_compliance and req_compliance.last_reviewed_date %}{{ req_compliance.last_reviewed_date }}{% endif %}" />
                </div>
                <div class="compliance-form__actions">
                  <button type="button" class="button button--primary button--small" data-save-requirement="{{ req.id }}">Save</button>
                </div>
              </form>
            </div>
          </details>
          {% endfor %}
        </div>
      </section>

      <section class="card card--panel compliance-requirements__group" data-level="ml3">
        <div class="compliance-requirements__header">
          <h2 class="compliance-requirements__title">Maturity level 3 (ML3)</h2>
          <button type="button" class="button button--ghost button--small" data-expand-all="ml3" data-expanded="false">Expand all</button>
        </div>
        <div class="compliance-requirements__list">
          {% for req in requirements_ml3 %}
          {% set req_compliance = requirement_compliance_map.get(req.id) %}
          <details class="requirement-item card-collapsible" data-requirement-id="{{ req.id }}">
            <summary class="card__header card__header--collapsible requirement-item__header">
              <div class="requirement-item__number">{{ req.requirement_order }}</div>
              <p class="requirement-item__description">{{ req.description }}</p>
              <div class="card__collapsible-meta">
                <div class="requirement-item__status">
                  {% if req_compliance %}
                  <span class="badge badge--status-{{ req_compliance.status }}" data-requirement-status>
                    {% if req_compliance.status == 'not_started' %}Not started
                    {% elif req_compliance.status == 'in_progress' %}In progress
                    {% elif req_compliance.status == 'compliant' %}✓ Compliant
                    {% elif req_compliance.status == 'non_compliant' %}✗ Non-compliant
                    {% elif req_compliance.status == 'not_applicable' %}N/A
                    {% endif %}
                  </span>
                  {% else %}
                  <span class="badge badge--status-not_started" data-requirement-status>Not started</span>
                  {% endif %}
                </div>
                <span class="card__toggle-icon" aria-hidden="true"></span>
              </div>
            </summary>
            <div class="card-collapsible__content requirement-item__details" id="requirement-details-{{ req.id }}" data-requirement-details>
              <form class="compliance-form" data-requirement-form="{{ req.id }}">
                <div class="form-field">
                  <label for="req-status-{{ req.id }}" class="form-label">Status</label>
                  <select id="req-status-{{ req.id }}" class="form-input" required>
                    <option value="not_started" {% if req_compliance and req_compliance.status == 'not_started' %}selected{% endif %}>Not started</option>
                    <option value="in_progress" {% if req_compliance and req_compliance.status == 'in_progress' %}selected{% endif %}>In progress</option>
                    <option value="compliant" {% if req_compliance and req_compliance.status == 'compliant' %}selected{% endif %}>Compliant</option>
                    <option value="non_compliant" {% if req_compliance and req_compliance.status == 'non_compliant' %}selected{% endif %}>Non-compliant</option>
                    <option value="not_applicable" {% if req_compliance and req_compliance.status == 'not_applicable' %}selected{% endif %}>Not applicable</option>
                  </select>
                </div>
                <div class="form-field">
                  <label for="req-evidence-{{ req.id }}" class="form-label">Evidence</label>
                  <textarea id="req-evidence-{{ req.id }}" class="form-input form-input--textarea" rows="2" placeholder="Links to documentation, screenshots, etc.">{% if req_compliance %}{{ req_compliance.evidence or '' }}{% endif %}</textarea>
                </div>
                <div class="form-field">
                  <label for="req-notes-{{ req.id }}" class="form-label">Notes</label>
                  <textarea id="req-notes-{{ req.id }}" class="form-input form-input--textarea" rows="2" placeholder="Implementation details, outstanding items, etc.">{% if req_compliance %}{{ req_compliance.notes or '' }}{% endif %}</textarea>
                </div>
                <div class="form-field">
                  <label for="req-reviewed-{{ req.id }}" class="form-label">Last reviewed date</label>
                  <input type="date" id="req-reviewed-{{ req.id }}" class="form-input" value="{% if req_compliance and req_compliance.last_reviewed_date %}{{ req_compliance.last_reviewed_date }}{% endif %}" />
                </div>
                <div class="compliance-form__actions">
                  <button type="button" class="button button--primary button--small" data-save-requirement="{{ req.id }}">Save</button>
                </div>
              </form>
            </div>
          </details>
          {% endfor %}
        </div>
      </section>
    </div>
  </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const companyId = {{ (company.id if company else None) | tojson }};
  const csrfToken = getCsrfToken();

  const requirementItems = document.querySelectorAll('.requirement-item');

  requirementItems.forEach(item => {
    item.addEventListener('toggle', () => {
      item.classList.toggle('is-expanded', item.open);
    });

    item.classList.toggle('is-expanded', item.open);
  });

  // Expand all buttons
  document.querySelectorAll('[data-expand-all]').forEach(btn => {
    btn.addEventListener('click', () => {
      const section = btn.closest('.compliance-requirements__group');
      if (!section) return;
      const isExpanding = btn.getAttribute('data-expanded') !== 'true';
      const items = section.querySelectorAll('.requirement-item');

      items.forEach(item => {
        if (isExpanding) {
          item.setAttribute('open', '');
        } else {
          item.removeAttribute('open');
        }

        item.classList.toggle('is-expanded', item.hasAttribute('open'));
      });

      btn.setAttribute('data-expanded', isExpanding ? 'true' : 'false');
      btn.textContent = isExpanding ? 'Collapse all' : 'Expand all';
    });
  });

  // Save requirement
  document.querySelectorAll('[data-save-requirement]').forEach(btn => {
    btn.addEventListener('click', async () => {
      if (!companyId) return;
      const requirementId = btn.dataset.saveRequirement;

      const formData = {
        status: document.getElementById(`req-status-${requirementId}`).value,
        evidence: document.getElementById(`req-evidence-${requirementId}`).value || null,
        notes: document.getElementById(`req-notes-${requirementId}`).value || null,
        last_reviewed_date: document.getElementById(`req-reviewed-${requirementId}`).value || null,
      };

      try {
        let response = await fetch(`/api/essential8/companies/${companyId}/requirements/${requirementId}/compliance`);

        let method = 'PATCH';
        let url = `/api/essential8/companies/${companyId}/requirements/${requirementId}/compliance`;

        if (response.status === 404) {
          method = 'POST';
          url = `/api/essential8/companies/${companyId}/requirements/compliance`;
          formData.company_id = companyId;
          formData.requirement_id = requirementId;
        }

        response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken
          },
          body: JSON.stringify(formData)
        });

        if (response.ok) {
          updateRequirementStatus(requirementId, formData.status);
          showNotification('Requirement updated successfully', 'success');
        } else {
          showNotification('Failed to update requirement', 'error');
        }
      } catch (error) {
        console.error('Error:', error);
        showNotification('Failed to update requirement', 'error');
      }
    });
  });

  function updateRequirementStatus(requirementId, status) {
    const item = document.querySelector(`[data-requirement-id="${requirementId}"]`);
    if (!item) return;
    const statusBadge = item.querySelector('[data-requirement-status]');
    if (!statusBadge) return;

    statusBadge.className = `badge badge--status-${status}`;

    let statusText = 'Not started';
    if (status === 'in_progress') statusText = 'In progress';
    else if (status === 'compliant') statusText = '✓ Compliant';
    else if (status === 'non_compliant') statusText = '✗ Non-compliant';
    else if (status === 'not_applicable') statusText = 'N/A';

    statusBadge.textContent = statusText;
  }

  function getCsrfToken() {
    return document.cookie
      .split('; ')
      .find(row => row.startsWith('myportal_session_csrf='))
      ?.split('=')[1] || '';
  }

  function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.className = `compliance-toast compliance-toast--${type}`;
    notification.textContent = message;
    document.body.appendChild(notification);

    setTimeout(() => {
      notification.remove();
    }, 3000);
  }
});
</script>
{% endblock %}
