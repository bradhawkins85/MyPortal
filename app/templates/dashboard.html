{% extends "base.html" %}

{% block content %}
{% set overview = overview or {} %}
<div class="dashboard">
  {% if ollama_enabled %}
  <section class="dashboard__section dashboard__section--agent">
    <div class="card card--panel agent-panel" data-agent-panel>
      <div class="agent-panel__header">
        <h2 class="agent-panel__title">Agent</h2>
        <p class="agent-panel__subtitle">
          Ask the MyPortal agent for summaries across knowledge base articles, your tickets, and available hardware.
        </p>
      </div>
      <form class="agent-panel__form" data-agent-form novalidate>
        <label class="agent-panel__label" for="agent-query">Ask the agent</label>
        <div class="agent-panel__controls">
          <input
            id="agent-query"
            name="query"
            class="agent-panel__input"
            type="search"
            placeholder="Search for setup steps, ticket history, or device recommendationsâ€¦"
            maxlength="2000"
            required
            data-agent-input
          />
          <button type="submit" class="button button--primary agent-panel__submit" data-agent-submit>
            Ask
          </button>
        </div>
        <p class="agent-panel__hint">
          The agent only replies with information that is available to you inside MyPortal.
        </p>
      </form>
      <div class="agent-panel__status" data-agent-status aria-live="polite"></div>
      <div class="agent-panel__results" data-agent-results hidden>
        <article class="agent-answer" data-agent-answer hidden>
          <h3 class="agent-answer__heading">Answer</h3>
          <div class="agent-answer__body" data-agent-answer-body></div>
        </article>
        <section class="agent-sources" data-agent-sources hidden>
          <h3 class="agent-sources__heading">Sources</h3>
          <div class="agent-sources__lists" data-agent-source-lists></div>
        </section>
        <div class="agent-panel__actions" data-agent-actions hidden>
          <button 
            type="button" 
            class="button button--primary" 
            data-agent-create-ticket
            hidden
          >
            Create Support Ticket
          </button>
        </div>
      </div>
    </div>
  </section>
  {% endif %}
  <section class="dashboard__section">
    <div class="dashboard__section-header">
      <h1 class="dashboard__title">Consolidated overview</h1>
      <p class="dashboard__subtitle">
        Key insights across the portal with compact spacing tailored for fast scanning.
      </p>
    </div>
    <div class="dashboard__grid dashboard__grid--summary" role="list">
      {% for card in overview.cards %}
      <article class="card summary-card" role="listitem" aria-live="polite">
        <span class="summary-card__label">{{ card.label }}</span>
        <span class="summary-card__value">{{ card.formatted or card.value }}</span>
        {% if card.description %}
        <span class="summary-card__meta">{{ card.description }}</span>
        {% endif %}
      </article>
      {% else %}
      <p class="dashboard__empty">Metrics will appear here once activity is recorded.</p>
      {% endfor %}
    </div>
  </section>

  <section class="dashboard__section">
    <div class="dashboard__section-header">
      <h2 class="dashboard__heading">
        {% if overview.company %}
          {{ overview.company.name }}
        {% else %}
          Company snapshot
        {% endif %}
      </h2>
      <p class="dashboard__subtitle">
        {% if overview.company %}
          Live metrics for the selected company.
        {% else %}
          Choose a company from the sidebar to populate this snapshot.
        {% endif %}
      </p>
    </div>
    {% if overview.company %}
    <div class="dashboard__grid dashboard__grid--company">
      <div class="dashboard__column">
        <div class="dashboard__grid dashboard__grid--metrics" role="list">
          {% for metric in overview.company.metrics %}
          <article class="card summary-card summary-card--compact" role="listitem">
            <span class="summary-card__label">{{ metric.label }}</span>
            <span class="summary-card__value">{{ metric.formatted or metric.value }}</span>
            {% if metric.meta %}
            <span class="summary-card__meta">{{ metric.meta }}</span>
            {% endif %}
          </article>
          {% endfor %}
        </div>
        <article class="card status-card">
          <h3 class="status-card__title">License capacity</h3>
          <dl class="status-list">
            <div class="status-list__row">
              <dt>Total seats</dt>
              <dd>{{ overview.company.licenses.formatted.total }}</dd>
            </div>
            <div class="status-list__row">
              <dt>Allocated</dt>
              <dd>{{ overview.company.licenses.formatted.allocated }}</dd>
            </div>
            <div class="status-list__row">
              <dt>Available</dt>
              <dd>{{ overview.company.licenses.formatted.available }}</dd>
            </div>
            <div class="status-list__row">
              <dt>Utilisation</dt>
              <dd>{{ overview.company.licenses.formatted.utilisation }}</dd>
            </div>
          </dl>
        </article>
      </div>
      <div class="dashboard__column">
        <article class="card status-card">
          <h3 class="status-card__title">Asset distribution</h3>
          <ul class="status-list" role="list">
            {% for status in overview.company.asset_status %}
            <li class="status-list__item" role="listitem">
              <span class="status-list__label">{{ status.label }}</span>
              <span class="status-list__value">{{ status.formatted }}</span>
            </li>
            {% endfor %}
          </ul>
        </article>
        <article class="card status-card">
          <h3 class="status-card__title">Invoice health</h3>
          <div class="status-card__highlight">{{ overview.company.financial.open_formatted }}</div>
          <p class="status-card__meta">
            {{ overview.company.financial.overdue_formatted }} overdue invoices
          </p>
          <ul class="status-list status-list--compact" role="list">
            {% for status in overview.company.invoice_status %}
            <li class="status-list__item" role="listitem">
              <span class="status-list__label">{{ status.label }}</span>
              <span class="status-list__value">{{ status.formatted }}</span>
            </li>
            {% endfor %}
          </ul>
        </article>
      </div>
    </div>
    {% else %}
    <p class="dashboard__empty">No company is active yet. Switch companies to populate the snapshot.</p>
    {% endif %}
  </section>

  <!-- Simple ticket creation modal for dashboard -->
  <div
    class="modal"
    id="create-ticket-modal"
    role="dialog"
    aria-modal="true"
    aria-labelledby="create-ticket-title"
    aria-hidden="true"
    hidden
  >
    <div class="modal__content" role="document">
      <button type="button" class="modal__close" data-modal-close>
        <span class="visually-hidden">Close create ticket form</span>
        &times;
      </button>
      <h2 class="modal__title" id="create-ticket-title">Create a ticket</h2>
      <p class="modal__subtitle">Raise a new support request and the team will follow up with updates.</p>
      <form id="dashboard-ticket-form" action="/tickets" method="post" class="form" novalidate>
        {% include "partials/csrf.html" %}
        <div class="form-field">
          <label class="form-label" for="modal-ticket-subject">Subject</label>
          <input
            id="modal-ticket-subject"
            name="subject"
            class="form-input"
            maxlength="255"
            required
          />
        </div>
        <div class="form-field">
          <label class="form-label" for="modal-ticket-description">Description</label>
          <textarea
            id="modal-ticket-description"
            name="description"
            class="form-input form-input--textarea"
            rows="8"
            placeholder="Describe the issue, impact, and any troubleshooting already attempted..."
          ></textarea>
        </div>
        <div class="form-actions">
          <button type="submit" class="button button--primary">Submit ticket</button>
          <button type="button" class="button button--ghost" data-modal-close>Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if ollama_enabled %}
  <script src="/static/js/agent.js" defer></script>
  <script>
    // Simple modal handler for dashboard ticket creation
    document.addEventListener('DOMContentLoaded', () => {
      const modal = document.getElementById('create-ticket-modal');
      if (!modal) return;

      const closeButtons = modal.querySelectorAll('[data-modal-close]');
      
      // Close modal function
      function closeModal() {
        modal.hidden = true;
        modal.setAttribute('aria-hidden', 'true');
      }
      
      // Close on button click
      closeButtons.forEach(button => {
        button.addEventListener('click', closeModal);
      });
      
      // Close on outside click
      modal.addEventListener('click', (e) => {
        if (e.target === modal) {
          closeModal();
        }
      });
      
      // Close on Escape key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !modal.hidden) {
          closeModal();
        }
      });
    });
  </script>
  {% endif %}
{% endblock %}
