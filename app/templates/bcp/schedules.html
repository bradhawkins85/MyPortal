{% extends "base.html" %}

{% block content %}
<div class="page-container">
  <!-- Success/Error Messages -->
  {% if request.query_params.get('success') %}
    <div class="alert alert-success">{{ request.query_params.get('success') }}</div>
  {% endif %}
  {% if request.query_params.get('error') %}
    <div class="alert alert-error">{{ request.query_params.get('error') }}</div>
  {% endif %}

  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Training & Review Schedules</h1>
      <p class="page-description">Manage training sessions and plan review schedules</p>
    </div>
    <div class="page-actions">
      <a href="/bcp" class="btn btn-secondary">Back to Overview</a>
    </div>
  </div>

  <!-- Help Text -->
  <section class="card help-card">
    <div class="card-body">
      <h3 class="help-title">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/>
        </svg>
        About Training & Reviews
      </h3>
      <p class="help-text">
        Regular training ensures that personnel are prepared to execute the business continuity plan effectively. 
        Schedule training sessions (e.g., tabletop exercises, full-scale drills) and document outcomes. 
        Plan reviews should be conducted periodically or after significant organizational changes to ensure the BCP remains current and effective.
      </p>
    </div>
  </section>

  <!-- Training Schedule -->
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Training Schedule</h2>
      {% if can_edit %}
      <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('createTrainingModal').showModal()">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 0.5rem;">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        Add Training
      </button>
      {% endif %}
    </div>
    <div class="card-body">
      {% if training_items %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Type</th>
              <th>Comments</th>
              {% if can_edit %}
              <th>Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for item in training_items %}
            <tr>
              <td>
                {% if item.training_date %}
                  {{ item.training_date.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td><strong>{{ item.training_type or '-' }}</strong></td>
              <td class="text-sm">{{ item.comments or '-' }}</td>
              {% if can_edit %}
              <td>
                <div class="action-buttons">
                  <button type="button" class="btn-icon" onclick="editTraining({{ item.id }}, '{{ item.training_date.strftime('%Y-%m-%dT%H:%M') if item.training_date else '' }}', '{{ item.training_type or '' }}', '{{ item.comments or '' }}')" title="Edit">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                  <form method="POST" action="/bcp/training/{{ item.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this training record?');">
                    <button type="submit" class="btn-icon btn-icon-danger" title="Delete">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <p class="text-muted">No training sessions scheduled yet.</p>
        {% if can_edit %}
        <button type="button" class="btn btn-primary" onclick="document.getElementById('createTrainingModal').showModal()">Schedule Training</button>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </section>

  <!-- Review Schedule -->
  <section class="card" style="margin-top: 2rem;">
    <div class="card-header">
      <h2 class="card-title">Review Schedule</h2>
      {% if can_edit %}
      <button type="button" class="btn btn-primary btn-sm" onclick="document.getElementById('createReviewModal').showModal()">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 0.5rem;">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        Add Review
      </button>
      {% endif %}
    </div>
    <div class="card-body">
      {% if review_items %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Date</th>
              <th>Reason for Review</th>
              <th>Changes Made</th>
              {% if can_edit %}
              <th>Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for item in review_items %}
            <tr>
              <td>
                {% if item.review_date %}
                  {{ item.review_date.strftime('%Y-%m-%d %H:%M') }}
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-sm">{{ item.reason or '-' }}</td>
              <td class="text-sm">{{ item.changes_made or '-' }}</td>
              {% if can_edit %}
              <td>
                <div class="action-buttons">
                  <button type="button" class="btn-icon" onclick="editReview({{ item.id }}, '{{ item.review_date.strftime('%Y-%m-%dT%H:%M') if item.review_date else '' }}', '{{ item.reason or '' }}', '{{ item.changes_made or '' }}')" title="Edit">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                  <form method="POST" action="/bcp/review/{{ item.id }}/delete" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this review record?');">
                    <button type="submit" class="btn-icon btn-icon-danger" title="Delete">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <div class="empty-state">
        <p class="text-muted">No reviews scheduled yet.</p>
        {% if can_edit %}
        <button type="button" class="btn btn-primary" onclick="document.getElementById('createReviewModal').showModal()">Schedule Review</button>
        {% endif %}
      </div>
      {% endif %}
    </div>
  </section>
</div>

{% if can_edit %}
<!-- Create Training Modal -->
<dialog id="createTrainingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Schedule Training</h3>
      <button type="button" class="modal-close" onclick="document.getElementById('createTrainingModal').close()">×</button>
    </div>
    <form method="POST" action="/bcp/training">
      <div class="modal-body">
        <div class="form-group">
          <label for="training_date" class="form-label">Training Date *</label>
          <input type="datetime-local" id="training_date" name="training_date" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="training_type" class="form-label">Type</label>
          <input type="text" id="training_type" name="training_type" class="form-control" placeholder="e.g., Tabletop Exercise, Full-scale Drill">
        </div>
        <div class="form-group">
          <label for="training_comments" class="form-label">Comments</label>
          <textarea id="training_comments" name="comments" class="form-control" rows="3" placeholder="Training notes and outcomes"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('createTrainingModal').close()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Edit Training Modal -->
<dialog id="editTrainingModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Edit Training</h3>
      <button type="button" class="modal-close" onclick="document.getElementById('editTrainingModal').close()">×</button>
    </div>
    <form method="POST" id="editTrainingForm">
      <div class="modal-body">
        <div class="form-group">
          <label for="edit_training_date" class="form-label">Training Date *</label>
          <input type="datetime-local" id="edit_training_date" name="training_date" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="edit_training_type" class="form-label">Type</label>
          <input type="text" id="edit_training_type" name="training_type" class="form-control" placeholder="e.g., Tabletop Exercise, Full-scale Drill">
        </div>
        <div class="form-group">
          <label for="edit_training_comments" class="form-label">Comments</label>
          <textarea id="edit_training_comments" name="comments" class="form-control" rows="3" placeholder="Training notes and outcomes"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('editTrainingModal').close()">Cancel</button>
        <button type="submit" class="btn btn-primary">Update</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Create Review Modal -->
<dialog id="createReviewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Schedule Review</h3>
      <button type="button" class="modal-close" onclick="document.getElementById('createReviewModal').close()">×</button>
    </div>
    <form method="POST" action="/bcp/review">
      <div class="modal-body">
        <div class="form-group">
          <label for="review_date" class="form-label">Review Date *</label>
          <input type="datetime-local" id="review_date" name="review_date" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="reason" class="form-label">Reason for Review</label>
          <textarea id="reason" name="reason" class="form-control" rows="2" placeholder="e.g., Annual review, organizational change"></textarea>
        </div>
        <div class="form-group">
          <label for="changes_made" class="form-label">Changes Made</label>
          <textarea id="changes_made" name="changes_made" class="form-control" rows="3" placeholder="Summary of changes made during review"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('createReviewModal').close()">Cancel</button>
        <button type="submit" class="btn btn-primary">Create</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Edit Review Modal -->
<dialog id="editReviewModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 class="modal-title">Edit Review</h3>
      <button type="button" class="modal-close" onclick="document.getElementById('editReviewModal').close()">×</button>
    </div>
    <form method="POST" id="editReviewForm">
      <div class="modal-body">
        <div class="form-group">
          <label for="edit_review_date" class="form-label">Review Date *</label>
          <input type="datetime-local" id="edit_review_date" name="review_date" class="form-control" required>
        </div>
        <div class="form-group">
          <label for="edit_reason" class="form-label">Reason for Review</label>
          <textarea id="edit_reason" name="reason" class="form-control" rows="2" placeholder="e.g., Annual review, organizational change"></textarea>
        </div>
        <div class="form-group">
          <label for="edit_changes_made" class="form-label">Changes Made</label>
          <textarea id="edit_changes_made" name="changes_made" class="form-control" rows="3" placeholder="Summary of changes made during review"></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('editReviewModal').close()">Cancel</button>
        <button type="submit" class="btn btn-primary">Update</button>
      </div>
    </form>
  </div>
</dialog>

<script>
function editTraining(id, date, type, comments) {
  document.getElementById('edit_training_date').value = date;
  document.getElementById('edit_training_type').value = type;
  document.getElementById('edit_training_comments').value = comments;
  document.getElementById('editTrainingForm').action = '/bcp/training/' + id + '/update';
  document.getElementById('editTrainingModal').showModal();
}

function editReview(id, date, reason, changes) {
  document.getElementById('edit_review_date').value = date;
  document.getElementById('edit_reason').value = reason;
  document.getElementById('edit_changes_made').value = changes;
  document.getElementById('editReviewForm').action = '/bcp/review/' + id + '/update';
  document.getElementById('editReviewModal').showModal();
}
</script>
{% endif %}
{% endblock %}
