{% extends "bcp/layout.html" %}

{% block bcp_content %}
<div class="bcp-page page-container">
  <!-- Success/Error Messages -->
  {% if request.query_params.get('success') %}
    <div class="alert alert-success">{{ request.query_params.get('success') }}</div>
  {% endif %}
  {% if request.query_params.get('error') %}
    <div class="alert alert-error">{{ request.query_params.get('error') }}</div>
  {% endif %}

  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Business Impact Analysis (BIA)</h1>
      <p class="page-description">Identify critical activities and assess their impact if unavailable</p>
    </div>
    <div class="page-actions">
      <a href="/bcp" class="btn btn-secondary">Back to Overview</a>
      {% if can_edit %}
      <a href="/bcp/bia/new" class="btn btn-primary">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 0.5rem;">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        Add Critical Activity
      </a>
      <a href="/bcp/bia/export" class="btn btn-secondary">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 0.5rem;">
          <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
        Export CSV
      </a>
      {% endif %}
    </div>
  </div>

  <!-- Help Text -->
  <section class="card help-card" role="region" aria-label="Business Impact Analysis Help">
    <div class="card-body">
      <h3 class="help-title">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor" aria-hidden="true" focusable="false">
          <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/>
        </svg>
        About Business Impact Analysis
      </h3>
      <p class="help-text">
        The Business Impact Analysis (BIA) identifies your organization's critical activities and 
        documents what happens if they become unavailable. For each activity, capture the financial, 
        operational, and reputational impacts, along with the maximum acceptable downtime 
        (Recovery Time Objective or RTO). This analysis helps prioritize recovery efforts and 
        allocate resources effectively.
      </p>
      <div class="help-text">
        <p><strong>Understanding RTO (Recovery Time Objective):</strong></p>
        <ul>
          <li><strong>Definition:</strong> The maximum acceptable time that a critical activity can be unavailable before causing unacceptable harm to the organization.</li>
          <li><strong>How it's used:</strong> RTOs guide recovery priorities. Activities with shorter RTOs must be restored first during an incident.</li>
          <li><strong>Setting RTOs:</strong> Consider financial losses per hour, regulatory requirements, customer expectations, and dependencies on other activities.</li>
          <li><strong>Example:</strong> If a payment processing system has a 4-hour RTO, recovery plans must restore it within 4 hours to avoid critical business impact.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- Sort Controls -->
  <section class="card">
    <div class="card-body">
      <div class="sort-controls">
        <label for="sort_by">Sort by:</label>
        <select id="sort_by" onchange="window.location.href='/bcp/bia?sort_by=' + this.value">
          <option value="importance" {% if sort_by == 'importance' %}selected{% endif %}>Importance (1=Most Important)</option>
          <option value="priority" {% if sort_by == 'priority' %}selected{% endif %}>Priority (High to Low)</option>
          <option value="name" {% if sort_by == 'name' %}selected{% endif %}>Activity Name</option>
        </select>
      </div>
    </div>
  </section>

  <!-- BIA Summary Table -->
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Critical Activities Summary</h2>
    </div>
    <div class="card-body">
      {% if activities %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Activity</th>
              <th>Description</th>
              <th>Priority</th>
              <th>Importance</th>
              <th>Impact Summary</th>
              <th>RTO</th>
              {% if can_edit %}
              <th>Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for activity in activities %}
            <tr>
              <td><strong>{{ activity.name }}</strong></td>
              <td class="text-sm">{{ activity.description or '-' }}</td>
              <td>
                {% if activity.priority %}
                  <span class="badge badge-{{ 'high' if activity.priority == 'High' else 'medium' if activity.priority == 'Medium' else 'low' }}">
                    {{ activity.priority }}
                  </span>
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-center">
                {% if activity.importance %}
                  <span class="importance-badge importance-{{ activity.importance }}">{{ activity.importance }}</span>
                {% else %}
                  -
                {% endif %}
              </td>
              <td class="text-sm">
                {% if activity.impact %}
                  {% set impacts = [] %}
                  {% if activity.impact.losses_financial %}
                    {% set _ = impacts.append('Financial: ' + activity.impact.losses_financial[:50] + ('...' if activity.impact.losses_financial|length > 50 else '')) %}
                  {% endif %}
                  {% if activity.impact.losses_staffing %}
                    {% set _ = impacts.append('Staffing: ' + activity.impact.losses_staffing[:50] + ('...' if activity.impact.losses_staffing|length > 50 else '')) %}
                  {% endif %}
                  {% if activity.impact.losses_reputation %}
                    {% set _ = impacts.append('Reputation: ' + activity.impact.losses_reputation[:50] + ('...' if activity.impact.losses_reputation|length > 50 else '')) %}
                  {% endif %}
                  {% if impacts %}
                    <div>{{ '; '.join(impacts) }}</div>
                  {% else %}
                    <span class="text-muted">No impact details</span>
                  {% endif %}
                {% else %}
                  <span class="text-muted">No impact assessment</span>
                {% endif %}
              </td>
              <td>
                {% if activity.impact and activity.impact.rto_humanized %}
                  <strong>{{ activity.impact.rto_humanized }}</strong>
                {% else %}
                  -
                {% endif %}
              </td>
              {% if can_edit %}
              <td>
                <div class="action-buttons">
                  <a href="/bcp/bia/{{ activity.id }}/edit" class="btn btn-sm btn-secondary">
                    Edit
                  </a>
                  <form method="post" action="/bcp/bia/{{ activity.id }}/delete" class="inline">
                    <input type="hidden" name="_csrf" value="{{ csrf_token }}">
                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Delete this critical activity and all its impact data?')">
                      Delete
                    </button>
                  </form>
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="text-muted">No critical activities defined yet. Click "Add Critical Activity" to begin your BIA.</p>
      {% endif %}
    </div>
  </section>
</div>
{% endblock %}
