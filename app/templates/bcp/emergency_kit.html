{% extends "base.html" %}

{% block content %}
<div class="page-container">
  <!-- Success/Error Messages -->
  {% if request.query_params.get('success') %}
    <div class="alert alert-success">{{ request.query_params.get('success') }}</div>
  {% endif %}
  {% if request.query_params.get('error') %}
    <div class="alert alert-error">{{ request.query_params.get('error') }}</div>
  {% endif %}

  <!-- Page Header -->
  <div class="page-header">
    <div>
      <h1 class="page-title">Emergency Kit</h1>
      <p class="page-description">Maintain inventory of emergency documents and equipment</p>
    </div>
    <div class="page-actions">
      <a href="/bcp/incident" class="btn btn-secondary">Back to Incident Console</a>
      {% if can_edit %}
      <button type="button" class="btn btn-primary" onclick="document.getElementById('createItemModal').showModal()">
        <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor" style="margin-right: 0.5rem;">
          <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
        </svg>
        Add Item
      </button>
      {% endif %}
    </div>
  </div>

  <!-- Help Text -->
  <section class="card help-card">
    <div class="card-body">
      <h3 class="help-title">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="currentColor">
          <path d="M11 17h2v-6h-2v6zm1-15C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zM11 9h2V7h-2v2z"/>
        </svg>
        About the Emergency Kit
      </h3>
      <p class="help-text">
        Maintain an inventory of essential documents and equipment needed in an emergency. Documents should include 
        copies of the BCP, staff contacts with next-of-kin details, customer/supplier lists, emergency contacts, 
        site plans, insurance details, and other critical business information. Equipment should include backup media, 
        spare keys, torches, communication devices, and basic supplies. Regularly check items to ensure they remain 
        current and functional.
      </p>
    </div>
  </section>

  <!-- Tabs -->
  <div class="tabs">
    <a href="/bcp/emergency-kit?tab=documents" class="tab {% if active_tab == 'documents' %}tab-active{% endif %}">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
        <path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/>
      </svg>
      Documents ({{ document_items|length }})
    </a>
    <a href="/bcp/emergency-kit?tab=equipment" class="tab {% if active_tab == 'equipment' %}tab-active{% endif %}">
      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
        <path d="M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z"/>
      </svg>
      Equipment ({{ equipment_items|length }})
    </a>
  </div>

  <!-- Documents Tab Content -->
  {% if active_tab == 'documents' %}
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Emergency Documents</h2>
    </div>
    <div class="card-body">
      {% if document_items %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Document Name</th>
              <th>Notes</th>
              <th>Last Checked</th>
              {% if can_edit %}
              <th>Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for item in document_items %}
            <tr>
              <td>
                <strong>{{ item.name }}</strong>
              </td>
              <td>{{ item.notes or '—' }}</td>
              <td>
                {% if item.last_checked_at %}
                  <span class="status-badge status-success">{{ item.last_checked_at.strftime('%Y-%m-%d') }}</span>
                {% else %}
                  <span class="status-badge status-warning">Not checked</span>
                {% endif %}
              </td>
              {% if can_edit %}
              <td>
                <div class="action-buttons">
                  <form action="/bcp/emergency-kit/{{ item.id }}/check" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-secondary" title="Mark checked today">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                      </svg>
                    </button>
                  </form>
                  <button type="button" class="btn btn-sm btn-secondary" onclick="openEditModal({{ item.id }}, '{{ item.category }}', '{{ item.name }}', '{{ item.notes or '' }}')" title="Edit">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                  <form action="/bcp/emergency-kit/{{ item.id }}/delete" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this item?')">
                    <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="empty-state">No documents recorded. Click "Add Item" to add your first document.</p>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <!-- Equipment Tab Content -->
  {% if active_tab == 'equipment' %}
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Emergency Equipment</h2>
    </div>
    <div class="card-body">
      {% if equipment_items %}
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th>Equipment Name</th>
              <th>Notes</th>
              <th>Last Checked</th>
              {% if can_edit %}
              <th>Actions</th>
              {% endif %}
            </tr>
          </thead>
          <tbody>
            {% for item in equipment_items %}
            <tr>
              <td>
                <strong>{{ item.name }}</strong>
              </td>
              <td>{{ item.notes or '—' }}</td>
              <td>
                {% if item.last_checked_at %}
                  <span class="status-badge status-success">{{ item.last_checked_at.strftime('%Y-%m-%d') }}</span>
                {% else %}
                  <span class="status-badge status-warning">Not checked</span>
                {% endif %}
              </td>
              {% if can_edit %}
              <td>
                <div class="action-buttons">
                  <form action="/bcp/emergency-kit/{{ item.id }}/check" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-sm btn-secondary" title="Mark checked today">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>
                      </svg>
                    </button>
                  </form>
                  <button type="button" class="btn btn-sm btn-secondary" onclick="openEditModal({{ item.id }}, '{{ item.category }}', '{{ item.name }}', '{{ item.notes or '' }}')" title="Edit">
                    <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                      <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
                    </svg>
                  </button>
                  <form action="/bcp/emergency-kit/{{ item.id }}/delete" method="post" style="display: inline;" onsubmit="return confirm('Are you sure you want to delete this item?')">
                    <button type="submit" class="btn btn-sm btn-danger" title="Delete">
                      <svg viewBox="0 0 24 24" width="16" height="16" fill="currentColor">
                        <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
                      </svg>
                    </button>
                  </form>
                </div>
              </td>
              {% endif %}
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      {% else %}
      <p class="empty-state">No equipment recorded. Click "Add Item" to add your first equipment item.</p>
      {% endif %}
    </div>
  </section>
  {% endif %}

  <!-- Quick Links -->
  <section class="card">
    <div class="card-header">
      <h2 class="card-title">Related Information</h2>
    </div>
    <div class="card-body">
      <div class="quick-links">
        <a href="/bcp/evacuation" class="quick-link-card">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M12 2L1 21h22L12 2zm0 3.99L19.53 19H4.47L12 5.99zM11 16h2v2h-2zm0-6h2v4h-2z"/>
          </svg>
          <div>
            <strong>Evacuation Procedures</strong>
            <p>View evacuation plan and meeting points</p>
          </div>
        </a>
        
        <a href="/bcp/incident" class="quick-link-card">
          <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
          </svg>
          <div>
            <strong>Incident Console</strong>
            <p>Manage active incidents and response</p>
          </div>
        </a>
      </div>
    </div>
  </section>
</div>

<!-- Create Item Modal -->
{% if can_edit %}
<dialog id="createItemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Add Emergency Kit Item</h2>
      <button type="button" class="modal-close" onclick="document.getElementById('createItemModal').close()">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
    <form action="/bcp/emergency-kit" method="post" class="modal-body">
      <div class="form-group">
        <label for="create_category" class="form-label required">Category</label>
        <select id="create_category" name="category" class="form-select" required>
          <option value="Document" {% if active_tab == 'documents' %}selected{% endif %}>Document</option>
          <option value="Equipment" {% if active_tab == 'equipment' %}selected{% endif %}>Equipment</option>
        </select>
      </div>

      <div class="form-group">
        <label for="create_name" class="form-label required">Name</label>
        <input type="text" id="create_name" name="name" class="form-input" required>
      </div>

      <div class="form-group">
        <label for="create_notes" class="form-label">Notes</label>
        <textarea id="create_notes" name="notes" class="form-textarea" rows="3"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('createItemModal').close()">Cancel</button>
        <button type="submit" class="btn btn-primary">Add Item</button>
      </div>
    </form>
  </div>
</dialog>

<!-- Edit Item Modal -->
<dialog id="editItemModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2 class="modal-title">Edit Emergency Kit Item</h2>
      <button type="button" class="modal-close" onclick="document.getElementById('editItemModal').close()">
        <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor">
          <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>
        </svg>
      </button>
    </div>
    <form id="editItemForm" method="post" class="modal-body">
      <div class="form-group">
        <label for="edit_category" class="form-label required">Category</label>
        <select id="edit_category" name="category" class="form-select" required>
          <option value="Document">Document</option>
          <option value="Equipment">Equipment</option>
        </select>
      </div>

      <div class="form-group">
        <label for="edit_name" class="form-label required">Name</label>
        <input type="text" id="edit_name" name="name" class="form-input" required>
      </div>

      <div class="form-group">
        <label for="edit_notes" class="form-label">Notes</label>
        <textarea id="edit_notes" name="notes" class="form-textarea" rows="3"></textarea>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" onclick="document.getElementById('editItemModal').close()">Cancel</button>
        <button type="submit" class="btn btn-primary">Save Changes</button>
      </div>
    </form>
  </div>
</dialog>

<script>
function openEditModal(itemId, category, name, notes) {
  const form = document.getElementById('editItemForm');
  form.action = `/bcp/emergency-kit/${itemId}/update`;
  
  document.getElementById('edit_category').value = category;
  document.getElementById('edit_name').value = name;
  document.getElementById('edit_notes').value = notes;
  
  document.getElementById('editItemModal').showModal();
}
</script>
{% endif %}

<style>
.tabs {
  display: flex;
  gap: 0.5rem;
  margin-bottom: 1.5rem;
  border-bottom: 2px solid var(--border-color);
}

.tab {
  display: flex;
  align-items: center;
  gap: 0.5rem;
  padding: 0.75rem 1.5rem;
  text-decoration: none;
  color: var(--text-muted);
  border-bottom: 2px solid transparent;
  margin-bottom: -2px;
  transition: all 0.2s;
}

.tab:hover {
  color: var(--text-primary);
  background: var(--bg-secondary);
}

.tab-active {
  color: var(--primary-color);
  border-bottom-color: var(--primary-color);
  font-weight: 600;
}

.action-buttons {
  display: flex;
  gap: 0.5rem;
}

.empty-state {
  text-align: center;
  padding: 3rem 1rem;
  color: var(--text-muted);
}

.quick-links {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
  gap: 1rem;
}

.quick-link-card {
  display: flex;
  align-items: center;
  gap: 1rem;
  padding: 1rem;
  border: 1px solid var(--border-color);
  border-radius: 8px;
  text-decoration: none;
  transition: all 0.2s;
}

.quick-link-card:hover {
  border-color: var(--primary-color);
  background: var(--bg-secondary);
  transform: translateY(-2px);
}

.quick-link-card svg {
  flex-shrink: 0;
  color: var(--primary-color);
}

.quick-link-card strong {
  display: block;
  color: var(--text-primary);
  margin-bottom: 0.25rem;
}

.quick-link-card p {
  margin: 0;
  font-size: 0.875rem;
  color: var(--text-muted);
}
</style>
{% endblock %}
