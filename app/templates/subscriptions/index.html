{% extends "base.html" %}

{% block title %}Subscriptions{% endblock %}

{% block header_actions %}
  <div class="header-actions">
    <input type="search" id="subscription-filter" class="input" placeholder="Filter subscriptions" aria-label="Filter subscriptions" />
  </div>
{% endblock %}

{% block content %}
<section class="panel">
  <header class="panel__header">
    <div>
      <h2 class="panel__title">Active subscriptions</h2>
      <p class="panel__subtitle">View your subscriptions and request changes to quantities.</p>
    </div>
    {% if company %}
    <div class="panel__meta">
      <span class="tag">{{ company.name }}</span>
    </div>
    {% endif %}
  </header>
  <div class="panel__body">
    <div class="table-responsive">
      <table class="table" data-subscription-table>
        <thead>
          <tr>
            <th scope="col" data-sort-key="product_name">Product</th>
            <th scope="col" data-sort-key="category_name">Category</th>
            <th scope="col" data-sort-key="quantity">Quantity</th>
            <th scope="col" data-sort-key="unit_price">Unit price</th>
            <th scope="col" data-sort-key="start_date">Start date</th>
            <th scope="col" data-sort-key="end_date">End date</th>
            <th scope="col" data-sort-key="status">Status</th>
            <th scope="col" data-sort-key="auto_renew">Auto-renew</th>
            {% if can_request_changes %}<th scope="col">Actions</th>{% endif %}
          </tr>
        </thead>
        <tbody>
          {% for subscription in subscriptions %}
          <tr>
            <td data-column="product_name" data-value="{{ subscription.product_name or '' }}">{{ subscription.product_name or '—' }}</td>
            <td data-column="category_name" data-value="{{ subscription.category_name or '' }}">{{ subscription.category_name or '—' }}</td>
            <td data-column="quantity" data-value="{{ subscription.quantity }}">{{ subscription.quantity }}</td>
            <td data-column="unit_price" data-value="{{ subscription.unit_price }}">${{ subscription.unit_price }}</td>
            <td data-column="start_date" data-value="{{ subscription.start_date }}">{{ subscription.start_date }}</td>
            <td data-column="end_date" data-value="{{ subscription.end_date }}">{{ subscription.end_date }}</td>
            <td data-column="status" data-value="{{ subscription.status }}">
              <span class="tag {% if subscription.status == 'active' %}tag--success{% elif subscription.status == 'pending_renewal' %}tag--warning{% elif subscription.status == 'expired' %}tag--danger{% else %}tag--secondary{% endif %}">
                {{ subscription.status | replace('_', ' ') | title }}
              </span>
            </td>
            <td data-column="auto_renew" data-value="{{ subscription.auto_renew }}">{{ 'Yes' if subscription.auto_renew else 'No' }}</td>
            {% if can_request_changes %}
            <td>
              <div class="button-group">
                <button type="button" class="button button--small button--success" data-subscription-add="{{ subscription.id }}" data-current-quantity="{{ subscription.quantity }}" data-end-date="{{ subscription.end_date }}">Add licenses</button>
                <button type="button" class="button button--small button--warning" data-subscription-decrease="{{ subscription.id }}" data-current-quantity="{{ subscription.quantity }}" data-end-date="{{ subscription.end_date }}">Request decrease</button>
              </div>
            </td>
            {% endif %}
          </tr>
          {% else %}
          <tr>
            <td colspan="{% if can_request_changes %}9{% else %}8{% endif %}" class="text-center">No active subscriptions found.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</section>

<dialog id="change-dialog" class="dialog">
  <form method="dialog" class="dialog__container" id="change-form">
    <header class="dialog__header">
      <h3 class="dialog__title" id="dialog-title">Modify subscription</h3>
      <button type="button" class="dialog__close" aria-label="Close" data-dialog-close>
        <span aria-hidden="true">&times;</span>
      </button>
    </header>
    <div class="dialog__body">
      <div id="change-info" class="mb-4"></div>
      
      <div id="pending-changes-section" style="display: none;" class="mb-4 p-3" style="background-color: #f9fafb; border-radius: 4px; border: 1px solid #e5e7eb;">
        <h4 class="text-sm font-semibold mb-2">Pending Changes:</h4>
        <ul id="pending-changes-list" class="text-sm space-y-1"></ul>
      </div>
      
      <div id="preview-section" style="display: none;" class="mb-4 p-3" style="background-color: #eff6ff; border-radius: 4px; border: 1px solid #bfdbfe;">
        <h4 class="text-sm font-semibold mb-2">Change Preview:</h4>
        <div id="preview-content" class="text-sm space-y-1"></div>
      </div>
      
      <div class="form-field">
        <label for="new-quantity" class="form-field__label">Number of licenses</label>
        <input type="number" id="new-quantity" name="quantity" class="input" min="1" required />
        <p class="form-field__hint" id="quantity-hint">Enter the number of licenses to add or remove.</p>
      </div>
      
      <div class="form-field">
        <label for="change-reason" class="form-field__label">Notes (optional)</label>
        <textarea id="change-reason" name="reason" class="input" rows="3" placeholder="Add any notes about this change..."></textarea>
      </div>
    </div>
    <footer class="dialog__footer">
      <button type="button" class="button button--secondary" data-dialog-close>Cancel</button>
      <button type="button" class="button" id="preview-change-btn">Preview Change</button>
      <button type="submit" class="button" id="submit-change" style="display: none;">Confirm</button>
    </footer>
  </form>
</dialog>

<div id="subscription-toast" class="toast" role="status" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
<script>
  (function () {
    const csrfToken = {{ csrf_token | tojson }};
    const filterInput = document.getElementById('subscription-filter');
    const table = document.querySelector('[data-subscription-table]');
    const toast = document.getElementById('subscription-toast');
    const changeDialog = document.getElementById('change-dialog');
    const changeForm = document.getElementById('change-form');
    const dialogTitle = document.getElementById('dialog-title');
    const changeInfo = document.getElementById('change-info');
    const pendingChangesSection = document.getElementById('pending-changes-section');
    const pendingChangesList = document.getElementById('pending-changes-list');
    const previewSection = document.getElementById('preview-section');
    const previewContent = document.getElementById('preview-content');
    const newQuantityInput = document.getElementById('new-quantity');
    const quantityHint = document.getElementById('quantity-hint');
    const changeReasonInput = document.getElementById('change-reason');
    const previewButton = document.getElementById('preview-change-btn');
    const submitButton = document.getElementById('submit-change');
    
    let currentSubscriptionId = null;
    let currentChangeType = null;
    let currentPreview = null;

    function showToast(message, type = 'info') {
      if (!toast) return;
      toast.textContent = message;
      toast.className = `toast toast--${type}`;
      toast.setAttribute('aria-hidden', 'false');
      setTimeout(() => {
        toast.setAttribute('aria-hidden', 'true');
      }, 4000);
    }

    function applyFilter() {
      if (!filterInput || !table) return;
      const term = filterInput.value.trim().toLowerCase();
      const rows = table.tBodies[0].rows;
      for (const row of rows) {
        const text = row.textContent.toLowerCase();
        row.style.display = term && !text.includes(term) ? 'none' : '';
      }
    }

    function sortTable(columnKey, ascending) {
      if (!table) return;
      const rows = Array.from(table.tBodies[0].rows);
      const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
      rows.sort((a, b) => {
        const aCell = a.querySelector(`[data-column='${columnKey}']`);
        const bCell = b.querySelector(`[data-column='${columnKey}']`);
        const aText = aCell ? aCell.getAttribute('data-value') || aCell.textContent.trim() : '';
        const bText = bCell ? bCell.getAttribute('data-value') || bCell.textContent.trim() : '';
        return ascending ? collator.compare(aText, bText) : collator.compare(bText, aText);
      });
      const fragment = document.createDocumentFragment();
      rows.forEach((row) => fragment.appendChild(row));
      table.tBodies[0].appendChild(fragment);
    }

    async function loadPendingChanges(subscriptionId) {
      try {
        const response = await fetch(`/api/v1/subscriptions/${subscriptionId}/pending-changes`, {
          headers: {
            'X-CSRF-Token': csrfToken || '',
          },
        });
        
        if (!response.ok) return [];
        
        return await response.json();
      } catch (err) {
        console.error('Failed to load pending changes:', err);
        return [];
      }
    }

    async function previewChange() {
      const quantity = parseInt(newQuantityInput.value, 10);
      
      if (isNaN(quantity) || quantity < 1) {
        showToast('Please enter a valid quantity.', 'error');
        return;
      }
      
      previewButton.disabled = true;
      
      try {
        const response = await fetch(`/api/v1/subscriptions/${currentSubscriptionId}/preview-change`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': csrfToken || '',
          },
          body: JSON.stringify({ 
            quantityChange: quantity,
            changeType: currentChangeType
          }),
        });
        
        if (!response.ok) {
          const error = await response.json();
          throw new Error(error.detail || 'Preview failed');
        }
        
        currentPreview = await response.json();
        displayPreview(currentPreview);
        
        submitButton.style.display = 'inline-block';
      } catch (err) {
        console.error(err);
        showToast(err.message || 'Unable to preview change.', 'error');
      } finally {
        previewButton.disabled = false;
      }
    }

    function displayPreview(preview) {
      previewSection.style.display = 'block';
      
      let html = '<ul class="space-y-1">';
      html += `<li><strong>Current quantity:</strong> ${preview.currentQuantity}</li>`;
      
      if (currentChangeType === 'addition') {
        html += `<li><strong>Licenses to add:</strong> ${preview.requestedChange}</li>`;
        html += `<li><strong>Prorated charge:</strong> $${preview.proratedCharge}</li>`;
        if (preview.proratedExplanation) {
          html += `<li class="text-xs text-gray-600">${preview.proratedExplanation.formula}</li>`;
        }
      } else {
        html += `<li><strong>Licenses to remove:</strong> ${preview.requestedChange}</li>`;
        html += `<li><em>No charges for decreases</em></li>`;
      }
      
      if (preview.pendingChangesCount > 0) {
        html += `<li class="mt-2"><strong>Net change at term end:</strong> ${preview.newNetChange > 0 ? '+' : ''}${preview.newNetChange}</li>`;
        html += `<li><strong>Quantity at term end:</strong> ${preview.newQuantityAtTermEnd}</li>`;
        if (preview.newTotalCharges > 0) {
          html += `<li><strong>Total pending charges:</strong> $${preview.newTotalCharges}</li>`;
        }
      } else {
        if (currentChangeType === 'addition') {
          html += `<li><strong>New quantity:</strong> ${preview.newQuantityAtTermEnd} (effective immediately)</li>`;
        } else {
          html += `<li><strong>Quantity at term end:</strong> ${preview.newQuantityAtTermEnd}</li>`;
        }
      }
      
      html += `<li class="text-xs text-gray-600 mt-2">Term ends: ${preview.endDate}</li>`;
      html += '</ul>';
      
      previewContent.innerHTML = html;
    }

    function displayPendingChanges(changes) {
      if (!changes || changes.length === 0) {
        pendingChangesSection.style.display = 'none';
        return;
      }
      
      pendingChangesSection.style.display = 'block';
      
      let html = '';
      for (const change of changes) {
        const icon = change.changeType === 'addition' ? '➕' : '➖';
        const chargeInfo = change.proratedCharge ? ` ($${change.proratedCharge})` : '';
        html += `<li>${icon} ${change.changeType === 'addition' ? 'Add' : 'Remove'} ${change.quantityChange} license(s)${chargeInfo}</li>`;
      }
      
      pendingChangesList.innerHTML = html;
    }

    async function openAddDialog(subscriptionId, currentQuantity, endDate) {
      currentSubscriptionId = subscriptionId;
      currentChangeType = 'addition';
      currentPreview = null;
      
      dialogTitle.textContent = 'Add Licenses';
      changeInfo.innerHTML = `<p><strong>Current quantity:</strong> ${currentQuantity}</p><p>Adding licenses will be applied immediately with prorated charges based on the remaining term until ${endDate}.</p>`;
      quantityHint.textContent = 'Enter the number of licenses to add.';
      newQuantityInput.value = '1';
      newQuantityInput.min = '1';
      changeReasonInput.value = '';
      
      previewSection.style.display = 'none';
      submitButton.style.display = 'none';
      
      const pendingChanges = await loadPendingChanges(subscriptionId);
      displayPendingChanges(pendingChanges);
      
      if (typeof changeDialog.showModal === 'function') {
        changeDialog.showModal();
      }
    }

    async function openDecreaseDialog(subscriptionId, currentQuantity, endDate) {
      currentSubscriptionId = subscriptionId;
      currentChangeType = 'decrease';
      currentPreview = null;
      
      dialogTitle.textContent = 'Request License Decrease';
      changeInfo.innerHTML = `<p><strong>Current quantity:</strong> ${currentQuantity}</p><p>Decrease requests will be applied at the end of the current term on ${endDate}. No charges will be incurred.</p>`;
      quantityHint.textContent = 'Enter the number of licenses to remove at term end.';
      newQuantityInput.value = '1';
      newQuantityInput.min = '1';
      newQuantityInput.max = currentQuantity.toString();
      changeReasonInput.value = '';
      
      previewSection.style.display = 'none';
      submitButton.style.display = 'none';
      
      const pendingChanges = await loadPendingChanges(subscriptionId);
      displayPendingChanges(pendingChanges);
      
      if (typeof changeDialog.showModal === 'function') {
        changeDialog.showModal();
      }
    }

    if (filterInput) {
      filterInput.addEventListener('input', applyFilter);
    }

    if (table) {
      table.querySelectorAll('th[data-sort-key]').forEach((header) => {
        let ascending = true;
        header.addEventListener('click', () => {
          table.querySelectorAll('th[data-sort-key]').forEach((h) => h.removeAttribute('aria-sort'));
          header.setAttribute('aria-sort', ascending ? 'ascending' : 'descending');
          sortTable(header.dataset.sortKey, ascending);
          ascending = !ascending;
        });
      });
    }

    document.querySelectorAll('[data-subscription-add]').forEach((button) => {
      button.addEventListener('click', () => {
        const subscriptionId = button.dataset.subscriptionAdd;
        const currentQuantity = button.dataset.currentQuantity;
        const endDate = button.dataset.endDate;
        openAddDialog(subscriptionId, currentQuantity, endDate);
      });
    });

    document.querySelectorAll('[data-subscription-decrease]').forEach((button) => {
      button.addEventListener('click', () => {
        const subscriptionId = button.dataset.subscriptionDecrease;
        const currentQuantity = button.dataset.currentQuantity;
        const endDate = button.dataset.endDate;
        openDecreaseDialog(subscriptionId, currentQuantity, endDate);
      });
    });

    document.querySelectorAll('[data-dialog-close]').forEach((button) => {
      button.addEventListener('click', () => {
        if (changeDialog && typeof changeDialog.close === 'function') {
          changeDialog.close();
        }
      });
    });

    if (previewButton) {
      previewButton.addEventListener('click', previewChange);
    }

    if (changeForm) {
      changeForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        if (!currentSubscriptionId || !currentPreview) {
          showToast('Please preview the change first.', 'error');
          return;
        }
        
        const quantity = parseInt(newQuantityInput.value, 10);
        const notes = changeReasonInput.value.trim();
        
        if (isNaN(quantity) || quantity < 1) {
          showToast('Please enter a valid quantity.', 'error');
          return;
        }
        
        submitButton.disabled = true;
        
        try {
          let endpoint, method, body;
          
          if (currentChangeType === 'addition') {
            endpoint = `/api/v1/subscriptions/${currentSubscriptionId}/add-licenses`;
            method = 'POST';
            body = JSON.stringify({ 
              quantity: quantity,
              notes: notes || null
            });
          } else {
            endpoint = `/api/v1/subscriptions/${currentSubscriptionId}/request-decrease`;
            method = 'POST';
            body = JSON.stringify({ 
              quantity: quantity,
              notes: notes || null
            });
          }
          
          const response = await fetch(endpoint, {
            method: method,
            headers: {
              'Content-Type': 'application/json',
              'X-CSRF-Token': csrfToken || '',
            },
            body: body,
          });
          
          if (!response.ok) {
            const error = await response.json();
            throw new Error(error.detail || 'Request failed');
          }
          
          const result = await response.json();
          showToast(result.message || 'Change applied successfully.', 'success');
          
          if (typeof changeDialog.close === 'function') {
            changeDialog.close();
          }
          
          // Reload the page to show updated data
          setTimeout(() => window.location.reload(), 1500);
        } catch (err) {
          console.error(err);
          showToast(err.message || 'Unable to apply change.', 'error');
        } finally {
          submitButton.disabled = false;
        }
      });
    }
  })();
</script>
{% endblock %}
